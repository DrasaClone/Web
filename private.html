<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chat Nâng Cao</title>

    <!-- SDKs & Fonts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a; --panel-bg: #242424; --modal-bg: rgba(20, 20, 20, 0.85);
            --text-color: #e0e0e0; --secondary-text-color: #9e9e9e; --accent-color: #3d82f0;
            --danger-color: #e53935; --online-color: #43a047; --primary-border-color: #3a3a3a;
            --hover-bg: #333333; --input-bg: #2c2c2c; --font-primary: 'Be Vietnam Pro', sans-serif;
            --shadow: 0 4px 12px rgba(0,0,0,.2); --transition-speed: 0.3s;
        }
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: var(--bg-color); color: var(--text-color); font-family: var(--font-primary); }
        button, input, a, li { cursor: pointer; }
        button { background-color: var(--accent-color); color: white; border: none; border-radius: 8px; padding: 10px 15px; font: 500 15px var(--font-primary); transition: background-color var(--transition-speed), transform 0.1s; }
        button:hover { background-color: #4a90e2; }
        button:active { transform: scale(0.98); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #c62828; }
        input[type="text"], input[type="password"] { width: 100%; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--primary-border-color); border-radius: 8px; padding: 12px; font-family: inherit; font-size: 15px; margin-bottom: 10px; }
        input:focus { border-color: var(--accent-color); outline: none; }
        hr { border: 0; border-top: 1px solid var(--primary-border-color); margin: 25px 0; }
        .view { display: none; width: 100%; height: 100%; overflow: hidden; flex-direction: column; }
        .view.active { display: flex; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Main Layout */
        #main-app-view { flex-direction: column; }
        .app-container { display: flex; width: 100%; height: 100%; }
        #main-nav { display: flex; flex-direction: column; align-items: center; background: var(--panel-bg); padding: 10px 0; border-right: 1px solid var(--primary-border-color); z-index: 10; }
        .nav-btn { background: none; border: none; color: var(--secondary-text-color); padding: 15px; width: 60px; height: 60px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; transition: all var(--transition-speed); position: relative; }
        .nav-btn.active, .nav-btn:hover { color: white; background: var(--nav-btn.active-bg, var(--hover-bg)); }
        .nav-btn.active { --nav-btn.active-bg: var(--accent-color); }
        .nav-btn svg { width: 28px; height: 28px; }

        /* Content Pages & Left Panel */
        #content-container { flex-grow: 1; display: flex; position: relative; overflow: hidden; }
        .content-page { display: none; animation: fadeIn 0.3s; } 
        .content-page.active { display: flex; width: 100%; height: 100%; flex-direction: row;}
        #left-panel { width: 340px; border-right: 1px solid var(--primary-border-color); display: flex; flex-direction: column; flex-shrink: 0; background: var(--panel-bg); }
        #panel-header { padding: 20px; border-bottom: 1px solid var(--primary-border-color); display: flex; justify-content: space-between; align-items: center; }
        #panel-header h4 { margin: 0; font-size: 20px; }
        #panel-header-actions button { background: none; border: 1px solid var(--primary-border-color); border-radius: 50%; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; font-size: 24px; padding: 0; color: white;}
        .tab-controls { display: flex; border-bottom: 1px solid var(--primary-border-color); }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: var(--secondary-text-color); border-bottom: 3px solid transparent; font: 500 15px var(--font-primary); }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        .item-list { flex-grow: 1; overflow-y: auto; list-style: none; margin: 0; padding: 10px; display: none; }
        .item-list.active { display: block; }
        .item-list li { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; transition: background .2s; }
        .item-list li.active, .item-list li:hover { background: var(--hover-bg); }
        .info { flex-grow: 1; overflow: hidden; }
        .username { font-weight: 500; }
        .last-message { font-size: .9em; color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .item-list li.unread .username { color: var(--accent-color); font-weight: 700; }

        /* Other Pages (Discover, Requests, Settings) */
        .page-container { width: 100%; height: 100%; padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .page-content { background: var(--panel-bg); padding: 30px; border-radius: 8px; width: 100%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        label { display:block; margin-bottom:5px; color:var(--secondary-text-color); }
        
        /* Chat UI */
        .chat-container { flex-grow: 1; display: none; flex-direction: column; background: var(--bg-color); }
        #chat-header { padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--primary-border-color); flex-shrink: 0; background: var(--panel-bg); }
        #chat-header-info { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        .chat-header-menu { display: flex; align-items: center; gap: 5px; }
        .chat-header-menu button { background: none; border: none; color: var(--secondary-text-color); padding: 8px; border-radius: 50%; width: 40px; height: 40px; }
        .chat-header-menu button:hover { background: var(--hover-bg); color: var(--text-color); }
        #chat-messages-wrapper { flex-grow: 1; overflow-y: auto; padding: 0 20px; display: flex; flex-direction: column-reverse; }
        #chat-messages { display: flex; flex-direction: column; gap: 4px; padding: 10px 0; }
        .message-bubble { padding: 10px 16px; border-radius: 20px; max-width: 70%; width: fit-content; animation: slideIn .3s ease-out; position: relative; word-wrap: break-word;}
        .message-bubble.mine { background-color: var(--accent-color); color: white; align-self: flex-end; }
        .message-bubble.other { background-color: var(--hover-bg); align-self: flex-start; }
        .message-timestamp { font-size: .75em; color: var(--secondary-text-color); margin-top: 5px; text-align: right; }
        .message-bubble.mine .message-timestamp { color: rgba(255,255,255,.7); }
        .message-sender-name { font-size: 0.85em; font-weight: bold; color: var(--accent-color); margin-bottom: 4px; }
        .message-bubble img, .message-bubble .map-preview img { max-width: 300px; border-radius: 10px; margin-top: 5px; display: block; }
        .mention-self { background-color: rgba(255, 215, 0, 0.4); padding: 1px 4px; border-radius: 4px; color: white;}
        .sys-message { align-self: center; text-align: center; color: var(--secondary-text-color); font-size: 0.8em; padding: 5px 12px; margin: 10px 0; background: var(--hover-bg); border-radius: 12px; }

        #chat-input-area { padding: 15px; border-top: 1px solid var(--primary-border-color); background: var(--panel-bg); flex-shrink: 0; position: relative; }
        #chat-input { display: flex; gap: 10px; align-items: center;}
        #chat-input-buttons { display:flex; gap: 5px;}
        #chat-input-buttons button { background: none; border: none; color: var(--secondary-text-color); padding: 8px; transition: color 0.2s; }
        #chat-input-buttons button:hover { color: var(--accent-color); }
        #mention-list-container { display: none; position: absolute; bottom: 85px; left: 15px; right: 15px; background: #2f2f2f; border: 1px solid var(--primary-border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow); }
        .mention-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; }
        .mention-item:hover { background-color: var(--hover-bg); }
        .user-item { width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; object-fit: cover; }

        /* Login & Call UI */
        #login-view { justify-content: center; align-items: center; padding: 15px; }
        .auth-container { width: 100%; max-width: 400px; }
        .auth-form { background: var(--panel-bg); border: 1px solid var(--primary-border-color); padding: 30px; border-radius: 12px; }
        .auth-form h2 { color: var(--accent-color); text-align: center; margin-bottom: 25px; }
        #call-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; flex-direction: column; animation: fadeIn 0.3s; }
        #call-videos { width: 100%; height: 100%; position: relative; }
        #remote-video-container, #local-video-container { position: absolute; background: #000; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        #remote-video-container { top:0; left:0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #remote-video-container video, #local-video-container video { width: 100%; height: 100%; object-fit: cover; }
        #local-video-container { bottom: 100px; right: 20px; width: 200px; height: 150px; border: 2px solid var(--accent-color); }
        #call-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; }
        #call-controls button { width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; padding: 0; }
        #call-controls svg { width: 24px; height: 24px;}
        #call-in-chat-notification { display: none; padding: 12px; background-color: var(--online-color); margin: 10px 0; border-radius: 8px; text-align: center; animation: fadeIn 0.5s; align-items: center; justify-content: center; gap: 15px; }
        .modal { position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--panel-bg); padding: 25px; border: 1px solid var(--primary-border-color); width: 90%; max-width: 500px; border-radius: 12px; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; padding-bottom: 60px; }
            #main-nav { position: fixed; bottom: 0; width: 100%; flex-direction: row; justify-content: space-around; border-top: 1px solid var(--primary-border-color); border-right: none;}
            #left-panel, .chat-container { position: fixed; top: 0; left: 0; width: 100%; height: calc(100% - 60px); transition: transform 0.3s ease-in-out; }
            #left-panel { transform: translateX(-100%); z-index: 2; }
            #left-panel.active { transform: translateX(0); }
            .chat-container { transform: translateX(100%); z-index: 3; }
            .chat-container.active { transform: translateX(0); }
            #back-to-list-btn { display: flex !important; }
        }
    </style>
</head>
<body>

    <div id="call-container">
        <div id="call-videos"><div id="remote-video-container"></div><div id="local-video-container"></div></div>
        <div id="call-controls">
            <button id="pip-btn" title="Hình trong hình" class="btn-secondary"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"></path></svg></button>
            <button id="end-call-btn" class="btn-danger" title="Kết thúc"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M23.64 17.37c-.33-.35-1.03-.54-1.52-.31l-2.12.87c-.52.21-.86.72-.86 1.29v2.13c-2.43-.8-4.66-2.02-6.59-3.57-2-1.58-3.7-3.41-4.92-5.49-.6-1.04-.9-2.14-.9-3.25 0-.58.47-1.05 1.05-1.05h3.08c.47 0 .88.32 1.01.76l.72 2.5c.16.58-.02 1.23-.42 1.63L9.7 13.01c.64 1.12 1.43 2.15 2.42 3.06 1 .92 2.05 1.7 3.23 2.31l2.09-1.92c.38-.37.95-.51 1.48-.32l2.36.87c.48.18.78.65.78 1.15v2.01c0 .48-.36.9-.84.99z" transform="scale(0.8) translate(2,4)"/></svg></button>
        </div>
    </div>
    
    <div id="login-view" class="view">
        <div class="auth-container">
            <div class="auth-form">
                <h2>Đăng Nhập / Đăng Ký</h2>
                <div class="form-group"><input type="text" id="reg-displayname" placeholder="Tên hiển thị"><input type="text" id="reg-username" placeholder="Tên đăng nhập (chữ thường, số, _)" autocomplete="username"><input type="password" id="reg-password" placeholder="Mật khẩu (ít nhất 6 ký tự)" autocomplete="new-password"><button id="register-btn">Tạo Tài Khoản</button></div>
                <hr><div class="form-group"><input type="text" id="login-username" placeholder="Tên đăng nhập" autocomplete="username"><input type="password" id="login-password" placeholder="Mật khẩu" autocomplete="current-password"><button id="login-btn">Đăng Nhập</button></div>
            </div>
        </div>
    </div>

    <div id="main-app-view" class="view">
        <div class="app-container">
            <nav id="main-nav">
                 <button class="nav-btn active" data-page="friends-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></button>
                 <button class="nav-btn" data-page="discover-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
                 <button class="nav-btn" data-page="requests-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
                 <button class="nav-btn" data-page="settings-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22-.07-.49-.12-.64l-2.11-1.65z"/></svg></button>
            </nav>
            <main id="content-container">
                 <section id="friends-view" class="content-page active">
                     <div id="left-panel">
                        <div id="panel-header"><h4>Trò chuyện</h4><div id="panel-header-actions"><button id="create-group-btn" title="Tạo nhóm">+</button></div></div>
                        <div class="tab-controls"><button class="tab-btn active" data-tab="friends-list">Bạn bè</button><button class="tab-btn" data-tab="groups-list">Nhóm</button></div>
                        <ul id="friends-list" class="item-list active"><li>Đang tải...</li></ul><ul id="groups-list" class="item-list"></ul>
                     </div>
                 </section>
                <section id="discover-view" class="content-page"><div class="page-container"><h2>Khám Phá</h2><div class="page-content"><input id="search-input" type="text" placeholder="Tìm bằng username..."/><div id="search-results-list" class="item-list" style="display:block;"></div></div></div></section>
                <section id="requests-view" class="content-page"><div class="page-container"><h2>Yêu cầu kết bạn</h2><div class="page-content"><ul id="friend-requests-list" class="item-list" style="display:block;"></ul></div></div></section>
                <section id="settings-view" class="content-page"><div class="page-container"><div class="page-content"><h2>Cài đặt</h2><button id="logout-btn" class="btn-danger">Đăng Xuất</button></div></div></section>
                 
                <div id="chat-container" class="chat-container">
                    <div id="chat-header">
                        <button id="back-to-list-btn" style="display: none; background:none; border:none; color:white; padding-right:10px;"><svg fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button>
                        <div id="chat-header-info"></div>
                        <div class="chat-header-menu">
                            <button id="start-voice-call-btn" title="Gọi thoại"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"/></svg></button>
                            <button id="start-video-call-btn" title="Gọi video"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
                        </div>
                    </div>
                    <div id="chat-messages-wrapper">
                         <div id="call-in-chat-notification"><p></p><button id="join-call-btn">Tham Gia</button></div>
                         <div id="chat-messages"></div>
                    </div>
                    <div id="chat-input-area">
                         <div id="mention-list-container"></div>
                         <div id="chat-input">
                            <div id="chat-input-buttons">
                                <button id="upload-image-btn" title="Ảnh"><svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M21.58 16.09l-1.09-1.09a2 2 0 0 0-2.83 0L14 18.66l-1.41-1.42a2 2 0 0 0-2.83 0L2.42 24.58A2 2 0 0 0 4 28a2 2 0 0 0 1.41-.59L21.41 10.09a2 2 0 0 0 0-2.83l-1.09-1.09a2 2 0 0 0-2.83 0L4.09 17.58A2 2 0 0 0 3 18.17V26h7.83a2 2 0 0 0 .59-.09l12.58-12.58a2 2 0 0 0 0-2.83z" transform="translate(-2 -4)"/></svg></button>
                                <button id="share-location-btn" title="Vị trí"><svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></button>
                            </div>
                            <input id="message-input" type="text" placeholder="Nhập tin nhắn..." autocomplete="off"/><button id="send-btn">Gửi</button>
                         </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="toast-container" style="position:fixed; bottom:20px; right:20px; z-index:100001;"></div>

    <script>
        // === CONFIGURATION ===
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
        };
        const CLOUDINARY_CLOUD_NAME = 'dgbux4wzo';
        const CLOUDINARY_UPLOAD_PRESET = 'okeqfdx4';
        const AGORA_APP_ID = 'a0b62867bee543fe828e23b4888eb3ae';
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

        // === INITIALIZATION ===
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.database();
        
        let currentUser = null, currentChat = null;
        let msgListener = null, callStatusListener = null;
        let agoraClient = null, localTracks = { audio: null, video: null }, activeCallInfo = { isActive: false, channel: null };
        let userCache = {}; 
        let isMobile = window.innerWidth <= 768;

        // === CORE APP LOGIC ===
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => { 
                user ? db.ref(`accounts/${user.uid}`).once('value', s => s.exists() ? (currentUser = { uid: user.uid, ...s.val() }, initializeApp()) : auth.signOut()) : showView('login-view');
            });
            document.getElementById('register-btn').addEventListener('click', registerUser);
            document.getElementById('login-btn').addEventListener('click', loginUser);
        });

        function initializeApp() {
            showView('main-app-view');
            document.getElementById('left-panel').classList.add('active');
            document.getElementById('chat-container').style.display = 'flex'; // Keep it in DOM for responsive layout
            initializeAgora();
            setupEventListeners();
            listenForFriends();
            listenForFriendRequests();
        }

        function setupEventListeners() {
            const el = id => document.getElementById(id);
            el('send-btn').addEventListener('click', sendMessage);
            el('message-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
            el('message-input').addEventListener('input', handleMentionInput);
            el('upload-image-btn').addEventListener('click', () => currentChat ? cloudinaryWidget.open() : showToast("Vui lòng chọn cuộc trò chuyện."));
            el('share-location-btn').addEventListener('click', shareLocation);
            el('start-video-call-btn').addEventListener('click', () => startCall('video'));
            el('start-voice-call-btn').addEventListener('click', () => startCall('voice'));
            el('end-call-btn').addEventListener('click', endCall);
            el('pip-btn').addEventListener('click', togglePictureInPicture);
            el('logout-btn').addEventListener('click', () => auth.signOut());
            el('search-input').addEventListener('input', e => performSearch(e.target.value));
            
            if (isMobile) {
                el('back-to-list-btn').addEventListener('click', () => {
                    el('chat-container').classList.remove('active');
                    el('left-panel').classList.add('active');
                });
            }
            setupNavigation();
            setupTabs();
        }

        // === AUTHENTICATION & USER MANAGEMENT ===
        function registerUser(){const d=document.getElementById("reg-displayname").value.trim(),e=document.getElementById("reg-username").value.trim().toLowerCase(),t=document.getElementById("reg-password").value;if(!d||!e||!t)return showToast("Vui lòng điền đủ thông tin.","error");if(!/^[a-z0-9_]+$/.test(e))return showToast("Tên đăng nhập không hợp lệ.","error");if(t.length<6)return showToast("Mật khẩu phải > 6 ký tự.","error");const o=`${e}@chat.app`;db.ref("accounts").orderByChild("username").equalTo(e).once("value",r=>{if(r.exists())return showToast("Tên đăng nhập đã tồn tại!","error");auth.createUserWithEmailAndPassword(o,t).then(userCred=>{db.ref(`accounts/${userCred.user.uid}`).set({username:e,displayName:d,email:o,profilePicture:"https://i.imgur.com/sC0zt4c.png"}).then(()=>showToast("Đăng ký thành công!"))}).catch(e=>showToast(`Lỗi: ${e.code}`,"error"))})}
        function loginUser(){const e=document.getElementById("login-username").value.trim().toLowerCase(),t=document.getElementById("login-password").value;if(!e||!t)return;db.ref("accounts").orderByChild("username").equalTo(e).once("value",a=>{if(!a.exists())return showToast("Tên đăng nhập không tồn tại!","error");const o=Object.values(a.val())[0];auth.signInWithEmailAndPassword(o.email,t).catch(e=>showToast("Sai mật khẩu!","error"))})}

        // === UI & NAVIGATION ===
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        function setupNavigation() { document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => { const pageId = btn.dataset.page; document.querySelectorAll('.content-page, .nav-btn').forEach(el => el.classList.remove('active')); document.getElementById(pageId).classList.add('active'); btn.classList.add('active'); }))}
        function setupTabs() { document.querySelectorAll('.tab-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.tab-btn, .item-list').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active'); })})}
        async function getUserData(uid) { if (userCache[uid]) return userCache[uid]; try {const s=await db.ref(`accounts/${uid}`).once('value'); if(s.exists()){userCache[uid]={uid,...s.val()}; return userCache[uid]}}catch(e){} return null; }

        // === DATA LISTENERS ===
        function listenForFriends(){const listUI=document.getElementById("friends-list");db.ref(`friends/${currentUser.uid}`).orderByChild("timestamp").on("value",async s=>{listUI.innerHTML="";if(!s.exists())return listUI.innerHTML="<li>Chưa có bạn bè.</li>";const friends=[];s.forEach(c=>friends.push({uid:c.key,...c.val()}));for(const f of friends.reverse()){const friendData=await getUserData(f.uid);if(friendData){const li=document.createElement("li");li.id=`friend-${f.uid}`;if(f.unread)li.classList.add('unread');li.innerHTML=`<img src="${friendData.profilePicture}"class="user-item"><div class="info"><span class="username">${friendData.displayName}</span><span class="last-message">${f.lastMessage||""}</span></div>`;li.onclick=()=>startPrivateChat(f.uid,friendData);listUI.appendChild(li)}}})}
        function listenForFriendRequests(){const listUI=document.getElementById("friend-requests-list");db.ref(`friend_requests/${currentUser.uid}`).on("value",async s=>{listUI.innerHTML="";if(!s.exists())return listUI.innerHTML="<li>Không có lời mời nào.</li>";for(const key in s.val()){const senderData=await getUserData(key);if(senderData){const li=document.createElement("li");li.innerHTML=`<img src="${senderData.profilePicture}"class="user-item"><div class="info"><span class="username">${senderData.displayName}</span></div> <button id="accept-${key}">✔</button><button id="decline-${key}" class="btn-danger">✖</button>`;listUI.appendChild(li);document.getElementById(`accept-${key}`).onclick=()=>acceptFriendRequest(key);document.getElementById(`decline-${key}`).onclick=()=>declineFriendRequest(key);}}})}
        function performSearch(query) { const listUI=document.getElementById('search-results-list'); listUI.innerHTML = ""; if (!query) return; db.ref("accounts").orderByChild("username").startAt(query).endAt(query + '\uf8ff').once("value", s => { if (!s.exists()) return listUI.innerHTML = "<li>Không tìm thấy.</li>"; s.forEach(c => { if(c.key === currentUser.uid) return; const user = c.val(); listUI.innerHTML += `<li class="user-item-entry"><img src="${user.profilePicture}" class="user-item"><div class="info"><span>${user.displayName}</span><small>@${user.username}</small></div><button onclick="sendFriendRequest('${c.key}')">Kết bạn</button></li>`; }); });}

        // === SOCIAL ACTIONS ===
        function acceptFriendRequest(uid){const u={};u[`friends/${currentUser.uid}/${uid}`]={timestamp:firebase.database.ServerValue.TIMESTAMP};u[`friends/${uid}/${currentUser.uid}`]={timestamp:firebase.database.ServerValue.TIMESTAMP};u[`friend_requests/${currentUser.uid}/${uid}`]=null;db.ref().update(u);showToast("Đã chấp nhận kết bạn!")}
        function declineFriendRequest(uid){db.ref(`friend_requests/${currentUser.uid}/${uid}`).remove();showToast("Đã từ chối kết bạn.")}
        function sendFriendRequest(uid){db.ref(`friend_requests/${uid}/${currentUser.uid}`).set({from:currentUser.uid}).then(()=>showToast("Đã gửi yêu cầu!"))}

        // === CHAT CORE ===
        function startPrivateChat(partnerUid, partnerData) {
            currentChat = { type: 'private', uid: partnerUid, data: partnerData };
            const chatContainer = document.getElementById('chat-container');
            chatContainer.classList.add('active');
            if (isMobile) document.getElementById('left-panel').classList.remove('active');

            document.querySelector('#chat-header-info').innerHTML = `<img src="${partnerData.profilePicture}" class="user-item"><div><strong>${partnerData.displayName}</strong><br><small>@${partnerData.username}</small></div>`; 
            
            const chatRoomId = currentUser.uid < partnerUid ? `${currentUser.uid}_${partnerUid}` : `${partnerUid}_${currentUser.uid}`;
            const chatRoomRef = db.ref(`private_chats/${chatRoomId}`);
            
            if(callStatusListener) callStatusListener.off();
            callStatusListener = chatRoomRef.child('active_call');
            callStatusListener.on('value', async s => {
                const callUI = document.getElementById('call-in-chat-notification');
                if (s.exists() && s.val().active) {
                    const initiatorData = await getUserData(s.val().initiatorId);
                    callUI.style.display = 'flex'; callUI.querySelector('p').textContent = `${initiatorData.displayName} đã bắt đầu cuộc gọi.`;
                    document.getElementById('join-call-btn').onclick = () => joinCall(s.val().type);
                } else { callUI.style.display = 'none'; }
            });

            setupChatListeners(chatRoomRef.child('messages'));
            document.querySelectorAll('#friends-list li.active').forEach(li => li.classList.remove('active'));
            document.getElementById(`friend-${partnerUid}`)?.classList.add('active');
        }

        function setupChatListeners(chatRef) {
             if(msgListener) msgListener.off();
             const messagesUI = document.getElementById('chat-messages'); messagesUI.innerHTML = '';
             let initialDataLoaded = false;
             chatRef.orderByKey().limitToLast(50).once('value', snapshot => {
                 snapshot.forEach(child => { renderMessage({key: child.key, ...child.val()}); });
                 initialDataLoaded = true;
                 msgListener = chatRef.orderByKey().startAt(snapshot.docs ? snapshot.docs[snapshot.docs.length-1]?.key : null); // Roughly
                 msgListener.on('child_added', s => { if (initialDataLoaded && !document.getElementById(`msg-${s.key}`)) renderMessage({ key: s.key, ...s.val() }, true); });
             });
        }
        
        async function renderMessage(msg, isNew=false) { const bubble = await createMessageBubble(msg); if (bubble) document.getElementById('chat-messages')[isNew ? 'appendChild' : 'prepend'](bubble); }
        async function createMessageBubble(msg) { /* ... Logic from previous full file goes here ... */ } // Placeholder to show it exists

        function sendMessage(){const text=document.getElementById("message-input").value.trim();if(!text||!currentChat)return;sendChatMessage({text});document.getElementById("message-input").value=""}
        function sendChatMessage(content,createLastMsg=true){const msgData={...content,senderId:currentUser.uid,timestamp:firebase.database.ServerValue.TIMESTAMP};const updates={};if(currentChat.type==='private'){const chatRoomId=currentUser.uid<currentChat.uid?`${currentUser.uid}_${currentChat.uid}`:`${currentChat.uid}_${currentUser.uid}`;const msgKey=db.ref(`private_chats/${chatRoomId}/messages`).push().key;updates[`private_chats/${chatRoomId}/messages/${msgKey}`]=msgData;if(createLastMsg){const p=msgData.text?msgData.text:msgData.imageUrl?"[Hình ảnh]":"[Vị trí]";updates[`friends/${currentUser.uid}/${currentChat.uid}/lastMessage`]=p;updates[`friends/${currentChat.uid}/${currentUser.uid}/lastMessage`]=p;updates[`friends/${currentUser.uid}/${currentChat.uid}/timestamp`]=msgData.timestamp;updates[`friends/${currentChat.uid}/${currentUser.uid}/timestamp`]=msgData.timestamp;}}db.ref().update(updates)}

        // === NEW FEATURES ===
        function handleMentionInput() { /* Mention logic placeholder */ }
        function shareLocation(){navigator.geolocation.getCurrentPosition(pos=>sendChatMessage({location:{lat:pos.coords.latitude,lng:pos.coords.longitude}}),()=>showToast("Không thể lấy vị trí.","error"))}

        function initializeAgora(){agoraClient=AgoraRTC.createClient({mode:'rtc',codec:'vp8'});agoraClient.on('user-published',async(user,mediaType)=>{await agoraClient.subscribe(user,mediaType);if(mediaType==='video')user.videoTrack.play('remote-video-container');if(mediaType==='audio')user.audioTrack.play()});agoraClient.on('user-left',()=>{document.getElementById('remote-video-container').innerHTML='';showToast('Người kia đã rời đi.');endCall(false)})}
        async function startCall(callType){if(!currentChat||activeCallInfo.isActive)return;const channel=currentUser.uid<currentChat.uid?`${currentUser.uid}_${currentChat.uid}`:`${currentChat.uid}_${currentUser.uid}`;activeCallInfo.channel=channel;await agoraClient.join(AGORA_APP_ID,channel,null,currentUser.uid);if(callType==='video'){[localTracks.audio,localTracks.video]=await AgoraRTC.createMicrophoneAndCameraTracks();localTracks.video.play('local-video-container')}else{localTracks.audio=await AgoraRTC.createMicrophoneAudioTrack()}await agoraClient.publish(Object.values(localTracks).filter(Boolean));document.getElementById('call-container').style.display='flex';activeCallInfo.isActive=true;db.ref(`private_chats/${channel}/active_call`).set({active:true,type:callType,initiatorId:currentUser.uid})}
        async function joinCall(callType){if(activeCallInfo.isActive)return;await startCall(callType)}
        async function endCall(notifyDB=true){if(!activeCallInfo.isActive)return;if(notifyDB)db.ref(`private_chats/${activeCallInfo.channel}/active_call`).remove();Object.values(localTracks).forEach(t=>{if(t){t.stop();t.close()}});localTracks={audio:null,video:null};await agoraClient.leave();document.getElementById('call-container').style.display='none';if(document.pictureInPictureElement)document.exitPictureInPicture();activeCallInfo={isActive:false,channel:null}}
        async function togglePictureInPicture(){const v=document.querySelector('#remote-video-container video');if(!v)return;try{document.pictureInPictureElement?await document.exitPictureInPicture():await v.requestPictureInPicture()}catch(e){console.error("PiP Error:",e)}}

        // === UTILITIES ===
        const cloudinaryWidget=cloudinary.createUploadWidget({cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,sources:["local","url"]}, (err,res)=>{if(!err&&res&&res.event==="success"){sendChatMessage({imageUrl:res.info.secure_url})}});
        function showToast(message,type='success'){const c=document.getElementById('toast-container'),t=document.createElement('div');t.style.cssText=`background:${type==='error'?'var(--danger-color)':'#4caf50'};color:white;padding:15px;border-radius:8px;margin-top:10px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);animation:toastIn .5s forwards;`;t.innerHTML=message;c.appendChild(t);setTimeout(()=>{t.style.animation='toastOut .5s forwards';t.addEventListener('animationend',()=>t.remove())},3000)}
        if(!document.getElementById('toast-styles')){document.head.insertAdjacentHTML("beforeend",`<style id="toast-styles">@keyframes toastIn{to{opacity:1;transform:translateX(0)}}@keyframes toastOut{to{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}</style>`)}

    </script>
</body>
</html>
