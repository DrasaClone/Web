<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chat</title>
    
    <!-- SDKs & Fonts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root, body.theme-hacker {--bg-color:#0d0d0d;--panel-bg:#121212;--modal-bg:rgba(18,18,18,.9);--text-color:#00ff41;--accent-color:#afff9c;--secondary-text-color:#aaa;--primary-border-color:#2a2a2a;--hover-bg:#222;--active-bg:#00ff41;--active-text-color:#0d0d0d;--font-primary:'Share Tech Mono',monospace;--text-shadow:0 0 3px var(--text-color);--shadow:0 4px 6px rgba(0,0,0,.1)}
        body.theme-light {--bg-color:#f4f5f7;--panel-bg:#fff;--modal-bg:rgba(255,255,255,.9);--text-color:#333;--accent-color:#007bff;--secondary-text-color:#6c757d;--primary-border-color:#e9ecef;--hover-bg:#e9ecef;--active-bg:#007bff;--active-text-color:#fff;--font-primary:"Dosis",cursive;--text-shadow:none;--shadow:0 4px 6px rgba(0,0,0,.05);--bubble-mine-bg:#007bff;--bubble-other-bg:#e9ecef;color:#333}
        /* Hiệu ứng nền & loading */
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#0d0d0d;display:flex;justify-content:center;align-items:center;z-index:99999;transition:opacity .75s ease-out}#loading-overlay.hidden{opacity:0;pointer-events:none}@keyframes rgb-flow{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}#permanent-rgb-border{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none;opacity:.75}.rgb-border{position:absolute;background:linear-gradient(90deg,#ff0000,#ff7300,#fffb00,#48ff00,#00ffd5,#002bff,#7a00ff,#ff00c8,#ff0000);background-size:200% auto;animation:rgb-flow 3s linear infinite;filter:blur(15px)}.rgb-border.top{top:-10px;left:0;width:100%;height:30px}.rgb-border.right{top:0;right:-10px;width:30px;height:100%}.rgb-border.bottom{bottom:-10px;left:0;width:100%;height:30px}.rgb-border.left{top:0;left:-10px;width:30px;height:100%}@keyframes rotate-sphere{from{transform:rotateY(0deg) rotateX(20deg)}to{transform:rotateY(360deg) rotateX(20deg)}}.sphere-container{perspective:800px}.sphere{width:200px;height:200px;position:relative;transform-style:preserve-3d;animation:rotate-sphere 12s linear infinite}.ring{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid #00ff41;box-shadow:0 0 10px #00ff41,inset 0 0 10px #00ff41}.ring:nth-child(1){transform:rotateY(0deg)}.ring:nth-child(2){transform:rotateY(30deg)}.ring:nth-child(3){transform:rotateY(60deg)}.ring:nth-child(4){transform:rotateY(90deg)}.ring:nth-child(5){transform:rotateY(120deg)}.ring:nth-child(6){transform:rotateY(150deg)}
        /* CON TRỎ CHUỘT TÙY CHỈNH */
        body, a, button, input { cursor: none; }
        .cat-cursor{position:fixed;z-index:100000;pointer-events:none;transform:translate(-50%,-50%);width:50px;height:50px;background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Ik00IDExLjVDNCA3LjA0Mzk2IDcuNTgzNzkgMy41IDIgOC41IDMuNSA4IDMuNSAyMCAxNi41QzIxLjA0ODcgMy41IDI0LjUgMy41IDI0LjUgOC41QzI0LjUgMTIgMjEuMDQ4NyAxNi41IDE2LjUgMTYuNUMxMi44OTU0IDE2LjUgMTIuMjk3OCAxNS4wOTE1IDggMTUuMzkxNUgxNkM4IDE1LjM5MTUgOC4xMDQ1NyAxNi41IDQuNSAxNi41QzIuODcxMjYgMTYuNSAwIDE1LjQwNTIgMCAxMy4yNVYxMi41WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTkuNSAxMC41QzkuNSAxMC43NzYxIDkuMjU5MzkgMTEgOC45OTM5MiAxMUM4LjcyODQ2IDExIDguNSA5Ljc3NjE0IDguNSA5LjVDOC41IDkuMjIzODYgOC43Mjg0NiA5IDguOTkzOTIgOUM5LjI1OTM5IDkgOS41IDkuMjIzODYgOS45IDEwLjVaIiBmaWxsPSJibGFjayIvPgo8cGF0aCBkPSJNMTUuNSAxMC41QzE1LjUgMTAuNzc2MSAxNS4yNTkzIDExIDE0Ljk5MzkgMTFDMTQuNzI4NSAxMSAxNC41IDkuNzc2MTQgMTQuNSA5LjVDMTQuNSA5LjMjMzg2IDE0LjcyODUgOSAxNC45OTM5IDlDMTUuMjU5MyA5IDE1LjUgOS4yMjM4NiAxNS41IDEwLjVaIiBmaWxsPSJibGFjayIvPgo8cGF0aCBkPSJNMTAuOTk3MSAxMi45MDY2QzExLjU0OTUgMTMuMzA2MiAxMi40NDg4IDEzLjMwNjIgMTIuOTk0NyAxMi45MDY2Ii8+CjwvZz4KPC9zdmc+Cg==');background-size:contain;background-repeat:no-repeat;transition:transform .2s ease,background-image .2s ease,width .2s ease,height .2s ease}
        .cat-cursor.pointer-active{width:35px;height:35px;transform:translate(-40%,-40%);background-image:url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgc3Ryb2tlPSJibGFjayIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxwYXRoIGQ9Ik05IDE4QzEwLjY1NjkgMTggMTIgMTYuNjU2OSAxMiAxNUMxMiAxMy4zNDMxIDEwLjY1NjkgMTIgOSAxMkw2IDEyQzQuMzQzMTUgMTIgMyAxMy4zNDMxIDMgMTVDMyAxNi42NTY5IDQuMzQzMTUgMTggNiAxOEg5WiIgZmlsbD0id2hpdGUiLz4KPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTggNCkiPgo8cGF0aCBkPSJNMSA1QzEuODI4NDMgNSA1IDEuODI4NDMgNSA2QzIuODczNjcgNi40NjU4NCAxLjUgNS41IDIgN0MzLjUgOS41IDIgOSA1IDEyQzguNSA5LjUgOC41IDUuNSA4LjUgNC41QzguNSA0IDggMS4yNDAyOCA0IDEuMjQwMjhDMSAxLjI0MDI4IDAgMy4yODQyNyAwIDVDMCA2LjY1Njg1IDEuMzQzMTUgOCAzIDhDNS41IDggNS41IDUgNS41IDQuNUM1LjUgMy41IDMuNSAxIDMgMVoiIGZpbGw9IndoaXRlIi8+CjwvZz4KPGNpcmNsZSBjeD0iNiIgb3BhY2l0eT0iMCIgY3k9IjQiIHI9IjIiIGZpbGw9ImJsYWNrIi8+CjxwYXRoIGQ9Ik0xOCAxMEMxOS4xMDQ2IDEwIDIwIDkuMTA0NTcgMjAgOEMyMCA2Ljg5NTQzIDE5LjEwNDYgNiAxOCA2QzE2Ljg5NTQgNiAxNiA2Ljg5NTQzIDE2IDhDMTYgOS4xMDQ1NyAxNi44OTU0IDEwIDE4IDEwWiIgZmlsbD0id2hpdGUiLz4KPC9nPgo8L3N2Zz4K')}
        /* GIAO DIỆN CỐT LÕI */
        *{box-sizing:border-box}body{margin:0;padding:0;height:100vh;overflow:hidden;background:var(--bg-color);color:var(--text-color);font-family:var(--font-primary);text-shadow:var(--text-shadow);transition:background .3s ease,color .3s ease}.view{display:none;width:100%;height:100%;overflow:hidden;flex-direction:column}.view.active{display:flex}
        #main-app-view{flex-direction:column}.app-container{display:flex;width:100%;height:100%}#main-nav{display:flex;flex-direction:column;align-items:center;background:var(--panel-bg);padding:10px 0;border-right:1px solid var(--primary-border-color)}.nav-btn{background:none;border:none;color:var(--secondary-text-color);cursor:pointer;padding:15px;width:60px;height:60px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:center;align-items:center;transition:all .2s}.nav-btn.active,.nav-btn:hover{color:var(--active-text-color);background:var(--active-bg)}.nav-btn svg{width:24px;height:24px}#content-container{flex-grow:1;display:flex}
        .content-page{display:none;width:100%;height:100%;animation:fadeIn .3s}.content-page.active{display:flex}#left-panel{width:320px;border-right:1px solid var(--primary-border-color);display:flex;flex-direction:column;flex-shrink:0}#panel-header{padding:15px;border-bottom:1px solid var(--primary-border-color);flex-shrink:0}#panel-header h4{margin:0}.item-list{flex-grow:1;overflow-y:auto;list-style:none;padding:10px}.item-list li{display:flex;align-items:center;gap:10px;padding:10px;cursor:pointer;border-radius:4px;transition:background .2s}.item-list li.active,.item-list li:hover{background:var(--hover-bg)}.info{display:flex;flex-direction:column;flex-grow:1;overflow:hidden}.username{font-weight:700}.last-message{font-size:.8em;color:var(--secondary-text-color);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}.item-list li.unread .username{color:var(--accent-color)}.item-list li.unread .last-message{color:var(--text-color);font-weight:700}
        #right-panel{flex-grow:1;display:flex;flex-direction:column}#chat-header{padding:10px 15px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--primary-border-color);flex-shrink:0}#chat-messages{flex-grow:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column-reverse}#chat-input{padding:15px;border-top:1px solid var(--primary-border-color);display:flex;gap:10px;flex-shrink:0}#message-input{flex-grow:1;padding:10px;background:var(--input-bg);border:1px solid var(--primary-border-color);color:var(--text-color);border-radius:8px;font-family:inherit}
        .user-item{width:40px;height:40px;border-radius:50%;flex-shrink:0;object-fit:cover}.status-online{border:2px solid var(--accent-color)}.status-offline{border:2px solid var(--secondary-text-color)}
        .message-bubble{padding:10px 15px;border-radius:18px;max-width:70%;margin-bottom:10px;width:fit-content;animation:slideIn .3s ease-out;position:relative}.message-bubble img{max-width:250px;border-radius:10px;margin-top:5px;display:block}.message-bubble.mine{background-color:var(--active-bg);color:var(--active-text-color);align-self:flex-end}.message-bubble.other{background-color:var(--hover-bg);align-self:flex-start}.message-timestamp{font-size:.7em;color:var(--secondary-text-color);margin-top:5px;align-self:flex-end}.message-bubble.mine .message-timestamp{color:rgba(255,255,255,.7)}
        @media (max-width:768px){#main-nav{position:fixed;bottom:0;left:0;right:0;width:100%;height:60px;flex-direction:row;justify-content:space-around;z-index:100;border-right:none;border-top:1px solid var(--primary-border-color)}.app-container{padding-bottom:60px}#friends-view.mobile-chat-active #left-panel{display:none}#friends-view.mobile-chat-active #right-panel{display:flex;width:100%}#right-panel{display:none}#left-panel{width:100%}#back-to-list-btn{display:block;background:none;border:none;color:var(--text-color);font-size:1.5em;padding:0 10px;}.nav-btn{margin:0}}
        .page-container{width:100%;padding:30px;display:flex;flex-direction:column;align-items:center;overflow-y:auto;}.page-content{background:var(--panel-bg);padding:30px;border-radius:8px;width:100%;max-width:500px}.form-group{margin-bottom:15px}label{display:block;margin-bottom:5px;color:var(--secondary-text-color)}
        #login-view{justify-content:center;align-items:center;padding:15px}.auth-container{width:100%;max-width:400px}.auth-form{background:var(--panel-bg);border:1px solid var(--primary-border-color);padding:30px;border-radius:8px}.auth-form h2{color:var(--accent-color);text-align:center}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    </style>
</head>
<body class="theme-hacker">
    <div class="cat-cursor"></div>
    <div id="permanent-rgb-border"><div class="rgb-border top"></div><div class="rgb-border right"></div><div class="rgb-border bottom"></div><div class="rgb-border left"></div></div>
    <div id="loading-overlay"><div class="sphere-container"><div class="sphere"><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div></div></div></div>
    
    <div id="login-view" class="view"><div class="auth-container"><div class="auth-form"><h2>Đăng Nhập/Đăng Ký</h2><div class="form-group"><input type="text" id="reg-displayname" placeholder="Tên hiển thị"><input type="text" id="reg-username" placeholder="Tên đăng nhập (viết liền)"><input type="password" id="reg-password" placeholder="Mật khẩu"><button id="register-btn">Tạo Tài Khoản Mới</button></div><hr style="border-color:var(--primary-border-color)"><div class="form-group" style="margin-top:20px"><input type="text" id="login-username" placeholder="Tên đăng nhập"><input type="password" id="login-password" placeholder="Mật khẩu"><button id="login-btn">Đăng Nhập</button></div></div></div></div>

    <div id="main-app-view" class="view">
        <div class="app-container">
            <nav id="main-nav">
                <button class="nav-btn active" data-page="friends-view" title="Trò chuyện"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg></button>
                <button class="nav-btn" data-page="search-view" title="Tìm kiếm"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></button>
                <button class="nav-btn" data-page="settings-view" title="Cài đặt"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg></button>
            </nav>
            <main id="content-container">
                <section id="friends-view" class="content-page"><div id="left-panel"><div id="panel-header"><h4>Cuộc trò chuyện</h4></div><ul id="friends-list" class="item-list"></ul></div><div id="right-panel"><div id="chat-header"><button id="back-to-list-btn" style="display:none">←</button><div id="chat-header-info"></div></div><div id="chat-messages"></div><div id="chat-input"><button id="upload-image-btn" style="width:auto;padding:0 12px;margin-right:5px;" title="Gửi ảnh"><svg viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M2.5 19.5c-.28 0-.53-.11-.71-.29-.18-.18-.29-.43-.29-.71V5.5c0-.28.11-.53.29-.71.18-.18.43-.29.71-.29h6.25l2.5 2.5h7.25c.28 0 .53.11.71.29.18.18.29.43.29.71v9c0 .28-.11.53-.29.71-.18.18-.43.29-.71.29H2.5z"/></svg></button><input id="message-input" type="text" placeholder="Nhập tin nhắn..."/><button id="send-btn" style="width:auto;padding:0 15px">Gửi</button></div></div></section>
                <section id="search-view" class="content-page"><div class="page-container"><div class="page-content"><h2>Tìm kiếm người dùng</h2><input id="search-input" type="text" placeholder="Nhập username để tìm..."/><div id="search-results-list" class="item-list" style="margin-top:20px"></div></div></div></section>
                <section id="settings-view" class="content-page"><div class="page-container"><div class="page-content"><h2>Cài đặt tài khoản</h2><div class="form-group"><label>Tên hiển thị</label><input id="settings-displayname" type="text"/><button id="save-displayname-btn">Lưu tên</button></div><hr style="border:0;border-top:1px solid var(--primary-border-color)"/><div class="form-group"><h4>Đổi mật khẩu</h4><input id="current-password" type="password" placeholder="Mật khẩu hiện tại"/><input id="new-password" type="password" placeholder="Mật khẩu mới"/><button id="change-password-btn">Đổi mật khẩu</button></div><hr style="border:0;border-top:1px solid var(--primary-border-color)"/><button id="logout-btn" style="background-color: #c0392b; color: white;">Đăng xuất</button></div></div></section>
            </main>
        </div>
    </div>

    <script>
        // === BƯỚC 1: CẤU HÌNH ===
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
        };
        const CLOUDINARY_CLOUD_NAME = 'dgbux4wzo';
        const CLOUDINARY_UPLOAD_PRESET = 'okeqfdx4';
        
        // --- KHỞI TẠO & BIẾN TOÀN CỤC ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.database();
        let currentUser = null, currentChatPartner = null;
        let messageListener = null;

        // --- CORE LOGIC & UI SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.classList.add('hidden');
            setTimeout(() => loadingOverlay.style.display = 'none', 750);

            auth.onAuthStateChanged(user => {
                if (user) {
                    db.ref(`accounts/${user.uid}`).once('value', s => {
                        if (s.exists()) {
                            currentUser = { uid: user.uid, ...s.val() };
                            initializeApp();
                        } else {
                            auth.signOut();
                        }
                    });
                } else {
                    currentUser = null;
                    showView('login-view');
                }
            });

            initCursor();
            document.getElementById('register-btn').addEventListener('click', registerUser);
            document.getElementById('login-btn').addEventListener('click', loginUser);
            document.querySelectorAll('#main-app-view #logout-btn, #settings-view #logout-btn').forEach(btn => btn.addEventListener('click', logoutUser));
        });

        const views = document.querySelectorAll('.view'); function showView(e) { views.forEach(v => v.classList.remove('active')); document.getElementById(e).classList.add('active') }

        function initializeApp() {
            showView('main-app-view');
            showContentPage('friends-view');
            document.querySelector('.nav-btn[data-page="friends-view"]').classList.add('active');

            setupNavigation();
            setupPresenceSystem();
            listenForFriends();

            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            searchInput.addEventListener('input', () => { const e = searchInput.value.trim().toLowerCase(); clearTimeout(searchTimeout); searchTimeout = setTimeout(() => performSearch(e), 300); });
            
            document.getElementById('send-btn').addEventListener('click', (e) => { e.preventDefault(); sendMessage(document.getElementById('message-input').value.trim()); });
            document.getElementById('upload-image-btn').addEventListener('click', () => { currentChatPartner ? cloudinaryWidget.open() : alert("Vui lòng chọn một cuộc trò chuyện."); });
            
            document.getElementById('settings-displayname').value = currentUser.displayName;
            document.getElementById('save-displayname-btn').addEventListener('click', () => { const newName = document.getElementById('settings-displayname').value.trim(); if (newName) db.ref(`accounts/${currentUser.uid}/displayName`).set(newName).then(() => { alert('Đã lưu tên hiển thị!'); currentUser.displayName = newName; }); });
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
            
            document.getElementById('back-to-list-btn').addEventListener('click', () => {
                document.getElementById('friends-view').classList.remove('mobile-chat-active');
                currentChatPartner = null;
                if(messageListener) messageListener.off();
            });

            updateClickableElements();
        }

        // --- ACCOUNT & AUTH ---
        function setupNavigation() { const navButtons = document.querySelectorAll('.nav-btn'); navButtons.forEach(btn => { btn.addEventListener('click', () => { const pageId = btn.dataset.page; showContentPage(pageId); navButtons.forEach(b => b.classList.remove('active')); btn.classList.add('active') }) }) }
        function showContentPage(pageId) { document.querySelectorAll('.content-page').forEach(page => page.classList.remove('active')); document.getElementById(pageId).classList.add('active') }
        function setupPresenceSystem() { const e = db.ref(`/accounts/${currentUser.uid}`); db.ref(".info/connected").on("value", t => { if (!1 === t.val()) return; e.onDisconnect().update({ status: "offline", lastOnline: firebase.database.ServerValue.TIMESTAMP }).then(() => e.update({ status: "online" })) }) }
        function registerUser(){const d=document.getElementById("reg-displayname").value.trim(),e=document.getElementById("reg-username").value.trim().toLowerCase(),t=document.getElementById("reg-password").value;if(!d||!e||!t)return alert("Vui lòng điền đủ thông tin.");if(!/^[a-z0-9_]+$/.test(e))return alert("Tên đăng nhập chỉ hợp lệ với chữ thường, số, và gạch dưới.");const o=`${e}@yourapp.com`;db.ref("accounts").orderByChild("username").equalTo(e).once("value",r=>{if(r.exists())return alert("Tên đăng nhập đã tồn tại!");auth.createUserWithEmailAndPassword(o,t).then(t=>{db.ref(`accounts/${t.user.uid}`).set({username:e,displayName:d,email:o,profilePicture:"https://i.imgur.com/sC0zt4c.png",status:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP}).then(()=>alert("Đăng ký thành công! Vui lòng đăng nhập."))}).catch(e=>alert(e.message))})}
        function loginUser(){const e=document.getElementById("login-username").value.trim().toLowerCase(),t=document.getElementById("login-password").value;if(!e||!t)return;db.ref("accounts").orderByChild("username").equalTo(e).once("value",a=>{if(!a.exists())return alert("Tên đăng nhập không tồn tại!");const o=Object.values(a.val())[0];auth.signInWithEmailAndPassword(o.email,t).catch(a=>{alert("Sai mật khẩu!")})})}
        function logoutUser(){db.ref(`accounts/${currentUser.uid}`).update({status:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP}).then(()=>auth.signOut())}
        function changePassword(){const e=document.getElementById("current-password").value,t=document.getElementById("new-password").value;if(!e||!t)return alert("Vui lòng nhập đủ thông tin.");if(t.length<6)return alert("Mật khẩu mới phải có ít nhất 6 ký tự.");const a=auth.currentUser,o=firebase.auth.EmailAuthProvider.credential(a.email,e);a.reauthenticateWithCredential(o).then(()=>(a.updatePassword(t))).then(()=>{alert('Đổi mật khẩu thành công!');document.getElementById('current-password').value='';document.getElementById('new-password').value=''}).catch(e=>{alert('Lỗi: '+e.message)})}

        // --- FRIENDS & SEARCH ---
        function listenForFriends(){const e=document.getElementById("friends-list");db.ref(`friends/${currentUser.uid}`).orderByChild("timestamp").on("value",t=>{const a=[];t.forEach(c=>{a.push({uid:c.key,...c.val()})});e.innerHTML="";a.reverse().forEach(o=>{db.ref(`accounts/${o.uid}`).on("value",u=>{const t=u.val(),n=e.querySelector(`#friend-${o.uid}`);n&&n.remove();const s=document.createElement("li");s.id=`friend-${o.uid}`,!1===o.read&&s.classList.add("unread");let i=o.lastMessage||"";"[Hình ảnh]"===i?i=i:i.startsWith(currentUser.uid+":")?i="Bạn: "+i.substring(currentUser.uid.length+1).trim():i.startsWith(o.uid+":")&&(i=i.substring(o.uid.length+1).trim());s.innerHTML=`<img src="${t.profilePicture}" class="user-item ${"online"===t.status?"status-online":"status-offline"}"> <div class="info"> <span class="username">${t.displayName}</span> <span class="last-message">${i}</span> </div>`;s.onclick=()=>startChat(o.uid,t);e.appendChild(s);updateClickableElements()})})})}
        function performSearch(e){const searchResultsUI=document.getElementById("search-results-list");searchResultsUI.innerHTML="";if(!e)return;db.ref("accounts").orderByChild("username").startAt(e).endAt(e+'\uf8ff').once("value",t=>{searchResultsUI.innerHTML='';t.forEach(c=>{if(c.key===currentUser.uid)return;const a=c.val();searchResultsUI.innerHTML+=`<li class="search-result-item"><img src="${a.profilePicture}" class="user-item"><a onclick="showProfile('${c.key}')">${a.displayName} (@${a.username})</a><button onclick="sendFriendRequest('${c.key}')">Kết bạn</button></li>`});updateClickableElements()})}
        function sendFriendRequest(e){db.ref(`friend_requests/${e}/${currentUser.uid}`).set({senderName:currentUser.displayName,timestamp:firebase.database.ServerValue.TIMESTAMP}).then(()=>alert("Đã gửi yêu cầu!"))}
        // (Bạn có thể thêm hàm listenForFriendRequests và accept/decline từ bản trước nếu muốn, logic không đổi)

        // --- CHAT ---
        function startChat(partnerUid, partnerData) { document.getElementById('friends-view').classList.add('mobile-chat-active'); currentChatPartner = { uid: partnerUid, ...partnerData }; document.querySelector('#chat-header-info').innerHTML = `<img src="${partnerData.profilePicture}" class="user-item ${partnerData.status === 'online' ? 'status-online' : 'status-offline'}"> <div><strong>${partnerData.displayName}</strong><br><small>@${partnerData.username}</small></div>`; const messagesUI = document.getElementById('chat-messages'); messagesUI.innerHTML = ''; oldestMessageKey = null; if (messageListener) messageListener.off(); db.ref(`friends/${currentUser.uid}/${partnerUid}/read`).set(true); const chatRoomId = currentUser.uid < partnerUid ? `${currentUser.uid}_${partnerUid}` : `${partnerUid}_${currentUser.uid}`; const chatRef = db.ref(`private_chats/${chatRoomId}`); chatRef.orderByKey().limitToLast(20).once('value', snapshot => { if (snapshot.exists()) { const messages = []; snapshot.forEach(child => { messages.push({ key: child.key, ...child.val() }) }); if(messages.length > 0) oldestMessageKey = messages[0].key; messages.reverse().forEach(msg => appendMessage(msg)); } }); messageListener = chatRef.orderByKey().startAt(oldestMessageKey || ' '); messageListener.on('child_added', snapshot => { if (!document.getElementById(`msg-${snapshot.key}`)) { appendMessage({ key: snapshot.key, ...snapshot.val() }) } }); }
        function createMessageBubble(msg){const bubble=document.createElement('div');bubble.id=`msg-${msg.key}`;bubble.className=`message-bubble ${msg.senderId===currentUser.uid?'mine':'other'}`;let content='';if(msg.text)content=msg.text;else if(msg.imageUrl)content=`<a href="${msg.imageUrl}" target="_blank"><img src="${msg.imageUrl}" alt="Hình ảnh đã gửi"></a>`;bubble.innerHTML=`${content} <span class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`;return bubble}
        function appendMessage(msg){const bubble=createMessageBubble(msg);messagesUI.insertBefore(bubble,messagesUI.firstChild)}
        function sendMessage(text) { if (!text || !currentChatPartner) return; sendChatMessage({ text: text }); }
        function sendImageMessage(imageUrl){if(!imageUrl||!currentChatPartner)return;sendChatMessage({imageUrl:imageUrl})}
        function sendChatMessage(content) { const chatRoomId = currentUser.uid < currentChatPartner.uid ? `${currentUser.uid}_${currentChatPartner.uid}` : `${currentChatPartner.uid}_${currentUser.uid}`; const messageData = { ...content, senderId: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`private_chats/${chatRoomId}`).push(messageData); const lastMessagePreview = content.text ? `${currentUser.uid}: ${content.text}` : "[Hình ảnh]"; const updates = {}; updates[`friends/${currentUser.uid}/${currentChatPartner.uid}`] = { lastMessage: lastMessagePreview, timestamp: messageData.timestamp, read: true }; updates[`friends/${currentChatPartner.uid}/${currentUser.uid}`] = { lastMessage: lastMessagePreview, timestamp: messageData.timestamp, read: false }; db.ref().update(updates); if (content.text) document.getElementById('message-input').value = ''; }
        const cloudinaryWidget=cloudinary.createUploadWidget({cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET,sources:["local","url","camera"],multiple:false},(err,res)=>{if(!err&&res&&"success"===res.event){sendImageMessage(res.info.secure_url)}});
        
        // --- CUSTOM CURSOR ---
        function initCursor(){const e=document.querySelector(".cat-cursor");document.addEventListener("mousemove",t=>{e.style.left=t.clientX+"px",e.style.top=t.clientY+"px"}),updateClickableElements()}
        function updateClickableElements(){const e=document.querySelector(".cat-cursor");document.querySelectorAll("a, button, input, li, .clickable").forEach(t=>{t.addEventListener("mouseenter",()=>{e.classList.add("pointer-active")}),t.addEventListener("mouseleave",()=>{e.classList.remove("pointer-active")})})}
    </script>
</body>
</html>
