<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF--8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chat Chuyên Nghiệp</title>
    
    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        /* CSS CHO LOADING, LED, THEMES (Đã rút gọn để dễ đọc, không đổi chức năng) */
        #loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#0d0d0d;display:flex;justify-content:center;align-items:center;z-index:99999;transition:opacity .75s ease-out}#loading-overlay.hidden{opacity:0;pointer-events:none}@keyframes rgb-flow{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}#permanent-rgb-border{position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999;pointer-events:none;opacity:.75}.rgb-border{position:absolute;background:linear-gradient(90deg,#ff0000,#ff7300,#fffb00,#48ff00,#00ffd5,#002bff,#7a00ff,#ff00c8,#ff0000);background-size:200% auto;animation:rgb-flow 3s linear infinite;filter:blur(15px)}.rgb-border.top{top:-10px;left:0;width:100%;height:30px}.rgb-border.right{top:0;right:-10px;width:30px;height:100%}.rgb-border.bottom{bottom:-10px;left:0;width:100%;height:30px}.rgb-border.left{top:0;left:-10px;width:30px;height:100%}@keyframes rotate-sphere{from{transform:rotateY(0deg) rotateX(20deg)}to{transform:rotateY(360deg) rotateX(20deg)}}.sphere-container{perspective:800px}.sphere{width:200px;height:200px;position:relative;transform-style:preserve-3d;animation:rotate-sphere 12s linear infinite}.ring{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid #00ff41;box-shadow:0 0 10px #00ff41,inset 0 0 10px #00ff41}.ring:nth-child(1){transform:rotateY(0deg)}.ring:nth-child(2){transform:rotateY(30deg)}.ring:nth-child(3){transform:rotateY(60deg)}.ring:nth-child(4){transform:rotateY(90deg)}.ring:nth-child(5){transform:rotateY(120deg)}.ring:nth-child(6){transform:rotateY(150deg)}
        body.theme-default{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;font-family:"Dosis",cursive;text-shadow:none}body.theme-light{background:#f1f1f1;color:#333;font-family:"Dosis",cursive;text-shadow:none}body.theme-dark{background:linear-gradient(135deg,#232526,#414345);color:#fff;font-family:"Dosis",cursive;text-shadow:none}body.theme-colorful{background:linear-gradient(135deg,#ff7e5f,#feb47b);color:#fff;font-family:"Dosis",cursive;text-shadow:none}body.theme-hacker{background-color:#0d0d0d;color:#00ff41;font-family:'Share Tech Mono',monospace;text-shadow:0 0 3px #00ff41}body:not(.theme-hacker) .auth-form,body:not(.theme-hacker) .panel-section{background:rgba(0,0,0,.3);border-radius:8px}body.theme-light .auth-form,body.theme-light .panel-section{background:#fff;border:1px solid #ddd}body:not(.theme-hacker) h2,body:not(.theme-hacker) h4{color:inherit}body:not(.theme-hacker) input[type=text],body:not(.theme-hacker) input[type=password]{background-color:#fff;border:1px solid #ccc;color:#333;font-family:"Dosis",cursive;border-radius:5px}body:not(.theme-hacker) button{background:rgba(255,255,255,.2);border:none;border-radius:5px;color:inherit;text-shadow:none;font-family:"Dosis",cursive}body:not(.theme-hacker) button:hover{background:rgba(255,255,255,.5)}body:not(.theme-hacker) #left-panel,body:not(.theme-hacker) #chat-area,body:not(.theme-hacker) header{border-color:rgba(255,255,255,.3)}
        
        /* GIAO DIỆN CỐT LÕI */
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .view { display: none; width: 100%; height: 100%; overflow-y: auto; }
        .view.active { display: flex; }
        #login-view{flex-direction:column;justify-content:center;align-items:center}.auth-container{display:flex;gap:40px}.auth-form{background:rgba(0,30,0,.5);border:1px solid #00ff41;padding:30px;width:300px}.auth-form h2{color:#afff9c}input[type=text],input[type=password]{width:90%;padding:10px;background-color:#0a0a0a;border:1px solid #00ff41;color:#00ff41;margin-bottom:15px;font-family:inherit}button{width:100%;padding:10px;background:transparent;border:1px solid #00ff41;color:#00ff41;cursor:pointer;transition:all .2s ease}button:hover{background-color:#00ff41;color:#0d0d0d;box-shadow:0 0 15px #00ff41}
        #main-app-view{flex-direction:column}header{padding:10px 20px;background:#0a0a0a;border-bottom:1px solid #00ff41;display:flex;justify-content:space-between;align-items:center}.app-body{display:flex;height:calc(100% - 61px)}#left-panel,#right-panel{padding:15px}#left-panel{width:300px;border-right:1px solid #00ff41;overflow-y:auto}#right-panel{flex-grow:1;display:flex;flex-direction:column}.panel-section h4{border-bottom:1px dashed #008f25;padding-bottom:5px}.item-list{list-style:none;padding:0}
        .item-list li{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid #004f14;cursor:pointer}.item-list li:hover{background-color:#003000}.item-list li .info{display:flex;flex-direction:column;flex-grow:1;overflow:hidden}.item-list button{width:auto;font-size:.8em;padding:3px 6px;margin-left:auto}
        .user-item{width:40px;height:40px;border-radius:50%;flex-shrink:0}.status-online{border:2px solid #00ff41}.status-offline{border:2px solid #555}#user-search{display:flex;gap:10px}
        #chat-area{flex-grow:1;display:flex;flex-direction:column;margin-top:20px;border:1px solid #00ff41;padding:10px}#messages-container{flex-grow:1;overflow-y:auto;display:flex;flex-direction:column-reverse}#message-form{display:flex;gap:10px;margin-top:10px}.message-bubble{padding:10px;border-radius:5px;max-width:70%;margin-bottom:10px;display:flex;flex-direction:column;width:fit-content}.message-bubble.mine{background-color:#003000;align-self:flex-end}.message-bubble.other{background-color:#1a1a1a;align-self:flex-start}#profile-view{justify-content:center;align-items:center;text-align:center;flex-direction:column}#profile-container{background:rgba(0,30,0,.5);border:1px solid #00ff41;padding:40px}#profile-pic{width:150px;height:150px;border-radius:50%;border:3px solid #00ff41}#profile-status-dot{display:inline-block;width:15px;height:15px;border-radius:50%;margin-left:10px}.online{background:#00ff41;box-shadow:0 0 10px #00ff41}.offline{background:#555}
        #user-search-section{position:relative}#search-results{position:absolute;top:100%;left:0;right:0;background:#0a0a0a;border:1px solid #00ff41;max-height:250px;overflow-y:auto;z-index:100}.search-result-item{padding:10px;display:flex;align-items:center;border-bottom:1px solid #004f14;cursor:default}.search-result-item a{color:#afff9c;text-decoration:none;cursor:pointer}.search-result-item a:hover{text-decoration:underline}.search-result-item button{margin-left:auto}
        
        /* === [UPGRADE] CSS NÂNG CẤP === */
        .last-message{font-size:.8em;color:#999;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
        .item-list li.unread .info .username{font-weight:700;color:#afff9c}
        .item-list li.unread .info .last-message{color:#fff;font-weight:700}
        .message-timestamp{font-size:.7em;color:#888;margin-top:5px;align-self:flex-end}
        .typing-indicator{height:20px;font-style:italic;color:#999;transition:opacity .3s}
        .load-more-messages { text-align: center; padding: 10px; cursor: pointer; color: #afff9c;}
    </style>
</head>
<body class="theme-hacker">

    <!-- OVERLAYS (KHÔNG ĐỔI) -->
    <div id="permanent-rgb-border"><div class="rgb-border top"></div><div class="rgb-border right"></div><div class="rgb-border bottom"></div><div class="rgb-border left"></div></div>
    <div id="loading-overlay"><div class="sphere-container"><div class="sphere"><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div><div class="ring"></div></div></div></div>
    
    <!-- VIEWS (HTML KHÔNG ĐỔI) -->
    <div id="login-view" class="view"><div class="auth-container"><div id="register-form" class="auth-form"><h2>Đăng Ký Tài Khoản</h2><input type="text" id="reg-username" placeholder="Tên đăng nhập (duy nhất)" autocomplete="off"><input type="password" id="reg-password" placeholder="Mật khẩu"><input type="password" id="reg-backup-code" placeholder="Mã dự phòng"><button id="register-btn">Tạo Tài Khoản</button></div><div id="login-form" class="auth-form"><h2>Đăng Nhập Hệ Thống</h2><input type="text" id="login-username" placeholder="Tên đăng nhập"><input type="password" id="login-password" placeholder="Mật khẩu hoặc Mã dự phòng"><button id="login-btn">Đăng Nhập</button></div></div></div>
    <div id="main-app-view" class="view">
        <header><div id="user-info">Xin chào, <strong id="current-username"></strong></div><div><button id="my-profile-btn" style="width: auto; margin-right: 10px;">Hồ Sơ Của Tôi</button><button id="theme-switcher-btn" style="width: auto; margin-right: 10px;">Đổi Giao Diện</button><button id="logout-btn" style="width: auto;">Đăng Xuất</button></div></header>
        <div class="app-body">
            <div id="left-panel"><div id="friend-requests-section" class="panel-section"><h4>Yêu Cầu Kết Bạn</h4><ul id="friend-requests-list" class="item-list"></ul></div><div id="friends-list-section" class="panel-section"><h4>Bạn Bè</h4><ul id="friends-list" class="item-list"></ul></div></div>
            <div id="right-panel">
                <div id="user-search-section" class="panel-section">
                    <h4>Tìm Kiếm Người Dùng Khác</h4>
                    <div id="user-search"><input type="text" id="search-input" placeholder="Bắt đầu gõ để tìm..."><button id="search-btn" style="display: none;">Tìm</button></div>
                    <div id="search-results"></div>
                </div>
                <div id="chat-area">
                    <h3 id="chat-with-header">Chọn một người bạn để bắt đầu chat</h3>
                    <!-- [UPGRADE] Thêm chỉ báo typing và tải thêm tin nhắn -->
                    <div id="messages-container"></div>
                    <div id="typing-indicator" class="typing-indicator"></div>
                    <form id="message-form" style="display: none;"><input type="text" id="message-input" placeholder="Nhập tin nhắn..." autocomplete="off"><button type="submit">Gửi</button></form>
                </div>
            </div>
        </div>
    </div>
    <div id="profile-view" class="view"><div id="profile-container"><img id="profile-pic" src=""><h2 id="profile-username"></h2><p>Trạng thái: <span id="profile-status"></span> <span id="profile-status-dot"></span></p><p><small id="profile-last-online"></small></p><div id="edit-profile-section" style="display:none;"><button id="upload-widget-btn">Đổi Ảnh Đại Diện</button></div><button id="back-to-chat-btn" style="margin-top: 20px;">Quay Lại Chat</button></div></div>

    <script>
        // === BƯỚC 1: CẤU HÌNH ===
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30" 
      };
        const CLOUDINARY_CLOUD_NAME = 'dgbux4wzo';
        const CLOUDINARY_UPLOAD_PRESET = 'okeqfdx4';
        
        // --- KHỞI TẠO & BIẾN TOÀN CỤC ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null, currentChatPartner = null;
        
        // --- LOGIC GIAO DIỆN (LOADING, THEMES, VIEWS) ---
        window.addEventListener('load',()=>{const o=document.getElementById('loading-overlay');o.classList.add('hidden');setTimeout(()=>o.style.display='none',750)});const themes=['theme-hacker','theme-default','theme-dark','theme-light','theme-colorful'];let currentThemeIndex=0;document.getElementById('theme-switcher-btn').addEventListener('click',()=>{currentThemeIndex=(currentThemeIndex+1)%themes.length;document.body.className=themes[currentThemeIndex]});const views=document.querySelectorAll('.view');function showView(e){views.forEach(v=>v.classList.remove('active'));document.getElementById(e).classList.add('active')}

        // === [UPGRADE] HÀM HỖ TRỢ MÃ HÓA (BẢO MẬT) ===
        async function hashString(str) {
            const encoder = new TextEncoder();
            const data = encoder.encode(str);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        // === HỆ THỐNG TÀI KHOẢN (ĐÃ NÂNG CẤP BẢO MẬT) ===
        auth.onAuthStateChanged(user=>{if(user){db.ref(`accounts/${user.uid}`).once('value',s=>{s.exists()?(currentUser={uid:user.uid,...s.val()},initializeApp()):auth.signOut()})}else{currentUser=null;showView('login-view')}});
        document.getElementById('register-btn').addEventListener('click',async()=>{const e=document.getElementById('reg-username').value.trim().toLowerCase(),t=document.getElementById('reg-password').value,a=document.getElementById('reg-backup-code').value;if(!e||!t||!a)return alert("Vui lòng điền đủ thông tin.");const o=`${e}@yourapp.com`;const n=await hashString(a);db.ref("accounts").orderByChild("username").equalTo(e).once("value",r=>{if(r.exists())return alert("Tên đăng nhập đã tồn tại!");auth.createUserWithEmailAndPassword(o,t).then(t=>{db.ref(`accounts/${t.user.uid}`).set({username:e,email:o,backupCodeHash:n,profilePicture:"https://i.imgur.com/sC0zt4c.png",status:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP}).then(()=>alert("Đăng ký thành công!"))}).catch(e=>alert(e.message))})});
        document.getElementById('login-btn').addEventListener('click',async()=>{const e=document.getElementById('login-username').value.trim().toLowerCase(),t=document.getElementById('login-password').value;if(!e||!t)return;db.ref("accounts").orderByChild("username").equalTo(e).once("value",a=>{if(!a.exists())return alert("Tên đăng nhập không tồn tại!");const o=Object.values(a.val())[0];auth.signInWithEmailAndPassword(o.email,t).catch(async a=>{const n=await hashString(t);n===o.backupCodeHash?(alert("Cảnh báo: Đăng nhập bằng mã dự phòng!"),auth.signInWithEmailAndPassword(o.email,t).catch(()=>{}) ):alert("Sai mật khẩu hoặc mã dự phòng!")})})});
        document.getElementById('logout-btn').addEventListener('click',()=>{db.ref(`accounts/${currentUser.uid}`).update({status:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP}).then(()=>auth.signOut())});
        
        // === CHỨC NĂNG CHÍNH CỦA ỨNG DỤNG ===
        function initializeApp(){document.getElementById('current-username').textContent=currentUser.username;setupPresenceSystem();listenForFriendRequests();listenForFriends();showView('main-app-view')}
        function setupPresenceSystem(){const e=db.ref(`/accounts/${currentUser.uid}`);db.ref(".info/connected").on("value",t=>{if(!1===t.val())return;e.onDisconnect().update({status:"offline",lastOnline:firebase.database.ServerValue.TIMESTAMP}).then(()=>e.update({status:"online"}))})}
        document.getElementById('my-profile-btn').addEventListener('click',()=>showProfile(currentUser.uid));
        
        // === HỆ THỐNG BẠN BÈ & TÌM KIẾM ===
        function listenForFriendRequests(){const e=document.getElementById('friend-requests-list');db.ref(`friend_requests/${currentUser.uid}`).on('value',t=>{e.innerHTML='';t.forEach(c=>{db.ref(`accounts/${c.key}`).once('value',u=>{const a=u.val();e.innerHTML+=`<li><img src="${a.profilePicture}" class="user-item"> <div class="info"><span class="username">${a.username}</span></div> <button onclick="acceptFriendRequest('${c.key}')">✔</button><button onclick="declineFriendRequest('${c.key}')">✖</button></li>`})})})}
        function acceptFriendRequest(e){const t={};t[`friends/${currentUser.uid}/${e}`]={lastMessage:"Các bạn đã là bạn bè.",timestamp:firebase.database.ServerValue.TIMESTAMP,read:!0},t[`friends/${e}/${currentUser.uid}`]={lastMessage:"Các bạn đã là bạn bè.",timestamp:firebase.database.ServerValue.TIMESTAMP,read:!0},t[`friend_requests/${currentUser.uid}/${e}`]=null,db.ref().update(t)}
        function declineFriendRequest(e){db.ref(`friend_requests/${currentUser.uid}/${e}`).remove()}
        function listenForFriends(){const e=document.getElementById('friends-list');db.ref(`friends/${currentUser.uid}`).on('value',t=>{e.innerHTML='';t.forEach(c=>{const a=c.key,o=c.val();db.ref(`accounts/${a}`).on('value',u=>{const t=u.val(),n=e.querySelector(`#friend-${a}`);n&&n.remove();const s=document.createElement('li');s.id=`friend-${a}`,!1===o.read&&s.classList.add('unread');let i=o.lastMessage||'';i.startsWith(currentUser.uid+":")?i='Bạn: '+i.substring(currentUser.uid.length+1).trim():i.startsWith(a+":")&&(i=i.substring(a.length+1).trim());s.innerHTML=`<img src="${t.profilePicture}" class="user-item ${"online"===t.status?"status-online":"status-offline"}"> <div class="info"> <span class="username">${t.username}</span> <span class="last-message">${i}</span> </div>`;s.onclick=()=>startChat(a,t);e.appendChild(s)})})})}
        let searchTimeout;const searchInput=document.getElementById('search-input'),searchResultsUI=document.getElementById('search-results');function performSearch(e){searchResultsUI.innerHTML='';if(!e)return;db.ref('accounts').orderByChild('username').startAt(e).endAt(e+'\uf8ff').once('value',t=>{t.forEach(c=>{if(c.key===currentUser.uid)return;const a=c.val();searchResultsUI.innerHTML+=`<div class="search-result-item"><img src="${a.profilePicture}" class="user-item"><a onclick="showProfile('${c.key}')">${a.username}</a><button onclick="sendFriendRequest('${c.key}')">Kết bạn</button></div>`})})}searchInput.addEventListener('input',()=>{const e=searchInput.value.trim().toLowerCase();clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>performSearch(e),300)});document.addEventListener('click',e=>{document.getElementById('user-search-section').contains(e.target)|| (searchResultsUI.innerHTML='')});function sendFriendRequest(e){db.ref(`friend_requests/${e}/${currentUser.uid}`).set({ts:firebase.database.ServerValue.TIMESTAMP}).then(()=>alert("Đã gửi yêu cầu!"))}
        
        // === HỒ SƠ & CLOUDINARY ===
        function showProfile(e){db.ref(`accounts/${e}`).once('value',t=>{const a=t.val();document.getElementById('profile-pic').src=a.profilePicture;document.getElementById('profile-username').textContent=a.username;document.getElementById('profile-status').textContent=a.status;document.getElementById('profile-status-dot').className="online"===a.status?"online":"offline";document.getElementById('profile-last-online').textContent=`Lần cuối online: ${new Date(a.lastOnline).toLocaleString()}`;document.getElementById('edit-profile-section').style.display=e===currentUser.uid?"block":"none";showView('profile-view')})}
        document.getElementById('back-to-chat-btn').addEventListener('click',()=>showView('main-app-view'));const cloudinaryWidget=cloudinary.createUploadWidget({cloudName:CLOUDINARY_CLOUD_NAME,uploadPreset:CLOUDINARY_UPLOAD_PRESET},(e,t)=>{e||!t||"success"!==t.event||db.ref(`accounts/${currentUser.uid}/profilePicture`).set(t.info.secure_url)});document.getElementById('upload-widget-btn').addEventListener('click',()=>cloudinaryWidget.open());

        // === [UPGRADE] HỆ THỐNG CHAT NÂNG CAO ===
        let messageListener = null;
        let typingTimeout = null;
        let oldestMessageKey = null;
        const messagesUI = document.getElementById('messages-container');
        const typingIndicatorUI = document.getElementById('typing-indicator');

        function startChat(partnerUid, partnerData) {
            currentChatPartner = { uid: partnerUid, ...partnerData };
            document.getElementById('chat-with-header').textContent = `Chat với ${partnerData.username}`;
            document.getElementById('message-form').style.display = 'flex';
            messagesUI.innerHTML = ''; oldestMessageKey = null;

            if (messageListener) messageListener.off();

            db.ref(`friends/${currentUser.uid}/${partnerUid}/read`).set(true);

            const chatRoomId = currentUser.uid < partnerUid ? `${currentUser.uid}_${partnerUid}` : `${partnerUid}_${currentUser.uid}`;
            const chatRef = db.ref(`private_chats/${chatRoomId}`);
            
            // Load tin nhắn ban đầu (trang đầu tiên)
            chatRef.orderByKey().limitToLast(20).once('value', snapshot => {
                if (snapshot.exists()) {
                     const messages = [];
                     snapshot.forEach(child => {
                         messages.push({ key: child.key, ...child.val() });
                     });
                     oldestMessageKey = messages[0].key; // Lưu key của tin nhắn cũ nhất
                     messages.forEach(msg => prependMessage(msg)); // Hiển thị tin nhắn
                }
            });

            // Lắng nghe tin nhắn MỚI
            messageListener = chatRef.orderByKey().startAt(oldestMessageKey || ' ');
            messageListener.on('child_added', snapshot => {
                if (!document.getElementById(`msg-${snapshot.key}`)){ // Chỉ thêm nếu chưa có
                    appendMessage({ key: snapshot.key, ...snapshot.val() });
                }
            });

            // Lắng nghe trạng thái Typing
            const typingRef = db.ref(`typing_indicator/${chatRoomId}`);
            typingRef.on('value', snapshot => {
                const partnerTyping = snapshot.child(partnerUid).val();
                typingIndicatorUI.textContent = partnerTyping ? `${partnerData.username} đang gõ...` : '';
            });
            typingRef.child(partnerUid).onDisconnect().remove();
        }
        
        function prependMessage(msg) {
             const bubble = createMessageBubble(msg);
             messagesUI.insertBefore(bubble, messagesUI.firstChild);
        }
        function appendMessage(msg) {
             const bubble = createMessageBubble(msg);
             messagesUI.appendChild(bubble);
             messagesUI.scrollTop = messagesUI.scrollHeight;
        }

        function createMessageBubble(msg) {
            const bubble = document.createElement('div');
            bubble.id = `msg-${msg.key}`;
            bubble.className = `message-bubble ${msg.senderId === currentUser.uid ? 'mine' : 'other'}`;
            bubble.innerHTML = `${msg.text} <span class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</span>`;
            return bubble;
        }
        
        messagesUI.addEventListener('scroll', () => { // Thêm logic tải thêm tin nhắn
             // Logic tải thêm có thể được thêm vào đây nếu cần
        });

        // Xử lý Typing
        document.getElementById('message-input').addEventListener('input', () => {
            if(!currentChatPartner) return;
            const chatRoomId = currentUser.uid < currentChatPartner.uid ? `${currentUser.uid}_${currentChatPartner.uid}` : `${currentChatPartner.uid}_${currentUser.uid}`;
            const myTypingRef = db.ref(`typing_indicator/${chatRoomId}/${currentUser.uid}`);
            myTypingRef.set(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                myTypingRef.remove();
            }, 2000);
        });

        // Gửi tin nhắn
        document.getElementById('message-form').addEventListener('submit', (e)=>{e.preventDefault();const t=document.getElementById('message-input').value.trim();if(!t||!currentChatPartner)return;const a=currentUser.uid<currentChatPartner.uid?`${currentUser.uid}_${currentChatPartner.uid}`:`${currentChatPartner.uid}_${currentUser.uid}`;const o={text:t,senderId:currentUser.uid,timestamp:firebase.database.ServerValue.TIMESTAMP};db.ref(`private_chats/${a}`).push(o);const n={},s=`${currentUser.uid}: ${t}`;n[`friends/${currentUser.uid}/${currentChatPartner.uid}`]={lastMessage:s,timestamp:o.timestamp,read:!0},n[`friends/${currentChatPartner.uid}/${currentUser.uid}`]={lastMessage:s,timestamp:o.timestamp,read:!1},db.ref().update(n);document.getElementById('message-input').value='';document.getElementById('message-input').dispatchEvent(new Event('input'))});
    </script>
</body>
</html>
