<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chat Nâng Cao</title>

    <!-- SDKs & Fonts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #242424;
            --modal-bg: rgba(20, 20, 20, 0.85);
            --text-color: #e0e0e0;
            --secondary-text-color: #9e9e9e;
            --accent-color: #3d82f0;
            --danger-color: #e53935;
            --online-color: #43a047;
            --primary-border-color: #3a3a3a;
            --hover-bg: #333333;
            --input-bg: #2c2c2c;
            --font-primary: 'Be Vietnam Pro', sans-serif;
            --shadow: 0 4px 12px rgba(0,0,0,.2);
            --transition-speed: 0.3s;
        }

        /* GENERAL STYLES */
        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            margin: 0; padding: 0; height: 100vh;
            overflow: hidden; background: var(--bg-color); color: var(--text-color);
            font-family: var(--font-primary);
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        button:not(.nav-btn, .chat-header-menu button, #chat-input-buttons button) {
            background-color: var(--accent-color); color: white; border: none; border-radius: 8px; 
            padding: 10px 15px; font-family: var(--font-primary); font-weight: 500; font-size: 15px;
            cursor: pointer; transition: background-color var(--transition-speed), transform 0.1s;
        }
        button:not(.nav-btn):hover { background-color: #4a90e2; }
        button:not(.nav-btn):active { transform: scale(0.98); }
        .btn-secondary { background: var(--hover-bg); color: var(--text-color); }
        .btn-danger { background: var(--danger-color); }
        .btn-danger:hover { background: #c62828; }
        input[type="text"], input[type="password"] {
            width: 100%; background: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--primary-border-color); border-radius: 8px;
            padding: 12px; font-family: inherit; font-size: 15px; margin-bottom: 10px;
        }
        input:focus { border-color: var(--accent-color); outline: none; }
        
        .view { display: none; width: 100%; height: 100%; overflow: hidden; flex-direction: column; }
        .view.active { display: flex; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #main-app-view { flex-direction: column; }
        .app-container { display: flex; width: 100%; height: 100%; }

        #main-nav { display: flex; flex-direction: column; align-items: center; background: var(--panel-bg); padding: 10px 0; border-right: 1px solid var(--primary-border-color); z-index: 10; }
        .nav-btn { background: none; border: none; color: var(--secondary-text-color); padding: 15px; width: 60px; height: 60px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: center; align-items: center; transition: all var(--transition-speed); position: relative; cursor:pointer;}
        .nav-btn.active { color: white; background: var(--accent-color); }
        .nav-btn:hover:not(.active) { color: var(--text-color); background: var(--hover-bg); }
        .nav-btn svg { width: 28px; height: 28px; }

        #content-container { flex-grow: 1; display: flex; position: relative; overflow: hidden; }
        .content-page { display: none; animation: fadeIn 0.3s; } 
        .content-page.active { display: flex; width: 100%; height: 100%; flex-direction: row;}

        #left-panel { width: 340px; border-right: 1px solid var(--primary-border-color); display: flex; flex-direction: column; flex-shrink: 0; background: var(--panel-bg); }
        #panel-header { padding: 20px; border-bottom: 1px solid var(--primary-border-color); display: flex; justify-content: space-between; align-items: center; }
        #panel-header h4 { margin: 0; font-size: 20px; }
        #panel-header-actions button { background: none; border: 1px solid var(--primary-border-color); border-radius: 50%; width: 36px; height: 36px; display: flex; justify-content: center; align-items: center; font-size: 24px; padding: 0; color: white;}
        
        .tab-controls { display: flex; border-bottom: 1px solid var(--primary-border-color); }
        .tab-btn { flex: 1; padding: 12px; background: none; border: none; color: var(--secondary-text-color); cursor: pointer; border-bottom: 3px solid transparent; font-size: 15px; font-weight: 500; }
        .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); }
        
        .item-list { flex-grow: 1; overflow-y: auto; list-style: none; margin: 0; padding: 10px; display: none; }
        .item-list.active { display: block; }
        .item-list li { display: flex; align-items: center; gap: 15px; padding: 12px; cursor: pointer; border-radius: 8px; transition: background .2s; }
        .item-list li.active, .item-list li:hover { background: var(--hover-bg); }
        .info { flex-grow: 1; overflow: hidden; }
        .username { font-weight: 500; font-family: inherit; }
        .last-message { font-size: .9em; color: var(--secondary-text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .item-list li.unread .username { color: var(--accent-color); font-weight: 700; }
        
        .page-container { width: 100%; height: 100%; padding: 30px; display: flex; flex-direction: column; align-items: center; overflow-y: auto; }
        .page-content { background: var(--panel-bg); padding: 30px; border-radius: 8px; width: 100%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        label{display:block;margin-bottom:5px;color:var(--secondary-text-color)}

        .chat-container { flex-grow: 1; display: none; flex-direction: column; background: var(--bg-color); }
        #chat-header { padding: 10px 15px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--primary-border-color); flex-shrink: 0; background: var(--panel-bg); }
        #chat-header-info { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
        .chat-header-menu { display: flex; align-items: center; gap: 5px; }
        .chat-header-menu button { background: none; border: none; color: var(--secondary-text-color); padding: 8px; border-radius: 50%; width: 40px; height: 40px; cursor:pointer;}
        .chat-header-menu button:hover { background: var(--hover-bg); color: var(--text-color); }

        #chat-messages-wrapper { flex-grow: 1; overflow-y: auto; padding: 0 20px; display: flex; flex-direction: column-reverse; }
        #chat-messages { display: flex; flex-direction: column-reverse; padding-top: 10px;}
        .message-bubble { padding: 10px 16px; border-radius: 20px; max-width: 70%; margin-bottom: 4px; width: fit-content; animation: slideIn .3s ease-out; position: relative; word-wrap: break-word;}
        .message-bubble.mine { background-color: var(--accent-color); color: white; align-self: flex-end; }
        .message-bubble.other { background-color: var(--hover-bg); align-self: flex-start; }
        .message-timestamp { font-size: .75em; color: var(--secondary-text-color); margin-top: 5px; text-align: right; }
        .message-bubble.mine .message-timestamp { color: rgba(255,255,255,.7); }
        .message-sender-name { font-size: 0.85em; font-weight: bold; color: var(--accent-color); margin-bottom: 4px; }
        .message-bubble img, .message-bubble .map-preview img { max-width: 300px; border-radius: 10px; margin-top: 5px; display: block; cursor: pointer; }
        .mention-self { background-color: rgba(255, 215, 0, 0.4); padding: 1px 4px; border-radius: 4px; color: white;}
        .sys-message { align-self: center; text-align: center; color: var(--secondary-text-color); font-size: 0.8em; padding: 5px 12px; margin: 10px 0; background: var(--hover-bg); border-radius: 12px; }

        #chat-input-area { padding: 15px; border-top: 1px solid var(--primary-border-color); background: var(--panel-bg); flex-shrink: 0; position: relative; }
        #chat-input { display: flex; gap: 10px; align-items: center;}
        #chat-input-buttons { display:flex; gap: 5px;}
        #chat-input-buttons button { background: none; border: none; color: var(--secondary-text-color); padding: 8px; transition: color 0.2s; cursor:pointer; }
        #chat-input-buttons button:hover { color: var(--accent-color); }
        #mention-list-container { display: none; position: absolute; bottom: 85px; left: 15px; right: 15px; background: #2f2f2f; border: 1px solid var(--primary-border-color); border-radius: 8px;  max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: var(--shadow); }
        .mention-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; }
        .mention-item:hover { background-color: var(--hover-bg); }
        .user-item { width: 45px; height: 45px; border-radius: 50%; flex-shrink: 0; object-fit: cover; }

        #login-view { justify-content: center; align-items: center; padding: 15px; }
        .auth-container { width: 100%; max-width: 400px; }
        .auth-form { background: var(--panel-bg); border: 1px solid var(--primary-border-color); padding: 30px; border-radius: 12px; }
        .auth-form h2 { color: var(--accent-color); text-align: center; margin-bottom: 25px; }

        #call-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; flex-direction: column; animation: fadeIn 0.3s; }
        #call-videos { width: 100%; height: 100%; position: relative; }
        #remote-video-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #remote-video-container video { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }
        #local-video-container { position: absolute; bottom: 100px; right: 20px; width: 200px; height: 150px; border: 2px solid var(--accent-color); border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); transition: all 0.3s; }
        #local-video-container video { width: 100%; height: 100%; object-fit: cover; }
        #call-controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 20px; }
        #call-controls button { width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; padding: 0; cursor:pointer;}
        #call-controls svg { width: 24px; height: 24px;}
        #call-in-chat-notification { display: none; padding: 12px; background-color: var(--online-color); margin: 10px; border-radius: 8px; text-align: center; animation: fadeIn 0.5s; align-items: center; justify-content: center; gap: 15px; }

        .modal { position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg); display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--panel-bg); padding: 25px; border: 1px solid var(--primary-border-color); width: 90%; max-width: 500px; border-radius: 12px; box-shadow: var(--shadow); }

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 768px) { 
            .app-container { flex-direction: column; }
            #main-nav { position: fixed; bottom: 0; width: 100%; flex-direction: row; justify-content: space-around; border-top: 1px solid var(--primary-border-color); border-right: none;}
            #content-container { height: calc(100% - 60px); }
            #left-panel { position: absolute; width: 100%; height: 100%; z-index: 2; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
            #left-panel.active { transform: translateX(0); }
            .chat-container { position: absolute; width: 100%; height: 100%; z-index: 1; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
            .chat-container.active { transform: translateX(0); }
            #back-to-list-btn { display: flex !important; }
        }
    </style>
</head>
<body>

    <!-- CALL UI CONTAINER -->
    <div id="call-container">
        <div id="call-videos"><div id="remote-video-container"></div><div id="local-video-container"></div></div>
        <div id="call-controls">
            <button id="pip-btn" title="Hình trong hình" class="btn-secondary"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"></path></svg></button>
            <button id="end-call-btn" class="btn-danger" title="Kết thúc"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 9c-1.6 0-3.15.25-4.62.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.1-2.66 1.82-.18.18-.43.28-.7.28-.26 0-.51-.1-.7-.29-.39-.39-.39-1.02 0-1.41C5.03 12.86 7.67 11.5 12 11.5c.34 0 .68.02 1.01.07V9.49c-.33-.03-.67-.04-1.01-.04M20 9.49V12.5c4.33 0 6.88 2.65 8.13 4.88.24.43.04.98-.39 1.22-.19.1-.4.15-.6.15-.3 0-.59-.12-.82-.35-.8-.85-1.7-1.6-2.68-2.22-.32-.2-.75-.12-.98.17-.45.58-.93 1.13-1.43 1.66-.41.42-.96.63-1.53.63-.49 0-.96-.18-1.34-.51-1.1- .95-2.27-1.74-3.56-2.28-.3-.12-.5-.39-.5-.7V9c0-5.42-3.87-7.85-8.29-8.4C2.15.53 0 .74 0 3.3V7.2c.48.06.96.12 1.44.18.5.07.9.5.83 1-.07.49-.5.85-.99.78-.3-.04-.59-.08-.88-.13V3.3c0-1.41 1.25-2.06 2.58-1.92 3.63.4 6.71 2.36 7.27 6.16L12 9.04c-.33-.03-.67-.04-1.01-.04-2.89 0-5.92 1-7.53 2.79v3.11c1.37-1.14 3.32-2 5.54-2 1.05 0 2.05.21 2.99.59v-3.08c.68-.13 1.39-.21 2.13-.21.28 0 .56.02.83.05zm-.15.02c-.22-.03-.45-.05-.68-.05-1.15 0-2.39.26-3.62.75V12.5c.49-.07 1-.12 1.5-.16.54-.04 1.02-.45 1.02-1V9.51Z" transform="scale(0.8) translate(2,2)"/></svg></button>
        </div>
    </div>
    
    <div id="login-view" class="view">
        <div class="auth-container">
            <div class="auth-form">
                <h2>Đăng Nhập / Đăng Ký</h2>
                <div class="form-group"><input type="text" id="reg-displayname" placeholder="Tên hiển thị"><input type="text" id="reg-username" placeholder="Tên đăng nhập"><input type="password" id="reg-password" placeholder="Mật khẩu"><button id="register-btn">Tạo Tài Khoản</button></div>
                <hr style="border-color: var(--primary-border-color); margin: 25px 0;">
                <div class="form-group"><input type="text" id="login-username" placeholder="Tên đăng nhập"><input type="password" id="login-password" placeholder="Mật khẩu"><button id="login-btn">Đăng Nhập</button></div>
            </div>
        </div>
    </div>

    <div id="main-app-view" class="view">
        <div class="app-container">
            <nav id="main-nav">
                 <button class="nav-btn active" data-page="friends-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg></button>
                 <button class="nav-btn" data-page="discover-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
                 <button class="nav-btn" data-page="requests-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></button>
                 <button class="nav-btn" data-page="settings-view"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23-.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65z"/></svg></button>
            </nav>
            <main id="content-container">
                 <section id="friends-view" class="content-page active">
                     <div id="left-panel">
                        <div id="panel-header"><h4>Trò chuyện</h4><div id="panel-header-actions"><button id="create-group-btn" title="Tạo nhóm mới">+</button></div></div>
                        <div class="tab-controls"><button class="tab-btn active" data-tab="friends-list">Bạn bè</button><button class="tab-btn" data-tab="groups-list">Nhóm</button></div>
                        <ul id="friends-list" class="item-list active"></ul><ul id="groups-list" class="item-list"></ul>
                     </div>
                 </section>
                <section id="discover-view" class="content-page"><div class="page-container"><h2>Khám Phá</h2><div class="page-content"><input id="search-input" type="text" placeholder="Tìm bằng username..."/><div id="search-results-list" class="item-list" style="display:block;"></div></div></div></section>
                <section id="requests-view" class="content-page"><div class="page-container"><h2>Yêu cầu kết bạn</h2><div class="page-content" id="friend-requests-list"></div></div></section>
                <section id="settings-view" class="content-page"><div class="page-container"><div class="page-content"><h2>Cài đặt</h2><button id="logout-btn" class="btn-danger">Đăng Xuất</button></div></div></section>
                 
                <div id="chat-container" class="chat-container">
                    <div id="chat-header">
                        <button id="back-to-list-btn" style="display: none; background:none; border:none; color:white; padding-right:10px;"><svg fill="currentColor" viewBox="0 0 24 24" width="24" height="24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg></button>
                        <div id="chat-header-info"></div>
                        <div class="chat-header-menu">
                            <button id="start-voice-call-btn"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.02.74-.25 1.02l-2.2 2.2z"/></svg></button>
                            <button id="start-video-call-btn"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg></button>
                        </div>
                    </div>
                    <div id="chat-messages-wrapper">
                         <div id="call-in-chat-notification"><p></p><button id="join-call-btn">Tham Gia</button></div>
                         <div id="chat-messages"></div>
                    </div>
                    <div id="chat-input-area">
                         <div id="mention-list-container"></div>
                         <div id="chat-input">
                            <div id="chat-input-buttons">
                                <button id="upload-image-btn"><svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M2.5 19.5c-.28 0-.53-.11-.71-.29-.18-.18-.29-.43-.29-.71V5.5c0-.28.11-.53.29-.71.18-.18.43-.29.71-.29h6.25l2.5 2.5h7.25c.28 0 .53.11.71.29.18.18.29.43.29.71v9c0 .28-.11-.53-.29.71-.18.18-.43.29-.71.29H2.5z"/></svg></button>
                                <button id="share-location-btn"><svg fill="currentColor" viewBox="0 0 24 24" width="20" height="20"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></button>
                            </div>
                            <input id="message-input" type="text" placeholder="Nhập tin nhắn..."/><button id="send-btn">Gửi</button>
                         </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <div id="toast-container" style="position:fixed; bottom:20px; right:20px; z-index:100001;"></div>

    <script>
        // === CONFIGURATION ===
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
        };
        const CLOUDINARY_CLOUD_NAME = 'dgbux4wzo';
        const CLOUDINARY_UPLOAD_PRESET = 'okeqfdx4';
        const AGORA_APP_ID = 'a0b62867bee543fe828e23b4888eb3ae';
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

        // === INITIALIZATION ===
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); 
        const db = firebase.database();
        
        let currentUser = null, currentChat = null, messageListener = null, callStatusListener = null;
        let agoraClient = null, localTracks = { audio: null, video: null }, activeCallInfo = { isActive: false, channel: null };
        let userCache = {}; // Cache for user data to reduce DB reads

        // === CORE APP LOGIC ===
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => { 
                user ? db.ref(`accounts/${user.uid}`).once('value', s => s.exists() ? (currentUser = { uid: user.uid, ...s.val() }, initializeApp()) : auth.signOut()) : showView('login-view');
            });
            document.getElementById('register-btn').addEventListener('click', registerUser);
            document.getElementById('login-btn').addEventListener('click', loginUser);
        });

        function initializeApp() {
            showView('main-app-view');
            document.getElementById('chat-container').style.display = 'none'; 
            initializeAgora();
            setupEventListeners();
            listenForFriends();
            // Other listeners like listenForGroups(), listenForFriendRequests() would go here
        }

        function setupEventListeners() {
             document.getElementById('send-btn').addEventListener('click', sendMessage);
             document.getElementById('message-input').addEventListener('keydown', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
             document.getElementById('message-input').addEventListener('input', handleMentionInput);
             document.getElementById('upload-image-btn').addEventListener('click', () => currentChat ? cloudinaryWidgetChat.open() : showToast("Vui lòng chọn cuộc trò chuyện."));
             document.getElementById('share-location-btn').addEventListener('click', shareLocation);
             document.getElementById('start-video-call-btn').addEventListener('click', () => startCall('video'));
             document.getElementById('start-voice-call-btn').addEventListener('click', () => startCall('voice'));
             document.getElementById('end-call-btn').addEventListener('click', endCall);
             document.getElementById('pip-btn').addEventListener('click', togglePictureInPicture);
             document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
             setupNavigation();
             setupTabs();
             // Responsive listeners
             if (window.innerWidth <= 768) {
                document.getElementById('back-to-list-btn').addEventListener('click', () => {
                    document.querySelector('.chat-container.active').classList.remove('active');
                    document.querySelector('#left-panel').classList.add('active');
                });
             }
        }

        // === AUTHENTICATION ===
        function registerUser() { const d=document.getElementById("reg-displayname").value.trim(),e=document.getElementById("reg-username").value.trim().toLowerCase(),t=document.getElementById("reg-password").value;if(!d||!e||!t)return showToast("Vui lòng điền đủ thông tin.","error");if(!/^[a-z0-9_]+$/.test(e))return showToast("Tên đăng nhập không hợp lệ.","error");if(t.length<6)return showToast("Mật khẩu phải có ít nhất 6 ký tự.","error");const o=`${e}@chat.app`;db.ref("accounts").orderByChild("username").equalTo(e).once("value",r=>{if(r.exists())return showToast("Tên đăng nhập đã tồn tại!","error");auth.createUserWithEmailAndPassword(o,t).then(t=>{db.ref(`accounts/${t.user.uid}`).set({username:e,displayName:d,email:o,profilePicture:"https://i.imgur.com/sC0zt4c.png"}).then(()=>showToast("Đăng ký thành công!"))}).catch(e=>showToast(e.message,"error"))})}
        function loginUser() { const e=document.getElementById("login-username").value.trim().toLowerCase(),t=document.getElementById("login-password").value;if(!e||!t)return;db.ref("accounts").orderByChild("username").equalTo(e).once("value",a=>{if(!a.exists())return showToast("Tên đăng nhập không tồn tại!","error");const o=Object.values(a.val())[0];auth.signInWithEmailAndPassword(o.email,t).catch(a=>showToast("Sai mật khẩu!","error"))})}

        // === UI & NAVIGATION ===
        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        function setupNavigation() { document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => { const pageId = btn.dataset.page; document.querySelectorAll('.content-page, .nav-btn').forEach(el => el.classList.remove('active')); document.getElementById(pageId).classList.add('active'); btn.classList.add('active'); }))}
        function setupTabs() { document.querySelectorAll('.tab-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.tab-btn, .item-list').forEach(el => el.classList.remove('active')); btn.classList.add('active'); document.getElementById(btn.dataset.tab).classList.add('active'); })})}

        async function getUserData(uid) {
            if (userCache[uid]) return userCache[uid];
            const snap = await db.ref(`accounts/${uid}`).once('value');
            if (snap.exists()) {
                userCache[uid] = { uid, ...snap.val() };
                return userCache[uid];
            }
            return null;
        }

        // === DATA LISTENERS ===
        function listenForFriends(){ const e = document.getElementById("friends-list"); db.ref(`friends/${currentUser.uid}`).orderByChild("timestamp").on("value", async t => { e.innerHTML = ""; if(!t.exists()) return; const friends = []; t.forEach(c => { friends.push({ uid: c.key, ...c.val() }); }); for(const o of friends.reverse()) { const friendData = await getUserData(o.uid); if (friendData) { const li=document.createElement("li");li.id=`friend-${o.uid}`;li.innerHTML=`<img src="${friendData.profilePicture}" class="user-item"><div class="info"><span class="username">${friendData.displayName}</span><span class="last-message">${o.lastMessage || ""}</span></div>`;li.onclick=()=>startPrivateChat(o.uid, friendData); e.appendChild(li); } } });}

        // === CHAT CORE ===
        function startPrivateChat(partnerUid, partnerData) {
            currentChat = { type: 'private', uid: partnerUid, data: partnerData };
            const chatContainer = document.getElementById('chat-container');
            chatContainer.style.display = 'flex'; chatContainer.classList.add('active');
            
            if (window.innerWidth <= 768) { document.getElementById('left-panel').classList.remove('active'); }

            document.querySelector('#chat-header-info').innerHTML = `<img src="${partnerData.profilePicture}" class="user-item"><div><strong>${partnerData.displayName}</strong><br><small>@${partnerData.username}</small></div>`; 
            
            const chatRoomId = currentUser.uid < partnerUid ? `${currentUser.uid}_${partnerUid}` : `${partnerUid}_${currentUser.uid}`;
            const chatRoomRef = db.ref(`private_chats/${chatRoomId}`);
            
            if (callStatusListener) callStatusListener.off();
            callStatusListener = chatRoomRef.child('active_call');
            callStatusListener.on('value', async snapshot => {
                const callUI = document.getElementById('call-in-chat-notification');
                if (snapshot.exists() && snapshot.val().active) {
                    const initiatorData = await getUserData(snapshot.val().initiatorId);
                    callUI.style.display = 'flex';
                    callUI.querySelector('p').textContent = `${initiatorData.displayName} đã bắt đầu cuộc gọi.`;
                    document.getElementById('join-call-btn').onclick = () => joinCall(snapshot.val().type);
                } else {
                    callUI.style.display = 'none';
                }
            });

            setupChatListeners(chatRoomRef.child('messages'));
            document.querySelectorAll('#friends-list li.active').forEach(li => li.classList.remove('active'));
            document.getElementById(`friend-${partnerUid}`)?.classList.add('active');
        }

        function setupChatListeners(chatRef) {
             if (messageListener) messageListener.off();
             const messagesUI = document.getElementById('chat-messages'); messagesUI.innerHTML = '';
             messageListener = chatRef.orderByKey().limitToLast(50);
             messageListener.on('child_added', async snapshot => { 
                if (document.getElementById(`msg-${snapshot.key}`)) return;
                const msg = { key: snapshot.key, ...snapshot.val() };
                const bubble = await createMessageBubble(msg);
                if (bubble) messagesUI.prepend(bubble);
             });
        }
        
        async function createMessageBubble(msg) {
            const isMine = msg.senderId === currentUser.uid;
            let contentHTML = '', senderNameHTML = '';
            
            if(msg.text) {
                if (msg.text.startsWith('SYS:')) { const li = document.createElement('div'); li.className = 'sys-message'; li.textContent = msg.text.substring(4); return li; }
                contentHTML = msg.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/@([a-z0-9_]+)/g,(m,u)=>`<strong class="${u===currentUser.username ?'mention-self':''}">${m}</strong>`);
            } else if (msg.imageUrl) { contentHTML = `<a href="${msg.imageUrl}" target="_blank"><img src="${msg.imageUrl}" alt="Hình ảnh"></a>`; } 
            else if (msg.location) { contentHTML = `<div class="map-preview"><a href="https://www.google.com/maps?q=${msg.location.lat},${msg.location.lng}" target="_blank"><img src="https://maps.googleapis.com/maps/api/staticmap?center=${msg.location.lat},${msg.location.lng}&zoom=15&size=300x160&maptype=roadmap&markers=color:red%7C${msg.location.lat},${msg.location.lng}&key=${GOOGLE_MAPS_API_KEY}" alt="Vị trí"></a></div>`; }
            
            const bubble = document.createElement('div'); bubble.id = `msg-${msg.key}`;
            bubble.className = `message-bubble ${isMine ? 'mine' : 'other'}`;
            const timestamp = `<span class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' })}</span>`;
            
            bubble.innerHTML = `${senderNameHTML}${contentHTML}${timestamp}`;
            return bubble;
        }

        function sendMessage() {
            const text = document.getElementById('message-input').value.trim();
            if (!text || !currentChat) return;
            sendChatMessage({ text });
            document.getElementById('message-input').value = '';
        }
        
        function sendChatMessage(content, createLastMessage = true) {
            const messageData = { ...content, senderId: currentUser.uid, timestamp: firebase.database.ServerValue.TIMESTAMP };
            const updates = {};
            if (currentChat.type === 'private') {
                 const chatRoomId = currentUser.uid < currentChat.uid ? `${currentUser.uid}_${currentChat.uid}` : `${currentChat.uid}_${currentChat.uid}`;
                 const msgKey = db.ref(`private_chats/${chatRoomId}/messages`).push().key;
                 updates[`private_chats/${chatRoomId}/messages/${msgKey}`] = messageData;
                 if(createLastMessage) { 
                    const preview = messageData.text || (messageData.imageUrl ? '[Hình ảnh]' : '[Vị trí]');
                    updates[`friends/${currentUser.uid}/${currentChat.uid}/lastMessage`] = preview; 
                    updates[`friends/${currentChat.uid}/${currentUser.uid}/lastMessage`] = preview; 
                 }
            } // ... similar logic for groups
             db.ref().update(updates).catch(e => showToast(`Lỗi: ${e.message}`, 'error'));
        }

        // === NEW FEATURES LOGIC ===
        function handleMentionInput(e) { /* Your mention logic from previous replies goes here */ }
        function shareLocation() { navigator.geolocation.getCurrentPosition(pos => sendChatMessage({ location: { lat: pos.coords.latitude, lng: pos.coords.longitude } }), err => showToast("Không thể lấy vị trí.", 'error')); }

        function initializeAgora() {
            agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
            agoraClient.on('user-published', async (user, mediaType) => { await agoraClient.subscribe(user, mediaType); if (mediaType === 'video') user.videoTrack.play('remote-video-container'); if (mediaType === 'audio') user.audioTrack.play(); });
            agoraClient.on('user-left', () => { document.getElementById('remote-video-container').innerHTML = ''; showToast('Người kia đã rời đi.'); endCall(false); });
        }
        
        async function startCall(callType) {
            if (!currentChat || activeCallInfo.isActive) return;
            const channel = (currentChat.type === 'private') ? (currentUser.uid < currentChat.uid ? `${currentUser.uid}_${currentChat.uid}` : `${currentChat.uid}_${currentChat.uid}`) : currentChat.id;
            const chatRoomId = channel;
            activeCallInfo.channel = channel;
            
            await agoraClient.join(AGORA_APP_ID, channel, null, currentUser.uid);

            if (callType === 'video') { [localTracks.audio, localTracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks(); localTracks.video.play('local-video-container'); } 
            else { localTracks.audio = await AgoraRTC.createMicrophoneAudioTrack(); }
            
            await agoraClient.publish(Object.values(localTracks).filter(Boolean));
            document.getElementById('call-container').style.display = 'flex';
            activeCallInfo.isActive = true;
            db.ref(`private_chats/${chatRoomId}/active_call`).set({ active: true, type: callType, initiatorId: currentUser.uid });
        }
        
        async function joinCall(callType) { if (activeCallInfo.isActive) return; await startCall(callType); }

        async function endCall(notifyDatabase = true) {
            if (!activeCallInfo.isActive) return;
            if (notifyDatabase) { db.ref(`private_chats/${activeCallInfo.channel}/active_call`).remove(); }
            Object.values(localTracks).forEach(track => { if(track) { track.stop(); track.close(); } });
            localTracks = { audio: null, video: null };
            await agoraClient.leave();
            document.getElementById('call-container').style.display = 'none';
            if (document.pictureInPictureElement) document.exitPictureInPicture();
            activeCallInfo = { isActive: false, channel: null };
        }
        
        async function togglePictureInPicture() { const v = document.querySelector('#remote-video-container video'); if (!v) return; try { document.pictureInPictureElement ? await document.exitPictureInPicture() : await v.requestPictureInPicture(); } catch(e) { console.error("PiP Error:", e); } }

        // === UTILITY FUNCTIONS ===
        const cloudinaryWidgetChat = cloudinary.createUploadWidget({ cloudName: CLOUDINARY_CLOUD_NAME, uploadPreset: CLOUDINARY_UPLOAD_PRESET, sources: ["local", "url"] }, (err, res) => { if (!err && res && "success" === res.event) { sendChatMessage({ imageUrl: res.info.secure_url }) } });
        function showToast(message, type = 'success') {
            const c=document.getElementById('toast-container'),t=document.createElement('div');
            t.style.cssText=`background:${type==='error'?'var(--danger-color)':'#4caf50'};color:white;padding:15px;border-radius:8px;margin-top:10px;box-shadow:var(--shadow);opacity:0;transform:translateX(100%);animation:toastIn .5s forwards;`;
            t.innerHTML=message; c.appendChild(t); setTimeout(()=>{t.style.animation='toastOut .5s forwards';t.addEventListener('animationend',()=>t.remove())},3000) 
        }
        if(!document.getElementById('toast-styles')) { document.head.insertAdjacentHTML("beforeend", `<style id="toast-styles">@keyframes toastIn{to{opacity:1;transform:translateX(0)}}@keyframes toastOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100%)}}</style>`);}
    </script>
</body>
</html>
