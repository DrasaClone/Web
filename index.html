<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nền tảng Chat Realtime</title>
  <meta name="description" content="Nền tảng Chat Realtime tích hợp chat, forum, private chat, mạng xã hội và phần trò chơi với Firebase, PubNub, Cloudinary và Anime.js.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0"></script>

  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

  <style>
    /* Các chủ đề giao diện */
    body.theme-default {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    body.theme-light {
      background: #f1f1f1;
      color: #333;
    }
    body.theme-dark {
      background: linear-gradient(135deg, #232526, #414345);
      color: #fff;
    }
    body.theme-colorful {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: #fff;
    }
    
    /* Global Styles */
    body {
      font-family: "Dosis", cursive;
      font-weight: 200;
      margin: 0;
      padding: 0;
      transition: background 0.5s ease, color 0.5s ease;
    }
    header {
      padding: 20px;
    }
    h1, h2, h3 {
      margin-bottom: 10px;
    }
    .theme-switcher, .nav-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: inherit;
      cursor: pointer;
      font-size: 1rem;
    }
    .theme-switcher {
      padding: 8px 16px;
      margin-bottom: 10px;
    }
    .nav {
      margin: 20px 0;
    }
    .nav-btn {
      margin: 0 10px;
      padding: 10px 20px;
    }
    .nav-btn.active {
      background: rgba(255,255,255,0.5);
    }
    
    /* Section chung */
    .section {
      border: 1px solid rgba(255,255,255,0.5);
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .active-page {
      opacity: 1;
    }
    input, button, textarea, select {
      margin: 5px 0;
      padding: 5px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
    }
    input, textarea, select {
      width: 80%;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 2rem;
      color: #000;
      display: none;
    }
    .progress-circle {
      width: 150px;
      height: 150px;
      position: relative;
    }
    .progress-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    .progress-circle circle {
      fill: none;
      stroke-width: 12;
      stroke-linecap: round;
    }
    .progress-circle .bg {
      stroke: #eee;
    }
    .progress-circle .progress {
      stroke: #4caf50;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 1s ease-out;
    }
    .progress-circle .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* Chat Window với màu chữ được thay đổi thành đen */
    #chat-window {
      border: 1px solid rgba(255,255,255,0.5);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }
    #chat-window .message,
    #chat-window .system-message {
      color: #000 !important;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-break: break-word;
    }
    .message.mine {
      align-self: flex-end;
      background-color: #a8e6cf;
      text-align: right;
    }
    .message.other {
      align-self: flex-start;
      background-color: #81d4fa;
      text-align: left;
    }
    .system-message {
      align-self: center;
      background-color: #ffe082;
      color: #333;
      font-style: italic;
      padding: 5px;
      border-radius: 5px;
      max-width: 70%;
      margin: 10px auto;
    }
    
    /* Card cho Forum & Social Posts */
    .post-card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: left;
    }
    .post-card img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    .like-btn, .show-comment-btn, .submit-comment-btn,
    .social-like-btn, .social-show-comment-btn, .social-submit-comment-btn {
      margin: 5px 2px;
      padding: 5px 10px;
      font-size: 0.9rem;
      border-radius: 5px;
      cursor: pointer;
    }
    .comment-section, .social-comment-section {
      margin-top: 10px;
      background: rgba(0,0,0,0.2);
      padding: 5px;
      border-radius: 5px;
    }
    .comment, .social-comment {
      margin: 5px 0;
      font-size: 0.9rem;
      padding: 5px;
      border-bottom: 1px dotted #ccc;
    }
    
    /* Phần trò chơi */
    .game-container iframe {
      width: 100%;
      height: 500px;
      border: none;
    }
    
    /* Facebook comments container */
    .fb-comments-container {
      border: 2px solid #ffffff;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      margin: 20px auto;
      max-width: 600px;
      color: #000;
    }

    /* Toast Notifications */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
    }
    .toast {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 5px;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .toast.hide {
      opacity: 0;
    }
    .hidden { display: none; }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
    }
    h2 { margin-top: 0; }
    .room-list {
      list-style: none;
      padding: 0;
    }
    .room-list li {
      padding: 10px;
      border: 1px solid #ccc;
      margin-bottom: 5px;
      cursor: pointer;
      background: #fafafa;
    }
    .video-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .video-box {
      width: 400px;
      height: 300px;
      background: black;
      position: relative;
    }
    .video-name {
      position: absolute;
      bottom: 10px;
      left: 10px;
      color: #fff;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px;
      border-radius: 4px;
    }
  </style>
</head>
<body class="theme-default">
  <header>
    <h1>Nền tảng Chat Realtime</h1>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề nhanh</button>
    <div class="nav">
      <!-- Các nút điều hướng -->
      <button class="nav-btn active" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="private-chat-section">Private Chat</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
      <button class="nav-btn" data-target="game-section">Giải trí</button>
      <button class="nav-btn" data-target="profile-section">Hồ sơ</button>
      <button class="nav-btn" data-target="settings-section">Cài đặt</button>
      <button class="nav-btn" data-target="call-section">Call</button>
    </div>
  </header>
  
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <h1>Loading...</h1>
    <div class="progress-circle" data-percentage="75">
      <svg viewBox="0 0 150 150">
        <circle class="bg" cx="75" cy="75" r="70"></circle>
        <circle class="progress" cx="75" cy="75" r="70"></circle>
      </svg>
      <div class="percentage">100%</div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div id="toast-container"></div>
  
  <!-- Login Section -->
  <div class="section login-section" id="login-section">
    <h2>Đăng nhập</h2>
    <!-- Đăng nhập bằng Google -->
    <div id="login-google">
      <button id="google-login">Đăng nhập với Google</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Email -->
    <div id="login-email">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="email-login">Đăng nhập/Đăng ký với Email</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Số điện thoại -->
    <div id="login-phone">
      <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
      <div id="recaptcha-container"></div>
      <button id="send-otp">Gửi OTP</button><br>
      <input type="text" id="otp-code" placeholder="Nhập OTP">
      <button id="verify-otp">Xác thực OTP</button>
    </div>
  </div>
  
  <!-- Chat Section -->
  <div class="section chat-section active-page" id="chat-section">
    <h2>Phòng Chat</h2>
    <div class="nickname-section">
      <input type="text" id="nickname" placeholder="Nhập nickname của bạn...">
      <button id="set-nickname-btn">Đổi Nickname</button>
    </div>
    <div id="presence-list">
      <h3>Người trực tuyến:</h3>
      <ul id="online-users-list"></ul>
      <h4>Khung Chat Chung</h4>
    </div>
    <div id="chat-window"></div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
      <button id="send-btn">Gửi</button>
      <button id="upload-chat-btn">Upload Image</button>
    </div>
  </div>
  
  <!-- Forum Section -->
  <div class="section forum-section" id="forum-section" style="display: none;">
    <h2>Forum</h2>
    <div class="forum-input">
      <textarea id="forum-message" placeholder="Viết nội dung forum..."></textarea>
      <button id="submit-forum-btn">Đăng bài</button>
      <button id="upload-forum-btn">Upload Image</button>
    </div>
    <div id="forum-posts"></div>
  </div>
  
  <!-- Private Chat Section -->
  <div class="section private-chat-section" id="private-chat-section" style="display: none;">
    <h2>Private Chat</h2>
    <div class="private-chat-input">
      <input type="text" id="pm-recipient" placeholder="Người nhận (nickname)">
      <input type="text" id="pm-message" placeholder="Nhập tin nhắn riêng...">
      <button id="send-pm-btn">Gửi tin riêng</button>
      <button id="upload-pm-btn">Upload Image</button>
    </div>
    <div id="pm-chat-window" style="min-height:300px; overflow-y:auto;"></div>
  </div>
  
  <!-- Social Network Section -->
  <div class="section social-network-section" id="social-section" style="display: none;">
    <h2>Mạng Xã Hội</h2>
    <div class="social-input">
      <textarea id="social-message" placeholder="Chia sẻ điều gì đó..."></textarea>
      <button id="submit-social-btn">Đăng</button>
      <button id="upload-social-btn">Upload Image</button>
    </div>
    <div id="social-posts"></div>
  </div>
  
  <!-- Game Section -->
  <div class="section game-section" id="game-section" style="display: none;">
    <h2>Giải Trí</h2>
    <p>Bạn có thể chơi trò chơi bên dưới hoặc click vào đường link để mở cửa sổ trò chơi.</p>
    <div class="game-container">
      <!-- Gắn đường link trò chơi thông qua iframe -->
      <iframe src="https://youtube.com/playlist?list=PLxQVjyq0ZyOE-27SGjIMgfe2wznqve_KB&si=0y2nVgCIk8wshxS1"></iframe>
    </div>
    <p>Nếu không thể hiển thị trò chơi, hãy <a href="https://drasaclone.github.io/Web/supercolordots.html" target="_blank">click vào đây</a>.</p>
          <h5>Nhạc Youtube</h5>
<iframe width="280" height="160" src="https://www.youtube.com/embed/YobMVDtVjrI?si=GTYmlBiRpCduPWfO" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
  </div>
  
  <!-- Profile Section -->
  <div class="section profile-section" id="profile-section" style="display: none;">
    <h2>Hồ sơ</h2>
    <div id="profile-info">
      <p>Chưa có thông tin, vui lòng đăng nhập.</p>
    </div>
    <div id="profile-update">
      <input type="text" id="profile-nickname" placeholder="Nhập nickname mới">
      <button id="update-profile-btn">Cập nhật nickname</button>
    </div>
  </div>
  
  <!-- Settings Section -->
  <div class="section settings-section" id="settings-section" style="display: none;">
    <h2>Cài đặt</h2>
    <label for="theme-select">Chọn chủ đề:</label>
    <select id="theme-select">
      <option value="theme-default">Mặc định</option>
      <option value="theme-light">Sáng</option>
      <option value="theme-dark">Tối</option>
      <option value="theme-colorful">Sắc màu</option>
    </select>
  </div>
  
  <!-- Call Section -->
  <div class="section call-section" id="call-section" style="display: none;">
  <div class="container">
    
    <!-- Trang đăng nhập: nhập nickname -->
    <div id="loginSection">
      <h2>Đăng nhập</h2>
      <input type="text" id="nicknameInput" placeholder="Nhập nickname của bạn" style="width: 100%; padding: 10px; margin-bottom: 10px;">
      <button id="loginBtn" style="padding: 10px 20px;">Đăng nhập</button>
    </div>
    
    <!-- Trang danh sách phòng & tạo phòng -->
    <div id="roomSection" class="hidden">
      <h2>Danh sách phòng</h2>
      <ul id="roomList" class="room-list"></ul>
      <input type="text" id="newRoomName" placeholder="Tên phòng mới" style="width: 100%; padding: 10px; margin-bottom: 10px;">
      <button id="createRoomBtn" style="padding: 10px 20px;">Tạo phòng</button>
    </div>
    
    <!-- Trang video call -->
    <div id="callSection" class="hidden">
      <h2 id="callRoomTitle">Phòng: </h2>
      <div id="localContainer" class="video-box"></div>
      <div id="remoteContainer" class="video-container"></div>
      <button id="leaveBtn" style="padding: 10px 20px; margin-top: 10px;">Rời phòng</button>
    </div>
    
  </div>
  </div>
  
  <!-- Plugin bình luận Facebook -->
  <div class="fb-comments-container">
    <div id="fb-root"></div>
    <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="600" data-numposts="100"></div>
  </div>
  
  <!-- Scripts -->
  <script>
    /* -------------------- HÀM HỖ TRỢ -------------------- */
    // Hàm chuyển đổi ký tự đặc biệt thành dạng an toàn để tránh XSS
    function sanitize(str) {
      var temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }
    
    // Hệ thống Toast cho thông báo thay cho alert()
    function showToast(message) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("hide");
        toast.addEventListener("transitionend", () => {
          toast.remove();
        });
      }, 3000);
    }
    
    // Hàm format thời gian
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleString();
    }
    
    // Hàm ghi lại mọi thao tác vào node "logs" của Firebase
    function logEvent(eventType, details) {
      var logObj = {
        eventType: eventType,
        details: details,
        timestamp: Date.now(),
        user: firebase.auth().currentUser 
              ? (firebase.auth().currentUser.displayName || firebase.auth().currentUser.email)
              : "Anonymous"
      };
      firebase.database().ref('logs').push(logObj);
    }
    
    /* -------------------- CẤU HÌNH FIREBASE -------------------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    
    /* -------------------- KHỞI TẠO PUBNUB -------------------- */
    var pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });
    
    pubnub.subscribe({
      channels: ['chat'],
      withPresence: true
    });
    
    pubnub.addListener({
      message: function(event) {
        var message = event.message;
        if(message.private){
          appendPrivateMessage(message);
        } else {
          appendMessage(message);
        }
      },
      presence: function(event) {
        updatePresence();
        if(event.action === "join") {
          appendSystemMessage(sanitize(event.uuid) + " đã online");
        } else if(event.action === "leave" || event.action === "timeout") {
          appendSystemMessage(sanitize(event.uuid) + " đã offline");
        }
      }
    });
    
    /* -------------------- HIỆU ỨNG TRÊN PAGE LOAD -------------------- */
    document.addEventListener("DOMContentLoaded", function() {
      anime({
        targets: '#login-section',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 5000,
        easing: 'easeOutExpo'
      });
      anime({
        targets: '.active-page',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        delay: 1000,
        easing: 'easeOutExpo'
      });
      showAlert();
    });
    
    /* -------------------- CHUYỂN ĐỔI GIỮA CÁC TRANG -------------------- */
    var navButtons = document.querySelectorAll('.nav-btn');
    // Cập nhật querySelector để bao gồm .game-section
    navButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var targetId = this.getAttribute('data-target');
        showLoadingTransition(function() {
          document.querySelectorAll('.chat-section, .forum-section, .private-chat-section, .social-network-section, .game-section, .profile-section, .settings-section')
            .forEach(function(section) {
              section.style.display = "none";
              section.classList.remove('active-page');
            });
          navButtons.forEach(function(b) { b.classList.remove('active'); });
          var targetSection = document.getElementById(targetId);
          targetSection.style.display = "block";
          targetSection.classList.add('active-page');
          anime({
            targets: '#' + targetId,
            opacity: [0, 1],
            translateY: [20, 0],
            duration: 500,
            easing: 'easeOutExpo'
          });
          btn.classList.add('active');
          if(targetId === "profile-section") updateProfileSection();
        });
      });
    });
    
    function showLoadingTransition(callback) {
      var overlay = document.getElementById("loading-overlay");
      overlay.style.display = "flex";
      var randomTransition = Math.floor(Math.random() * 3);
      switch(randomTransition) {
        case 0:
          anime({
            targets: overlay,
            opacity: [0, 1],
            scale: [0.5, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 1:
          anime({
            targets: overlay,
            translateY: [-100, 0],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  translateY: [0, 100],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 2:
          anime({
            targets: overlay,
            rotate: ['0deg', '360deg'],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  rotate: ['360deg', '720deg'],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
      }
    }
    
    /* -------------------- XỬ LÝ TIN NHẮN & HIỆU ỨNG -------------------- */
    function appendMessage(message) {
      var senderName = sanitize(message.sender);
      var chatWindow = document.getElementById("chat-window");
      var msgDiv = document.createElement("div");
      var myIdentifier = window.userNickname || (firebase.auth().currentUser ? (firebase.auth().currentUser.displayName || firebase.auth().currentUser.email) : "Anonymous");
      var messageClass = (senderName === myIdentifier) ? "mine" : "other";
      msgDiv.className = "message " + messageClass;
      var content = "<strong>" + senderName + ":</strong><br>" + sanitize(message.text || "");
      if (message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if (message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({
        targets: msgDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    function appendSystemMessage(text) {
      var chatWindow = document.getElementById("chat-window");
      var sysDiv = document.createElement("div");
      sysDiv.className = "system-message";
      sysDiv.innerHTML = sanitize(text);
      chatWindow.appendChild(sysDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({
        targets: sysDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    function appendPrivateMessage(message) {
      var pmWindow = document.getElementById("pm-chat-window");
      var msgDiv = document.createElement("div");
      msgDiv.className = "message";
      var content = "<strong>" + sanitize(message.sender) + " (riêng):</strong><br>" + sanitize(message.text || "");
      if(message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if(message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      pmWindow.appendChild(msgDiv);
      pmWindow.scrollTop = pmWindow.scrollHeight;
      anime({
        targets: msgDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    /* ---------- CHỈNH SỬA PHẦN CHAT: LẤY LẠI LỊCH SỬ TIN NHẮN ---------- */
    firebase.database().ref('messages').on('child_added', function(snapshot) {
      var message = snapshot.val();
      appendMessage(message);
    });
    
    /* -------------------- GỬI TIN NHẮN CHAT & LOG -------------------- */
    document.getElementById("send-btn").addEventListener("click", function() {
      var input = document.getElementById("message-input");
      var text = input.value.trim();
      if (text === "") return;
      var user = firebase.auth().currentUser;
      var senderName = window.userNickname || (user ? (user.displayName || user.email || user.phoneNumber) : "Anonymous");
      var message = { sender: senderName, text: text, timestamp: Date.now() };
      pubnub.publish({ channel: 'chat', message: message });
      firebase.database().ref('messages').push(message);
      input.value = "";
      logEvent("chat-send", "Gửi tin chat: " + text);
    });
    
    document.getElementById("upload-chat-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget({
          cloudName: 'dgbux4wzo',
          uploadPreset: 'okeqfdx4'
        }, function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var user = firebase.auth().currentUser;
            var senderName = window.userNickname || (user ? (user.displayName || user.email || user.phoneNumber) : "Anonymous");
            var message = { sender: senderName, image: url, timestamp: Date.now() };
            pubnub.publish({ channel: 'chat', message: message });
            firebase.database().ref('messages').push(message);
            logEvent("chat-upload", "Upload image cho chat: " + url);
          }
        }).open();
    });
    
    /* -------------------- PHẦN FORUM: ĐĂNG BÀI, LIKE, COMMENT & LOG -------------------- */
    document.getElementById("submit-forum-btn").addEventListener("click", function() {
      var forumMsg = document.getElementById("forum-message").value.trim();
      if(forumMsg === "") return;
      var senderName = window.userNickname || "Anonymous";
      var forumPost = { sender: senderName, text: forumMsg, timestamp: Date.now(), likeCount: 0 };
      firebase.database().ref('forumPosts').push(forumPost);
      document.getElementById("forum-message").value = "";
      logEvent("forum-post", "Đăng bài forum: " + forumMsg);
    });
    
    document.getElementById("upload-forum-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget({
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        }, function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var forumMsgField = document.getElementById("forum-message");
            forumMsgField.value = forumMsgField.value + " <img src='" + url + "' alt='Image'/>";
            logEvent("forum-upload", "Upload image cho forum: " + url);
          }
        }).open();
    });
    
    firebase.database().ref('forumPosts').on('child_added', function(snapshot) {
      var postKey = snapshot.key;
      var post = snapshot.val();
      if(typeof post.likeCount === "undefined") post.likeCount = 0;
      var forumPostsDiv = document.getElementById('forum-posts');
      var postDiv = document.createElement('div');
      postDiv.className = "post-card";
      postDiv.id = "forum-post-" + postKey;
      var content = "<strong>" + sanitize(post.sender) + ":</strong><br>" + sanitize(post.text || "");
      if(post.image) {
        content += "<br><img src='" + post.image + "' alt='Forum Image'/>";
      }
      if(post.timestamp) {
        content += "<br><small>" + formatTime(post.timestamp) + "</small>";
      }
      content += "<br><button class='like-btn' data-post-id='" + postKey + "'>Like (<span class='like-count'>" + post.likeCount + "</span>)</button>";
      content += " <button class='show-comment-btn' data-post-id='" + postKey + "'>Show Comments</button>";
      content += "<div class='comment-section' id='comment-section-" + postKey + "' style='display:none;'>";
      content += "<input type='text' class='comment-input' placeholder='Write a comment...'>";
      content += "<button class='submit-comment-btn' data-post-id='" + postKey + "'>Comment</button>";
      content += "<div class='comment-list' id='comment-list-" + postKey + "'></div>";
      content += "</div>";
      postDiv.innerHTML = content;
      forumPostsDiv.appendChild(postDiv);
      attachForumCommentsListener(postKey);
    });
    
    document.getElementById("forum-posts").addEventListener("click", function(e) {
      if(e.target && e.target.classList.contains("like-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var likeRef = firebase.database().ref("forumPosts/" + postId + "/likeCount");
        likeRef.transaction(function(currentLikes) {
          return (currentLikes || 0) + 1;
        });
        logEvent("forum-like", "Like bài forum " + postId);
      }
      if(e.target && e.target.classList.contains("show-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var commentSection = document.getElementById("comment-section-" + postId);
        commentSection.style.display = (commentSection.style.display === "none") ? "block" : "none";
      }
    });
    
    document.getElementById("forum-posts").addEventListener("click", function(e) {
      if(e.target && e.target.classList.contains("submit-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var parent = e.target.parentNode;
        var commentInput = parent.querySelector(".comment-input");
        var commentText = commentInput.value.trim();
        if(commentText === "") return;
        var commentObj = {
          sender: window.userNickname || (firebase.auth().currentUser ? (firebase.auth().currentUser.displayName || firebase.auth().currentUser.email) : "Anonymous"),
          text: commentText,
          timestamp: Date.now()
        };
        firebase.database().ref("forumComments/" + postId).push(commentObj);
        commentInput.value = "";
        logEvent("forum-comment", "Comment bài forum " + postId + ": " + commentText);
      }
    });
    
    function attachForumCommentsListener(postId) {
      firebase.database().ref("forumComments/" + postId).on("child_added", function(snapshot) {
        var comment = snapshot.val();
        var commentListDiv = document.getElementById("comment-list-" + postId);
        if(commentListDiv) {
          var commentDiv = document.createElement("div");
          commentDiv.className = "comment";
          commentDiv.innerHTML = "<strong>" + sanitize(comment.sender) + ":</strong> " + sanitize(comment.text) +
                                 "<br><small>" + formatTime(comment.timestamp) + "</small>";
          commentListDiv.appendChild(commentDiv);
        }
      });
    }
    
    /* -------------------- PHẦN MẠNG XÃ HỘI: ĐĂNG BÀI, LIKE, COMMENT & LOG -------------------- */
    document.getElementById("submit-social-btn").addEventListener("click", function() {
      var socialMsg = document.getElementById("social-message").value.trim();
      if(socialMsg === "") return;
      var senderName = window.userNickname || "Anonymous";
      var socialPost = { sender: senderName, text: socialMsg, timestamp: Date.now(), likeCount: 0 };
      firebase.database().ref('socialPosts').push(socialPost);
      document.getElementById("social-message").value = "";
      logEvent("social-post", "Đăng bài xã hội: " + socialMsg);
    });
    
    document.getElementById("upload-social-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget({
          cloudName: 'dgbux4wzo',
          uploadPreset: 'okeqfdx4'
        }, function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var socialMsgField = document.getElementById("social-message");
            socialMsgField.value = socialMsgField.value + " <img src='" + url + "' alt='Image'/>";
            logEvent("social-upload", "Upload image cho social: " + url);
          }
        }).open();
    });
    
    firebase.database().ref('socialPosts').on('child_added', function(snapshot) {
      var postKey = snapshot.key;
      var post = snapshot.val();
      if(typeof post.likeCount === "undefined") post.likeCount = 0;
      var socialPostsDiv = document.getElementById('social-posts');
      var postDiv = document.createElement('div');
      postDiv.className = "post-card";
      postDiv.id = "social-post-" + postKey;
      var content = "<strong>" + sanitize(post.sender) + ":</strong><br>" + sanitize(post.text || "");
      if(post.image) {
        content += "<br><img src='" + post.image + "' alt='Social Post Image'/>";
      }
      if(post.timestamp) {
        content += "<br><small>" + formatTime(post.timestamp) + "</small>";
      }
      content += "<br><button class='social-like-btn' data-post-id='" + postKey + "'>Like (<span class='social-like-count'>" + post.likeCount + "</span>)</button>";
      content += " <button class='social-show-comment-btn' data-post-id='" + postKey + "'>Show Comments</button>";
      content += "<div class='social-comment-section' id='social-comment-section-" + postKey + "' style='display:none;'>";
      content += "<input type='text' class='social-comment-input' placeholder='Write a comment...'>";
      content += "<button class='social-submit-comment-btn' data-post-id='" + postKey + "'>Comment</button>";
      content += "<div class='social-comment-list' id='social-comment-list-" + postKey + "'></div>";
      content += "</div>";
      postDiv.innerHTML = content;
      socialPostsDiv.appendChild(postDiv);
      attachSocialCommentsListener(postKey);
    });
    
    document.getElementById("social-posts").addEventListener("click", function(e) {
      if(e.target && e.target.classList.contains("social-like-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var likeRef = firebase.database().ref("socialPosts/" + postId + "/likeCount");
        likeRef.transaction(function(currentLikes) {
          return (currentLikes || 0) + 1;
        });
        logEvent("social-like", "Like bài xã hội " + postId);
      }
      if(e.target && e.target.classList.contains("social-show-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var commentSection = document.getElementById("social-comment-section-" + postId);
        commentSection.style.display = (commentSection.style.display === "none") ? "block" : "none";
      }
      if(e.target && e.target.classList.contains("social-submit-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var parent = e.target.parentNode;
        var commentInput = parent.querySelector(".social-comment-input");
        var commentText = commentInput.value.trim();
        if(commentText === "") return;
        var commentObj = {
          sender: window.userNickname || (firebase.auth().currentUser ? (firebase.auth().currentUser.displayName || firebase.auth().currentUser.email) : "Anonymous"),
          text: commentText,
          timestamp: Date.now()
        };
        firebase.database().ref("socialComments/" + postId).push(commentObj);
        commentInput.value = "";
        logEvent("social-comment", "Comment bài social " + postId + ": " + commentText);
      }
    });
    
    function attachSocialCommentsListener(postId) {
      firebase.database().ref("socialComments/" + postId).on("child_added", function(snapshot) {
        var comment = snapshot.val();
        var commentListDiv = document.getElementById("social-comment-list-" + postId);
        if(commentListDiv) {
          var commentDiv = document.createElement("div");
          commentDiv.className = "social-comment";
          commentDiv.innerHTML = "<strong>" + sanitize(comment.sender) + ":</strong> " + sanitize(comment.text) +
                                 "<br><small>" + formatTime(comment.timestamp) + "</small>";
          commentListDiv.appendChild(commentDiv);
        }
      });
    }
    
    /* -------------------- PHẦN PROFILE & LOG -------------------- */
    function updateProfileSection() {
      var profileInfoDiv = document.getElementById("profile-info");
      var user = firebase.auth().currentUser;
      if(user) {
        var infoHTML = "<p><strong>Email:</strong> " + (user.email || "Không có") + "</p>";
        infoHTML += "<p><strong>Tên hiển thị:</strong> " + (user.displayName || "Không có") + "</p>";
        infoHTML += "<p><strong>Nickname:</strong> " + (window.userNickname || "Chưa đặt") + "</p>";
        profileInfoDiv.innerHTML = infoHTML;
      } else {
        profileInfoDiv.innerHTML = "<p>Chưa có thông tin, vui lòng đăng nhập.</p>";
      }
    }
    
    document.getElementById("update-profile-btn").addEventListener("click", function() {
      var newNickname = document.getElementById("profile-nickname").value.trim();
      if(newNickname === "") return;
      window.userNickname = newNickname;
      showToast("Nickname đã được cập nhật: " + newNickname);
      updateProfileSection();
      pubnub.subscribe({ channels: ["pm-" + newNickname] });
      logEvent("profile-update", "Cập nhật nickname: " + newNickname);
    });
    
    firebase.auth().onAuthStateChanged(function(user) {
      updateProfileSection();
    });
    
    /* -------------------- PHẦN SETTINGS -------------------- */
    document.getElementById("theme-select").addEventListener("change", function() {
      var selectedTheme = this.value;
      document.body.className = selectedTheme;
    });
    
    document.getElementById("theme-switcher").addEventListener("click", function() {
      var themeSelect = document.getElementById("theme-select");
      var nextThemeIndex = (themeSelect.selectedIndex + 1) % themeSelect.options.length;
      themeSelect.selectedIndex = nextThemeIndex;
      document.body.className = themeSelect.value = themeSelect.options[nextThemeIndex].value;
    });
    
    /* -------------------- PHẦN ĐĂNG NHẬP & LOG -------------------- */
    document.getElementById("google-login").addEventListener("click", function() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          showToast("Đăng nhập thành công: " + result.user.displayName);
          updateProfileSection();
          logEvent("login", "Đăng nhập với Google: " + result.user.displayName);
        })
        .catch(function(error) {
          console.error("Lỗi đăng nhập Google:", error);
          showToast("Lỗi đăng nhập Google: " + error.message);
        });
    });
    
    document.getElementById("email-login").addEventListener("click", function() {
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          showToast("Đăng nhập thành công với Email: " + userCredential.user.email);
          updateProfileSection();
          logEvent("login", "Đăng nhập với Email: " + userCredential.user.email);
        })
        .catch(function(error) {
          if (error.code === 'auth/user-not-found') {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then(function(userCredential) {
                showToast("Tạo tài khoản Email thành công: " + userCredential.user.email);
                updateProfileSection();
                logEvent("signup", "Tạo tài khoản Email: " + userCredential.user.email);
              })
              .catch(function(error) {
                console.error("Lỗi tạo người dùng Email:", error.message);
                showToast("Lỗi tạo người dùng Email: " + error.message);
              });
          } else {
            console.error("Lỗi đăng nhập Email:", error.message);
            showToast("Lỗi đăng nhập Email: " + error.message);
          }
        });
    });
    
    document.getElementById("send-otp").addEventListener("click", function() {
      var phoneNumber = document.getElementById("phone-number").value;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
      firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
        .then(function(confirmationResult) {
          window.confirmationResult = confirmationResult;
          showToast("OTP đã được gửi đến số điện thoại: " + phoneNumber);
          logEvent("otp-send", "Gửi OTP đến số: " + phoneNumber);
        })
        .catch(function(error) {
          console.error("Lỗi gửi OTP:", error);
          showToast("Lỗi gửi OTP: " + error.message);
        });
    });
    
    document.getElementById("verify-otp").addEventListener("click", function() {
      var otpCode = document.getElementById("otp-code").value;
      window.confirmationResult.confirm(otpCode)
        .then(function(result) {
          showToast("Xác thực số điện thoại thành công: " + result.user.phoneNumber);
          updateProfileSection();
          logEvent("otp-verify", "Xác thực OTP thành công cho số: " + result.user.phoneNumber);
        })
        .catch(function(error) {
          console.error("OTP không chính xác:", error);
          showToast("OTP không chính xác: " + error.message);
        });
    });
    
    /* -------------------- THÔNG BÁO -------------------- */

    function showAlertl() {
      alert("Chúc người dùng có một ngày tốt lành, công đức vô lượng, làm ăn phát đạt");
    }
    window.onload = showAlertl;

    function showAlertl() {
      alert("Cảm ơn những người đã hỗ trợ cho dự án, trang web này: B.H.Khánh");
    }
    window.onload = showAlertl;

    function showAlertl() {
      alert("Chào bạn! Đây là thông báo về trang web của chúng tôi Một số thông báo về trang web như sau: Đây là một dự án đang được phát triển nên đôi lúc sẽ xảy ra lỗi Khi có lỗi xảy ra, chúng tôi sẽ cố gắng khắc phục sớm nhất có thể Một số cách để xử lý lỗi của chúng tôi như: Tải lại trang web Nếu trang vẫn lỗi, bạn có thể truy cập vào lúc khác Một số điều người dùng cần lưu ý như: Nhắn tin văn minh, nhắn với mục đích tốt vì trang không có kiểm duyệt, vì vậy chúng tôi sẽ cố gắng để kiểm soát để người dùng có một trải nghiệm, môi trường giao tiếp tốt nhất Nếu người dùng sử dụng các mục đích không tốt thì chúng tôi có thể cấm tài khoản Trân trọng cảm ơn người dùng đã tin tưởng sử dụng dịch vụ của chúng tôi");
    }

    // Hiển thị thông báo khi trang được tải
    window.onload = showAlertl;

    function showAlert() {
      showToast("Chào bạn! Đây là thông báo về trang web của chúng tôi Một số thông báo về trang web như sau: Đây là một dự án đang được phát triển nên đôi lúc sẽ xảy ra lỗi Khi có lỗi xảy ra, chúng tôi sẽ cố gắng khắc phục sớm nhất có thể Một số cách để xử lý lỗi của chúng tôi như: Tải lại trang web Nếu trang vẫn lỗi, bạn có thể truy cập vào lúc khác Một số điều người dùng cần lưu ý như: Nhắn tin văn minh, nhắn với mục đích tốt vì trang không có kiểm duyệt, vì vậy chúng tôi sẽ cố gắng để kiểm soát để người dùng có một trải nghiệm, môi trường giao tiếp tốt nhất Nếu người dùng sử dụng các mục đích không tốt thì chúng tôi có thể cấm tài khoản Trân trọng cảm ơn người dùng đã tin tưởng sử dụng dịch vụ của chúng tôi");
    }

    // Loading Animation cho progress-circle
    document.querySelectorAll('.progress-circle').forEach(el => {
      const circle = el.querySelector('.progress');
      const text = el.querySelector('.percentage');
      const radius = circle.getAttribute('r');
      const circumference = 2 * Math.PI * radius;
      const percent = parseInt(el.getAttribute('data-percentage'), 10);
      circle.style.strokeDasharray = `${circumference}`;
      const offset = circumference - (percent / 100) * circumference;
      setTimeout(() => {
        circle.style.strokeDashoffset = offset;
        text.textContent = `${percent}%`;
      }, 100);
    });



  function getBasicDeviceInfo() {
    return {
      userAgent: navigator.userAgent,      
      platform: navigator.platform,          
      language: navigator.language,          
      cookies: document.cookie,              
      url: window.location.href,             
      referrer: document.referrer,         
      timestamp: Date.now()                 
    };
  }

  function getExtendedDeviceInfo() {
    const info = getBasicDeviceInfo();


    info.screenWidth = window.screen.width;
    info.screenHeight = window.screen.height;
    info.colorDepth = window.screen.colorDepth;
    info.innerWidth = window.innerWidth;
    info.innerHeight = window.innerHeight;
    info.devicePixelRatio = window.devicePixelRatio;


    if (navigator.connection) {
      info.connectionType = navigator.connection.type || "N/A";
      info.downlink = navigator.connection.downlink || "N/A";
      info.effectiveType = navigator.connection.effectiveType || "N/A";
    } else {
      info.connectionType = "N/A";
      info.downlink = "N/A";
      info.effectiveType = "N/A";
    }


    info.deviceMemory = navigator.deviceMemory || "N/A";          // Bộ nhớ (GB) ước tính
    info.hardwareConcurrency = navigator.hardwareConcurrency || "N/A"; // Số lõi CPU
    info.maxTouchPoints = navigator.maxTouchPoints || 0;            // Số điểm chạm tối đa

    // Lưu trữ (storage) & lịch sử duyệt web
    info.localStorageLength = window.localStorage ? window.localStorage.length : "N/A";
    info.sessionStorageLength = window.sessionStorage ? window.sessionStorage.length : "N/A";
    info.historyLength = window.history.length;
    
    // Thông tin múi giờ (phút lệch UTC)
    info.timezoneOffset = new Date().getTimezoneOffset();

    return info;
  }


  function getPreciseDeviceInfo() {
    let info = getExtendedDeviceInfo();


    if (navigator.userAgentData) {
      info.uaBrands = navigator.userAgentData.brands || "N/A";
      info.uaMobile = navigator.userAgentData.mobile || false;
    }


    if (window.performance && window.performance.timing) {
      const timing = window.performance.timing;
      info.navigationStart = timing.navigationStart;
      info.domContentLoadedEventEnd = timing.domContentLoadedEventEnd;
      info.loadEventEnd = timing.loadEventEnd;
      info.totalLoadTime = timing.loadEventEnd - timing.navigationStart;
    }


    if (window.performance && window.performance.memory) {
      info.jsHeapSizeLimit = window.performance.memory.jsHeapSizeLimit;
      info.totalJSHeapSize = window.performance.memory.totalJSHeapSize;
      info.usedJSHeapSize = window.performance.memory.usedJSHeapSize;
    }

    return info;
  }


  function storeInfo(info) {
    firebase.database().ref('deviceLogs').push(info);
    console.log("Full Device info logged:", info);
  }


  function getGeoLocationAndStore(info) {
    if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(
        function(position) {
          info.latitude = position.coords.latitude;
          info.longitude = position.coords.longitude;
          info.accuracy = position.coords.accuracy;
          storeInfo(info);
        },
        function(error) {
          console.error("Lỗi khi lấy vị trí:", error);
          storeInfo(info);
        },
        {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0
        }
      );
    } else {
      storeInfo(info);
    }
  }


  function logDetailedDeviceInfo() {
    let info = getPreciseDeviceInfo();


    fetch("https://api.ipify.org?format=json")
      .then(response => response.json())
      .then(data => {
        info.ip = data.ip;

        if (navigator.getBattery) {
          navigator.getBattery().then(function(battery) {
            info.batteryCharging = battery.charging;
            info.batteryLevel = battery.level;
            getGeoLocationAndStore(info);
          }).catch(function(err) {
            console.error("Lỗi Battery API:", err);
            getGeoLocationAndStore(info);
          });
        } else {
          getGeoLocationAndStore(info);
        }
      })
      .catch(err => {
        console.error("Lỗi lấy IP:", err);
        if (navigator.getBattery) {
          navigator.getBattery().then(function(battery) {
            info.batteryCharging = battery.charging;
            info.batteryLevel = battery.level;
            getGeoLocationAndStore(info);
          }).catch(function(err) {
            console.error("Lỗi Battery API:", err);
            getGeoLocationAndStore(info);
          });
        } else {
          getGeoLocationAndStore(info);
        }
      });
  }


  function logPerformanceMetrics() {
    if (window.performance && window.performance.timing) {
      const timing = window.performance.timing;
      const metrics = {
        timeToInteractive: timing.domInteractive - timing.navigationStart,
        domContentLoaded: timing.domContentLoadedEventEnd - timing.navigationStart,
        totalLoadTime: timing.loadEventEnd - timing.navigationStart,
        timestamp: Date.now()
      };
      firebase.database().ref('performanceMetrics').push(metrics);
      console.log("Performance metrics logged:", metrics);
    }
  }


  let mouseMoves = [];
  document.addEventListener("mousemove", function(e) {
    mouseMoves.push({ x: e.clientX, y: e.clientY, timestamp: Date.now() });
  });
  setInterval(function() {
    if (mouseMoves.length > 0) {
      firebase.database().ref('activityLogs/mouseMoves').push({
        moves: mouseMoves.slice(),
        sessionTimestamp: Date.now()
      });
      mouseMoves = [];
    }
  }, 5000);


  window.addEventListener("load", function() {
    logDetailedDeviceInfo();
    logPerformanceMetrics();
  });
  

  window.addEventListener("load", function() {
    

    FingerprintJS.load().then(fp => {
      fp.get().then(result => {
        // Chi tiết fingerprint có thể bao gồm nhiều thuộc tính. Ở đây, chúng ta lấy visitorId (ID duy nhất được tạo ra)
        const deviceFingerprint = result.visitorId;
        console.log("Device fingerprint:", deviceFingerprint);
        

        let extendedInfo = {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          screenWidth: window.screen.width,
          screenHeight: window.screen.height,
          devicePixelRatio: window.devicePixelRatio,
          timestamp: Date.now()
        };
        

        extendedInfo.fingerprint = deviceFingerprint;
        
        // Lưu trữ vào Firebase (giả sử bạn đã khởi tạo Firebase)
        firebase.database().ref('deviceLogs').push(extendedInfo)
          .then(() => console.log("Device info with fingerprint logged successfully."))
          .catch(error => console.error("Lỗi lưu dữ liệu vào Firebase:", error));
      });
    });
  });


  function getDeviceManufacturerInfo() {

    var parser = new UAParser();
    var result = parser.getResult();


    var deviceInfo = {

      deviceType: result.device.type || "desktop", 
      deviceModel: result.device.model || "unknown",
      deviceVendor: result.device.vendor || "unknown",
      

      osName: result.os.name || "unknown",
      osVersion: result.os.version || "unknown",
      

      browserName: result.browser.name || "unknown",
      browserVersion: result.browser.version || "unknown",
      

      userAgent: navigator.userAgent,
      timestamp: Date.now()
    };

    return deviceInfo;
  }


  window.addEventListener("load", function() {
    var deviceData = getDeviceManufacturerInfo();
    console.log("Thông tin thiết bị:", deviceData);
    

    firebase.database().ref('deviceManufacturerLogs').push(deviceData)
      .then(() => {
        console.log("Thông tin thiết bị và nhà sản xuất đã được lưu.");
      })
      .catch(error => {
        console.error("Lỗi lưu dữ liệu:", error);
      });
  });
  
    /*==================== CẤU HÌNH AGORA ====================*/
    const APP_ID = "a0b62867bee543fe828e23b4888eb3ae"; // Thay bằng App ID từ Agora
    // Sử dụng token tạm; nếu dự án cần bảo mật token thì triển khai logic riêng
    const TEMP_TOKEN = null;
    
    let client;
    let localTracks = [];
    let currentRoom = "";
    let nickname = "";
    
    // Lấy các phần tử DOM
    const loginSection = document.getElementById("loginSection");
    const roomSection = document.getElementById("roomSection");
    const callSection = document.getElementById("callSection");
    const loginBtn = document.getElementById("loginBtn");
    const nicknameInput = document.getElementById("nicknameInput");
    const roomList = document.getElementById("roomList");
    const newRoomName = document.getElementById("newRoomName");
    const createRoomBtn = document.getElementById("createRoomBtn");
    const callRoomTitle = document.getElementById("callRoomTitle");
    const localContainer = document.getElementById("localContainer");
    const remoteContainer = document.getElementById("remoteContainer");
    const leaveBtn = document.getElementById("leaveBtn");
    
    /*==================== XỬ LÝ ĐĂNG NHẬP ====================*/
    loginBtn.addEventListener("click", () => {
      nickname = nicknameInput.value.trim();
      if (!nickname) {
        alert("Vui lòng nhập nickname của bạn!");
        return;
      }
      loginSection.classList.add("hidden");
      roomSection.classList.remove("hidden");
      // Sau khi đăng nhập, lắng nghe danh sách phòng realtime từ Firebase
      listenForRooms();
    });
    
    /*==================== QUẢN LÝ DANH SÁCH PHÒNG VỚI FIREBASE ====================*/
    // Lắng nghe và render danh sách phòng từ node "rooms" của Firebase
    function listenForRooms() {
      db.ref("rooms").on("value", function(snapshot) {
        roomList.innerHTML = "";
        var roomsData = snapshot.val();
        if (!roomsData) {
          var li = document.createElement("li");
          li.textContent = "Chưa có phòng nào, hãy tạo phòng mới.";
          roomList.appendChild(li);
        } else {
          Object.keys(roomsData).forEach(function(key) {
            var room = roomsData[key];
            var li = document.createElement("li");
            li.textContent = room.name + " (Tạo bởi: " + room.createdBy + ")";
            li.addEventListener("click", function() {
              joinRoom(room.name);
            });
            roomList.appendChild(li);
          });
        }
      });
    }
    
    // Xử lý tạo phòng mới: lưu dữ liệu vào Firebase tại node "rooms"
    createRoomBtn.addEventListener("click", () => {
      var roomName = newRoomName.value.trim();
      if (!roomName) {
        alert("Vui lòng nhập tên phòng.");
        return;
      }
      // Lưu thông tin phòng vào Firebase (ở ví dụ này không kiểm tra phòng trùng lặp)
      var newRoomRef = db.ref("rooms").push();
      newRoomRef.set({
        name: roomName,
        createdBy: nickname,
        createdAt: Date.now()
      });
      newRoomName.value = "";
    });
    
    /*==================== THAM GIA PHÒNG VÀ CUỘC GỌI VIDEO ====================*/
    async function joinRoom(room) {
      currentRoom = room;
      roomSection.classList.add("hidden");
      callSection.classList.remove("hidden");
      callRoomTitle.textContent = "Phòng: " + room;
      
      // Tạo client Agora mới
      client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
      try {
        await client.join(APP_ID, currentRoom, TEMP_TOKEN, null);
        
        // Tạo track audio & video cục bộ
        localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
        
        // Hiển thị video cục bộ
        localContainer.innerHTML = "";
        var nameTag = document.createElement("div");
        nameTag.className = "video-name";
        nameTag.textContent = nickname + " (Bạn)";
        localContainer.appendChild(nameTag);
        localTracks[1].play(localContainer);
        
        // Công bố các track cục bộ
        await client.publish(localTracks);
        
        // Lắng nghe sự kiện người dùng khác tham gia
        client.on("user-published", async function(user, mediaType) {
          await client.subscribe(user, mediaType);
          if (mediaType === "video") {
            var remoteVideo = document.createElement("div");
            remoteVideo.id = "remote-" + user.uid;
            remoteVideo.className = "video-box";
            var remoteNameTag = document.createElement("div");
            remoteNameTag.className = "video-name";
            // Ví dụ này chỉ hiển thị uid; bạn hoàn thiện logic nhận diện nickname thực tế khi dùng signaling
            remoteNameTag.textContent = "User " + user.uid;
            remoteVideo.appendChild(remoteNameTag);
            remoteContainer.appendChild(remoteVideo);
            user.videoTrack.play(remoteVideo);
          }
          if (mediaType === "audio") {
            user.audioTrack.play();
          }
        });
        
        // Lắng nghe sự kiện khi người dùng khác rời phòng
        client.on("user-unpublished", function(user, mediaType) {
          var remoteVideo = document.getElementById("remote-" + user.uid);
          if (remoteVideo) remoteVideo.remove();
        });
        
      } catch (error) {
        console.error("Lỗi khi tham gia phòng:", error);
      }
    }
    
    // Xử lý rời phòng: dừng tracks, rời client và cập nhật lại giao diện
    leaveBtn.addEventListener("click", async () => {
      localTracks.forEach(track => {
        track.stop();
        track.close();
      });
      await client.leave();
      localContainer.innerHTML = "";
      remoteContainer.innerHTML = "";
      callSection.classList.add("hidden");
      roomSection.classList.remove("hidden");
    });


    // (Có thể bổ sung thêm push notifications, caching offline, ...)

    // (Hàm updatePresence có thể được định nghĩa thêm nếu cần để quản lý danh sách online)
  </script>
</body>
</html>

