<!DOCTYPE html>

<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thành Phố Giao Tiếp Realtime</title>
  <meta name="description" content="Trải nghiệm thế giới 3D online, tích hợp chat, forum, private chat, mạng xã hội và phần trò chơi với Firebase, PubNub, Cloudinary và Anime.js.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- === CÁC THƯ VIỆN GỐC (GIỮ NGUYÊN) === -->
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0"></script>
  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <!-- Axios -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>

  <!-- === CÁC THƯ VIỆN MỚI CHO GAME 3D === -->
  <!-- Three.js (Engine đồ họa 3D) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- GLTFLoader (Để tải mô hình 3D) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <!-- OrbitControls (Để xoay camera trên máy tính) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <!-- NippleJS (Joystick cho di động) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

  <style>
    /* === CSS GỐC (GIỮ NGUYÊN VÀ TINH CHỈNH) === */
    :root {
      --primary-color: #667eea;
      --secondary-color: #764ba2;
      --text-color: #fff;
    }
    body.theme-default {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-color: #fff;
    }
    body.theme-light {
        --primary-color: #e0e0e0;
        --secondary-color: #ffffff;
        --text-color: #333;
    }
    body.theme-dark {
        --primary-color: #232526;
        --secondary-color: #414345;
        --text-color: #fff;
    }
    body.theme-colorful {
        --primary-color: #ff7e5f;
        --secondary-color: #feb47b;
        --text-color: #fff;
    }
    
    /* Global Styles */
    html, body {
      overflow: hidden; /* Ngăn cuộn trang, để canvas game chiếm toàn bộ */
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Dosis", cursive;
      font-weight: 200;
      transition: background 0.5s ease, color 0.5s ease;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-color);
    }
    header {
      padding: 10px;
      position: absolute;
      top: 0;
      left: 0;
      width: calc(100% - 20px);
      z-index: 100;
      display: none; /* Ẩn header ban đầu, chỉ hiện khi cần */
      background: rgba(0,0,0,0.2);
    }
    
    .theme-switcher, .nav-btn {
      background: rgba(255,255,255,0.2); border: none; border-radius: 5px; color: inherit; cursor: pointer; font-size: 1rem;
    }
    .nav { margin: 10px 0; }
    .nav-btn { margin: 0 5px; padding: 8px 15px; }
    .nav-btn.active { background: rgba(255,255,255,0.5); }
    
    /* Tinh chỉnh Section để hiển thị như Pop-up trên game */
    .section {
      border: 1px solid rgba(255,255,255,0.5);
      padding: 20px;
      margin: auto; /* Để căn giữa */
      max-width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      background-color: rgba(0,0,0,0.8); /* Nền tối hơn để dễ đọc */
      border-radius: 10px;
      position: absolute; /* Hiển thị chồng lên game */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 101;
      display: none; /* Ẩn tất cả section ban đầu */
    }
    .section.active-page {
        display: block; /* Chỉ hiện section được kích hoạt */
    }
    
    input, button, textarea, select {
      margin: 5px 0; padding: 5px; font-size: 1rem; border-radius: 5px; border: none;
      color: #333; /* Chữ đen dễ đọc trên nền sáng */
    }

    /* === CSS MỚI CHO GAME 3D === */

    /* Container cho Canvas của Three.js */
    #game-world-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1; /* Nằm dưới các UI */
    }

    /* Giao diện đăng nhập/chọn nhân vật */
    #pre-game-ui {
        position: absolute;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 200;
        flex-direction: column;
    }
    
    #character-selection {
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        color: white;
    }
    
    .char-option {
        width: 100px; height: 100px;
        border: 2px solid white;
        border-radius: 10px;
        display: inline-block;
        margin: 10px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .char-option:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px #fff;
    }
    .char-male { background-color: #3498db; }
    .char-female { background-color: #e91e63; }
    
    #enter-world-btn {
        padding: 15px 30px;
        font-size: 1.2rem;
        border: none;
        border-radius: 10px;
        background-color: #2ecc71;
        color: white;
        cursor: pointer;
        margin-top: 20px;
    }

    /* Joystick container */
    #joystick-container {
        position: absolute;
        bottom: 20px;
        left: 20px;
        width: 150px;
        height: 150px;
        z-index: 150;
        display: none; /* Chỉ hiển thị trên thiết bị cảm ứng */
    }

    /* Hiển thị tên người chơi khác */
    .player-name-label {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 2px 8px;
        border-radius: 5px;
        font-size: 12px;
        pointer-events: none; /* Để không bắt sự kiện chuột */
        white-space: nowrap;
        transform: translateX(-50%); /* Căn giữa */
    }
    
    /* Nút đóng cho các section pop-up */
    .close-section-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        line-height: 30px;
        text-align: center;
    }

    /*--- Copy các style gốc còn lại để đảm bảo không thiếu sót ---*/
    /* Loading Overlay */
    .loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000; font-size: 2rem; color: #000; display: none;
    }
    /* Chat Window */
    #chat-window {
      border: 1px solid rgba(255,255,255,0.5); height: 300px; overflow-y: auto;
      padding: 10px; margin: 10px 0; background-color: rgba(255,255,255,0.9);
      display: flex; flex-direction: column; color: #000;
    }
    .message {
      margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 80%;
      word-break: break-word; color: #000 !important;
    }
    .message.mine { align-self: flex-end; background-color: #a8e6cf; text-align: right; }
    .message.other { align-self: flex-start; background-color: #81d4fa; text-align: left; }
    .system-message { align-self: center; background-color: #ffe082; color: #333 !important; font-style: italic;
      padding: 5px; border-radius: 5px; max-width: 70%; margin: 10px auto; }
    .post-card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px; padding: 10px; margin: 10px 0; text-align: left; }
    .post-card img { max-width: 100%; margin-top: 10px; border-radius: 5px; }
    .game-container iframe { width: 100%; height: 500px; border: none; }
    .fb-comments-container { border: 2px solid #ffffff; padding: 10px; background-color: #f9f9f9; border-radius: 5px;
      margin: 20px auto; max-width: 600px; color: #000; }
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px 20px; margin-top: 10px;
      border-radius: 5px; opacity: 1; transition: opacity 0.5s ease-out; }
    .toast.hide { opacity: 0; }
    .hidden { display: none; }
    h1, h2, h3, h4, h5, p { color: inherit; }
  </style>

</head>
<body class="theme-default">

  <!-- === CẤU TRÚC GIAO DIỆN GAME === -->

  <!-- Container cho thế giới 3D -->
  <div id="game-world-container"></div>
  
  <!-- UI đăng nhập & chọn nhân vật -->
  <div id="pre-game-ui">
      <!-- Phần login gốc sẽ được di chuyển vào đây -->
      <div id="login-section-wrapper">
         <!-- Login Section (mã gốc) sẽ được đặt ở đây bằng JS -->
      </div>
      
      <!-- Giao diện chọn nhân vật (hiển thị sau khi đăng nhập) -->
      <div id="character-selection" style="display:none;">
        <h2>Chọn nhân vật</h2>
        <div>
            <div class="char-option char-male" data-gender="male" title="Nhân vật Nam"></div>
            <div class="char-option char-female" data-gender="female" title="Nhân vật Nữ"></div>
        </div>
        <button id="enter-world-btn">Vào Thế Giới</button>
      </div>
  </div>
  
  <!-- Joystick cho di động -->
  <div id="joystick-container"></div>
  
  <!-- === CẤU TRÚC HTML GỐC (GIỮ NGUYÊN) === -->
  <header>
    <h1>Nền tảng Chat Realtime</h1>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề nhanh</button>
  </header>

  <div id="toast-container"></div>

  <!-- Nơi chứa các Section Gốc. Chúng sẽ được quản lý hiển thị bằng JS -->
  <div id="all-sections-wrapper" style="position: absolute; top:0; left: 0; width: 100%; height: 100%; pointer-events: none;">
      <!-- Khi các section được hiển thị, pointer-events sẽ được bật lại -->
      <!-- Login Section -->
      <div class="section login-section" id="login-section">
        <h2>Đăng nhập</h2>
        <div id="login-google">
          <button id="google-login">Đăng nhập với Google</button>
        </div>
        <hr>
        <div id="login-email">
          <input type="email" id="email" placeholder="Email">
          <input type="password" id="password" placeholder="Mật khẩu">
          <button id="email-login">Đăng nhập/Đăng ký với Email</button>
        </div>
        <hr>
        <div id="login-phone">
          <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
          <div id="recaptcha-container"></div>
          <button id="send-otp">Gửi OTP</button><br>
          <input type="text" id="otp-code" placeholder="Nhập OTP">
          <button id="verify-otp">Xác thực OTP</button>
        </div>
      </div>
    
      <!-- Các section khác sẽ được di chuyển vào đây bằng JS -->
  </div>
  
  
  <!-- Tất cả mã HTML gốc khác vẫn tồn tại ở đây -->
  <div class="nav">
      <!-- Các nút điều hướng -->
      <button class="nav-btn active" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="private-chat-section">Private Chat</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
      <button class="nav-btn" data-target="game-section">Giải trí</button>
      <button class="nav-btn" data-target="profile-section">Hồ sơ</button>
      <button class="nav-btn" data-target="settings-section">Cài đặt</button>
      <button class="nav-btn" data-target="call-section">Call</button>
      <button class="nav-btn" data-target="img-section">Ảnh</button>
      <button class="nav-btn" data-target="video-section">Video</button>
      <button class="nav-btn" data-target="help-section">Help</button>
  </div>
  
  <!-- Các section còn lại -->
  <!-- ... (toàn bộ các thẻ div.section gốc của bạn) ... -->

  <!-- *** Script gốc và Script Game mới sẽ được đặt bên dưới *** -->
  <script>
    'use strict';
    /* -------------------- SCRIPT GỐC CỦA BẠN (GIỮ NGUYÊN) -------------------- */
    /* 
       Tôi sẽ giữ lại toàn bộ khối script gốc của bạn ở đây để đảm bảo mọi
       chức năng hiện tại vẫn hoạt động. Tôi sẽ chỉ thêm và chỉnh sửa một chút
       để tích hợp nó vào logic game mới.
    */
    
    // ... (TẤT CẢ CÁC HÀM JAVASCRIPT GỐC CỦA BẠN SẼ NẰM Ở ĐÂY) ...
    // ... Tôi sẽ không sao chép lại toàn bộ để giữ câu trả lời gọn gàng ...
    // ... nhưng trong file cuối cùng của bạn, bạn hãy DÁN TOÀN BỘ script gốc vào đây.
    
    // VÍ DỤ MỘT VÀI HÀM GỐC ĐỂ BẠN HÌNH DUNG
    function sanitize(str) {
      var temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }
    
    function showToast(message) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("hide");
        toast.addEventListener("transitionend", () => toast.remove());
      }, 5000); // Tăng thời gian toast lên 5s
    }

    var firebaseConfig = {
        apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
        authDomain: "webai-7642b.firebaseapp.com",
        databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "webai-7642b",
        storageBucket: "webai-7642b.appspot.com",
        messagingSenderId: "967881370128",
        appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
        measurementId: "G-61XJ390Q30"
    };
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    var db = firebase.database();
    var auth = firebase.auth();
    var currentUser = null; // Biến toàn cục cho user
    
    // ... (Toàn bộ các hàm và event listener khác của bạn)
  </script>

  <!-- === SCRIPT MỚI CHO GAME 3D === -->
  <script>
    'use strict';
    
    document.addEventListener('DOMContentLoaded', () => {

        // --- CÁC BIẾN TOÀN CỤC CHO GAME ---
        let scene, camera, renderer, controls;
        let player, playerInfo = { id: null, nickname: 'Guest', gender: 'male', object: null, velocity: new THREE.Vector3(), direction: new THREE.Vector3() };
        const otherPlayers = new Map();
        const interactionZones = [];
        let keyboard = {};
        let joystick = null;
        let clock = new THREE.Clock();
        
        let sunLight;
        const gameWorldContainer = document.getElementById('game-world-container');
        const preGameUI = document.getElementById('pre-game-ui');
        const loginSectionOriginal = document.getElementById('login-section');
        const loginSectionWrapper = document.getElementById('login-section-wrapper');
        const characterSelectionUI = document.getElementById('character-selection');
        const enterWorldBtn = document.getElementById('enter-world-btn');
        const allSectionsWrapper = document.getElementById('all-sections-wrapper');

        // --- SETUP BAN ĐẦU ---

        // Di chuyển các phần tử giao diện vào đúng vị trí
        loginSectionWrapper.appendChild(loginSectionOriginal);
        document.querySelectorAll('.section:not(.login-section)').forEach(sec => {
            allSectionsWrapper.appendChild(sec);
            // Thêm nút đóng cho mỗi section
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.className = 'close-section-btn';
            closeBtn.onclick = () => hideAllSections();
            sec.style.position = 'relative'; // để nút close định vị đúng
            sec.appendChild(closeBtn);
            sec.style.pointerEvents = 'auto'; // bật lại event
        });
        loginSectionOriginal.style.display = 'block';

        
        // Lắng nghe trạng thái đăng nhập của Firebase
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                playerInfo.id = user.uid;
                playerInfo.nickname = user.displayName || user.email || 'Player';
                
                loginSectionWrapper.style.display = 'none';
                characterSelectionUI.style.display = 'block';
                showToast(`Chào mừng ${playerInfo.nickname}! Hãy chọn nhân vật.`);
            } else {
                currentUser = null;
                loginSectionWrapper.style.display = 'block';
                characterSelectionUI.style.display = 'none';
            }
        });
        
        // Xử lý chọn nhân vật
        document.querySelectorAll('.char-option').forEach(option => {
            option.addEventListener('click', (e) => {
                playerInfo.gender = e.target.dataset.gender;
                document.querySelectorAll('.char-option').forEach(opt => opt.style.border = '2px solid white');
                e.target.style.border = '2px solid #2ecc71';
            });
        });

        // Xử lý vào game
        enterWorldBtn.addEventListener('click', () => {
            preGameUI.style.display = 'none'; // Ẩn giao diện đăng nhập
            initGame();
        });


        // --- KHỞI TẠO GAME ---
        function initGame() {
            // 1. Scene
            scene = new THREE.Scene();
            
            // 2. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true; // Bật đổ bóng
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            gameWorldContainer.appendChild(renderer.domElement);

            // 3. Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            camera.position.set(0, 5, 10);

            // 4. Lighting (Hệ thống ánh sáng cho ngày/đêm)
            scene.add(new THREE.AmbientLight(0xffffff, 0.2));
            sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
            sunLight.position.set(100, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            scene.add(sunLight);
            
            // 5. Build World
            createWorld();
            createPlayer();
            
            // 6. Controls
            setupControls();

            // 7. Multiplayer Setup
            initFirebaseListeners();
            
            // 8. Start Animation Loop
            animate();
            
            showToast("Sử dụng WASD/chuột trên PC hoặc Joystick trên điện thoại để di chuyển. Tiến vào các tòa nhà để tương tác!", 10000);
        }

        // --- XÂY DỰNG THẾ GIỚI ---
        function createWorld() {
            // Sky
            scene.background = new THREE.Color(0x87ceeb); // Bầu trời xanh ban ngày
            
            // Ground
            const groundGeo = new THREE.PlaneGeometry(500, 500);
            const groundMat = new THREE.MeshLambertMaterial({ color: 0x55aa55 });
            const ground = new THREE.Mesh(groundGeo, groundMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // City Buildings & Interaction Zones
            const buildings = [
                { name: 'Chat', id: 'chat-section', pos: new THREE.Vector3(-30, 0, -20), color: 0xf1c40f },
                { name: 'Forum', id: 'forum-section', pos: new THREE.Vector3(30, 0, -20), color: 0x3498db },
                { name: 'Social', id: 'social-section', pos: new THREE.Vector3(-30, 0, 20), color: 0x9b59b6 },
                { name: 'Video', id: 'video-section', pos: new THREE.Vector3(30, 0, 20), color: 0xe74c3c },
                { name: 'Giải trí', id: 'game-section', pos: new THREE.Vector3(0, 0, 40), color: 0x1abc9c },
                { name: 'Profile', id: 'profile-section', pos: new THREE.Vector3(0, 0, -40), color: 0xffffff }
            ];

            const boxGeo = new THREE.BoxGeometry(10, 20, 10);
            buildings.forEach(b => {
                const material = new THREE.MeshStandardMaterial({ color: b.color, roughness: 0.8 });
                const building = new THREE.Mesh(boxGeo, material);
                building.position.set(b.pos.x, boxGeo.parameters.height / 2, b.pos.z);
                building.castShadow = true;
                building.receiveShadow = true;
                scene.add(building);

                // Add text label for building
                // Đây là cách đơn giản, để đẹp hơn cần dùng THREE.Sprite hoặc CSS2DRenderer
                
                // Interaction Zone
                const zoneSize = new THREE.Vector3(15, 25, 15);
                const zoneBox = new THREE.Box3().setFromCenterAndSize(building.position, zoneSize);
                interactionZones.push({ box: zoneBox, sectionId: b.id });

                // (Tùy chọn) Helper để nhìn thấy vùng tương tác
                // const helper = new THREE.Box3Helper(zoneBox, 0xffff00);
                // scene.add(helper);
            });
        }
        
        // --- LOGIC NHÂN VẬT ---
        function createPlayer() {
            const playerHeight = 1.8;
            const playerWidth = 0.8;
            // Thay vì dùng model thật, ta dùng hình khối đơn giản để đảm bảo chạy được ngay
            const geometry = new THREE.CapsuleGeometry(playerWidth / 2, playerHeight - playerWidth, 4, 8);
            
            const color = (playerInfo.gender === 'male') ? 0x3498db : 0xe91e63;
            const material = new THREE.MeshStandardMaterial({ color: color });
            
            player = new THREE.Mesh(geometry, material);
            player.castShadow = true;
            // Dịch chuyển mesh lên để chân chạm đất
            player.position.set(0, (playerHeight - playerWidth)/2 + playerWidth/2, 0); 
            
            // Tạo một group để camera dễ dàng follow
            playerInfo.object = new THREE.Group();
            playerInfo.object.add(player);
            playerInfo.object.position.y = 0; // Group nằm ở mặt đất
            scene.add(playerInfo.object);
            
            // Gán camera follow người chơi
            if (!isMobile()) {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.target.copy(playerInfo.object.position);
                controls.enablePan = false; // Ngăn di chuyển ngang bằng chuột
                controls.minDistance = 5;
                controls.maxDistance = 20;
            }
        }
        
        function updatePlayer(delta) {
            if (!playerInfo.object) return;

            const moveSpeed = 8.0;
            const rotateSpeed = 4.0;
            
            // Get direction from keyboard or joystick
            playerInfo.velocity.set(0, 0, 0);
            if (keyboard['w']) playerInfo.velocity.z = -1;
            if (keyboard['s']) playerInfo.velocity.z = 1;
            if (keyboard['a']) playerInfo.velocity.x = -1;
            if (keyboard['d']) playerInfo.velocity.x = 1;

            if (joystick?.front) {
                const angle = joystick.angle.radian;
                playerInfo.velocity.x = Math.cos(angle);
                playerInfo.velocity.z = -Math.sin(angle);
            }

            if (playerInfo.velocity.lengthSq() > 0) {
                playerInfo.velocity.normalize().multiplyScalar(moveSpeed * delta);
                
                // Move player
                playerInfo.object.position.add(playerInfo.velocity);

                // Rotate player to face movement direction
                const targetAngle = Math.atan2(playerInfo.velocity.x, playerInfo.velocity.z);
                const currentAngle = playerInfo.object.rotation.y;
                let diff = targetAngle - currentAngle;
                // find shortest angle
                while (diff < -Math.PI) diff += 2 * Math.PI;
                while (diff > Math.PI) diff -= 2 * Math.PI;

                playerInfo.object.rotation.y += diff * rotateSpeed * delta;
            }

            // Update camera to follow player
            if (isMobile()) {
                const offset = new THREE.Vector3(0, 8, 12);
                camera.position.lerp(playerInfo.object.position.clone().add(offset), 0.1);
                camera.lookAt(playerInfo.object.position.clone().add(new THREE.Vector3(0, 1.5, 0)));
            } else {
                 controls.target.lerp(playerInfo.object.position, 0.1);
                 controls.update();
            }

            // Check for interactions
            const playerBox = new THREE.Box3().setFromObject(player);
            let inZone = false;
            for (const zone of interactionZones) {
                if (playerBox.intersectsBox(zone.box)) {
                    showSection(zone.sectionId);
                    inZone = true;
                    break;
                }
            }
        }

        // --- MULTIPLAYER (FIREBASE) ---
        function initFirebaseListeners() {
            const playersRef = db.ref('game_players');
            
            // Cập nhật vị trí của mình
            const myRef = playersRef.child(playerInfo.id);
            myRef.onDisconnect().remove(); // Xóa khỏi DB khi disconnect

            setInterval(() => {
                 if (playerInfo.object) {
                     myRef.set({
                         nickname: playerInfo.nickname,
                         gender: playerInfo.gender,
                         pos: playerInfo.object.position,
                         rot: playerInfo.object.rotation.toVector3()
                     });
                 }
            }, 100); // Gửi cập nhật 10 lần/giây, thực tế và tiết kiệm
            
            // Lắng nghe người chơi khác
            playersRef.on('child_added', (snapshot) => {
                if (snapshot.key === playerInfo.id) return;
                addOtherPlayer(snapshot.key, snapshot.val());
            });

            playersRef.on('child_changed', (snapshot) => {
                if (snapshot.key === playerInfo.id) return;
                updateOtherPlayer(snapshot.key, snapshot.val());
            });

            playersRef.on('child_removed', (snapshot) => {
                removeOtherPlayer(snapshot.key);
            });
        }
        
        function addOtherPlayer(id, data) {
            const playerHeight = 1.8;
            const playerWidth = 0.8;
            const geometry = new THREE.CapsuleGeometry(playerWidth / 2, playerHeight - playerWidth, 4, 8);
            const color = (data.gender === 'male') ? 0x0077b6 : 0xc9184a;
            const material = new THREE.MeshStandardMaterial({ color: color });
            const other = new THREE.Mesh(geometry, material);
            other.castShadow = true;
            other.position.set(data.pos.x, (playerHeight - playerWidth)/2 + playerWidth/2 + data.pos.y, data.pos.z);
            other.rotation.y = data.rot.y;
            scene.add(other);

            // Tạo nhãn tên
            const nameLabelDiv = document.createElement('div');
            nameLabelDiv.className = 'player-name-label';
            nameLabelDiv.textContent = data.nickname;
            document.body.appendChild(nameLabelDiv);
            
            otherPlayers.set(id, { object: other, label: nameLabelDiv });
        }
        
        function updateOtherPlayer(id, data) {
            const other = otherPlayers.get(id);
            if (other && other.object) {
                const playerHeight = 1.8;
                const playerWidth = 0.8;
                // Dùng lerp để di chuyển mượt mà
                other.object.position.lerp(new THREE.Vector3(data.pos.x, (playerHeight - playerWidth)/2 + playerWidth/2 + data.pos.y, data.pos.z), 0.3);
                // Xoay
                other.object.rotation.y = data.rot.y;
            }
        }
        
        function removeOtherPlayer(id) {
            const other = otherPlayers.get(id);
            if (other) {
                scene.remove(other.object);
                document.body.removeChild(other.label);
                otherPlayers.delete(id);
            }
        }
        
        // --- GAME LOOP & UPDATES ---
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            // Update day/night cycle
            const time = Date.now() * 0.0001; // Tốc độ ngày đêm
            sunLight.position.x = Math.sin(time) * 200;
            sunLight.position.y = Math.cos(time) * 200;

            if(Math.cos(time) < 0) { // Đêm
                sunLight.intensity = 0.1;
                scene.background.lerpColors(new THREE.Color(0x87ceeb), new THREE.Color(0x000033), 0.05);
            } else { // Ngày
                sunLight.intensity = 1.5;
                 scene.background.lerpColors(new THREE.Color(0x000033), new THREE.Color(0x87ceeb), 0.05);
            }

            // Update player
            updatePlayer(delta);

            // Update other players' labels
            otherPlayers.forEach((p) => {
                if (p.object && p.label) {
                    const pos = p.object.position.clone();
                    pos.y += 2.2; // Độ cao của label trên đầu
                    const screenPos = pos.project(camera);
                    const x = (screenPos.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (-screenPos.y * 0.5 + 0.5) * window.innerHeight;
                    p.label.style.transform = `translate(${x}px, ${y}px) translateX(-50%)`;
                }
            });

            renderer.render(scene, camera);
        }

        // --- UTILS & CONTROLS ---
        function setupControls() {
            window.addEventListener('keydown', (e) => keyboard[e.key.toLowerCase()] = true);
            window.addEventListener('keyup', (e) => keyboard[e.key.toLowerCase()] = false);

            if (isMobile()) {
                const joystickContainer = document.getElementById('joystick-container');
                joystickContainer.style.display = 'block';
                const joyManager = nipplejs.create({
                    zone: joystickContainer,
                    mode: 'static',
                    position: { left: '50%', top: '50%' },
                    color: 'white',
                    size: 150
                });

                joyManager.on('move', (evt, data) => {
                    joystick = data;
                });
                joyManager.on('end', () => {
                    joystick = null;
                });
            }
             window.addEventListener('resize', onWindowResize, false);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // --- UI INTEGRATION ---
        function showSection(id) {
            const targetSection = document.getElementById(id);
            if(targetSection && targetSection.style.display !== 'block'){
                hideAllSections();
                targetSection.style.display = 'block';
                targetSection.classList.add('active-page');
                 anime({
                    targets: `#${id}`,
                    opacity: [0, 1],
                    scale: [0.9, 1],
                    duration: 500,
                    easing: 'easeOutExpo'
                  });
            }
        }
        
        function hideAllSections() {
             document.querySelectorAll('.section.active-page').forEach(sec => {
                sec.classList.remove('active-page');
                anime({
                    targets: sec,
                    opacity: [1, 0],
                    scale: [1, 0.9],
                    duration: 300,
                    easing: 'easeInExpo',
                    complete: () => {
                        sec.style.display = 'none';
                    }
                });
            });
        }
    });

  </script>

</body>
</html>
