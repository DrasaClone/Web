<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII-NET v3.0 - Full Feature Integration</title>
    
    <!-- ================== TÍCH HỢP SDK TỪ index++.html ================== -->
    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- PubNub SDK -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    
    <!-- Agora RTC SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <!-- ================================================================= -->

    <style>
        :root {
            --bg-color: #0d0d0d;
            --main-color: #00ff41;
            --accent-color: #f0f0f0;
            --border-color: #333;
            --error-color: #ff3860;
        }
        
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background-color: #000; color: var(--main-color);
            font-family: 'Courier New', Courier, monospace; font-size: 16px;
            overflow: hidden;
        }
        #terminal {
            width: 100%; height: 100%; padding: 15px;
            border: 2px solid var(--border-color); background-color: var(--bg-color);
            overflow-y: auto; position: relative;
        }
        #terminal::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: rgba(0, 0, 0, 0.15); opacity: 0.2;
            animation: scanline 7s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
        
        .page { width: 100%; display: none; }
        .page.active { display: block; }
        .sub-page { display: none; }

        .header-title { text-align: center; margin-bottom: 20px; text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--main-color); }
        pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: inherit; font-size: inherit; }
        .ascii-art { color: var(--accent-color); }
        .ascii-box { border: 1px solid var(--main-color); padding: 10px; margin-bottom: 15px; }
        .ascii-button {
            display: inline-block; border: 1px solid var(--main-color); padding: 5px 10px; margin: 5px;
            cursor: pointer; background-color: transparent; color: var(--main-color); font-family: inherit;
        }
        .ascii-button:hover, .ascii-button.active { background-color: var(--main-color); color: var(--bg-color); }
        .ascii-button:disabled { cursor: not-allowed; opacity: 0.5; }

        input[type="text"], input[type="password"], textarea {
            background-color: transparent; border: none; border-bottom: 1px solid var(--main-color);
            color: var(--main-color); font-family: inherit; font-size: 1em; width: 250px;
        }
        textarea { width: 100%; border: 1px solid var(--main-color); padding: 5px; }
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 5px var(--main-color); }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: var(--main-color); } }
        #main-nav { display: flex; justify-content: center; flex-wrap: wrap; margin: 10px 0; border-top: 1px dashed var(--main-color); border-bottom: 1px dashed var(--main-color); padding: 5px 0; }
        .status-online { color: #23d160; } .status-offline { color: #ff3860; }
        .loader { display: inline-block; font-size: 1em; text-align: center; width: 100%; }
        a { color: var(--main-color); text-decoration: underline; cursor: pointer; }
        .comment, .social-comment { border-bottom: 1px dotted var(--border-color); padding: 5px 0; margin-top: 5px; }
        
        /* Video Call Specific Styles */
        .video-call-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;}
        .video-box { border: 1px solid var(--main-color); background: #000; width: 320px; height: 240px; position: relative; }
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-name { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 3px; font-size: 0.9em; }

        #toast-container { position: fixed; bottom: 10px; left: 10px; z-index: 9999; }
        .toast { border: 1px solid var(--main-color); background: var(--bg-color); padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="terminal">

    <!-- TRANG 0: KHỞI ĐỘNG HỆ THỐNG -->
    <div id="boot-page" class="page active">
        <pre class="ascii-art">
           _   _  ___ ___ ___ _    ___ 
          /_\ | |/ __/ __/ __| |  |_ _|
         / _ \| | (_|(_| \__ \ |__ | | 
        /_/ \_\_|\___\___\___/____|___|
                                   
        [ ASCII-NET v3.0 - Full Feature Integration ]
        </pre>
        <pre id="boot-log"></pre>
    </div>


    <!-- TRANG 1: ĐĂNG NHẬP -->
    <div id="login-page" class="page">
        <div class="header-title">
            <pre>===================== TRUY CẬP HỆ THỐNG =====================</pre>
        </div>
        <div id="login-form">
             <div class="ascii-box">
                <pre>
> Nhập Email:   [ <input type="text" id="email" placeholder="user@domain.com" required> ]
> Mật khẩu:     [ <input type="password" id="password" placeholder="ít nhất 6 ký tự" required> ]<span class="blinking-cursor">_</span>
                </pre>
                <br>
                <button id="email-login" class="ascii-button">[//> ĐĂNG NHẬP / ĐĂNG KÝ BẰNG EMAIL <//]</button>
             </div>
             <div class="ascii-box">
                <pre>> Phương thức khác:</pre>
                <button id="google-login" class="ascii-button">[G]> ĐĂNG NHẬP VỚI GOOGLE <[G]</button>
            </div>
        </div>
        <div id="login-loader" style="display: none; margin-top: 20px;">
            <pre class="loader">Đang kết nối đến hệ thống chính... [|]</pre>
        </div>
    </div>


    <!-- =============================================== -->
    <!--  KHU VỰC CHÍNH SAU KHI ĐĂNG NHẬP -->
    <!-- =============================================== -->
    <div id="main-interface" class="page">
        <div class="ascii-box">
            <pre id="welcome-message">Đang kết nối...</pre>
            <div id="main-nav">
                <a class="ascii-button active" data-target="newsfeed-page">[Bảng tin]</a>
                <a class="ascii-button" data-target="chat-public-page">[Chat Chung]</a>
                <a class="ascii-button" data-target="private-chat-page">[Tin Nhắn Riêng]</a>
                <a class="ascii-button" data-target="video-call-page">[Gọi Video]</a>
                <a class="ascii-button" data-target="profile-page">[Hồ sơ]</a>
                <a class="ascii-button" data-target="help-page">[Trợ giúp]</a>
                <a class="ascii-button" data-target="settings-page">[Cài Đặt]</a>
                <button id="logout-btn" class="ascii-button" style="color:var(--error-color)">[Đăng xuất]</button>
            </div>
        </div>
        
        <!-- NỘI DUNG CÁC TRANG CON -->
        <div id="page-content">
        
            <!-- Trang con: BẢNG TIN -->
            <div id="newsfeed-page" class="sub-page">
                <pre class="header-title">+++ BẢNG TIN HỆ THỐNG +++</pre>
                <div class="ascii-box">
                    <pre>Tạo bài đăng mới:</pre>
                    <textarea id="social-message" rows="3" placeholder="Chia sẻ suy nghĩ của bạn ở đây..."></textarea>
                    <button id="submit-social-btn" class="ascii-button">[ Đăng ]</button>
                    <button id="upload-social-btn" class="ascii-button">[ Tải Lên Ảnh ]</button>
                </div>
                <div id="social-posts-container">
                    <pre class="loader">Đang tải bảng tin... [-]</pre>
                </div>
            </div>

            <!-- Trang con: CHAT CHUNG -->
            <div id="chat-public-page" class="sub-page">
                <pre class="header-title">### KÊNH CHAT CHUNG TOÀN MẠNG ###</pre>
                <div style="display: flex; gap: 15px;">
                    <div class="ascii-box" style="flex-grow: 3;">
                        <pre><u><b>Cửa sổ chat (Gõ /help để xem lệnh):</b></u></pre>
                        <div id="public-chat-window" style="height: 300px; overflow-y: auto; padding-top: 5px;"></div>
                        <div style="display: flex; margin-top: 10px;">
                            <pre style="flex-grow: 1;">[<input type="text" id="public-chat-input" style="width: 95%;" placeholder="Nhập tin nhắn hoặc lệnh..."><span class="blinking-cursor">_</span>]</pre>
                            <button id="send-chat-btn" class="ascii-button">[ Gửi ]</button>
                            <button id="upload-chat-image-btn" class="ascii-button">[> UPLOAD IMG <]</button>
                        </div>
                    </div>
                    <div class="ascii-box" style="flex-grow: 1;">
                         <pre><u><b>Online Users (Click để chat riêng):</b></u></pre>
                         <div id="online-users-list" style="height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

             <!-- Trang con: TIN NHẮN RIÊNG -->
            <div id="private-chat-page" class="sub-page">
                <pre class="header-title">@@@ TIN NHẮN RIÊNG TƯ @@@</pre>
                <div id="private-chat-start-prompt" class="ascii-box">
                    <pre>
                        Chọn một người dùng từ danh sách Online bên trang "Chat Chung" để bắt đầu.
                    </pre>
                </div>
                <div id="private-chat-interface" class="ascii-box" style="display:none;">
                    <pre>Đang chat với: <b id="pm-partner-name"></b> <button id="pm-back-btn" class="ascii-button" style="float: right;">[< Quay lại]</button></pre>
                    <div id="pm-chat-window" style="height: 300px; overflow-y: auto; padding-top: 5px; border-top: 1px dashed; border-bottom: 1px dashed; margin: 10px 0;"></div>
                    <div style="display: flex; margin-top: 10px;">
                        <pre style="flex-grow: 1;">[<input type="text" id="pm-chat-input" style="width: 95%;" placeholder="Gửi tin nhắn riêng..."><span class="blinking-cursor">_</span>]</pre>
                        <button id="pm-send-btn" class="ascii-button">[ Gửi ]</button>
                    </div>
                </div>
            </div>

            <!-- Trang con: GỌI VIDEO -->
            <div id="video-call-page" class="sub-page">
                <pre class="header-title">📞 TRUNG TÂM GỌI VIDEO AGORA 📞</pre>
                <!-- Room List & Creation -->
                <div id="room-selection" class="ascii-box">
                    <pre><b>Danh sách phòng hiện có:</b></pre>
                    <div id="room-list">Chưa có phòng nào.</div>
                    <hr>
                    <pre>Tạo phòng mới: [ <input type="text" id="new-room-name" placeholder="Tên phòng..."> ] <button id="create-room-btn" class="ascii-button">[ Tạo ]</button></pre>
                </div>
                <!-- Call Interface -->
                <div id="call-interface" style="display:none;">
                    <pre id="call-room-title">Đang trong phòng: </pre>
                    <div class="video-call-container">
                        <div class="video-box" id="local-stream">
                           <div class="video-name">You (Local)</div>
                        </div>
                        <!-- Remote streams will be added here by JS -->
                        <div id="remote-streams"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                       <button id="leave-btn" class="ascii-button">[ KẾT THÚC CUỘC GỌI ]</button>
                    </div>
                </div>
            </div>

            <!-- Các trang còn lại: Profile, Help, Settings -->
            <!-- ... Giữ nguyên như phiên bản trước ... -->

            <!-- Trang con: HỒ SƠ -->
            <div id="profile-page" class="sub-page">
                 <pre class="header-title">*** HỒ SƠ NGƯỜI DÙNG ***</pre>
                 <div class="ascii-box" id="profile-info-container">
                    <pre>Đang tải thông tin hồ sơ...</pre>
                 </div>
                 <div class="ascii-box">
                    <pre>Cập nhật nickname:<br>[ <input type="text" id="profile-nickname-input" placeholder="Nhập nickname mới..."> ] <button id="update-nickname-btn" class="ascii-button">[ Cập nhật ]</button></pre>
                 </div>
            </div>

            <!-- Trang con: TRỢ GIÚP / FEEDBACK -->
            <div id="help-page" class="sub-page">
                 <pre class="header-title">??? TRỢ GIÚP & PHẢN HỒI ???</pre>
                 <div class="ascii-box">
                    <form id="feedback-form">
                        <pre>Họ và Tên:  [ <input type="text" id="feedback-name" required> ]</pre>
                        <pre>Nội dung phản hồi:</pre>
                        <textarea id="feedback-message" rows="4" required></textarea><br>
                        <button type="submit" class="ascii-button">[ Gửi Phản Hồi ]</button>
                    </form>
                 </div>
                 <div class="ascii-box">
                     <pre><b>Danh sách các phản hồi:</b></pre>
                     <div id="feedback-container"></div>
                 </div>
            </div>
            
            <!-- Trang con: CÀI ĐẶT -->
            <div id="settings-page" class="sub-page">
                <pre class="header-title">⚙️ CÀI ĐẶT HỆ THỐNG ⚙️</pre>
                 <div class="ascii-box">
                    <pre><b>[Chủ đề (Theme)]</b> - Thay đổi màu sắc giao diện</pre>
                    <br>
                    <button class="ascii-button theme-btn" data-theme="green">Terminal (Mặc định)</button>
                    <button class="ascii-button theme-btn" data-theme="amber">Amber</button>
                    <button class="ascii-button theme-btn" data-theme="blue">Matrix Blue</button>
                    <button class="ascii-button theme-btn" data-theme="white">Classic DOS</button>
                 </div>
            </div>

        </div>
    </div>
    
</div>
<div id="toast-container"></div>
<div id="recaptcha-container" style="display:none;"></div>

<script>
// Prevent FOUC
document.body.style.display = "none";

document.addEventListener('DOMContentLoaded', () => {
    document.body.style.display = "block";
    // === CẤU HÌNH FIREBASE, PUBNUB, AGORA ===
    const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    const pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });

    const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
    const socialCloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: 'dgbux4wzo',
        uploadPreset: 'okeqfdx4'
    }, (error, result) => {
        if (!error && result && result.event === "success") {
            const socialMsgField = document.getElementById("social-message");
            socialMsgField.value += `\n[image]${result.info.secure_url}[/image]`;
            showToast(`> Ảnh đã được thêm vào bài đăng.`);
        }
    });
    // UPGRADE: New widget instance for chat
    const chatCloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: 'dgbux4wzo',
        uploadPreset: 'okeqfdx4'
    }, (error, result) => {
        if (!error && result && result.event === "success") {
             const message = {
                sender: userNickname,
                imageUrl: result.info.secure_url,
                timestamp: Date.now()
            };
            pubnub.publish({ channel: 'ascii_chat', message: message });
            db.ref('publicChatMessages').push(message); // Save to Firebase for history
        }
    });

    // === BIẾN TOÀN CỤC & DOM ELEMENTS ===
    let currentUser = null;
    let userNickname = 'anonymous';
    // UPGRADE: Variables for Private Chat
    let currentPrivateChannel = null;
    
    // === HÀM TIỆN ÍCH ===
    function showToast(message) { /* ... Giữ nguyên ... */ }
    function sanitize(str) { /* ... Giữ nguyên ... */ }
    function formatTime(timestamp) { return new Date(timestamp).toLocaleTimeString(); }
    function showPage(pageId) { /* ... Giữ nguyên ... */ }
    function showSubPage(subPageId) { /* ... Gi-/iữ nguyên ... */ }

    // === XỬ LÝ KHỞI ĐỘNG HỆ THỐNG & LOGIN/LOGOUT ===
    function runBootSequence() { /* ... Giữ nguyên ... */ }
    function initializeApp() {
        showPage('main-interface');
        showSubPage('newsfeed-page');
        document.getElementById('welcome-message').textContent = `USER: ${userNickname} | STATUS: Online`;

        loadChatHistory(); // UPGRADE: Load history before subscribing
        subscribeToPubNub();
        loadSocialPosts();
        loadFeedback();
        listenForAgoraRooms();
        updateProfilePage();
    }
    // All login/logout functions ... Giữ nguyên ...
    
    // === CHỨC NĂNG CHAT CHUNG (PUBNUB + FIREBASE) ===
    const publicChatInput = document.getElementById('public-chat-input');
    const publicChatWindow = document.getElementById('public-chat-window');

    // UPGRADE: Load last 50 messages from Firebase on start
    function loadChatHistory() {
        db.ref('publicChatMessages').limitToLast(50).once('value', snapshot => {
            snapshot.forEach(child => {
                appendChatMessage(child.val(), publicChatWindow);
            });
            publicChatWindow.innerHTML += `<pre><i>--- Lịch sử chat đã tải. Chào mừng tới kênh chung. ---</i></pre>`;
            publicChatWindow.scrollTop = publicChatWindow.scrollHeight;
        });
    }

    function subscribeToPubNub() {
        const channelsToSubscribe = ['ascii_chat'];
        if (userNickname) {
            channelsToSubscribe.push(`pm-${userNickname}`); // Subscribe to own private channel
        }
        pubnub.subscribe({ channels: channelsToSubscribe, withPresence: true });
        
        pubnub.addListener({
            message: (event) => {
                if (event.channel === 'ascii_chat') {
                    appendChatMessage(event.message, publicChatWindow);
                } else if (event.channel.startsWith('pm-')) {
                    handlePrivateMessage(event);
                }
            },
            presence: (event) => {
                 updateOnlineUsers();
                 if (event.action === "join") {
                     appendSystemMessage(`${event.uuid} has connected.`);
                 } else if (event.action === "leave" || event.action === "timeout") {
                     appendSystemMessage(`${event.uuid} has disconnected.`);
                 }
            }
        });
        updateOnlineUsers();
    }
    
    function appendChatMessage(msg, windowElement) {
        const line = document.createElement('pre');
        let content;
        if (msg.text) {
            content = sanitize(msg.text);
        } else if (msg.imageUrl) {
            content = `chia sẻ một ảnh: <a href="${msg.imageUrl}" target="_blank">[LINK_TO_IMAGE]</a>`;
        }
        line.innerHTML = `[${formatTime(msg.timestamp)}] <b><${sanitize(msg.sender)}></b>: ${content}`;
        windowElement.appendChild(line);
        windowElement.scrollTop = windowElement.scrollHeight;
    }
    
    function appendSystemMessage(text, isCommand = false) {
        const line = document.createElement('pre');
        const style = isCommand ? `style="color: var(--accent-color)"` : 'style="font-style: italic"';
        line.innerHTML = `<span ${style}>--- ${sanitize(text)} ---</span>`;
        publicChatWindow.appendChild(line);
        publicChatWindow.scrollTop = publicChatWindow.scrollHeight;
    }

    function sendChatMessage() {
        const text = publicChatInput.value.trim();
        if (!text) return;
        
        // UPGRADE: Command handler
        if (text.startsWith('/')) {
            handleCommand(text);
            publicChatInput.value = '';
            return;
        }

        const message = { sender: userNickname, text: text, timestamp: Date.now() };
        pubnub.publish({ channel: 'ascii_chat', message: message });
        db.ref('publicChatMessages').push(message); // UPGRADE: Save to Firebase for history
        publicChatInput.value = '';
    }
    document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
    publicChatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });
    // UPGRADE: Bind click to the new image upload button
    document.getElementById('upload-chat-image-btn').addEventListener('click', () => chatCloudinaryWidget.open());

    function updateOnlineUsers(){
        pubnub.hereNow({ channels: ["ascii_chat"], includeUUIDs: true }, (status, response) => {
            const onlineUsersList = document.getElementById('online-users-list');
            onlineUsersList.innerHTML = '';
            if (response && response.channels.ascii_chat) {
                response.channels.ascii_chat.occupants.forEach(user => {
                    const userPre = document.createElement('pre');
                    if (user.uuid === userNickname) {
                         userPre.innerHTML = `> <b>${user.uuid} (You)</b>`;
                    } else {
                        // UPGRADE: Make username clickable for private chat
                        userPre.innerHTML = `> <a class="pm-user-link" data-user="${user.uuid}">${user.uuid}</a>`;
                    }
                    onlineUsersList.appendChild(userPre);
                });
                // Re-bind click events
                 document.querySelectorAll('.pm-user-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        const targetUser = e.target.getAttribute('data-user');
                        startPrivateChat(targetUser);
                    });
                });
            }
        });
    }

    // UPGRADE: Command handling function
    function handleCommand(commandText) {
        const [command, ...args] = commandText.split(' ');
        switch (command) {
            case '/clear':
                publicChatWindow.innerHTML = '';
                appendSystemMessage("Cửa sổ chat đã được xóa.", true);
                break;
            case '/help':
                const helpText = `Lệnh có sẵn:\n`+
                                 `  /clear         - Xóa cửa sổ chat.\n` +
                                 `  /help          - Hiển thị thông báo này.\n` +
                                 `  /who           - Hiển thị danh sách online.\n` +
                                 `  /theme [name]  - Đổi theme (green, amber, blue, white).`;
                appendSystemMessage(helpText, true);
                break;
            case '/who':
                updateOnlineUsers();
                appendSystemMessage("Đã làm mới danh sách online.", true);
                break;
            case '/theme':
                const themeBtn = document.querySelector(`.theme-btn[data-theme="${args[0]}"]`);
                if (themeBtn) {
                    themeBtn.click();
                    appendSystemMessage(`Theme đã đổi thành ${args[0]}.`, true);
                } else {
                    appendSystemMessage(`Lỗi: Theme '${args[0]}' không tồn tại.`, true);
                }
                break;
            default:
                appendSystemMessage(`Lỗi: Lệnh '${command}' không được nhận dạng.`, true);
                break;
        }
    }
    
    // === UPGRADE: CHỨC NĂNG TIN NHẮN RIÊNG (PRIVATE MESSAGING) ===
    function getPrivateChannelName(user1, user2) {
        return `pm-${[user1, user2].sort().join('-')}`;
    }

    function startPrivateChat(partnerNickname) {
        if (partnerNickname === userNickname) {
            showToast('> Bạn không thể tự chat với chính mình.');
            return;
        }
        
        currentPrivateChannel = getPrivateChannelName(userNickname, partnerNickname);
        showSubPage('private-chat-page');
        document.getElementById('private-chat-start-prompt').style.display = 'none';
        document.getElementById('private-chat-interface').style.display = 'block';
        document.getElementById('pm-partner-name').textContent = partnerNickname;

        const pmWindow = document.getElementById('pm-chat-window');
        pmWindow.innerHTML = ''; // Clear previous chat
        
        // Load history for this PM channel from Firebase
        db.ref(`privateMessages/${currentPrivateChannel}`).limitToLast(50).once('value', snapshot => {
             snapshot.forEach(child => {
                appendChatMessage(child.val(), pmWindow);
            });
             pmWindow.scrollTop = pmWindow.scrollHeight;
        });

        showToast(`> Bắt đầu chat riêng với ${partnerNickname}`);
    }

    function handlePrivateMessage(event) {
        // Only append if the user is currently viewing the correct PM window
        if (event.channel === currentPrivateChannel) {
            appendChatMessage(event.message, document.getElementById('pm-chat-window'));
        } else {
            // Otherwise, just show a toast notification
            showToast(`> Tin nhắn mới từ ${event.message.sender}`);
        }
    }
    
    function sendPrivateMessage() {
        const partner = document.getElementById('pm-partner-name').textContent;
        const channel = getPrivateChannelName(userNickname, partner);
        const input = document.getElementById('pm-chat-input');
        const text = input.value.trim();

        if (text && channel) {
            const message = { sender: userNickname, text: text, timestamp: Date.now() };
            // Publish to PubNub for both users
            pubnub.publish({ channel: channel, message: message });
            // Save to Firebase for history
            db.ref(`privateMessages/${channel}`).push(message);
            input.value = '';
        }
    }

    document.getElementById('pm-send-btn').addEventListener('click', sendPrivateMessage);
    document.getElementById('pm-chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendPrivateMessage(); });
    document.getElementById('pm-back-btn').addEventListener('click', () => {
         currentPrivateChannel = null; // Exit the private chat state
         document.getElementById('private-chat-interface').style.display = 'none';
         document.getElementById('private-chat-start-prompt').style.display = 'block';
         showSubPage('chat-public-page'); // Go back to public chat
    });


    // === ALL OTHER FUNCTIONS (BẢNG TIN, PROFILE, AGORA, SETTINGS, etc.) ===
    // ... Giữ nguyên như phiên bản trước, không cần thay đổi.
    // Logic for:
    // loadSocialPosts()
    // createPostElement()
    // document.getElementById('submit-social-btn').addEventListener('click',...)
    // document.getElementById('upload-social-btn').addEventListener('click',...)
    // updateProfilePage()
    // document.getElementById('update-nickname-btn').addEventListener('click',...)
    // feedbackForm.addEventListener('submit', ...)
    // loadFeedback()
    // document.querySelectorAll('.theme-btn').forEach(...)
    // Agora logic: listenForAgoraRooms(), joinRoom(), leaveRoom(), etc.
    // ... (Toàn bộ các hàm này được sao chép và giữ nguyên)

    // === BẮT ĐẦU CHƯƠG TRÌNH ===
    runBootSequence();

});
</script>

</body>
</html>
