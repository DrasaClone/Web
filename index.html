<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Th√†nh Ph·ªë Giao Ti·∫øp Realtime</title>
  <meta name="description" content="Tr·∫£i nghi·ªám m·ªôt th√†nh ph·ªë ·∫£o, n∆°i b·∫°n c√≥ th·ªÉ di chuy·ªÉn, g·∫∑p g·ª° v√† giao ti·∫øp qua chat, forum, m·∫°ng x√£ h·ªôi v√† nhi·ªÅu h∆°n n·ªØa. T√≠ch h·ª£p Firebase, PubNub, Cloudinary.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0"></script>

  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <!-- Axios ƒë·ªÉ upload video l√™n Cloudinary -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>

  <style>
    /* Reset & Global Game Styles */
    * { box-sizing: border-box; }
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Quan tr·ªçng: NgƒÉn cu·ªôn trang */
      font-family: "Dosis", cursive;
      font-weight: 200;
      color: #fff;
      position: relative;
    }
    
    /* C√°c ch·ªß ƒë·ªÅ giao di·ªán (√°p d·ª•ng cho modal) */
    .theme-default { background: linear-gradient(135deg, #667eea, #764ba2); }
    .theme-light { background: #f1f1f1; }
    .theme-dark { background: linear-gradient(135deg, #232526, #414345); }
    .theme-colorful { background: linear-gradient(135deg, #ff7e5f, #feb47b); }

    /* Game World Container */
    #game-world-container {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%;
      height: 100%;
    }
    #city-canvas {
      display: block;
      width: 100%;
      height: 100%;
      background-color: #3a3a3a; /* N·ªÅn c·ªßa map n·∫øu ·∫£nh ch∆∞a load */
    }

    /* Modal Container (Ch·ª©a t·∫•t c·∫£ c√°c section ch·ª©c nƒÉng) */
    #modal-container {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      display: none; /* ·∫®n container m·∫∑c ƒë·ªãnh */
      align-items: center;
      justify-content: center;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
    }
    #modal-container.active {
        display: flex;
    }

    /* Section (ƒë∆∞·ª£c bi·∫øn ƒë·ªïi th√†nh Modal) */
    .section {
      border: 1px solid rgba(255, 255, 255, 0.5);
      padding: 20px;
      margin: 20px auto;
      max-width: 90%;
      max-height: 90vh;
      width: 800px;
      background-color: rgba(0, 0, 0, 0.8);
      border-radius: 10px;
      display: none; /* ·∫®n t·ª´ng section */
      flex-direction: column;
      position: relative;
      overflow-y: auto; /* Th√™m thanh cu·ªôn n·∫øu n·ªôi dung d√†i */
    }
    .section.active-modal {
      display: flex;
      opacity: 0;
      animation: fadeInModal 0.5s forwards;
    }
    
    @keyframes fadeInModal {
        to { opacity: 1; transform: scale(1); }
    }

    .modal-close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 2rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    
    /* ƒê·∫ßu trang trong Modal */
    header {
      padding: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    /* ·∫®n c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng c≈© */
    .nav { display: none; }
    h1, h2, h3 { margin-bottom: 10px; }

    input, button, textarea, select {
      margin: 5px 0;
      padding: 8px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
      color: #333;
    }
    input, textarea, select { width: calc(100% - 16px); }

    /* Mobile Joystick */
    #joystick-container {
        position: absolute;
        bottom: 30px;
        left: 30px;
        width: 120px;
        height: 120px;
        z-index: 10;
        opacity: 0.5;
    }
    #joystick-base {
        position: relative;
        width: 100%;
        height: 100%;
        background: rgba(128, 128, 128, 0.5);
        border-radius: 50%;
    }
    #joystick-stick {
        position: absolute;
        width: 60px;
        height: 60px;
        background: rgba(200, 200, 200, 0.8);
        border-radius: 50%;
        top: 30px;
        left: 30px;
    }

    /* C√°c style c≈© ƒë∆∞·ª£c gi·ªØ l·∫°i v√† ƒëi·ªÅu ch·ªânh */
    #chat-window {
      border: 1px solid rgba(255,255,255,0.5);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(255, 255, 255, 0.9);
      color: #000;
      display: flex;
      flex-direction: column;
    }
     #chat-window .message,
    #chat-window .system-message {
      color: #000 !important;
    }
    .message {
      margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 80%; word-break: break-word;
    }
    .message.mine { align-self: flex-end; background-color: #a8e6cf; text-align: right; }
    .message.other { align-self: flex-start; background-color: #81d4fa; text-align: left; }
    .system-message { align-self: center; background-color: #ffe082; color: #333; font-style: italic; padding: 5px; border-radius: 5px; max-width: 70%; margin: 10px auto; }
    .post-card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 10px; margin: 10px 0; text-align: left; }
    .post-card img { max-width: 100%; margin-top: 10px; border-radius: 5px; }
    .fb-comments-container { border: 2px solid #ffffff; padding: 10px; background-color: #f9f9f9; border-radius: 5px; margin: 20px auto; max-width: 95%; color: #000; }
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .toast { background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px 20px; margin-top: 10px; border-radius: 5px; opacity: 1; transition: opacity 0.5s ease-out; }
    .toast.hide { opacity: 0; }
    
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; font-size: 2rem; color: #fff; }
    .progress-circle { width: 150px; height: 150px; position: relative; }
    .progress-circle svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .progress-circle circle { fill: none; stroke-width: 12; stroke-linecap: round; }
    .progress-circle .bg { stroke: #555; }
    .progress-circle .progress { stroke: #4caf50; stroke-dasharray: 440; stroke-dashoffset: 440; transition: stroke-dashoffset 1s ease-out; }
    .progress-circle .percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; }

    /* Responsive cho mobile v√† m√†n h√¨nh xoay */
    @media (max-width: 768px) {
      .section {
        width: 95%;
        max-width: 95%;
        padding: 15px;
      }
      .modal-close-btn { font-size: 1.8rem; }
      h1 { font-size: 1.5rem; }
      h2 { font-size: 1.2rem; }
    }
    
    .hidden { display: none; }
    /* Gi·ªØ l·∫°i c√°c class style kh√°c n·∫øu c·∫ßn thi·∫øt */
    .container { max-width: 800px; margin: auto; background: rgba(255,255,255,0.1); padding: 20px; border-radius: 8px; }
    .video-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .video-box { width: 400px; height: 300px; background: black; position: relative; }
  </style>
</head>
<body class="theme-default">

  <!-- Game World Container -->
  <div id="game-world-container">
    <canvas id="city-canvas"></canvas>
    <!-- Joystick ·∫£o cho mobile -->
    <div id="joystick-container">
      <div id="joystick-base">
        <div id="joystick-stick"></div>
      </div>
    </div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container">
      <!-- T·∫•t c·∫£ c√°c section ƒë∆∞·ª£c chuy·ªÉn v√†o ƒë√¢y -->
      <!-- Login Section (Modal) -->
      <div class="section login-section" id="login-section">
          <!-- KH√îNG C·∫¶N N√öT ƒê√ìNG, N√ì S·∫º T·ª∞ ƒê√ìNG KHI LOGIN TH√ÄNH C√îNG -->
          <h2>ƒêƒÉng nh·∫≠p ƒë·ªÉ v√†o th√†nh ph·ªë</h2>
          <div id="login-google"> <button id="google-login">ƒêƒÉng nh·∫≠p v·ªõi Google</button> </div> <hr>
          <div id="login-email">
              <input type="email" id="email" placeholder="Email">
              <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
              <button id="email-login">ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω</button>
          </div> <hr>
          <div id="login-phone">
              <input type="text" id="phone-number" placeholder="SƒêT (VD: +849xxxxxxxx)">
              <div id="recaptcha-container"></div>
              <button id="send-otp">G·ª≠i OTP</button><br>
              <input type="text" id="otp-code" placeholder="Nh·∫≠p OTP">
              <button id="verify-otp">X√°c th·ª±c OTP</button>
          </div>
      </div>

      <!-- Chat Section (Modal) -->
      <div class="section chat-section" id="chat-section">
          <button class="modal-close-btn">√ó</button>
          <h2><span role="img" aria-label="cafe">‚òï</span> Qu√°n Cafe (Chat Chung)</h2>
          <div id="presence-list">
            <h3>Ng∆∞·ªùi c√≥ m·∫∑t:</h3> <ul id="online-users-list"></ul>
          </div>
          <div id="chat-window"></div>
          <div class="chat-input">
              <input type="text" id="message-input" placeholder="Tr√≤ chuy·ªán n√†o...">
              <button id="send-btn">G·ª≠i</button>
              <button id="upload-chat-btn">G·ª≠i ·∫¢nh</button>
          </div>
      </div>

      <!-- Forum Section (Modal) -->
      <div class="section forum-section" id="forum-section">
        <button class="modal-close-btn">√ó</button>
        <h2><span role="img" aria-label="townhall">üèõÔ∏è</span> T√≤a Th·ªã Ch√≠nh (Forum)</h2>
        <div class="forum-input">
          <textarea id="forum-message" placeholder="ƒêƒÉng th√¥ng b√°o ho·∫∑c th·∫£o lu·∫≠n..."></textarea>
          <button id="submit-forum-btn">ƒêƒÉng b√†i</button>
          <button id="upload-forum-btn">ƒê√≠nh k√®m ·∫¢nh</button>
        </div>
        <div id="forum-posts"></div>
      </div>
      
      <!-- C√°c section kh√°c c≈©ng ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y theo c√πng c·∫•u tr√∫c -->
      <div class="section private-chat-section" id="private-chat-section">
        <button class="modal-close-btn">√ó</button>
        <h2><span role="img" aria-label="home">üè†</span> Nh√† Ri√™ng (Private Chat)</h2>
        <div class="private-chat-input">
            <input type="text" id="pm-recipient" placeholder="G·ª≠i tin cho (nickname)">
            <input type="text" id="pm-message" placeholder="Nh·∫≠p tin nh·∫Øn ri√™ng...">
            <button id="send-pm-btn">G·ª≠i</button> <button id="upload-pm-btn">G·ª≠i ·∫£nh</button>
        </div>
        <div id="pm-chat-window" style="min-height:200px; overflow-y:auto; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 5px;"></div>
      </div>

      <div class="section social-network-section" id="social-section">
        <button class="modal-close-btn">√ó</button>
        <h2><span role="img" aria-label="park">üå≥</span> C√¥ng Vi√™n (M·∫°ng X√£ H·ªôi)</h2>
        <div class="social-input">
            <textarea id="social-message" placeholder="Chia s·∫ª kho·∫£nh kh·∫Øc..."></textarea>
            <button id="submit-social-btn">ƒêƒÉng</button>
            <button id="upload-social-btn">ƒê√≠nh k√®m ·∫¢nh</button>
        </div>
        <div id="social-posts"></div>
      </div>

      <div class="section game-section" id="game-section">
        <button class="modal-close-btn">√ó</button>
        <h2><span role="img" aria-label="arcade">üéÆ</span> Khu Gi·∫£i Tr√≠</h2>
        <div class="game-container" style="text-align:center;">
          <p>Ch∆°i game nh·∫π ngay t·∫°i ƒë√¢y!</p>
          <iframe src="https://drasaclone.github.io/Web/gamelite.html" style="width:100%; height:400px; border: 1px solid white;"></iframe>
          <h5>Nghe nh·∫°c</h5>
          <iframe width="280" height="150" src="https://www.youtube.com/embed/YobMVDtVjrI?si=GTYmlBiRpCduPWfO" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
        </div>
      </div>
      
      <div class="section profile-section" id="profile-section">
        <button class="modal-close-btn">√ó</button>
        <h2><span role="img" aria-label="profile">üë§</span> H·ªì S∆° C√° Nh√¢n</h2>
         <div id="profile-info"></div>
        <div id="profile-update">
            <input type="text" id="profile-nickname" placeholder="Nickname trong th√†nh ph·ªë">
            <button id="set-nickname-btn">C·∫≠p nh·∫≠t Nickname</button>
            <label for="theme-select">ƒê·ªïi m√†u n·ªÅn Modal:</label>
            <select id="theme-select">
                <option value="theme-default">M·∫∑c ƒë·ªãnh</option>
                <option value="theme-light">S√°ng</option>
                <option value="theme-dark">T·ªëi</option>
                <option value="theme-colorful">S·∫Øc m√†u</option>
            </select>
        </div>
      </div>
      
       <!-- Call Section -->
        <div class="section call-section" id="call-section">
            <button class="modal-close-btn">√ó</button>
            <h2><span role="img" aria-label="call">üìû</span> Tr·∫°m Li√™n L·∫°c (Video Call)</h2>
            <div class="container">
                <div id="loginSection" class="hidden"><h2>ƒêƒÉng nh·∫≠p Call</h2><input type="text" id="nicknameInput" placeholder="Nh·∫≠p nickname c·ªßa b·∫°n" style="width: 100%; padding: 10px; margin-bottom: 10px; color:#000;"><button id="loginBtn" style="padding: 10px 20px;">ƒêƒÉng nh·∫≠p</button></div>
                <div id="roomSection" class="hidden"><h2>Danh s√°ch ph√≤ng</h2><ul id="roomList" class="room-list"></ul><input type="text" id="newRoomName" placeholder="T√™n ph√≤ng m·ªõi" style="width: 100%; padding: 10px; margin-bottom: 10px; color:#000;"><button id="createRoomBtn" style="padding: 10px 20px;">T·∫°o ph√≤ng</button></div>
                <div id="callSection_inner" class="hidden"> <h2 id="callRoomTitle">Ph√≤ng: </h2><div id="localContainer" class="video-box"></div><div id="remoteContainer" class="video-container"></div><button id="leaveBtn" style="padding: 10px 20px; margin-top: 10px;">R·ªùi ph√≤ng</button></div>
            </div>
        </div>

      <!-- C√°c section c√≤n l·∫°i t∆∞∆°ng t·ª± -->
       <div class="section img-section" id="img-section">
         <button class="modal-close-btn">√ó</button>
         <h2><span role="img" aria-label="gallery">üñºÔ∏è</span> Tri·ªÉn L√£m ·∫¢nh</h2>
         <button id="upload_widget_opener">Upload ·∫¢nh</button>
         <div id="images_section" style="display:flex; flex-wrap:wrap; gap: 10px; justify-content:center;"></div>
      </div>

       <div class="section video-section" id="video-section">
          <button class="modal-close-btn">√ó</button>
          <h2><span role="img" aria-label="cinema">üé¨</span> R·∫°p Chi·∫øu Phim (Video)</h2>
          <div class="upload-video" style="text-align:center;">
              <input type="file" id="videoFile" accept="video/*"><br>
              <button id="uploadButton">Upload Video</button>
          </div>
          <div id="videoContainer" style="display:flex; flex-wrap:wrap; gap: 10px; justify-content:center;"></div>
      </div>
      
      <div class="section help-section" id="help-section">
          <button class="modal-close-btn">√ó</button>
           <h2><span role="img" aria-label="help">‚ùì</span> G√≥p √ù & H·ªó Tr·ª£</h2>
          <form id="userFeedbackForm" style="background: none; box-shadow: none; padding:0;">
              <label for="userFullName">H·ªç v√† t√™n:</label><input type="text" id="userFullName" class="custom-input" placeholder="Nh·∫≠p h·ªç v√† t√™n c·ªßa b·∫°n" required style="color:#000;">
              <label for="type">Ch·ªçn lo·∫°i ph·∫£n h·ªìi:</label><select id="type" class="custom-select" style="color:#000;"><option value="feedback">Feedback</option><option value="evaluation">ƒê√°nh gi√°</option><option value="qna">Q&A</option></select>
              <div id="ratingBlock" style="display: none;"><label>ƒê√°nh gi√° (1-5 sao):</label><div id="stars">...</div></div>
              <label for="userMessage">Chi ti·∫øt:</label><textarea id="userMessage" class="custom-textarea" rows="4" placeholder="Nh·∫≠p n·ªôi dung c·ªßa b·∫°n" required style="color:#000;"></textarea>
              <button type="submit" class="custom-button">G·ª≠i √Ω ki·∫øn</button>
          </form>
          <h2>T·∫•t c·∫£ ƒë√°nh gi√°:</h2>
          <div id="feedbackContainer"></div>
      </div>

  </div>

  <!-- Loading overlay v√† Toast Container kh√¥ng ƒë·ªïi -->
  <div id="loading-overlay" class="loading-overlay">
      <div class="progress-circle" data-percentage="100">
        <svg viewBox="0 0 150 150"> <circle class="bg" cx="75" cy="75" r="70"></circle> <circle class="progress" cx="75" cy="75" r="70"></circle> </svg>
        <div class="percentage">100%</div>
      </div>
  </div>
  <div id="toast-container"></div>
  
  <div id="fb-root"></div> <!-- Gi·ªØ l·∫°i cho FB comments -->

  <script>
    // --- KHAI B√ÅO BI·∫æN TO√ÄN C·ª§C CHO GAME ---
    const canvas = document.getElementById('city-canvas');
    const ctx = canvas.getContext('2d');
    const modalContainer = document.getElementById('modal-container');
    const joystickContainer = document.getElementById('joystick-container');
    const joystickStick = document.getElementById('joystick-stick');
    
    let players = {};
    let me = { id: null, x: 100, y: 100, speed: 4, size: 20, nickname: 'Guest' };
    const keys = { w: false, a: false, s: false, d: false };
    let camera = { x: 0, y: 0 };

    let isJoystickActive = false;
    let joystick = {
        x: joystickContainer.clientWidth / 2,
        y: joystickContainer.clientHeight / 2,
        radius: joystickContainer.clientWidth / 2,
        stickX: joystickContainer.clientWidth / 2,
        stickY: joystickContainer.clientHeight / 2,
        stickRadius: joystickStick.clientWidth / 2
    };

    const map = {
        width: 2000,
        height: 2000,
        buildings: [
            { id: 'chat-section',       name: '‚òï Qu√°n Cafe',      x: 200, y: 200, w: 200, h: 150, color: '#c27c0e' },
            { id: 'forum-section',      name: 'üèõÔ∏è T√≤a Th·ªã Ch√≠nh',   x: 600, y: 150, w: 250, h: 200, color: '#95a5a6' },
            { id: 'profile-section',    name: 'üë§ Nh√† T√¥i',        x: 100, y: 500, w: 150, h: 150, color: '#2980b9' },
            { id: 'social-section',     name: 'üå≥ C√¥ng Vi√™n',      x: 1000, y: 300, w: 300, h: 250, color: '#27ae60' },
            { id: 'game-section',       name: 'üéÆ Khu Gi·∫£i Tr√≠',     x: 550, y: 700, w: 200, h: 150, color: '#8e44ad' },
            { id: 'img-section',        name: 'üñºÔ∏è Tri·ªÉn L√£m ·∫¢nh',  x: 1400, y: 100, w: 200, h: 200, color: '#f1c40f' },
            { id: 'video-section',      name: 'üé¨ R·∫°p Phim',        x: 1400, y: 400, w: 200, h: 200, color: '#e74c3c' },
            { id: 'call-section',       name: 'üìû Tr·∫°m Li√™n L·∫°c',  x: 900, y: 800, w: 180, h: 150, color: '#3498db' },
            { id: 'help-section',       name: '‚ùì H·ªó Tr·ª£',           x: 100, y: 800, w: 150, h: 150, color: '#d35400' },
        ]
    };

    /* -------------------- H√ÄM H·ªñ TR·ª¢ & CODE C≈® KH√îNG ƒê·ªîI -------------------- */
    // H√†m sanitize, showToast, formatTime, logEvent ƒë∆∞·ª£c gi·ªØ nguy√™n
    function sanitize(str) { var temp = document.createElement('div'); temp.textContent = str; return temp.innerHTML; }
    function showToast(message) { const c=document.getElementById("toast-container"),t=document.createElement("div");t.className="toast",t.textContent=message,c.appendChild(t),setTimeout(()=>{t.classList.add("hide"),t.addEventListener("transitionend",()=>t.remove())}, 5000); }
    function formatTime(timestamp) { return new Date(timestamp).toLocaleString(); }
    function logEvent(type, details) {
      if (!firebase.auth().currentUser) return;
      var log = { eventType: type, details: details, timestamp: Date.now(), user: firebase.auth().currentUser.uid };
      firebase.database().ref('logs').push(log);
    }
    
    // ... (To√†n b·ªô code config v√† x·ª≠ l√Ω c·ªßa Firebase, PubNub, Agora, Cloudinary... ƒë∆∞·ª£c gi·ªØ nguy√™n ·ªü ƒë√¢y)
    // --- START ORIGINAL JS CODE ---

    /* -------------------- C·∫§U H√åNH FIREBASE -------------------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    var db = firebase.database();
    
    
    /* -------------------- KH·ªûI T·∫†O PUBNUB -------------------- */
    var pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });
    
    pubnub.subscribe({
      channels: ['chat'],
      withPresence: true
    });
    
    // --- END ORIGINAL JS CODE ---
    
    /* -------------------- C√ÅC H√ÄM C·ªêT L√ïI C·ª¶A GAME -------------------- */

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        joystickContainer.style.left = '30px';
        joystickContainer.style.bottom = '30px';
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
    
    function update() {
        // Player movement
        let dx = 0;
        let dy = 0;

        if (isJoystickActive) {
            dx = joystick.stickX - joystick.x;
            dy = joystick.stickY - joystick.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            if (distance > 0) {
                me.x += (dx / distance) * me.speed;
                me.y += (dy / distance) * me.speed;
            }
        } else {
             if (keys.w) dy -= me.speed;
             if (keys.s) dy += me.speed;
             if (keys.a) dx -= me.speed;
             if (keys.d) dx += me.speed;
             
             if (dx !== 0 && dy !== 0) { // Diagonal movement normalization
                const factor = me.speed / Math.sqrt(2);
                dx = dx > 0 ? factor : -factor;
                dy = dy > 0 ? factor : -factor;
            } else {
                dx *= me.speed;
                dy *= me.speed;
            }

            me.x += dx / (dx && dy ? Math.sqrt(2) : 1);
            me.y += dy / (dx && dy ? Math.sqrt(2) : 1);
        }


        // Map boundaries
        me.x = Math.max(me.size / 2, Math.min(map.width - me.size / 2, me.x));
        me.y = Math.max(me.size / 2, Math.min(map.height - me.size / 2, me.y));

        // Update player position on Firebase
        if (me.id && (dx !== 0 || dy !== 0)) {
            db.ref('players/' + me.id).update({ x: me.x, y: me.y });
        }
        
        // Update camera to follow player
        camera.x = me.x - canvas.width / 2;
        camera.y = me.y - canvas.height / 2;
        
        // Check for building interaction
        checkBuildingInteraction();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Save context and translate for camera
        ctx.save();
        ctx.translate(-camera.x, -camera.y);

        // Draw map background/grid
        drawMapGrid();

        // Draw buildings
        map.buildings.forEach(building => {
            ctx.fillStyle = building.color;
            ctx.fillRect(building.x, building.y, building.w, building.h);
            ctx.fillStyle = 'white';
            ctx.font = '24px "Dosis"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(building.name, building.x + building.w / 2, building.y + building.h / 2);
        });
        
        // Draw other players
        for (const id in players) {
            if (id !== me.id) {
                const p = players[id];
                ctx.fillStyle = 'orange';
                ctx.beginPath();
                ctx.arc(p.x, p.y, me.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'black';
                ctx.font = '16px "Dosis"';
                ctx.fillText(p.nickname, p.x, p.y - me.size);
            }
        }
        
        // Draw me
        ctx.fillStyle = 'cyan';
        ctx.beginPath();
        ctx.arc(me.x, me.y, me.size / 2, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = 'black';
        ctx.font = '16px "Dosis"';
        ctx.fillText(me.nickname, me.x, me.y - me.size);

        ctx.restore(); // Restore context from camera translate
    }

    function drawMapGrid() {
      ctx.strokeStyle = '#555';
      ctx.lineWidth = 1;
      const gridSize = 50;
      for (let x = 0; x <= map.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, map.height);
        ctx.stroke();
      }
      for (let y = 0; y <= map.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(map.width, y);
        ctx.stroke();
      }
    }

    /* -------------------- QU·∫¢N L√ù MODAL -------------------- */
    let currentOpenModal = null;

    function openModal(sectionId) {
        if(currentOpenModal) return; // Prevent opening multiple modals

        const section = document.getElementById(sectionId);
        if(section) {
            currentOpenModal = sectionId;
            modalContainer.classList.add('active');
            section.classList.add('active-modal');

            // Speacial handling for profile section
            if (sectionId === "profile-section") updateProfileSection();

            // Special handling for call section
            if (sectionId === "call-section") {
                 // Check if nickname for call is set
                 if (!nickname) {
                    document.getElementById('loginSection').classList.remove('hidden');
                 } else {
                    document.getElementById('roomSection').classList.remove('hidden');
                    listenForRooms();
                 }
            }
        }
    }
    
    function closeModal() {
        if(!currentOpenModal) return;
        
        const section = document.getElementById(currentOpenModal);
        if(section) {
            section.classList.remove('active-modal');
        }
        modalContainer.classList.remove('active');
        currentOpenModal = null;
    }
    
    document.querySelectorAll('.modal-close-btn').forEach(btn => {
        btn.addEventListener('click', closeModal);
    });
    
    function checkBuildingInteraction() {
        if(currentOpenModal) return; // Don't check if a modal is already open

        for (const building of map.buildings) {
            if (me.x > building.x && me.x < building.x + building.w &&
                me.y > building.y && me.y < building.y + building.h)
            {
                openModal(building.id);
                // Push player out slightly to prevent re-triggering immediately
                me.y = building.y + building.h + me.size;
                break;
            }
        }
    }
    
    /* -------------------- ƒêI·ªÄU KHI·ªÇN & S·ª∞ KI·ªÜN -------------------- */
    window.addEventListener('keydown', e => {
        if(currentOpenModal) return; // Disable movement when modal is open
        if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = true;
    });

    window.addEventListener('keyup', e => {
        if(e.key.toLowerCase() in keys) keys[e.key.toLowerCase()] = false;
    });

    // Joystick events for mobile
    joystickContainer.addEventListener('touchstart', e => {
        if(currentOpenModal) return;
        e.preventDefault();
        isJoystickActive = true;
        moveJoystick(e.touches[0]);
    }, { passive: false });

    joystickContainer.addEventListener('touchmove', e => {
        if(!isJoystickActive || currentOpenModal) return;
        e.preventDefault();
        moveJoystick(e.touches[0]);
    }, { passive: false });
    
    joystickContainer.addEventListener('touchend', e => {
        isJoystickActive = false;
        resetJoystick();
    });
    
    function moveJoystick(touch) {
        const rect = joystickContainer.getBoundingClientRect();
        let x = touch.clientX - rect.left - joystick.radius;
        let y = touch.clientY - rect.top - joystick.radius;
        const distance = Math.sqrt(x*x + y*y);

        if (distance > joystick.radius - joystick.stickRadius) {
            x = (x / distance) * (joystick.radius - joystick.stickRadius);
            y = (y / distance) * (joystick.radius - joystick.stickRadius);
        }

        joystick.stickX = joystick.radius + x;
        joystick.stickY = joystick.radius + y;
        joystickStick.style.transform = `translate(${x}px, ${y}px)`;
    }
    
    function resetJoystick() {
        joystick.stickX = joystick.radius;
        joystick.stickY = joystick.radius;
        joystickStick.style.transform = `translate(0px, 0px)`;
    }

    window.addEventListener('resize', resizeCanvas);


    /* -------------------- T√çCH H·ª¢P AUTH & FIREBASE PLAYER SYNC -------------------- */
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        me.id = user.uid;
        me.nickname = user.displayName || user.email || user.phoneNumber || 'Anonymous';
        document.getElementById('nickname').value = me.nickname;
        
        const playerRef = db.ref('players/' + me.id);
        playerRef.set({
          nickname: me.nickname,
          x: me.x,
          y: me.y
        });
        playerRef.onDisconnect().remove(); // Clean up when user disconnects
        
        closeModal(); // Close the login modal
        updateProfileSection();
        showToast(`Ch√†o m·ª´ng ${me.nickname} ƒë·∫øn v·ªõi th√†nh ph·ªë!`);
        logEvent('login', 'User logged in: ' + me.nickname);

      } else {
        openModal('login-section'); // Show login modal if not authenticated
        db.ref('players/' + me.id).remove(); // Remove player from db if they log out
        me.id = null;
      }
    });

    // Listen for all players' movements
    db.ref('players').on('value', (snapshot) => {
        players = snapshot.val() || {};
        const onlineList = document.getElementById('online-users-list');
        onlineList.innerHTML = '';
        for(const id in players) {
            const li = document.createElement('li');
            li.textContent = players[id].nickname;
            onlineList.appendChild(li);
        }
    });

    document.getElementById("set-nickname-btn").addEventListener("click", function() {
        const newNickname = document.getElementById("profile-nickname").value.trim();
        if(newNickname === "" || !me.id) return;
        
        me.nickname = newNickname;
        firebase.auth().currentUser.updateProfile({
            displayName: newNickname
        }).then(() => {
             db.ref('players/' + me.id).update({ nickname: newNickname });
             showToast("Nickname ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh: " + newNickname);
             updateProfileSection();
             logEvent("profile-update", "C·∫≠p nh·∫≠t nickname: " + newNickname);
        });
    });


    // ---- Code C≈© ƒê∆∞·ª£c T√≠ch H·ª£p (Ch·ªâ c√°c listener v√† h√†m logic) ----

    document.addEventListener("DOMContentLoaded", function() {
        showAlert(); // Hi·ªÉn th·ªã th√¥ng b√°o ch√†o m·ª´ng ban ƒë·∫ßu
        resizeCanvas();
        gameLoop(); // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p game
        
        const overlay = document.getElementById("loading-overlay");
        overlay.style.display = "flex";
        
        const circle = document.querySelector('.progress');
        const radius = circle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        
        anime({
            targets: circle,
            strokeDashoffset: [circumference, 0],
            duration: 1500,
            easing: 'easeInOutQuad',
            complete: function() {
                anime({
                    targets: overlay,
                    opacity: 0,
                    duration: 500,
                    easing: 'easeOutExpo',
                    complete: () => overlay.style.display = 'none'
                });
            }
        });
    });
    
    function showAlert() {
      // G·ªôp c√°c alert c≈© v√†o m·ªôt toast duy nh·∫•t, th√¢n thi·ªán h∆°n
      showToast("Ch√†o m·ª´ng b·∫°n! ƒê√¢y l√† m·ªôt d·ª± √°n ƒëang ph√°t tri·ªÉn. Vui l√≤ng nh·∫Øn tin vƒÉn minh. C·∫£m ∆°n B.H.Kh√°nh ƒë√£ h·ªó tr·ª£ d·ª± √°n. Ch√∫c b·∫°n m·ªôt ng√†y t·ªët l√†nh!");
    }

    // T√≠ch h·ª£p PubNub Listeners v√† c√°c h√†m x·ª≠ l√Ω s·ª± ki·ªán c≈©...
    pubnub.addListener({
        message: function(event) {
            //... Gi·ªØ nguy√™n
        },
        presence: function(event) {
            //... Gi·ªØ nguy√™n
        }
    });
    // C√°c h√†m appendMessage, appendSystemMessage, appendPrivateMessage gi·ªØ nguy√™n

    // C√°c event listener cho c√°c n√∫t trong modal (send-btn, submit-forum-btn,...)
    document.getElementById("send-btn").addEventListener("click", function() {
        var input = document.getElementById("message-input");
        var text = input.value.trim();
        if (text === "") return;
        var senderName = me.nickname;
        var message = { sender: senderName, text: text, timestamp: Date.now() };
        pubnub.publish({ channel: 'chat', message: message });
        db.ref('messages').push(message); // L∆∞u v√†o Firebase ƒë·ªÉ c√≥ l·ªãch s·ª≠
        input.value = "";
        logEvent("chat-send", "G·ª≠i tin chat: " + text);
    });

    // ... (T·∫•t c·∫£ c√°c event listener v√† h√†m logic kh√°c ƒë∆∞·ª£c ƒë·∫∑t ·ªü ƒë√¢y)
    // IMPORTANT: C√°c h√†m `append...` c·∫ßn ƒë∆∞·ª£c gi·ªØ nguy√™n ƒë·ªÉ hi·ªÉn th·ªã n·ªôi dung trong modal
    /*
      V√≠ d·ª•: function appendMessage(message) { ... }
      V√≠ d·ª•: document.getElementById("submit-forum-btn").addEventListener("click", ...);
      ... to√†n b·ªô logic x·ª≠ l√Ω s·ª± ki·ªán c·ªßa b·∫°n t·ª´ file g·ªëc ...
    */
   
    /* ------------- Gi·ªØ l·∫°i to√†n b·ªô code logic c·ªßa c√°c ch·ª©c nƒÉng ---------------*/

    //<PLACEHOLDER FOR ALL YOUR ORIGINAL LOGIC>
    // To keep it clean, you would copy-paste ALL remaining JS functions and event listeners
    // from your original file right here. This includes:
    // - appendMessage, appendSystemMessage, appendPrivateMessage
    // - All "click" listeners for forum, social, pm, uploads
    // - attachForumCommentsListener, attachSocialCommentsListener
    // - updateProfileSection logic
    // - All login provider logic (google-login, email-login, send-otp)
    // - All device info logging functions (getBasicDeviceInfo, logDetailedDeviceInfo, etc.)
    // - All Agora logic (joinRoom, leaveBtn, etc. - IMPORTANT: adapt callSection to callSection_inner)
    // - All Cloudinary image/video logic (createImageElement, uploadToCloudinary, etc.)
    // - All feedback form logic.

    function updateProfileSection() {
        const profileInfoDiv = document.getElementById("profile-info");
        const user = firebase.auth().currentUser;
        if(user) {
            me.nickname = user.displayName || me.nickname;
            let infoHTML = `<p><strong>Email:</strong> ${user.email || "Kh√¥ng c√≥"}</p>`;
            infoHTML += `<p><strong>T√™n trong th√†nh ph·ªë:</strong> ${me.nickname}</p>`;
            infoHTML += `<p><strong>UID:</strong> ${user.uid}</p>`;
            profileInfoDiv.innerHTML = infoHTML;
            document.getElementById('profile-nickname').value = me.nickname;
        } else {
            profileInfoDiv.innerHTML = "<p>Ch∆∞a ƒëƒÉng nh·∫≠p.</p>";
        }
    }

    /* V√ç D·ª§ T√çCH H·ª¢P ƒê·∫¶Y ƒê·ª¶: */
    /* ... Ch√®n to√†n b·ªô c√°c h√†m JS g·ªëc v√†o ƒë√¢y, t·ª´ 'function sanitize' ƒë·∫øn h·∫øt ... */
    // Ch·ªâ c·∫ßn ƒë·∫£m b·∫£o kh√¥ng khai b√°o l·∫°i c√°c bi·∫øn ƒë√£ c√≥ (db, pubnub, ...)
    // v√† ƒëi·ªÅu ch·ªânh ID n·∫øu c·∫ßn thi·∫øt (v√≠ d·ª• callSection -> callSection_inner)

    // V√≠ d·ª• v·ªÅ vi·ªác ph·∫£i ƒëi·ªÅu ch·ªânh
    // C≈©: document.getElementById('callSection').classList.add('hidden');
    // M·ªõi: document.getElementById('callSection_inner').classList.add('hidden');

  </script>

</body>
</html>
