<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII-NET v2.0 - Realtime Integration</title>
    
    <!-- ================== TÍCH HỢP SDK TỪ index++.html ================== -->
    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- PubNub SDK -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    
    <!-- Agora RTC SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <!-- ================================================================= -->

    <style>
        :root {
            --bg-color: #0d0d0d;
            --main-color: #00ff41;
            --accent-color: #f0f0f0;
            --border-color: #333;
            --error-color: #ff3860;
        }
        
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background-color: #000; color: var(--main-color);
            font-family: 'Courier New', Courier, monospace; font-size: 16px;
            overflow: hidden;
        }
        #terminal {
            width: 100%; height: 100%; padding: 15px;
            border: 2px solid var(--border-color); background-color: var(--bg-color);
            overflow-y: auto; position: relative;
        }
        #terminal::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: rgba(0, 0, 0, 0.15); opacity: 0.2;
            animation: scanline 7s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
        
        .page { width: 100%; display: none; }
        .page.active { display: block; }
        .sub-page { display: none; }

        .header-title { text-align: center; margin-bottom: 20px; text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--main-color); }
        pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: inherit; font-size: inherit; }
        .ascii-art { color: var(--accent-color); }
        .ascii-box { border: 1px solid var(--main-color); padding: 10px; margin-bottom: 15px; }
        .ascii-button {
            display: inline-block; border: 1px solid var(--main-color); padding: 5px 10px; margin: 5px;
            cursor: pointer; background-color: transparent; color: var(--main-color); font-family: inherit;
        }
        .ascii-button:hover, .ascii-button.active { background-color: var(--main-color); color: var(--bg-color); }
        input[type="text"], input[type="password"], textarea {
            background-color: transparent; border: none; border-bottom: 1px solid var(--main-color);
            color: var(--main-color); font-family: inherit; font-size: 1em; width: 250px;
        }
        textarea { width: 100%; border: 1px solid var(--main-color); padding: 5px; }
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 5px var(--main-color); }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: var(--main-color); } }
        #main-nav { display: flex; justify-content: center; flex-wrap: wrap; margin: 10px 0; border-top: 1px dashed var(--main-color); border-bottom: 1px dashed var(--main-color); padding: 5px 0; }
        .status-online { color: #23d160; } .status-offline { color: #ff3860; }
        .loader { display: inline-block; font-size: 1em; text-align: center; width: 100%; }
        a { color: var(--main-color); text-decoration: underline; cursor: pointer; }
        .comment, .social-comment { border-bottom: 1px dotted var(--border-color); padding: 5px 0; margin-top: 5px; }
        
        /* Video Call Specific Styles */
        .video-call-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;}
        .video-box { border: 1px solid var(--main-color); background: #000; width: 320px; height: 240px; position: relative; }
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-name { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 3px; font-size: 0.9em; }

        #toast-container { position: fixed; bottom: 10px; left: 10px; z-index: 9999; }
        .toast { border: 1px solid var(--main-color); background: var(--bg-color); padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="terminal">

    <!-- TRANG 0: KHỞI ĐỘNG HỆ THỐNG -->
    <div id="boot-page" class="page active">
        <pre class="ascii-art">
           _   _  ___ ___ ___ _    ___ 
          /_\ | |/ __/ __/ __| |  |_ _|
         / _ \| | (_|(_| \__ \ |__ | | 
        /_/ \_\_|\___\___\___/____|___|
                                   
        [ ASCII-NET v2.0 - Realtime Integration ]
        </pre>
        <pre id="boot-log"></pre>
    </div>


    <!-- TRANG 1: ĐĂNG NHẬP -->
    <div id="login-page" class="page">
        <div class="header-title">
            <pre>===================== TRUY CẬP HỆ THỐNG =====================</pre>
        </div>
        <div id="login-form">
             <div class="ascii-box">
                <pre>
> Nhập Email:   [ <input type="text" id="email" placeholder="user@domain.com" required> ]
> Mật khẩu:     [ <input type="password" id="password" placeholder="ít nhất 6 ký tự" required> ]<span class="blinking-cursor">_</span>
                </pre>
                <br>
                <button id="email-login" class="ascii-button">[//> ĐĂNG NHẬP / ĐĂNG KÝ BẰNG EMAIL <//]</button>
             </div>
             <div class="ascii-box">
                <pre>> Phương thức khác:</pre>
                <button id="google-login" class="ascii-button">[G]> ĐĂNG NHẬP VỚI GOOGLE <[G]</button>
            </div>
        </div>
        <div id="login-loader" style="display: none; margin-top: 20px;">
            <pre class="loader">Đang kết nối đến hệ thống chính... [|]</pre>
        </div>
    </div>


    <!-- =============================================== -->
    <!--  KHU VỰC CHÍNH SAU KHI ĐĂNG NHẬP -->
    <!-- =============================================== -->
    <div id="main-interface" class="page">
        <div class="ascii-box">
            <pre id="welcome-message">Đang kết nối...</pre>
            <div id="main-nav">
                <a class="ascii-button active" data-target="newsfeed-page">[Bảng tin]</a>
                <a class="ascii-button" data-target="chat-public-page">[Chat Chung]</a>
                <a class="ascii-button" data-target="video-call-page">[Gọi Video]</a>
                <a class="ascii-button" data-target="profile-page">[Hồ sơ]</a>
                <a class="ascii-button" data-target="help-page">[Trợ giúp]</a>
                <a class="ascii-button" data-target="settings-page">[Cài Đặt]</a>
                <button id="logout-btn" class="ascii-button" style="color:var(--error-color)">[Đăng xuất]</button>
            </div>
        </div>
        
        <!-- NỘI DUNG CÁC TRANG CON -->
        <div id="page-content">
        
            <!-- Trang con: BẢNG TIN -->
            <div id="newsfeed-page" class="sub-page">
                <pre class="header-title">+++ BẢNG TIN HỆ THỐNG +++</pre>
                <div class="ascii-box">
                    <pre>Tạo bài đăng mới:</pre>
                    <textarea id="social-message" rows="3" placeholder="Chia sẻ suy nghĩ của bạn ở đây..."></textarea>
                    <button id="submit-social-btn" class="ascii-button">[ Đăng ]</button>
                    <button id="upload-social-btn" class="ascii-button">[ Tải Lên Ảnh ]</button>
                </div>
                <div id="social-posts-container">
                    <pre class="loader">Đang tải bảng tin... [-]</pre>
                </div>
            </div>

            <!-- Trang con: CHAT CHUNG -->
            <div id="chat-public-page" class="sub-page">
                <pre class="header-title">### KÊNH CHAT CHUNG TOÀN MẠNG ###</pre>
                <div style="display: flex; gap: 15px;">
                    <div class="ascii-box" style="flex-grow: 3;">
                        <pre><u><b>Cửa sổ chat:</b></u></pre>
                        <div id="public-chat-window" style="height: 300px; overflow-y: auto; padding-top: 5px;"></div>
                        <div style="display: flex; margin-top: 10px;">
                            <pre style="flex-grow: 1;">[<input type="text" id="public-chat-input" style="width: 95%;" placeholder="Nhập tin nhắn..."><span class="blinking-cursor">_</span>]</pre>
                            <button id="send-chat-btn" class="ascii-button">[ Gửi ]</button>
                        </div>
                    </div>
                    <div class="ascii-box" style="flex-grow: 1;">
                         <pre><u><b>Đang Online:</b></u></pre>
                         <div id="online-users-list" style="height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Trang con: GỌI VIDEO -->
            <div id="video-call-page" class="sub-page">
                <pre class="header-title">@@@ TRUNG TÂM GỌI VIDEO AGORA @@@</pre>
                <!-- Room List & Creation -->
                <div id="room-selection" class="ascii-box">
                    <pre><b>Danh sách phòng hiện có:</b></pre>
                    <div id="room-list">Chưa có phòng nào.</div>
                    <hr>
                    <pre>Tạo phòng mới: [ <input type="text" id="new-room-name" placeholder="Tên phòng..."> ] <button id="create-room-btn" class="ascii-button">[ Tạo ]</button></pre>
                </div>
                <!-- Call Interface -->
                <div id="call-interface" style="display:none;">
                    <pre id="call-room-title">Đang trong phòng: </pre>
                    <div class="video-call-container">
                        <div class="video-box" id="local-stream">
                           <div class="video-name">You (Local)</div>
                        </div>
                         <!-- Remote streams will be added here by JS -->
                        <div id="remote-streams"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                       <button id="leave-btn" class="ascii-button">[ KẾT THÚC CUỘC GỌI ]</button>
                    </div>
                </div>
            </div>

            <!-- Trang con: HỒ SƠ -->
            <div id="profile-page" class="sub-page">
                 <pre class="header-title">*** HỒ SƠ NGƯỜI DÙNG ***</pre>
                 <div class="ascii-box" id="profile-info-container">
                    <pre>Đang tải thông tin hồ sơ...</pre>
                 </div>
                 <div class="ascii-box">
                    <pre>Cập nhật nickname:<br>[ <input type="text" id="profile-nickname-input" placeholder="Nhập nickname mới..."> ] <button id="update-nickname-btn" class="ascii-button">[ Cập nhật ]</button></pre>
                 </div>
            </div>

            <!-- Trang con: TRỢ GIÚP / FEEDBACK -->
            <div id="help-page" class="sub-page">
                 <pre class="header-title">??? TRỢ GIÚP & PHẢN HỒI ???</pre>
                 <div class="ascii-box">
                    <form id="feedback-form">
                        <pre>Họ và Tên:  [ <input type="text" id="feedback-name" required> ]</pre>
                        <pre>Nội dung phản hồi:</pre>
                        <textarea id="feedback-message" rows="4" required></textarea><br>
                        <button type="submit" class="ascii-button">[ Gửi Phản Hồi ]</button>
                    </form>
                 </div>
                 <div class="ascii-box">
                     <pre><b>Danh sách các phản hồi:</b></pre>
                     <div id="feedback-container"></div>
                 </div>
            </div>
            
            <!-- Trang con: CÀI ĐẶT -->
            <div id="settings-page" class="sub-page">
                <pre class="header-title">⚙️ CÀI ĐẶT HỆ THỐNG ⚙️</pre>
                 <div class="ascii-box">
                    <pre><b>[Chủ đề (Theme)]</b> - Thay đổi màu sắc giao diện</pre>
                    <br>
                    <button class="ascii-button theme-btn" data-theme="green">Terminal (Mặc định)</button>
                    <button class="ascii-button theme-btn" data-theme="amber">Amber</button>
                    <button class="ascii-button theme-btn" data-theme="blue">Matrix Blue</button>
                    <button class="ascii-button theme-btn" data-theme="white">Classic DOS</button>
                 </div>
            </div>
            
        </div>
    </div>
    
</div>
<div id="toast-container"></div>
<div id="recaptcha-container" style="display:none;"></div>

<script>
// Prevent FOUC
document.body.style.display = "none";

document.addEventListener('DOMContentLoaded', () => {
    document.body.style.display = "block";
    // === CẤU HÌNH FIREBASE, PUBNUB, AGORA ===
    const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    const pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });

    const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
    const cloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: 'dgbux4wzo',
        uploadPreset: 'okeqfdx4'
    }, (error, result) => {
        if (!error && result && result.event === "success") {
            const socialMsgField = document.getElementById("social-message");
            socialMsgField.value += `\n[image]${result.info.secure_url}[/image]`;
            showToast(`> Ảnh đã được thêm vào bài đăng.`);
        }
    });

    // === BIẾN TOÀN CỤC & DOM ELEMENTS ===
    const pages = document.querySelectorAll('.page');
    const subPages = document.querySelectorAll('.sub-page');
    const navButtons = document.querySelectorAll('#main-nav .ascii-button');
    const terminal = document.getElementById('terminal');
    let currentUser = null;
    let userNickname = 'anonymous';

    // === HÀM TIỆN ÍCH ===
    function showToast(message) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.innerHTML = `<pre>${message}</pre>`;
      container.appendChild(toast);
      setTimeout(() => { toast.remove(); }, 5000);
    }

    function sanitize(str) {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    function formatTime(timestamp) {
        return new Date(timestamp).toLocaleTimeString();
    }
    
    function showPage(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(pageId)?.classList.add('active');
        terminal.scrollTop = 0;
    }
    
    function showSubPage(subPageId) {
        subPages.forEach(sp => sp.style.display = 'none');
        document.getElementById(subPageId).style.display = 'block';
        navButtons.forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-target') === subPageId);
        });
    }

    // === XỬ LÝ KHỞI ĐỘNG HỆ THỐNG ===
    const bootLog = document.getElementById('boot-log');
    const bootSteps = [ "Initializing...", "Loading ASCII-NET OS...", "Connecting to network...", "System Ready." ];
    let stepIndex = 0;
    function runBootSequence() {
        if (stepIndex < bootSteps.length) {
            bootLog.innerHTML += `<pre>[ OK ] ${bootSteps[stepIndex]}</pre>`;
            stepIndex++;
            setTimeout(runBootSequence, Math.random() * 400 + 100);
        } else {
            setTimeout(() => {
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        userNickname = user.displayName || user.email.split('@')[0];
                        initializeApp();
                    } else {
                        showPage('login-page');
                    }
                });
            }, 1000);
        }
    }
    
    function initializeApp() {
        showPage('main-interface');
        showSubPage('newsfeed-page');
        document.getElementById('welcome-message').textContent = `USER: ${userNickname} | STATUS: Online`;

        // Start listening to all realtime services
        subscribeToPubNub();
        loadSocialPosts();
        loadFeedback();
        listenForAgoraRooms();
        updateProfilePage();
    }

    // === XỬ LÝ ĐĂNG NHẬP / ĐĂNG XUẤT ===
    document.getElementById('email-login').addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, password).catch(error => {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                showToast(`> Lỗi: ${error.message}\n> Thử tạo tài khoản mới...`);
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => showToast(`> Tài khoản mới đã được tạo.`))
                    .catch(err => showToast(`> Lỗi tạo tài khoản: ${err.message}`));
            }
        });
    });

    document.getElementById('google-login').addEventListener('click', () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider);
    });

    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().then(() => location.reload()));
    
    // === ĐIỀU HƯỚNG GIAO DIỆN CHÍNH ===
    navButtons.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const targetId = link.getAttribute('data-target');
            if (targetId) showSubPage(targetId);
        });
    });

    // === CHỨC NĂNG CHAT CHUNG (PUBNUB) ===
    const chatInput = document.getElementById('public-chat-input');
    const chatWindow = document.getElementById('public-chat-window');

    function subscribeToPubNub() {
        pubnub.subscribe({ channels: ['ascii_chat'], withPresence: true });
        pubnub.addListener({
            message: (event) => {
                appendChatMessage(event.message);
            },
            presence: (event) => {
                updateOnlineUsers();
                if (event.action === "join") {
                     appendSystemMessage(`${event.uuid} has connected.`);
                } else if (event.action === "leave" || event.action === "timeout") {
                     appendSystemMessage(`${event.uuid} has disconnected.`);
                }
            }
        });
        updateOnlineUsers();
    }

    function appendChatMessage(msg) {
        const line = document.createElement('pre');
        line.innerHTML = `[${formatTime(msg.timestamp)}] <b>&lt;${sanitize(msg.sender)}&gt;</b>: ${sanitize(msg.text)}`;
        chatWindow.appendChild(line);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
     function appendSystemMessage(text) {
        const line = document.createElement('pre');
        line.innerHTML = `<i>--- ${sanitize(text)} ---</i>`;
        chatWindow.appendChild(line);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function sendChatMessage() {
        if (!chatInput.value.trim()) return;
        pubnub.publish({
            channel: 'ascii_chat',
            message: { sender: userNickname, text: chatInput.value, timestamp: Date.now() }
        });
        chatInput.value = '';
    }

    document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
    chatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });
    
    function updateOnlineUsers(){
        pubnub.hereNow({ channels: ["ascii_chat"], includeUUIDs: true }, (status, response) => {
            const onlineUsersList = document.getElementById('online-users-list');
            onlineUsersList.innerHTML = '';
            response.channels.ascii_chat.occupants.forEach(user => {
                const userPre = document.createElement('pre');
                userPre.textContent = `> ${user.uuid}`;
                onlineUsersList.appendChild(userPre);
            });
        });
    }

    // === CHỨC NĂNG BẢNG TIN (FIREBASE) ===
    const socialPostsContainer = document.getElementById('social-posts-container');
    
    function loadSocialPosts() {
        const postsRef = db.ref('socialPosts').orderByChild('timestamp').limitToLast(20);
        postsRef.on('value', snapshot => {
            socialPostsContainer.innerHTML = '';
            let posts = [];
            snapshot.forEach(child => { posts.push({ key: child.key, ...child.val() }); });
            posts.reverse().forEach(post => {
                 socialPostsContainer.appendChild(createPostElement(post.key, post));
            });
        });
    }

    function createPostElement(key, post) {
        const postBox = document.createElement('div');
        postBox.className = 'ascii-box';

        let content = sanitize(post.text);
        // Replace image markdown with an actual link
        content = content.replace(/\[image\](.*?)\[\/image\]/g, `<br/><pre> >> Image Link: <a href="$1" target="_blank">$1</a></pre>`);
        
        postBox.innerHTML = `
            <pre>
<b>@${sanitize(post.sender)}</b> at ${new Date(post.timestamp).toLocaleString()}:
<hr>
${content}
<hr>
<button class="ascii-button like-btn" data-key="${key}">[Thích (${post.likeCount || 0})]</button>
<button class="ascii-button comment-btn" data-key="${key}">[Bình luận]</button>
            </pre>
            <div class="comment-section" id="comments-${key}"></div>`;

        // Attach listeners
        postBox.querySelector('.like-btn').addEventListener('click', () => {
            db.ref(`socialPosts/${key}/likeCount`).transaction(count => (count || 0) + 1);
        });
        postBox.querySelector('.comment-btn').addEventListener('click', () => {
            const commentText = prompt('Nhập bình luận của bạn:');
            if (commentText) {
                db.ref(`socialPosts/${key}/comments`).push({
                    sender: userNickname, text: commentText, timestamp: Date.now()
                });
            }
        });
        
        // Load comments
        const commentsContainer = postBox.querySelector('.comment-section');
        db.ref(`socialPosts/${key}/comments`).on('value', snap => {
            commentsContainer.innerHTML = '';
            snap.forEach(child => {
                const comment = child.val();
                commentsContainer.innerHTML += `<pre class="comment">  <b>&lt;${sanitize(comment.sender)}&gt;</b> ${sanitize(comment.text)}</pre>`;
            });
        });

        return postBox;
    }

    document.getElementById('submit-social-btn').addEventListener('click', () => {
        const text = document.getElementById('social-message').value.trim();
        if (!text) {
            showToast('> Nội dung không thể trống.'); return;
        }
        db.ref('socialPosts').push({
            sender: userNickname,
            text: text,
            timestamp: Date.now(),
            likeCount: 0
        });
        document.getElementById('social-message').value = '';
    });
    
    document.getElementById('upload-social-btn').addEventListener('click', () => cloudinaryWidget.open());


    // === CHỨC NĂNG PROFILE ===
    function updateProfilePage() {
        const container = document.getElementById('profile-info-container');
        if (currentUser) {
            container.innerHTML = `<pre>
Email.......: ${currentUser.email || 'N/A'}
User ID.....: ${currentUser.uid}
Nickname....: ${userNickname}
</pre>`;
        }
    }
    document.getElementById('update-nickname-btn').addEventListener('click', () => {
        const newNickname = document.getElementById('profile-nickname-input').value.trim();
        if (newNickname) {
            currentUser.updateProfile({ displayName: newNickname }).then(() => {
                userNickname = newNickname;
                pubnub.setUUID(newNickname);
                updateProfilePage();
                showToast('> Cập nhật nickname thành công.');
                location.reload(); // To reflect new nickname everywhere
            }).catch(error => showToast(`> Lỗi: ${error.message}`));
        }
    });

    // === CHỨC NĂNG FEEDBACK ===
    const feedbackForm = document.getElementById('feedback-form');
    const feedbackContainer = document.getElementById('feedback-container');
    feedbackForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('feedback-name').value;
        const message = document.getElementById('feedback-message').value;
        db.ref('feedback').push({
            name, message, timestamp: Date.now()
        }).then(() => {
            showToast('> Cảm ơn phản hồi của bạn!');
            feedbackForm.reset();
        });
    });

    function loadFeedback() {
        db.ref('feedback').on('value', snap => {
            feedbackContainer.innerHTML = '';
            snap.forEach(child => {
                const fb = child.val();
                feedbackContainer.innerHTML += `<pre class="comment">> [${new Date(fb.timestamp).toLocaleDateString()}] <b>${sanitize(fb.name)}</b>: ${sanitize(fb.message)}</pre>`;
            });
        });
    }

    // === CHỨC NĂNG CÀI ĐẶT THEME ===
    const themes = {
        green: { bg: '#0d0d0d', main: '#00ff41', accent: '#f0f0f0', error: '#ff3860'},
        amber: { bg: '#2E2519', main: '#FFB000', accent: '#FFEca1', error: '#FF4136'},
        blue:  { bg: '#051025', main: '#33A1FF', accent: '#AedFFF', error: '#FF6347'},
        white: { bg: '#0000AA', main: '#FFFFFF', accent: '#CCCCCC', error: '#FFFF55'}
    };
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const selectedTheme = themes[btn.getAttribute('data-theme')];
            const root = document.documentElement;
            root.style.setProperty('--bg-color', selectedTheme.bg);
            root.style.setProperty('--main-color', selectedTheme.main);
            root.style.setProperty('--accent-color', selectedTheme.accent);
            root.style.setProperty('--error-color', selectedTheme.error);
        });
    });

    // === AGORA VIDEO CALL LOGIC ===
    let agoraClient;
    let localTracks = [];
    let currentRoomName = '';

    const roomSelectionDiv = document.getElementById('room-selection');
    const callInterfaceDiv = document.getElementById('call-interface');

    function listenForAgoraRooms() {
        db.ref("agoraRooms").on("value", snapshot => {
            const roomListDiv = document.getElementById("room-list");
            roomListDiv.innerHTML = "";
            const roomsData = snapshot.val();
            if (!roomsData) {
                roomListDiv.innerHTML = "<pre>Chưa có phòng nào. Hãy tạo một phòng!</pre>";
            } else {
                Object.keys(roomsData).forEach(key => {
                    const room = roomsData[key];
                    const roomEl = document.createElement('pre');
                    roomEl.innerHTML = `> ${room.name} [ <a data-room-name="${room.name}">Tham gia</a> ]`;
                    roomEl.querySelector('a').onclick = () => joinRoom(room.name);
                    roomListDiv.appendChild(roomEl);
                });
            }
        });
    }

    document.getElementById("create-room-btn").addEventListener("click", () => {
        const roomName = document.getElementById("new-room-name").value.trim();
        if (!roomName) { showToast('> Tên phòng không hợp lệ'); return; }
        db.ref("agoraRooms").push({ name: roomName, createdBy: userNickname, createdAt: Date.now() });
        document.getElementById("new-room-name").value = "";
    });

    async function joinRoom(roomName) {
        currentRoomName = roomName;
        roomSelectionDiv.style.display = 'none';
        callInterfaceDiv.style.display = 'block';
        document.getElementById("call-room-title").textContent = `Đang trong phòng: ${roomName}`;
        
        agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        agoraClient.on("user-published", handleUserPublished);
        agoraClient.on("user-left", handleUserLeft);
        
        try {
            await agoraClient.join(AGORA_APP_ID, currentRoomName, null, null);
            localTracks = await AgoraRTC.createMicrophoneAndCameraTracks();
            
            const localPlayer = document.createElement('div');
            localPlayer.id = `player-${currentUser.uid}`;
            localPlayer.className = 'video-box';
            localPlayer.innerHTML = `<div class="video-name">You (${userNickname})</div>`;
            document.getElementById('local-stream').innerHTML = '';
            document.getElementById('local-stream').appendChild(localPlayer);
            localTracks[1].play(localPlayer);

            await agoraClient.publish(localTracks);
        } catch (error) {
            console.error("Lỗi tham gia phòng:", error);
            showToast('> Lỗi tham gia phòng. Kiểm tra console.');
            await leaveRoom();
        }
    }
    
    async function handleUserPublished(user, mediaType) {
        await agoraClient.subscribe(user, mediaType);
        if (mediaType === "video") {
            const remotePlayer = document.createElement('div');
            remotePlayer.id = `player-${user.uid}`;
            remotePlayer.className = 'video-box';
            remotePlayer.innerHTML = `<div class="video-name">User ${user.uid}</div>`; // In a real app, you'd fetch the user's nickname
            document.getElementById('remote-streams').appendChild(remotePlayer);
            user.videoTrack.play(remotePlayer);
        }
        if (mediaType === "audio") {
            user.audioTrack.play();
        }
    }

    function handleUserLeft(user) {
        document.getElementById(`player-${user.uid}`)?.remove();
    }
    
    async function leaveRoom() {
        for (let track of localTracks) {
            track.stop();
            track.close();
        }
        await agoraClient?.leave();
        document.getElementById('local-stream').innerHTML = `<div class="video-name">You (Local)</div>`;
        document.getElementById('remote-streams').innerHTML = '';
        roomSelectionDiv.style.display = 'block';
        callInterfaceDiv.style.display = 'none';
        showToast(`> Đã rời phòng ${currentRoomName}`);
        currentRoomName = '';
    }
    document.getElementById("leave-btn").addEventListener("click", leaveRoom);
    

    // === BẮT ĐẦU CHƯƠNG TRÌNH ===
    runBootSequence();

});
</script>

</body>
</html>
