<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII-NET v3.0 - Citadel Edition</title>
    
    <!-- ================== SDKs ================== -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <!-- ================================================================= -->

    <style>
        :root {
            --bg-color: #0d0d0d;
            --main-color: #00ff41;
            --accent-color: #f0f0f0;
            --border-color: #333;
            --error-color: #ff3860;
            --like-color: #33A1FF;
        }
        
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background-color: #000; color: var(--main-color);
            font-family: 'Courier New', Courier, monospace; font-size: 16px;
            overflow: hidden;
        }
        #terminal {
            width: 100%; height: 100%; padding: 15px;
            border: 2px solid var(--border-color); background-color: var(--bg-color);
            overflow-y: auto; position: relative;
        }
        #terminal::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: rgba(0, 0, 0, 0.15); opacity: 0.2;
            animation: scanline 7s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
        
        .page { width: 100%; display: none; }
        .page.active { display: block; }
        .sub-page { display: none; }

        .header-title { text-align: center; margin-bottom: 20px; text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--main-color); }
        pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: inherit; font-size: inherit; }
        .ascii-art { color: var(--accent-color); text-align: center; }
        .ascii-box { border: 1px solid var(--main-color); padding: 10px; margin-bottom: 15px; }
        .ascii-button {
            display: inline-block; border: 1px solid var(--main-color); padding: 5px 10px; margin: 5px;
            cursor: pointer; background-color: transparent; color: var(--main-color); font-family: inherit; font-size: 0.9em;
        }
        .ascii-button:hover, .ascii-button.active { background-color: var(--main-color); color: var(--bg-color); }
        .ascii-button:disabled { cursor: not-allowed; opacity: 0.5; }
        input[type="text"], input[type="password"], textarea {
            background-color: transparent; border: none; border-bottom: 1px solid var(--main-color);
            color: var(--main-color); font-family: inherit; font-size: 1em; width: 250px;
        }
        textarea { width: 100%; border: 1px solid var(--main-color); padding: 5px; resize: vertical; }
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 5px var(--main-color); }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: var(--main-color); } }
        #main-nav { display: flex; justify-content: center; flex-wrap: wrap; margin: 10px 0; border-top: 1px dashed var(--main-color); border-bottom: 1px dashed var(--main-color); padding: 5px 0; }
        a { color: var(--main-color); text-decoration: underline; cursor: pointer; }
        .loader { animation: blink 1.5s linear infinite; }
        
        /* Social Feed Styles */
        .avatar-img { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--main-color); margin-right: 10px; vertical-align: middle; }
        .post-content-img { max-width: 90%; border: 1px solid var(--border-color); margin-top: 10px; }
        .comment-section { border-top: 1px dashed var(--border-color); margin-top: 10px; padding-top: 10px; }
        .comment { border-bottom: 1px dotted var(--border-color); padding: 8px 5px; margin-top: 5px; display: flex; }
        .comment-content { flex-grow: 1; }
        .comment-actions { font-size: 0.8em; }
        .comment-actions a { margin-left: 10px; }
        .comment-input-area { display: flex; gap: 10px; margin-top: 10px; }
        .comment-input-area input { flex-grow: 1; }
        .post-actions button { font-size: 0.8em; padding: 3px 8px;}
        .like-btn.liked { background-color: var(--like-color); color: var(--bg-color); border-color: var(--like-color);}

        /* Video Call Specific Styles */
        .video-call-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;}
        .video-box { border: 1px solid var(--main-color); background: #000; width: 320px; height: 240px; position: relative; display: flex; align-items: center; justify-content: center;}
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-name { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 3px; font-size: 0.9em; }
        .video-controls { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); display: flex; gap: 5px; padding: 3px;}
        .control-btn.muted { text-decoration: line-through; color: var(--error-color); }

        /* Toast & Misc */
        #toast-container { position: fixed; bottom: 10px; left: 10px; z-index: 9999; }
        .toast { border: 1px solid var(--main-color); background: var(--bg-color); padding: 10px; margin-top: 5px; }
        #boot-progress-bar { width: 0; height: 5px; background-color: var(--main-color); transition: width 0.5s ease-out; margin: 10px 0;}

        /* Responsive Design */
        @media (max-width: 768px) {
            #main-nav { flex-direction: column; align-items: center; }
            .ascii-button { width: 80%; text-align: center; }
            #chat-public-page > div { flex-direction: column; }
            .video-box { width: 90vw; height: 67.5vw; }
            input[type="text"], input[type="password"] { width: 90%; }
        }
    </style>
</head>
<body>

<div id="terminal">
    <!-- TRANG 0: KHỞI ĐỘNG HỆ THỐNG -->
    <div id="boot-page" class="page active">
        <pre class="ascii-art">
           _   _  ___ ___ ___ _    ___ 
          /_\ | |/ __/ __/ __| |  |_ _|
         / _ \| | (_|(_| \__ \ |__ | | 
        /_/ \_\_|\___\___\___/____|___|
                                   
      [ ASCII-NET v3.0 - Citadel Edition ]
        </pre>
        <pre id="boot-log"></pre>
        <div id="boot-progress-bar-container"><div id="boot-progress-bar"></div></div>
    </div>


    <!-- TRANG 1: ĐĂNG NHẬP -->
    <div id="login-page" class="page">
        <div class="header-title"><pre>===================== TRUY CẬP HỆ THỐNG =====================</pre></div>
        <div id="login-form">
             <div class="ascii-box">
                <pre>
> Nhập Email:   [ <input type="text" id="email" placeholder="user@domain.com" required> ]
> Mật khẩu:     [ <input type="password" id="password" placeholder="ít nhất 6 ký tự" required> ]<span class="blinking-cursor">_</span>
                </pre><br>
                <button id="email-login" class="ascii-button">[//> ĐĂNG NHẬP / ĐĂNG KÝ <//]</button>
             </div>
             <div class="ascii-box">
                <pre>> Phương thức khác:</pre>
                <button id="google-login" class="ascii-button">[G]> ĐĂNG NHẬP VỚI GOOGLE <[G]</button>
            </div>
        </div>
        <div id="login-loader" style="display: none; margin-top: 20px;"><pre class="loader">Đang kết nối đến hệ thống chính...</pre></div>
    </div>


    <!-- =============================================== -->
    <!--  KHU VỰC CHÍNH SAU KHI ĐĂNG NHẬP -->
    <!-- =============================================== -->
    <div id="main-interface" class="page">
        <div class="ascii-box">
            <pre id="welcome-message">Đang kết nối...</pre>
            <div id="main-nav">
                <a class="ascii-button active" data-target="newsfeed-page">[Bảng tin]</a>
                <a class="ascii-button" data-target="chat-public-page">[Chat Chung]</a>
                <a class="ascii-button" data-target="video-call-page">[Gọi Video]</a>
                <a class="ascii-button" data-target="profile-page">[Hồ sơ]</a>
                <a class="ascii-button" data-target="help-page">[Trợ giúp]</a>
                <a class="ascii-button" data-target="settings-page">[Cài Đặt]</a>
                <button id="logout-btn" class="ascii-button" style="color:var(--error-color)">[Đăng xuất]</button>
            </div>
        </div>
        
        <div id="page-content">
        
            <!-- Trang con: BẢNG TIN -->
            <div id="newsfeed-page" class="sub-page">
                <pre class="header-title">+++ BẢNG TIN HỆ THỐNG +++</pre>
                <div class="ascii-box">
                    <pre>Tạo bài đăng mới:</pre>
                    <textarea id="social-message" rows="3" placeholder="Chia sẻ suy nghĩ của bạn..."></textarea>
                    <button id="submit-social-btn" class="ascii-button">[ Đăng ]</button>
                    <button id="upload-social-btn" class="ascii-button">[ Tải Ảnh ]</button>
                </div>
                <div id="social-posts-container"><pre class="loader">Đang tải bảng tin...</pre></div>
            </div>

            <!-- Trang con: CHAT CHUNG -->
            <div id="chat-public-page" class="sub-page">
                <pre class="header-title">### KÊNH CHAT CHUNG TOÀN MẠNG ###</pre>
                <div style="display: flex; gap: 15px;">
                    <div class="ascii-box" style="flex-grow: 3;">
                        <pre><u><b>Cửa sổ chat:</b></u></pre>
                        <div id="public-chat-window" style="height: 300px; overflow-y: auto; padding: 5px;"><pre class="loader">Đang tải lịch sử chat...</pre></div>
                        <div style="display: flex; margin-top: 10px;">
                            <pre style="flex-grow: 1;">[<input type="text" id="public-chat-input" style="width: 95%;" placeholder="Nhập tin nhắn..."><span class="blinking-cursor">_</span>]</pre>
                            <button id="send-chat-btn" class="ascii-button">[ Gửi ]</button>
                        </div>
                    </div>
                    <div class="ascii-box" style="flex-grow: 1;">
                         <pre><u><b>Đang Online:</b></u></pre>
                         <div id="online-users-list" style="height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- Trang con: GỌI VIDEO -->
            <div id="video-call-page" class="sub-page">
                <pre class="header-title">@@@ TRUNG TÂM GỌI VIDEO AGORA @@@</pre>
                <div id="room-selection" class="ascii-box">
                    <pre><b>Danh sách phòng hiện có:</b></pre>
                    <div id="room-list">Chưa có phòng nào.</div><hr>
                    <pre>Tạo phòng mới: [ <input type="text" id="new-room-name" placeholder="Tên phòng..."> ] <button id="create-room-btn" class="ascii-button">[ Tạo ]</button></pre>
                </div>
                <div id="call-interface" style="display:none;">
                    <pre id="call-room-title">Đang trong phòng: </pre>
                    <div class="video-call-container">
                        <div class="video-box" id="local-stream">
                           <div class="video-name">You (Local)</div>
                           <div class="video-controls">
                                <button id="mic-btn" class="ascii-button control-btn">[Tắt Mic]</button>
                                <button id="cam-btn" class="ascii-button control-btn">[Ẩn Cam]</button>
                           </div>
                        </div>
                        <div id="remote-streams"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                       <button id="leave-btn" class="ascii-button">[ KẾT THÚC CUỘC GỌI ]</button>
                    </div>
                </div>
            </div>

            <!-- Trang con: HỒ SƠ -->
            <div id="profile-page" class="sub-page">
                 <pre class="header-title">*** HỒ SƠ NGƯỜI DÙNG ***</pre>
                 <div class="ascii-box" id="profile-info-container"><pre>Đang tải thông tin...</pre></div>
                 <div class="ascii-box">
                    <pre>Cập nhật nickname:<br>[ <input type="text" id="profile-nickname-input" placeholder="Nhập nickname mới..."> ] <button id="update-nickname-btn" class="ascii-button">[ Cập nhật ]</button></pre>
                 </div>
                 <div class="ascii-box">
                    <pre>Cập nhật ảnh đại diện (avatar):</pre>
                    <button id="upload-avatar-btn" class="ascii-button">[ Tải Lên Ảnh Đại Diện ]</button>
                 </div>
            </div>

            <!-- Trang con: TRỢ GIÚP / FEEDBACK -->
            <div id="help-page" class="sub-page">
                 <pre class="header-title">??? TRỢ GIÚP & PHẢN HỒI ???</pre>
                 <div class="ascii-box">
                    <form id="feedback-form">
                        <pre>Họ và Tên:  [ <input type="text" id="feedback-name" required> ]</pre>
                        <pre>Nội dung phản hồi:</pre>
                        <textarea id="feedback-message" rows="4" required></textarea><br>
                        <button type="submit" class="ascii-button">[ Gửi Phản Hồi ]</button>
                    </form>
                 </div>
                 <div class="ascii-box">
                     <pre><b>Danh sách các phản hồi đã gửi:</b></pre>
                     <div id="feedback-container"></div>
                 </div>
            </div>
            
            <!-- Trang con: CÀI ĐẶT -->
            <div id="settings-page" class="sub-page">
                <pre class="header-title">⚙️ CÀI ĐẶT HỆ THỐNG ⚙️</pre>
                 <div class="ascii-box">
                    <pre><b>[Chủ đề (Theme)]</b> - Thay đổi màu sắc giao diện (Lựa chọn sẽ được lưu lại)</pre><br>
                    <button class="ascii-button theme-btn" data-theme="green">Terminal (Mặc định)</button>
                    <button class="ascii-button theme-btn" data-theme="amber">Amber</button>
                    <button class="ascii-button theme-btn" data-theme="blue">Matrix Blue</button>
                    <button class="ascii-button theme-btn" data-theme="white">Classic DOS</button>
                 </div>
            </div>
        </div>
    </div>
</div>
<div id="toast-container"></div>

<script>
// Prevent FOUC and apply stored theme
document.body.style.display = "none";
const themes = {
    green: { bg: '#0d0d0d', main: '#00ff41', accent: '#f0f0f0', error: '#ff3860', like: '#33A1FF'},
    amber: { bg: '#2E2519', main: '#FFB000', accent: '#FFEca1', error: '#FF4136', like: '#61dafb'},
    blue:  { bg: '#051025', main: '#33A1FF', accent: '#AedFFF', error: '#FF6347', like: '#ffb300'},
    white: { bg: '#0000AA', main: '#FFFFFF', accent: '#CCCCCC', error: '#FFFF55', like: '#ff80ed'}
};
function applyTheme(themeName) {
    const selectedTheme = themes[themeName] || themes.green;
    const root = document.documentElement;
    root.style.setProperty('--bg-color', selectedTheme.bg);
    root.style.setProperty('--main-color', selectedTheme.main);
    root.style.setProperty('--accent-color', selectedTheme.accent);
    root.style.setProperty('--error-color', selectedTheme.error);
    root.style.setProperty('--like-color', selectedTheme.like);
    localStorage.setItem('ascii-net-theme', themeName);
}
const savedTheme = localStorage.getItem('ascii-net-theme');
if (savedTheme) applyTheme(savedTheme);


document.addEventListener('DOMContentLoaded', () => {
    document.body.style.display = "block";
    
    // === CONFIGURATIONS ===
    const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    const pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });

    const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
    const CHAT_HISTORY_LENGTH = 50;
    const POST_LIMIT = 20;

    // === GLOBAL VARIABLES & DOM ELEMENTS ===
    const terminal = document.getElementById('terminal');
    let currentUser = null;
    let userProfile = { nickname: 'anonymous', avatarUrl: 'https://i.imgur.com/83wS136.png' }; 

    // === UTILITY FUNCTIONS ===
    const showToast = (message, isError = false) => {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        if(isError) toast.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--error-color');
        toast.innerHTML = `<pre>> ${message}</pre>`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 5000);
    };

    const sanitize = (str) => {
      if(!str) return '';
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    };
    
    const timeAgo = (timestamp) => {
        const now = new Date();
        const seconds = Math.floor((now - new Date(timestamp)) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " năm trước";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " tháng trước";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " ngày trước";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " giờ trước";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " phút trước";
        return "vài giây trước";
    };

    const showPage = (pageId) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId)?.classList.add('active');
        terminal.scrollTop = 0;
    };
    
    const showSubPage = (subPageId) => {
        document.querySelectorAll('.sub-page').forEach(sp => sp.style.display = 'none');
        document.getElementById(subPageId).style.display = 'block';
        document.querySelectorAll('#main-nav .ascii-button').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-target') === subPageId);
        });
        if(subPageId === 'chat-public-page') document.getElementById('public-chat-input').focus();
    };

    // === BOOT SEQUENCE ===
    const runBootSequence = () => {
        const bootLog = document.getElementById('boot-log');
        const progressBar = document.getElementById('boot-progress-bar');
        const bootSteps = [ "Initializing Kernel v3.0...", "Loading Citadel Drivers...", "Establishing Secure Network Interface...", "Connecting to ASCII-NET Mainframe...", "Authentication Layer Ready."];
        let stepIndex = 0;
        function nextStep() {
            if (stepIndex < bootSteps.length) {
                bootLog.innerHTML += `<pre>[ OK ] ${bootSteps[stepIndex]}</pre>`;
                progressBar.style.width = `${((stepIndex + 1) / bootSteps.length) * 100}%`;
                stepIndex++;
                setTimeout(nextStep, Math.random() * 300 + 100);
            } else {
                setTimeout(() => auth.onAuthStateChanged(handleAuthStateChange), 500);
            }
        }
        nextStep();
    };

    // === AUTHENTICATION & USER PROFILE MANAGEMENT ===
    const handleAuthStateChange = async (user) => {
        if (user) {
            currentUser = user;
            await loadUserProfile(user); // Load or create user profile
            initializeApp();
        } else {
            currentUser = null;
            userProfile = { nickname: 'anonymous', avatarUrl: 'https://i.imgur.com/83wS136.png' };
            showPage('login-page');
        }
    };
    
    const loadUserProfile = async (user) => {
        const userRef = db.ref('users/' + user.uid);
        const snapshot = await userRef.once('value');
        if (snapshot.exists()) {
            userProfile = snapshot.val();
        } else { // Create a profile for new users
            userProfile = {
                uid: user.uid,
                email: user.email,
                nickname: user.displayName || user.email.split('@')[0],
                avatarUrl: user.photoURL || 'https://i.imgur.com/83wS136.png'
            };
            await userRef.set(userProfile);
        }
        pubnub.setUUID(user.uid); // Use UID as UUID
        // Set state for presence, now including nickname and avatar for all users to see
        pubnub.setState({ state: { nickname: userProfile.nickname, avatar: userProfile.avatarUrl } });
    };

    const initializeApp = () => {
        showPage('main-interface');
        showSubPage('newsfeed-page');
        document.getElementById('welcome-message').textContent = `USER: ${userProfile.nickname} | STATUS: Online`;
        
        loadChatHistoryAndSubscribe();
        loadSocialPosts();
        loadFeedback();
        listenForAgoraRooms();
        updateProfilePage();
    };
    
    // Login Handlers...
    document.getElementById('email-login').addEventListener('click', () => { /* ... (no changes) ... */ });
    document.getElementById('google-login').addEventListener('click', () => { /* ... (no changes) ... */ });
    document.getElementById('logout-btn').addEventListener('click', () => { /* ... (no changes) ... */ });

    // === MAIN INTERFACE NAVIGATION ===
    document.querySelectorAll('#main-nav a.ascii-button').forEach(link => {
        link.addEventListener('click', (e) => showSubPage(link.getAttribute('data-target')));
    });

    // === PUBNUB & FIREBASE CHAT (UPGRADED) ===
    const loadChatHistoryAndSubscribe = () => {
        const chatWindow = document.getElementById('public-chat-window');
        chatWindow.innerHTML = '<pre class="loader">Đang tải lịch sử chat...</pre>';

        // 1. Load history from Firebase
        db.ref('chatMessages').orderByChild('timestamp').limitToLast(CHAT_HISTORY_LENGTH).once('value', snapshot => {
            chatWindow.innerHTML = '';
            snapshot.forEach(child => {
                appendChatMessage(child.val(), false);
            });
             chatWindow.scrollTop = chatWindow.scrollHeight;

            // 2. Subscribe to PubNub for real-time messages after history is loaded
            subscribeToPubNub();
        });
    };
    
    const subscribeToPubNub = () => {
        pubnub.subscribe({ channels: ['ascii_chat'], withPresence: true });
        pubnub.addListener({
            message: (event) => appendChatMessage(event.message, true),
            presence: () => updateOnlineUsers(),
        });
        updateOnlineUsers();
    };

    const appendChatMessage = (msg, isNew) => {
        const chatWindow = document.getElementById('public-chat-window');
        const line = document.createElement('div');
        line.classList.add('comment');
        line.innerHTML = `
            <img src="${sanitize(msg.avatarUrl)}" class="avatar-img" style="width:25px;height:25px;">
            <div>
                <pre><b><${sanitize(msg.sender)}></b> <small><i>${timeAgo(msg.timestamp)}</i></small></pre>
                <pre>${sanitize(msg.text)}</pre>
            </div>`;
        chatWindow.appendChild(line);
        if(isNew) chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll only for new messages
    };
    
    const sendChatMessage = () => {
        const chatInput = document.getElementById('public-chat-input');
        if (!chatInput.value.trim()) return;
        const message = { 
            sender: userProfile.nickname, 
            text: chatInput.value, 
            avatarUrl: userProfile.avatarUrl,
            uid: currentUser.uid,
            timestamp: firebase.database.ServerValue.TIMESTAMP 
        };
        
        // 1. Publish to PubNub for real-time
        pubnub.publish({ channel: 'ascii_chat', message: message });

        // 2. Save to Firebase for history
        // We use the timestamp from ServerValue, so we push a temporary object to PubNub
        // and a full object with ServerValue to Firebase.
        // A cleaner approach: Let's send a slightly different object without server timestamp to pubnub.
        const pubnubMessage = {...message, timestamp: Date.now() };
        pubnub.publish({ channel: 'ascii_chat', message: pubnubMessage });
        
        db.ref('chatMessages').push(message).catch(e => showToast(`Lỗi gửi tin nhắn: ${e.message}`, true));
        chatInput.value = '';
    };
    document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
    document.getElementById('public-chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });
    
    const updateOnlineUsers = () => { /* ... (no changes needed here, as state now has avatar) ... */};

    // === FIREBASE NEWSFEED (UPGRADED) ===
    const socialPostsContainer = document.getElementById('social-posts-container');
    
    const loadSocialPosts = () => {
        db.ref('socialPosts').orderByChild('timestamp').limitToLast(POST_LIMIT).on('value', snapshot => {
            socialPostsContainer.innerHTML = '';
            let posts = [];
            snapshot.forEach(child => { posts.push({ key: child.key, ...child.val() }); });
            posts.reverse().forEach(post => {
                 const postElement = createPostElement(post.key, post);
                 socialPostsContainer.appendChild(postElement);
                 // After appending, load its comments
                 const commentsContainer = postElement.querySelector('.comments-display-area');
                 const commentsLoader = postElement.querySelector('.comments-loader');
                 renderComments(post.key, commentsContainer, commentsLoader);
            });
        });
    };
    
    const createPostElement = (key, post) => {
        const postBox = document.createElement('div');
        postBox.className = 'ascii-box';
        postBox.id = `post-${key}`;

        let content = sanitize(post.text);
        content = content.replace(/\[image\](.*?)\[\/image\]/g, `<br><a href="$1" target="_blank"><img src="$1" class="post-content-img" alt="User uploaded image"></a><br>`);

        const isLikedByMe = post.likes && post.likes[currentUser.uid];
        const likeCount = post.likes ? Object.keys(post.likes).length : 0;
        
        postBox.innerHTML = `
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                 <img src="${sanitize(post.avatarUrl)}" class="avatar-img">
                 <div>
                    <pre><b>@${sanitize(post.sender)}</b></pre>
                    <pre><small>${timeAgo(post.timestamp)}</small></pre>
                 </div>
            </div>
            <hr>
            <pre class="post-content-text">${content}</pre>
            <hr>
            <div class="post-actions">
                <button class="ascii-button like-btn ${isLikedByMe ? 'liked' : ''}" data-key="${key}">[${isLikedByMe ? 'Đã Thích' : 'Thích'} (${likeCount})]</button>
                <button class="ascii-button comment-btn" data-key="${key}">[Bình luận]</button>
                ${post.uid === currentUser.uid ? `<button class="ascii-button delete-post-btn" data-key="${key}" style="color:var(--error-color);">[Xóa]</button>` : ''}
            </div>
            <div class="comment-section">
                <div class="comments-display-area"></div>
                <div class="comments-loader" style="display:none;"><pre class="loader">Đang tải bình luận...</pre></div>
                <div class="comment-input-area">
                     <input type="text" class="comment-input" placeholder="Viết bình luận..." data-key="${key}">
                     <button class="ascii-button send-comment-btn" data-key="${key}">[Gửi]</button>
                </div>
            </div>`;

        // --- Event Listeners for Post ---
        postBox.querySelector('.like-btn').addEventListener('click', (e) => {
             db.ref(`socialPosts/${key}/likes/${currentUser.uid}`).transaction(current_value => {
                 return current_value ? null : true; // If exists, remove. If not, add.
             });
        });
        
        if (post.uid === currentUser.uid) {
            postBox.querySelector('.delete-post-btn').addEventListener('click', (e) => { /* ... (same as before, but with confirmation) ... */ });
        }

        const commentInput = postBox.querySelector('.comment-input');
        postBox.querySelector('.comment-btn').addEventListener('click', () => commentInput.focus());
        postBox.querySelector('.send-comment-btn').addEventListener('click', () => submitComment(key, commentInput));
        commentInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') submitComment(key, commentInput); });
        
        return postBox;
    };
    
    const submitComment = (postKey, inputElement) => {
        const text = inputElement.value.trim();
        if (!text) return;
        db.ref(`socialPosts/${postKey}/comments`).push({
            uid: currentUser.uid,
            nickname: userProfile.nickname,
            avatarUrl: userProfile.avatarUrl,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            inputElement.value = '';
        }).catch(e => showToast(`Lỗi: ${e.message}`, true));
    };

    const renderComments = (postKey, container, loader) => {
        loader.style.display = 'block';
        db.ref(`socialPosts/${postKey}/comments`).orderByChild('timestamp').on('value', snapshot => {
            container.innerHTML = '';
            loader.style.display = 'none';
            snapshot.forEach(child => {
                const commentKey = child.key;
                const commentData = child.val();
                container.appendChild(createCommentElement(postKey, commentKey, commentData));
            });
        });
    };

    const createCommentElement = (postKey, commentKey, comment) => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.innerHTML = `
            <img src="${sanitize(comment.avatarUrl)}" class="avatar-img" style="width:25px;height:25px;border-radius:4px;">
            <div class="comment-content">
                <pre><b>${sanitize(comment.nickname)}</b> <small><i>${timeAgo(comment.timestamp)}</i></small></pre>
                <pre class="comment-text">${sanitize(comment.text)}</pre>
                ${currentUser.uid === comment.uid ? `
                <div class="comment-actions">
                    <a href="#" class="edit-comment-btn">[sửa]</a>
                    <a href="#" class="delete-comment-btn" style="color:var(--error-color);">[xóa]</a>
                </div>` : ''}
            </div>
        `;

        if (currentUser.uid === comment.uid) {
            div.querySelector('.delete-comment-btn').addEventListener('click', (e) => {
                e.preventDefault();
                if(confirm("Bạn có chắc muốn xóa bình luận này?")) {
                    db.ref(`socialPosts/${postKey}/comments/${commentKey}`).remove();
                }
            });
            // EDIT logic could be added here similar to delete
        }
        return div;
    };

    document.getElementById('submit-social-btn').addEventListener('click', () => { /* ... (no changes) ... */ });
    
    // Cloudinary for social posts
    const socialImageWidget = cloudinary.createUploadWidget({ cloudName: 'dgbux4wzo', uploadPreset: 'okeqfdx4' }, (error, result) => { /* ... (no changes) ... */ });
    document.getElementById('upload-social-btn').addEventListener('click', () => socialImageWidget.open());

    // --- All other sections (PROFILE, FEEDBACK, SETTINGS, AGORA VIDEO) have no major logic changes needed ---
    // So we can copy them as they are, but they will benefit from the improved utility functions like timeAgo() if used there.

    const updateProfilePage = () => { /* ... */ };
    document.getElementById('update-nickname-btn').addEventListener('click', () => { /* ... */ });
    const avatarWidget = cloudinary.createUploadWidget({ /* ... */ });
    document.getElementById('upload-avatar-btn').addEventListener('click', () => avatarWidget.open());
    document.getElementById('feedback-form').addEventListener('submit', (e) => { /* ... */ });
    const loadFeedback = () => { /* ... (could be updated to use timeAgo) ... */ };
    document.querySelectorAll('.theme-btn').forEach(btn => btn.addEventListener('click', () => applyTheme(btn.getAttribute('data-theme'))));
    let agoraClient, localTracks = { videoTrack: null, audioTrack: null }, currentRoomName = '', roomParticipants = {};
    const listenForAgoraRooms = () => { /* ... */ };
    document.getElementById("create-room-btn").addEventListener("click", () => { /* ... */ });
    const joinRoom = async (roomName) => { /* ... */ };
    const handleUserPublished = async (user, mediaType) => { /* ... */ };
    const handleUserLeft = (user) => { /* ... */ };
    const leaveRoom = async () => { /* ... */ };
    document.getElementById("leave-btn").addEventListener("click", leaveRoom);
    const toggleMic = () => { /* ... */ };
    const toggleCam = () => { /* ... */ };


    // === FINAL EXECUTION ===
    // Making copies of unchanged functions to keep the script running
    // In a real refactor, these would be imported or organized differently.
    
    // Unchanged function implementations from the original script
    document.getElementById('email-login').addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, password).catch(error => {
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                showToast(`> Đăng nhập thất bại. Thử tạo tài khoản mới...`);
                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => showToast(`> Tài khoản mới đã được tạo với email này.`))
                    .catch(err => showToast(`> Lỗi: ${err.message}`, true));
            } else {
                 showToast(`> Lỗi: ${error.message}`, true)
            }
        });
    });
    document.getElementById('google-login').addEventListener('click', () => {
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast(`Lỗi đăng nhập Google: ${e.message}`, true));
    });
    document.getElementById('logout-btn').addEventListener('click', () => {
        if (currentRoomName) {
            db.ref(`agoraRooms/${currentRoomName}/participants/${currentUser.uid}`).remove();
        }
        pubnub.unsubscribeAll();
        auth.signOut().then(() => location.reload());
    });
    updateOnlineUsers = () => {
        pubnub.hereNow({ channels: ["ascii_chat"], includeUUIDs: true, includeState: true }, (status, response) => {
            const onlineUsersList = document.getElementById('online-users-list');
            onlineUsersList.innerHTML = '';
            if (response && response.channels && response.channels.ascii_chat) {
                response.channels.ascii_chat.occupants.forEach(user => {
                    const nick = user.state?.nickname || user.uuid;
                    const avatar = user.state?.avatar || 'https://i.imgur.com/83wS136.png';
                    const userDiv = document.createElement('div');
                    userDiv.className = 'comment'; 
                    userDiv.innerHTML = `<img src="${sanitize(avatar)}" class="avatar-img" style="width:25px;height:25px;"><pre>> ${sanitize(nick)}</pre>`;
                    onlineUsersList.appendChild(userDiv);
                });
            }
        });
    };
    document.getElementById('submit-social-btn').addEventListener('click', () => {
        const text = document.getElementById('social-message').value.trim();
        if (!text) { showToast('> Nội dung không thể trống.', true); return; }
        db.ref('socialPosts').push({
            uid: currentUser.uid,
            sender: userProfile.nickname,
            avatarUrl: userProfile.avatarUrl,
            text: text,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            likes: {} // Initialize likes object
        });
        document.getElementById('social-message').value = '';
    });
    if (post.uid === currentUser.uid) {
        postBox.querySelector('.delete-post-btn').addEventListener('click', () => {
            if(confirm('Bạn có chắc muốn xóa bài đăng này?')) {
                db.ref(`socialPosts/${key}`).remove()
                    .then(() => showToast("> Bài đăng đã được xóa."))
                    .catch(e => showToast(`> Lỗi: ${e.message}`, true));
            }
        });
    }
    //... The rest of the functions are just copied
    updateProfilePage = () => {
        const container = document.getElementById('profile-info-container');
        if (currentUser) {
            container.innerHTML = `
            <div style="display: flex; align-items: center;">
                 <img src="${sanitize(userProfile.avatarUrl)}" class="avatar-img" style="width:80px;height:80px;">
                 <pre>
Email.......: ${currentUser.email || 'N/A'}
User ID.....: ${currentUser.uid}
Nickname....: ${userProfile.nickname}
                 </pre>
            </div>`;
        }
    };
    document.getElementById('update-nickname-btn').addEventListener('click', () => {
        const newNickname = document.getElementById('profile-nickname-input').value.trim();
        if (newNickname && newNickname !== userProfile.nickname) {
            db.ref('users/' + currentUser.uid).update({ nickname: newNickname }).then(() => {
                showToast('> Cập nhật nickname thành công. Trang sẽ tải lại để áp dụng thay đổi.');
                setTimeout(() => location.reload(), 2000);
            }).catch(error => showToast(`> Lỗi: ${error.message}`, true));
        }
    });
    avatarWidget = cloudinary.createUploadWidget({ cloudName: 'dgbux4wzo', uploadPreset: 'okeqfdx4', multiple: false }, (error, result) => {
        if (!error && result && result.event === "success") {
            const avatarUrl = result.info.secure_url;
            db.ref('users/' + currentUser.uid).update({ avatarUrl }).then(() => {
                userProfile.avatarUrl = avatarUrl;
                updateProfilePage();
                showToast('> Avatar đã được cập nhật.');
            });
        }
    });
    document.getElementById('upload-avatar-btn').addEventListener('click', () => avatarWidget.open());
    document.getElementById('feedback-form').addEventListener('submit', (e) => {
        e.preventDefault();
        db.ref('feedback').push({
            name: document.getElementById('feedback-name').value,
            message: document.getElementById('feedback-message').value,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            showToast('> Cảm ơn phản hồi của bạn!');
            e.target.reset();
        });
    });
    loadFeedback = () => {
        db.ref('feedback').orderByChild('timestamp').limitToLast(20).on('value', snap => {
            const feedbackContainer = document.getElementById('feedback-container');
            feedbackContainer.innerHTML = '';
            let feedbacks = [];
            snap.forEach(child => feedbacks.push(child.val()));
            feedbacks.reverse().forEach(fb => {
                 feedbackContainer.innerHTML += `<pre class="comment">> [${new Date(fb.timestamp).toLocaleDateString()}] <b>${sanitize(fb.name)}</b>: ${sanitize(fb.message)}</pre>`;
            });
        });
    };
    listenForAgoraRooms = () => {
        db.ref("agoraRooms").on("value", snapshot => {
            const roomListDiv = document.getElementById("room-list");
            roomListDiv.innerHTML = "";
            const roomsData = snapshot.val();
            if (!roomsData) {
                roomListDiv.innerHTML = "<pre>Chưa có phòng nào. Hãy tạo một phòng!</pre>";
            } else {
                 Object.entries(roomsData).forEach(([key, room]) => {
                    const participantCount = room.participants ? Object.keys(room.participants).length : 0;
                    const roomEl = document.createElement('pre');
                    roomEl.innerHTML = `> ${sanitize(room.name)} (${participantCount} người) [ <a data-room-name="${sanitize(room.name)}" data-room-key="${key}">Tham gia</a> ]`;
                    roomEl.querySelector('a').onclick = (e) => {
                        const target = e.currentTarget;
                        joinRoom(target.dataset.roomName, target.dataset.roomKey);
                    };
                    roomListDiv.appendChild(roomEl);
                });
            }
        });
    };
    document.getElementById("create-room-btn").addEventListener("click", () => {
        const roomName = document.getElementById("new-room-name").value.trim();
        if (!roomName) { showToast('> Tên phòng không hợp lệ', true); return; }
        db.ref(`agoraRooms`).push({ name: roomName, createdBy: userProfile.nickname, createdAt: firebase.database.ServerValue.TIMESTAMP })
        .then(()=> showToast(`> Đã tạo phòng: ${roomName}`))
        .catch(e=> showToast(`Lỗi: ${e.message}`, true));
        document.getElementById("new-room-name").value = "";
    });

    joinRoom = async (roomName, roomKey) => {
        currentRoomName = roomName;
        const roomRef = db.ref(`agoraRooms/${roomKey}`);

        document.getElementById('room-selection').style.display = 'none';
        document.getElementById('call-interface').style.display = 'block';
        document.getElementById("call-room-title").textContent = `Đang trong phòng: ${roomName}`;
        
        agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        agoraClient.on("user-published", handleUserPublished);
        agoraClient.on("user-left", handleUserLeft);
        
        const participantRef = roomRef.child('participants');
        participantRef.on('value', snapshot => { roomParticipants = snapshot.val() || {}; });

        try {
            await agoraClient.join(AGORA_APP_ID, currentRoomName, null, currentUser.uid);
            participantRef.child(currentUser.uid).set(userProfile);
            participantRef.child(currentUser.uid).onDisconnect().remove();

            [localTracks.audioTrack, localTracks.videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
            
            const localPlayerContainer = document.getElementById('local-stream');
            localPlayerContainer.innerHTML = ''; // Clear it first
            localPlayerContainer.insertAdjacentHTML('beforeend', `<div class="video-name">You (${userProfile.nickname})</div>`);
             localPlayerContainer.insertAdjacentHTML('beforeend', `
                <div class="video-controls">
                    <button id="mic-btn" class="ascii-button control-btn">[ Tắt Mic ]</button>
                    <button id="cam-btn" class="ascii-button control-btn">[ Ẩn Cam ]</button>
                </div>`);

            localTracks.videoTrack.play(localPlayerContainer);
            await agoraClient.publish(Object.values(localTracks));

            document.getElementById('mic-btn').onclick = toggleMic;
            document.getElementById('cam-btn').onclick = toggleCam;
        } catch (error) {
            console.error("Agora Join/Publish Error:", error);
            showToast('> Lỗi tham gia phòng. Kiểm tra console.', true);
            await leaveRoom();
        }
    };
    handleUserPublished = async (user, mediaType) => {
        await agoraClient.subscribe(user, mediaType);
        
        setTimeout(async () => {
             const participantInfo = roomParticipants[user.uid] || { nickname: `User ${user.uid.substring(0,6)}`, avatarUrl:'' };
            if (mediaType === "video") {
                let remotePlayerContainer = document.getElementById(`player-container-${user.uid}`);
                if (!remotePlayerContainer) {
                    remotePlayerContainer = document.createElement('div');
                    remotePlayerContainer.id = `player-container-${user.uid}`;
                    remotePlayerContainer.className = 'video-box';
                    document.getElementById('remote-streams').appendChild(remotePlayerContainer);
                }
                 remotePlayerContainer.innerHTML = `<div class="video-name">${sanitize(participantInfo.nickname)}</div>`;
                user.videoTrack.play(remotePlayerContainer);
            }
            if (mediaType === "audio") {
                user.audioTrack.play();
            }
        }, 500); // Small delay to wait for Firebase state to sync
    };
    handleUserLeft = (user) => {
        document.getElementById(`player-container-${user.uid}`)?.remove();
    };
    leaveRoom = async () => {
        // DB clean up already handled by onDisconnect
        db.ref().child('agoraRooms').off();
        
        for (let trackType in localTracks) {
            localTracks[trackType]?.stop();
            localTracks[trackType]?.close();
            localTracks[trackType] = null;
        }
        await agoraClient?.leave();
        
        document.getElementById('remote-streams').innerHTML = '';
        document.getElementById('room-selection').style.display = 'block';
        document.getElementById('call-interface').style.display = 'none';
        
        const localPlayer = document.getElementById('local-stream');
        localPlayer.innerHTML = `<div class="video-name">You (Local)</div><div class="video-controls"><button id="mic-btn" class="ascii-button control-btn">[Tắt Mic]</button><button id="cam-btn" class="ascii-button control-btn">[Ẩn Cam]</button></div>`;

        showToast(`> Đã rời phòng ${currentRoomName}`);
        currentRoomName = '';
        listenForAgoraRooms(); // Re-listen for rooms after leaving
    };
    toggleMic = () => {
        const micBtn = document.getElementById('mic-btn');
        if(localTracks.audioTrack.muted){
            localTracks.audioTrack.setMuted(false);
            micBtn.textContent = '[ Tắt Mic ]'; micBtn.classList.remove('muted');
        } else {
            localTracks.audioTrack.setMuted(true);
            micBtn.textContent = '[ Bật Mic ]'; micBtn.classList.add('muted');
        }
    };
    toggleCam = () => {
        const camBtn = document.getElementById('cam-btn');
         if(localTracks.videoTrack.muted){
            localTracks.videoTrack.setMuted(false);
            camBtn.textContent = '[ Ẩn Cam ]'; camBtn.classList.remove('muted');
        } else {
            localTracks.videoTrack.setMuted(true);
            camBtn.textContent = '[ Hiện Cam ]'; camBtn.classList.add('muted');
        }
    };

    // === START PROGRAM ===
    runBootSequence();

});
</script>

</body>
</html>
