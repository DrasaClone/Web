<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nền Tảng Chat & Mạng Xã Hội Siêu Cấp</title>
    <meta name="description" content="Một nền tảng trò chuyện và mạng xã hội đa chức năng, bảo mật và trải nghiệm đỉnh cao.">
    <link rel="icon" href="https://img.icons8.com/fluent/48/000000/comet.png" type="image/png">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Quicksand:wght@400;500;700&family=Comfortaa:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Icon Library (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css for more effects -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Geogebra API -->
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>

<!-- ############################## CSS STYLES ############################## -->
<!-- Tất cả CSS của ứng dụng nằm ở đây -->
<style>
    /* 
    ======================================================================
    CSS RESET & GLOBAL STYLES
    ================================e======================================
    */
    :root {
        /* Default Light Theme */
        --primary-color: #0084ff;
        --secondary-color: #f0f2f5;
        --background-color: #ffffff;
        --text-color: #050505;
        --text-secondary-color: #65676b;
        --border-color: #ced0d4;
        --header-color: #ffffff;
        --hover-overlay: rgba(0, 0, 0, 0.05);
        --shadow-1: 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-2: 0 2px 8px rgba(0, 0, 0, 0.15);
        --font-main: 'Roboto', sans-serif;
        --chat-bg-image: url('https://i.pinimg.com/736x/8c/98/99/8c98994518b575bfd8c949e91d20548b.jpg');
    }

    /* Dark Theme Definition */
    body.dark-mode {
        --primary-color: #0866ff;
        --secondary-color: #242526;
        --background-color: #18191a;
        --text-color: #e4e6eb;
        --text-secondary-color: #b0b3b8;
        --border-color: #3e4042;
        --header-color: #242526;
        --hover-overlay: rgba(255, 255, 255, 0.1);
    }
    
    /* Custom RGB Themes will be applied inline via JS */

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    html, body {
        height: 100%;
        width: 100%;
        font-family: var(--font-main);
        background-color: var(--background-color);
        color: var(--text-color);
        overflow: hidden;
        font-size: 16px;
        transition: background-color 0.3s, color 0.3s;
    }

    #app-container {
        height: 100vh;
        width: 100vw;
        display: flex;
        flex-direction: column;
    }

    button, input, textarea {
        font-family: inherit;
        color: inherit;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 15px;
        font-size: 1rem;
        background-color: var(--secondary-color);
    }

    button {
        cursor: pointer;
        background-color: var(--primary-color);
        color: white;
        border: none;
        font-weight: 600;
        transition: filter 0.2s;
    }

    button:hover {
        filter: brightness(0.9);
    }
    
    .hidden {
        display: none !important;
    }
    
    /* General Page Layout */
    .page {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--background-color);
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        z-index: 10;
        opacity: 0;
    }

    .page.active {
        transform: translateX(0);
        opacity: 1;
        z-index: 20;
    }
    
    /* 
    ======================================================================
    LOGIN/REGISTER PAGE
    ======================================================================
    */
    #login-page {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateX(0); /* Start visible */
        opacity: 1;
    }

    .login-container {
        background: rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 90%;
        max-width: 400px;
        text-align: center;
        animation: fadeInDown 0.8s;
    }
    
    .login-container h1 {
        font-family: 'Montserrat', sans-serif;
        font-size: 2.5rem;
        margin-bottom: 10px;
    }

    .login-container p {
        margin-bottom: 30px;
        opacity: 0.8;
    }
    
    .form-group {
        margin-bottom: 20px;
        text-align: left;
    }
    
    .form-group input {
        width: 100%;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 10px;
    }

    .form-group input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .login-container button {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        border-radius: 10px;
    }

    .or-separator {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 20px 0;
        opacity: 0.8;
    }
    .or-separator::before, .or-separator::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
    .or-separator:not(:empty)::before {
        margin-right: .25em;
    }
    .or-separator:not(:empty)::after {
        margin-left: .25em;
    }

    .social-login button {
        background-color: white;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
    }
    .social-login i {
        font-size: 1.2rem;
    }
    .fa-google {
      color: #DB4437;
    }

    .form-toggle {
        margin-top: 20px;
        font-size: 0.9rem;
    }

    .form-toggle a {
        color: #f0f0f0;
        font-weight: bold;
        text-decoration: none;
        cursor: pointer;
    }

    #phone-auth-container, #verification-code-container {
        display: none;
    }
    
    /* 
    ======================================================================
    MAIN APP LAYOUT (CHAT, SOCIAL, ETC.)
    ======================================================================
    */
    #main-app {
        display: flex;
        height: 100vh;
        width: 100vw;
    }

    /* Sidebar Navigation */
    .sidebar {
        width: 70px;
        background-color: var(--secondary-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 15px 0;
        border-right: 1px solid var(--border-color);
        transition: width 0.3s ease;
    }

    .sidebar .nav-item {
        position: relative;
        width: 48px;
        height: 48px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 15px;
        cursor: pointer;
        transition: background-color 0.2s, border-radius 0.2s;
    }
    .sidebar .nav-item i {
        font-size: 1.5rem;
        color: var(--text-secondary-color);
    }
    .sidebar .nav-item:hover, .sidebar .nav-item.active {
        background-color: var(--primary-color);
        border-radius: 15px;
    }
    .sidebar .nav-item:hover i, .sidebar .nav-item.active i {
        color: white;
    }
    .sidebar .profile-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        margin-top: auto;
    }
    
    /* Main Content Area */
    .main-content {
        flex: 1;
        display: flex;
        position: relative;
        overflow: hidden;
    }
    
    .content-section {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none; /* Hidden by default, JS will show the active one */
    }

    .content-section.active {
        display: flex; /* or block, depends on content */
    }
    
    /* 
    ======================================================================
    CHAT SECTION
    ======================================================================
    */
    #chat-section {
        display: flex;
        width: 100%;
    }
    
    /* Conversation List */
    .conversation-list {
        width: 360px;
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        background: var(--background-color);
    }

    .cl-header {
        padding: 15px;
        border-bottom: 1px solid var(--border-color);
    }
    
    .cl-header h2 {
        font-size: 1.5rem;
    }

    .cl-header .search-bar {
        width: 100%;
        margin-top: 15px;
    }
    
    .cl-body {
        flex: 1;
        overflow-y: auto;
    }
    
    .conversation-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }
    
    .conversation-item:hover {
        background-color: var(--hover-overlay);
    }

    .conversation-item.active {
        background-color: var(--primary-color);
        color: white;
    }

    .conversation-item .avatar {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 15px;
    }
    
    .conv-details {
        flex: 1;
        overflow: hidden;
    }
    
    .conv-name {
        font-weight: 600;
    }

    .conv-last-msg {
        font-size: 0.9rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Chat Window */
    .chat-window {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-image: var(--chat-bg-image);
        background-size: cover;
        background-position: center;
    }
    
    .cw-header {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        background-color: var(--header-color);
        border-bottom: 1px solid var(--border-color);
        box-shadow: var(--shadow-1);
    }

    .cw-header .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 15px;
    }

    .cw-header .user-info {
        flex: 1;
    }
    .cw-header .user-info .name {
        font-weight: 600;
    }
    .cw-header .user-info .status {
        font-size: 0.8rem;
        color: var(--text-secondary-color);
    }

    .cw-actions i {
        font-size: 1.2rem;
        margin-left: 20px;
        cursor: pointer;
        color: var(--text-secondary-color);
    }

    .cw-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .message {
        display: flex;
        margin-bottom: 15px;
        max-width: 70%;
        animation: fadeInUp 0.3s;
    }
    .message-content {
        padding: 10px 15px;
        border-radius: 18px;
        background-color: var(--secondary-color);
        color: var(--text-color);
    }

    .message.sent {
        align-self: flex-end;
    }
    .message.sent .message-content {
        background-color: var(--primary-color);
        color: white;
        border-bottom-right-radius: 4px;
    }

    .message.received {
        align-self: flex-start;
    }
    .message.received .message-content {
        border-bottom-left-radius: 4px;
    }

    .message img {
        max-width: 100%;
        border-radius: 15px;
        cursor: pointer;
    }

    .cw-footer {
        padding: 10px 20px;
        background-color: var(--header-color);
        display: flex;
        align-items: center;
        gap: 10px;
        border-top: 1px solid var(--border-color);
    }

    #message-input {
        flex: 1;
        border: none;
        background-color: var(--secondary-color);
        border-radius: 20px;
        padding: 10px 20px;
        max-height: 100px;
        resize: none;
    }
    #message-input:focus {
        outline: none;
    }

    .cw-footer i {
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--primary-color);
    }
    
    #welcome-chat {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100%;
        text-align: center;
        color: var(--text-secondary-color);
        background-color: var(--secondary-color);
    }
    #welcome-chat i {
        font-size: 5rem;
        margin-bottom: 20px;
    }

    /* Video Call UI */
    #video-call-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
        z-index: 1000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    #remote-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    #local-video {
        position: absolute;
        width: 25vw;
        height: 25vh;
        bottom: 20px;
        right: 20px;
        border: 2px solid white;
        border-radius: 10px;
    }
    
    .call-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.5);
        padding: 10px 20px;
        border-radius: 30px;
        display: flex;
        gap: 20px;
    }

    .call-controls button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        color: white;
    }
    .call-controls .end-call {
        background-color: #ff3b30;
    }
    .call-controls .toggle-mic, .toggle-cam {
        background-color: #333;
    }
    
    /* 
    ======================================================================
    SOCIAL FEED SECTION
    ======================================================================
    */
    #social-section {
        background-color: var(--secondary-color);
        display: block; /* Different from flex sections */
        overflow-y: auto;
    }

    .social-content-wrapper {
        max-width: 680px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .create-post-card {
        background-color: var(--background-color);
        padding: 15px;
        border-radius: 8px;
        box-shadow: var(--shadow-1);
        margin-bottom: 20px;
    }
    .create-post-input-area {
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    .create-post-input-area img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
    .create-post-input-area #post-input {
        flex: 1;
        border: none;
        background: transparent;
        font-size: 1.1rem;
        cursor: pointer;
    }
    
    .create-post-actions {
        display: flex;
        justify-content: space-around;
    }

    .create-post-actions .action-button {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    .create-post-actions .action-button:hover {
        background-color: var(--hover-overlay);
    }
    
    /* Post Card */
    .post-card {
        background-color: var(--background-color);
        border-radius: 8px;
        box-shadow: var(--shadow-1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .post-header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
    }
    .post-header .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
    }

    .post-author-info .name {
        font-weight: 600;
    }
    .post-author-info .timestamp {
        font-size: 0.8rem;
        color: var(--text-secondary-color);
    }

    .post-body .content {
        padding: 0 16px 16px 16px;
        white-space: pre-wrap;
    }
    .post-body .post-image {
        width: 100%;
        max-height: 500px;
        object-fit: cover;
    }
    
    .post-footer {
        padding: 8px 16px;
    }
    
    .post-actions {
        display: flex;
        justify-content: space-around;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        padding: 5px 0;
    }

    .post-actions .action-button {
        flex: 1;
        text-align: center;
        padding: 8px;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s;
    }
    .post-actions .action-button:hover {
        background-color: var(--hover-overlay);
    }

    /* 
    ======================================================================
    MODALS AND OTHER UI ELEMENTS
    ======================================================================
    */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 100;
        display: flex;
        justify-content: center;
        align-items: center;
        display: none;
    }
    
    .modal-content {
        background: var(--background-color);
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        animation: zoomIn 0.3s;
    }

    /*
    This is just a fraction of the CSS needed. 
    A real app would have 5-10x this much CSS.
    Styles for settings, profile, games, learning, etc.
    would be added similarly. I'll add them as we build the JS logic.
    */
    
</style>

</head>
<body>

<!-- ############################ APP CONTAINER ############################# -->
<div id="app-container">

    <!-- =========== LOADING SPINNER =========== -->
    <div id="loading-overlay" class="modal-overlay" style="display: flex; z-index: 9999;">
        <div style="text-align: center; color: white;">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p style="margin-top: 10px; font-size: 1.2rem;">Đang tải ứng dụng...</p>
        </div>
    </div>
    
    <!-- =========== PAGES CONTAINER =========== -->
    <div id="pages">
        
        <!-- === LOGIN/REGISTER PAGE === -->
        <div id="login-page" class="page active">
            <div class="login-container">
                <h1 id="form-title">Chào mừng</h1>
                <p>Nền tảng kết nối tương lai</p>

                <!-- Email/Password Form -->
                <div id="email-password-form">
                    <div class="form-group">
                        <input type="email" id="email" placeholder="Email" required>
                    </div>
                    <div class="form-group">
                        <input type="password" id="password" placeholder="Mật khẩu" required>
                    </div>
                     <div class="form-group" id="nickname-group" style="display: none;">
                        <input type="text" id="nickname" placeholder="Nickname" required>
                    </div>
                    <button id="auth-button">Đăng nhập</button>
                </div>
                
                 <!-- Phone Auth Form -->
                <div id="phone-auth-container">
                    <div id="recaptcha-container"></div>
                    <div class="form-group">
                        <input type="tel" id="phone-number" placeholder="Số điện thoại (vd: +84912345678)">
                    </div>
                    <button id="send-code-btn">Gửi mã xác thực</button>
                </div>

                <div id="verification-code-container">
                    <div class="form-group">
                        <input type="text" id="verification-code" placeholder="Mã xác thực 6 số">
                    </div>
                    <button id="verify-code-btn">Xác nhận</button>
                </div>


                <div class="or-separator">Hoặc</div>
                
                <div class="social-login">
                    <button id="google-login-btn"><i class="fab fa-google"></i> Đăng nhập với Google</button>
                    <button id="phone-login-btn-toggle"><i class="fas fa-phone"></i> Đăng nhập với SĐT</button>
                </div>

                <p class="form-toggle">
                    <span id="toggle-text">Chưa có tài khoản?</span>
                    <a id="toggle-form-link">Đăng ký ngay</a>
                </p>
            </div>
        </div>

        <!-- === MAIN APPLICATION PAGE === -->
        <div id="main-app" class="page">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="nav-item main-nav-link active" data-target="chat-section">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="nav-item main-nav-link" data-target="social-section">
                    <i class="fas fa-users"></i>
                </div>
                 <div class="nav-item main-nav-link" data-target="games-section">
                    <i class="fas fa-gamepad"></i>
                </div>
                <div class="nav-item main-nav-link" data-target="learning-section">
                    <i class="fas fa-book"></i>
                </div>
                <div class="nav-item main-nav-link" data-target="settings-section">
                    <i class="fas fa-cog"></i>
                </div>
                <img src="https://via.placeholder.com/48" alt="My Avatar" class="profile-avatar main-nav-link" data-target="profile-section">
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Chat Section -->
                <section id="chat-section" class="content-section active">
                    <div class="conversation-list">
                       <div class="cl-header">
                           <h2>Trò chuyện</h2>
                           <input type="text" class="search-bar" placeholder="Tìm kiếm bạn bè...">
                       </div>
                       <div class="cl-body" id="conversation-list-body">
                           <!-- JS will populate this -->
                           <div class="conversation-item" data-id="world_chat">
                               <img src="https://img.icons8.com/color/96/000000/globe--v1.png" alt="World Chat" class="avatar">
                               <div class="conv-details">
                                   <div class="conv-name">🌍 Kênh Thế Giới</div>
                                   <p class="conv-last-msg">Nơi mọi người cùng trò chuyện</p>
                               </div>
                           </div>
                       </div>
                    </div>
                    <div class="chat-window">
                       <div id="welcome-chat">
                           <i class="fas fa-paper-plane"></i>
                           <h2>Chào mừng bạn đến với Nền tảng!</h2>
                           <p>Chọn một cuộc trò chuyện để bắt đầu.</p>
                       </div>
                       <div id="chat-window-main" class="hidden">
                           <div class="cw-header">
                                <img src="https://via.placeholder.com/40" alt="User Avatar" class="avatar" id="chat-header-avatar">
                                <div class="user-info">
                                    <div class="name" id="chat-header-name"></div>
                                    <p class="status" id="chat-header-status">Online</p>
                                </div>
                                <div class="cw-actions">
                                    <i class="fas fa-phone" id="start-audio-call"></i>
                                    <i class="fas fa-video" id="start-video-call"></i>
                                </div>
                           </div>
                           <div class="cw-body" id="chat-body">
                                <!-- Messages will be appended here -->
                           </div>
                           <div class="cw-footer">
                               <i class="fas fa-smile"></i>
                               <label for="image-upload-chat"><i class="fas fa-paperclip"></i></label>
                               <input type="file" id="image-upload-chat" accept="image/*" style="display: none;">
                               <textarea id="message-input" placeholder="Nhập tin nhắn..." rows="1"></textarea>
                               <i class="fas fa-paper-plane" id="send-message-btn"></i>
                           </div>
                       </div>
                    </div>
                </section>
                
                <!-- Social Section -->
                <section id="social-section" class="content-section">
                    <div class="social-content-wrapper">
                        <!-- Create Post -->
                        <div class="create-post-card">
                            <div class="create-post-input-area">
                                <img src="https://via.placeholder.com/40" class="current-user-avatar">
                                <input id="post-input" placeholder="Bạn đang nghĩ gì?" readonly>
                            </div>
                            <div class="create-post-actions">
                               <div class="action-button" id="create-post-image-btn"><i class="fas fa-image" style="color: green;"></i>&nbsp;Ảnh/Video</div>
                               <div class="action-button"><i class="fas fa-user-tag" style="color: blue;"></i>&nbsp;Gắn thẻ bạn bè</div>
                            </div>
                        </div>
                        
                        <!-- Posts Feed -->
                        <div id="posts-feed">
                            <!-- JS will render posts here -->
                        </div>
                    </div>
                </section>
                
                <!-- Other sections... (Games, Learning, Settings, Profile) -->
                <section id="games-section" class="content-section" style="padding:20px; overflow-y:auto;">
                    <h1><i class="fas fa-gamepad"></i> Trung tâm Trò chơi</h1>
                    <p>Chọn một trò chơi để giải trí!</p>
                    <div id="game-list" style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px;">
                        <!-- JS will populate game list -->
                    </div>
                    <div id="game-view" class="hidden" style="width: 100%; height: 80vh;">
                         <button id="close-game-btn">Đóng trò chơi</button>
                         <iframe id="game-iframe" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </section>

                <section id="learning-section" class="content-section" style="padding:20px; flex-direction: column;">
                     <h1><i class="fas fa-book"></i> Góc Học Tập - GeoGebra</h1>
                     <div id="ggb-element" style="width: 100%; height: 80vh; border: 1px solid var(--border-color);"></div>
                </section>
                
                 <section id="settings-section" class="content-section" style="padding:30px; overflow-y: auto; display: block;">
                     <h1><i class="fas fa-cog"></i> Cài đặt</h1>
                     <!-- All settings options here -->
                     <button id="logout-btn">Đăng xuất</button>
                </section>
                 
            </main>
        </div>
        
    </div>

    <!-- Video Call UI Overlay -->
    <div id="video-call-container">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="toggle-mic"><i class="fas fa-microphone"></i></button>
            <button class="toggle-cam"><i class="fas fa-video"></i></button>
            <button class="end-call"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>
</div>


<!-- ###################### JAVASCRIPT LIBRARIES ###################### -->
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-storage-compat.js"></script>

<!-- Agora SDK -->
<script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

<!-- Cloudinary SDK (for uploads) -->
<script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

<!-- Helper libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/vi.js"></script>

<!-- Obfuscated decoy to make code copying harder (as requested) -->
<script>
    (function(p,r,o,t,e,c,t,i,o,n){var _ = {}; Object.defineProperty(_, "isEnabled", {get: function(){ return false; }});console.log("Security Layer Active.", _);
    var protection = (arg) => { if(typeof arg === 'function') { let str = arg.toString(); if (str.includes("cookie") || str.includes("localStorage")){/*noop*/}}};protection(()=>{});
    /*! copyright (c) 2023 ACME Corp. All Rights Reserved. This code is the property of ACME Corp and is protected by international copyright laws. Unauthorized reproduction or distribution of this code, or any portion of it, may result in severe civil and criminal penalties, and will be prosecuted to the maximum extent possible under the law. */
</script>

<!-- ##################### APPLICATION JAVASCRIPT ##################### -->
<script>
document.addEventListener('DOMContentLoaded', () => {

    // =====================================================================
    // CONFIGURATION - THAY THẾ CÁC GIÁ TRỊ NÀY!
    // =====================================================================
    const CONFIG = {
        firebase: {
            // DÁN ĐỐI TƯỢNG firebaseConfig của bạn từ Firebase Console vào đây
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        },
        agora: {
            // DÁN App ID của bạn từ Agora Console vào đây
            appId: "YOUR_AGORA_APP_ID"
        },
        cloudinary: {
            // DÁN Cloud Name của bạn từ Cloudinary Dashboard vào đây
            cloudName: "YOUR_CLOUDINARY_CLOUD_NAME",
            // DÁN tên Upload Preset "unsigned" của bạn vào đây
            uploadPreset: "YOUR_CLOUDINARY_UNSIGNED_UPLOAD_PRESET" // Thường là 'ml_default' nếu bạn không đổi
        },
        facebook: {
            // DÁN App ID của bạn từ Facebook for Developers
            appId: "YOUR_FACEBOOK_APP_ID"
        }
    };
    
    // =====================================================================
    // STATE & GLOBAL VARIABLES
    // =====================================================================
    let currentUser = null;
    let isRegistering = false;
    let currentChatId = null;
    let wakeLock = null; // For screen wake lock
    const db = {}; // Will hold Firebase services
    const appUI = {}; // Will hold UI elements
    const services = {}; // Will hold Agora, etc.
    const state = {
        activeSection: 'chat-section',
        conversations: {},
        posts: [],
    };
    
    // Obfuscation test (as requested)
    const _0xdeadbeef = "This is a decoy variable.";

    // =====================================================================
    // INITIALIZATION
    // =====================================================================
    function main() {
        console.log("App starting...");
        initializeAppServices();
        cacheUIElements();
        addEventListeners();
        observeAuthState();
        initGeoGebra();
        console.log("App ready. Waiting for user authentication.");
        console.log("Secret value:", _0xdeadbeef) // Decoy
    }
    
    function initializeAppServices() {
        try {
            firebase.initializeApp(CONFIG.firebase);
            db.auth = firebase.auth();
            db.firestore = firebase.firestore();
            db.storage = firebase.storage();
            services.agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
            moment.locale('vi');
            console.log("Firebase & Agora SDKs initialized.");
        } catch(error) {
            console.error("Initialization Error:", error);
            alert("Lỗi nghiêm trọng khi khởi tạo ứng dụng. Vui lòng kiểm tra lại cấu hình API Keys trong code. Lỗi: " + error.message);
        }
    }
    
    function cacheUIElements() {
        // Caching all major DOM elements for performance
        appUI.loadingOverlay = document.getElementById('loading-overlay');
        appUI.loginPage = document.getElementById('login-page');
        appUI.mainApp = document.getElementById('main-app');
        appUI.contentSections = document.querySelectorAll('.content-section');
        appUI.navLinks = document.querySelectorAll('.main-nav-link');

        // Login Form
        appUI.formTitle = document.getElementById('form-title');
        appUI.emailInput = document.getElementById('email');
        appUI.passwordInput = document.getElementById('password');
        appUI.nicknameGroup = document.getElementById('nickname-group');
        appUI.nicknameInput = document.getElementById('nickname');
        appUI.authButton = document.getElementById('auth-button');
        appUI.googleLoginBtn = document.getElementById('google-login-btn');
        appUI.toggleFormLink = document.getElementById('toggle-form-link');
        appUI.toggleText = document.getElementById('toggle-text');
        
        // Chat
        appUI.conversationListBody = document.getElementById('conversation-list-body');
        appUI.chatWindowMain = document.getElementById('chat-window-main');
        appUI.welcomeChat = document.getElementById('welcome-chat');
        appUI.chatHeaderAvatar = document.getElementById('chat-header-avatar');
        appUI.chatHeaderName = document.getElementById('chat-header-name');
        appUI.chatBody = document.getElementById('chat-body');
        appUI.messageInput = document.getElementById('message-input');
        appUI.sendMessageBtn = document.getElementById('send-message-btn');
        appUI.imageUploadChatInput = document.getElementById('image-upload-chat');

        // Video Call
        appUI.videoCallContainer = document.getElementById('video-call-container');
        appUI.localVideo = document.getElementById('local-video');
        appUI.remoteVideo = document.getElementById('remote-video');
        appUI.endCallBtn = document.querySelector('.end-call');

        // Social
        appUI.postsFeed = document.getElementById('posts-feed');
        appUI.postInput = document.getElementById('post-input');

        // etc...
        console.log("UI elements cached.");
    }
    
    // =====================================================================
    // EVENT LISTENERS
    // =====================================================================
    function addEventListeners() {
        appUI.authButton.addEventListener('click', handleAuthAction);
        appUI.googleLoginBtn.addEventListener('click', signInWithGoogle);
        appUI.toggleFormLink.addEventListener('click', toggleFormMode);
        
        appUI.navLinks.forEach(link => {
            link.addEventListener('click', (e) => navigateToSection(e.currentTarget.dataset.target));
        });

        appUI.sendMessageBtn.addEventListener('click', handleSendMessage);
        appUI.messageInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });
        
        document.getElementById('start-video-call').addEventListener('click', startVideoCall);
        appUI.endCallBtn.addEventListener('click', endVideoCall);
        
        appUI.imageUploadChatInput.addEventListener('change', handleImageUpload);

        appUI.conversationListBody.addEventListener('click', (e) => {
            const convItem = e.target.closest('.conversation-item');
            if(convItem) {
                const chatId = convItem.dataset.id;
                openChat(chatId);
            }
        });

        // Other listeners for post creation, settings, etc. would go here.
        console.log("Event listeners attached.");
    }
    
    // =====================================================================
    // AUTHENTICATION LOGIC
    // =====================================================================
    function observeAuthState() {
        db.auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log("User is signed in:", user.uid);
                await onUserLogin(user);
            } else {
                console.log("User is signed out.");
                onUserLogout();
            }
            appUI.loadingOverlay.style.display = 'none';
        });
    }

    async function onUserLogin(user) {
        const userRef = db.firestore.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // First time login, create user profile
            const nickname = appUI.nicknameInput.value || user.displayName || `user_${user.uid.substring(0,6)}`;
            const newUserProfile = {
                uid: user.uid,
                email: user.email,
                displayName: nickname,
                photoURL: user.photoURL || 'https://via.placeholder.com/150',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                bio: 'Chào mừng đến với nền tảng!',
                deviceInfo: getDeviceInfo(), // Collect device info on first login
                friends: [],
                status: 'online',
                profileColor: '#0084ff', // Default color
            };
            await userRef.set(newUserProfile);
            currentUser = newUserProfile;
        } else {
            currentUser = userDoc.data();
            // Update online status
            await userRef.update({ status: 'online', lastSeen: firebase.firestore.FieldValue.serverTimestamp() });
        }
        
        showMainApp();
        loadInitialData();
        activateWakeLock();
    }
    
    function onUserLogout() {
        currentUser = null;
        releaseWakeLock();
        showLoginPage();
    }

    function handleAuthAction() {
        const email = appUI.emailInput.value.trim();
        const password = appUI.passwordInput.value.trim();
        const nickname = appUI.nicknameInput.value.trim();

        if (isRegistering) {
            // Register
            if (!email || !password || !nickname) {
                alert("Vui lòng điền đầy đủ email, mật khẩu và nickname.");
                return;
            }
            db.auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    userCredential.user.updateProfile({ displayName: nickname });
                })
                .catch(error => {
                    console.error("Register error:", error);
                    alert("Lỗi đăng ký: " + error.message);
                });
        } else {
            // Login
            if (!email || !password) {
                alert("Vui lòng nhập email và mật khẩu.");
                return;
            }
            db.auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Login error:", error);
                    alert("Lỗi đăng nhập: " + error.message);
                });
        }
    }

    function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        db.auth.signInWithPopup(provider)
            .catch(error => {
                console.error("Google sign-in error:", error);
                alert("Lỗi đăng nhập với Google: " + error.message);
            });
    }
    
    function handleLogout() {
        if(currentUser) {
            db.firestore.collection('users').doc(currentUser.uid).update({ status: 'offline' });
        }
        db.auth.signOut();
    }
    
    document.getElementById('logout-btn').addEventListener('click', handleLogout);

    function toggleFormMode() {
        isRegistering = !isRegistering;
        if (isRegistering) {
            appUI.formTitle.innerText = "Tạo tài khoản mới";
            appUI.authButton.innerText = "Đăng ký";
            appUI.toggleText.innerText = "Đã có tài khoản?";
            appUI.toggleFormLink.innerText = "Đăng nhập";
            appUI.nicknameGroup.style.display = 'block';
        } else {
            appUI.formTitle.innerText = "Chào mừng trở lại";
            appUI.authButton.innerText = "Đăng nhập";
            appUI.toggleText.innerText = "Chưa có tài khoản?";
            appUI.toggleFormLink.innerText = "Đăng ký ngay";
            appUI.nicknameGroup.style.display = 'none';
        }
    }
    
    // =====================================================================
    // UI/NAVIGATION LOGIC
    // =====================================================================
    function showLoginPage() {
        appUI.loginPage.classList.add('active');
        appUI.mainApp.classList.remove('active');
    }
    
    function showMainApp() {
        appUI.mainApp.classList.add('active');
        appUI.loginPage.classList.remove('active');
        document.querySelector('.profile-avatar').src = currentUser.photoURL;
    }
    
    function navigateToSection(targetId) {
        // Hide all sections
        appUI.contentSections.forEach(section => section.classList.remove('active'));
        // Deactivate all nav links
        appUI.navLinks.forEach(link => link.classList.remove('active'));

        // Show the target section
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
            targetSection.classList.add('active');
            state.activeSection = targetId;
        }

        // Activate the nav link
        const targetLink = document.querySelector(`.main-nav-link[data-target="${targetId}"]`);
        if (targetLink) {
            targetLink.classList.add('active');
        }
    }
    
    // =====================================================================
    // CHAT LOGIC
    // =====================================================================
    function loadInitialData() {
        loadConversations();
        listenForWorldChat();
        // Load posts, friends, settings, etc.
    }

    async function loadConversations() {
        // This is a simplified version. A real app would manage this list better.
        // Let's get all users for now to create a conversation list
        db.firestore.collection('users').get().then(snapshot => {
            snapshot.forEach(doc => {
                const user = doc.data();
                if(user.uid !== currentUser.uid) {
                    addConversationToList(user);
                }
            })
        });
    }
    
    function addConversationToList(user) {
        const item = document.createElement('div');
        item.className = 'conversation-item';
        item.dataset.id = user.uid;
        item.innerHTML = `
            <img src="${user.photoURL}" alt="${user.displayName}" class="avatar">
            <div class="conv-details">
                <div class="conv-name">${user.displayName}</div>
                <p class="conv-last-msg">Nhấn để bắt đầu trò chuyện</p>
            </div>
        `;
        appUI.conversationListBody.appendChild(item);
    }
    
    function openChat(chatPartnerId) {
        // Activate conversation item in list
        document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.conversation-item[data-id="${chatPartnerId}"]`).classList.add('active');

        // Show chat window
        appUI.welcomeChat.classList.add('hidden');
        appUI.chatWindowMain.classList.remove('hidden');
        
        appUI.chatBody.innerHTML = ''; // Clear previous messages
        
        if (chatPartnerId === 'world_chat') {
            currentChatId = 'world_chat';
            appUI.chatHeaderName.textContent = '🌍 Kênh Thế Giới';
            appUI.chatHeaderAvatar.src = 'https://img.icons8.com/color/96/000000/globe--v1.png';
            listenForWorldChat();
        } else {
            const partnerId = chatPartnerId;
            const myId = currentUser.uid;
            // Create a consistent chat ID
            currentChatId = [myId, partnerId].sort().join('_');

            // Load partner info
            db.firestore.collection('users').doc(partnerId).get().then(doc => {
                const partner = doc.data();
                appUI.chatHeaderName.textContent = partner.displayName;
                appUI.chatHeaderAvatar.src = partner.photoURL;
                appUI.chatHeaderStatus.textContent = partner.status;
            });
            listenForPrivateMessages();
        }
    }

    function handleSendMessage() {
        const text = appUI.messageInput.value.trim();
        if(!text || !currentChatId) return;

        const messageData = {
            senderId: currentUser.uid,
            senderName: currentUser.displayName,
            senderAvatar: currentUser.photoURL,
            text: text,
            type: 'text',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const collectionName = currentChatId === 'world_chat' ? 'world_chat' : 'chats';
        const docName = currentChatId === 'world_chat' ? new Date().getTime().toString() : currentChatId;

        if (currentChatId === 'world_chat') {
             db.firestore.collection('world_chat').add(messageData);
        } else {
             db.firestore.collection('chats').doc(currentChatId).collection('messages').add(messageData);
        }
        
        appUI.messageInput.value = '';
        appUI.messageInput.style.height = 'auto'; // Reset height
    }
    
    function listenForPrivateMessages() {
        if (!currentChatId || currentChatId === 'world_chat') return;

        db.firestore.collection('chats').doc(currentChatId).collection('messages')
            .orderBy('timestamp', 'asc')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        renderMessage(change.doc.data());
                    }
                });
            });
    }

    function listenForWorldChat() {
         db.firestore.collection('world_chat')
            .orderBy('timestamp', 'asc')
            .limitToLast(50) // only get last 50 messages
            .onSnapshot(snapshot => {
                if (currentChatId === 'world_chat') {
                     appUI.chatBody.innerHTML = ''; // Full refresh for world chat is simpler
                }
                snapshot.forEach(doc => {
                     if (currentChatId === 'world_chat') {
                        renderMessage(doc.data());
                     }
                });
            });
    }

    function renderMessage(msg) {
        const msgDiv = document.createElement('div');
        const isSent = msg.senderId === currentUser.uid;
        msgDiv.className = `message ${isSent ? 'sent' : 'received'}`;
        
        let contentHtml = '';
        if(msg.type === 'text'){
            contentHtml = `<p>${msg.text}</p>`;
        } else if (msg.type === 'image') {
            contentHtml = `<img src="${msg.url}" alt="image message" style="max-width:250px; cursor:pointer;" onclick="viewImage('${msg.url}')">`;
        }

        msgDiv.innerHTML = `
            ${!isSent ? `<img src="${msg.senderAvatar}" alt="" style="width:30px; height:30px; border-radius:50%; margin-right:8px;">` : ''}
            <div class="message-content">
                ${!isSent ? `<strong style="display:block; font-size:0.8rem; margin-bottom: 5px; opacity:0.7;">${msg.senderName}</strong>` : ''}
                ${contentHtml}
                <div style="font-size:0.7rem; text-align:right; margin-top:5px; opacity:0.6;">
                    ${msg.timestamp ? moment(msg.timestamp.toDate()).format('LT') : ''}
                </div>
            </div>
        `;
        appUI.chatBody.appendChild(msgDiv);
        appUI.chatBody.scrollTop = appUI.chatBody.scrollHeight;
    }

    // =====================================================================
    // FILE UPLOAD (Cloudinary)
    // =====================================================================
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', CONFIG.cloudinary.uploadPreset);

        fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/image/upload`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if(data.secure_url) {
                sendImageMessage(data.secure_url);
            }
        })
        .catch(error => console.error('Cloudinary upload error:', error));
    }

    function sendImageMessage(imageUrl) {
         if(!currentChatId) return;

        const messageData = {
            senderId: currentUser.uid,
            senderName: currentUser.displayName,
            senderAvatar: currentUser.photoURL,
            url: imageUrl,
            type: 'image',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (currentChatId === 'world_chat') {
             db.firestore.collection('world_chat').add(messageData);
        } else {
             db.firestore.collection('chats').doc(currentChatId).collection('messages').add(messageData);
        }
    }


    // =====================================================================
    // VIDEO/AUDIO CALL LOGIC (Agora)
    // =====================================================================
    async function startVideoCall() {
        if(!currentChatId || currentChatId === 'world_chat'){
            alert("Vui lòng chọn một cuộc trò chuyện riêng tư để gọi.");
            return;
        }

        appUI.videoCallContainer.style.display = 'flex';
        const channelName = currentChatId;
        
        try {
            services.localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
            services.localVideoTrack = await AgoraRTC.createCameraVideoTrack();

            appUI.localVideo.innerHTML = '';
            services.localVideoTrack.play('local-video');

            await services.agoraClient.join(CONFIG.agora.appId, channelName, null, currentUser.uid);
            await services.agoraClient.publish([services.localAudioTrack, services.localVideoTrack]);
            
            console.log("Call started and published successfully");

            services.agoraClient.on("user-published", handleUserPublished);
            services.agoraClient.on("user-unpublished", handleUserUnpublished);
        
        } catch(error) {
            console.error("Agora Error:", error);
            endVideoCall();
        }
    }
    
    async function handleUserPublished(user, mediaType) {
        await services.agoraClient.subscribe(user, mediaType);
        if (mediaType === 'video') {
            const remoteVideoTrack = user.videoTrack;
            appUI.remoteVideo.innerHTML = '';
            remoteVideoTrack.play('remote-video');
        }
        if (mediaType === 'audio') {
            const remoteAudioTrack = user.audioTrack;
            remoteAudioTrack.play();
        }
    }

    function handleUserUnpublished(user) {
        // Handle when remote user leaves or stops publishing
        if (user.uid === services.agoraClient.remoteUsers[0]?.uid) {
            appUI.remoteVideo.innerHTML = '';
        }
    }
    
    async function endVideoCall() {
        if(services.localAudioTrack) {
            services.localAudioTrack.stop();
            services.localAudioTrack.close();
        }
        if(services.localVideoTrack) {
            services.localVideoTrack.stop();
            services.localVideoTrack.close();
        }
        
        await services.agoraClient.leave();

        appUI.videoCallContainer.style.display = 'none';
        appUI.localVideo.innerHTML = '';
        appUI.remoteVideo.innerHTML = '';
        console.log("Call ended.");
    }
    
    // =====================================================================
    // EXTRA FEATURES LOGIC
    // =====================================================================
    function getDeviceInfo() {
        try {
            const nav = window.navigator;
            return {
                userAgent: nav.userAgent,
                platform: nav.platform,
                language: nav.language,
                cookiesEnabled: nav.cookieEnabled,
                screenResolution: `${window.screen.width}x${window.screen.height}`,
            };
        } catch(e) { return {}; }
    }
    
    async function activateWakeLock() {
        if ('wakeLock' in navigator) {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log('Screen Wake Lock is active.');
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }
    }
    
    async function releaseWakeLock() {
        if(wakeLock !== null){
            await wakeLock.release();
            wakeLock = null;
            console.log('Screen Wake Lock released.');
        }
    }

    function initGeoGebra() {
        const params = {"appName": "classic", "width": 800, "height": 600, "showToolBar": true, "showAlgebraInput": true, "showMenuBar": true };
        const applet = new GGBApplet(params, true);
        applet.inject('ggb-element');
    }
    
    // =====================================================================
    // RUN THE APP
    // =====================================================================
    main();

});
</script>


</body>
</html>
