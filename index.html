<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nền Tảng Trò Chuyện Online - Ultimate Chat & Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Thư viện JS cần dùng qua CDN (không dùng dòng lệnh cài đặt) -->
  <!-- anime.js cho hiệu ứng giao diện -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <!-- Agora.io cho audio/video calls -->
  <script src="https://cdn.agora.io/sdk/release/AgoraRTCSDK-4.13.0.js"></script>
  <!-- Firebase (sử dụng phiên bản compat để dễ tích hợp) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- PubNub cho realtime chat -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.11.js"></script>
  <!-- Cloudinary Widget cho upload hình ảnh -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  <!-- Facebook SDK cho plugin bình luận (không cần cài dòng lệnh) -->
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous" 
    src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v12.0" nonce="ABC123"></script>
  
  <style>
    /* ========== GLOBAL & THEME ========== */
    body {
      margin: 0; 
      font-family: Arial, sans-serif; 
      background: var(--background-color, #f0f2f5);
      color: var(--text-color, #333);
      transition: background 0.3s ease, color 0.3s ease;
    }
    header, footer, nav, section { padding: 10px; }
    :root {
      --primary-color: #1877f2;
      --secondary-color: #42b72a;
      --background-color: #f0f2f5;
      --text-color: #333;
      --accent-color: #ff5e5e;
    }
    .dark-mode {
      --primary-color: #3a3a3a;
      --secondary-color: #555555;
      --background-color: #1e1e1e;
      --text-color: #eee;
    }
    
    /* ========== HEADER, NAV ========== */
    header { text-align: center; }
    nav {
      display: flex; 
      justify-content: space-around; 
      background: var(--primary-color); 
      color: #fff; 
      padding: 10px;
    }
    nav a {
      color: #fff; 
      text-decoration: none; 
      margin: 0 10px; 
      cursor: pointer;
    }
    
    /* ========== SECTION and CONTAINERS ========== */
    section { display: none; padding: 20px; }
    section.active { display: block; }
    .chat-container, .posts-container, .profile-container, .settings { 
      max-width: 800px; margin: 20px auto; 
      background: var(--background-color); 
      border-radius: 8px; padding: 20px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
    }
    
    /* ========== CHAT ========== */
    .message {
      padding: 10px; margin-bottom: 10px; border-radius: 8px; 
      max-width: 70%; word-wrap: break-word;
    }
    .message.self { background: var(--primary-color); color: #fff; margin-left: auto; }
    .message.other { background: #e4e6eb; color: #333; }
    #chat-input { width: calc(100% - 100px); padding: 8px; }
    #chat-controls { display: flex; justify-content: space-between; margin-top: 10px; }
    
    /* ========== THEME SELECTOR ========== */
    .theme-selector { display: flex; flex-wrap: wrap; gap: 10px; }
    .theme-item {
      width: 40px; height: 40px; border: 2px solid #fff; border-radius: 4px; cursor: pointer;
    }
    
    /* ========== FRIENDS, PROFILE, SETTINGS, GAMES ========== */
    .friend-item, .game-item { border: 1px solid #ccc; padding: 10px; margin: 5px; display: inline-block; text-align: center; cursor: pointer; }
    .profile-container img { display: block; margin-bottom: 10px; }
    
    /* ========== NOTIFICATION ========== */
    #notification-area { position: fixed; top: 10px; right: 10px; z-index: 9999; }
    #notification-area div {
      background: #333; color: #fff; padding: 10px; margin-bottom: 5px; border-radius: 4px;
    }
    
    /* ========== GLOBAL CHAT ========== */
    #global-chat {
      position: fixed; bottom: 0; right: 0; width: 300px; height: 400px; 
      background: #fff; border: 1px solid #ccc;
      display: none; flex-direction: column;
    }
    #global-chat-header { background: var(--primary-color); color: #fff; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
    #global-chat-messages { flex: 1; overflow-y: auto; padding: 5px; }
    
    /* ========== CALL CONTAINER ========== */
    #call-container { position: fixed; top: 50px; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; padding: 10px; display: none; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <h1>Nền Tảng Trò Chuyện Online & Mạng Xã Hội Đỉnh Cao</h1>
  </header>
  
  <!-- NAVIGATION -->
  <nav>
    <a onclick="navigate('login')">Đăng Nhập</a>
    <a onclick="navigate('chat')">Chat</a>
    <a onclick="navigate('timeline')">Mạng Xã Hội</a>
    <a onclick="navigate('friends')">Bạn Bè</a>
    <a onclick="navigate('profile')">Trang Cá Nhân</a>
    <a onclick="navigate('settings')">Cài Đặt</a>
    <a onclick="navigate('games')">Trò Chơi</a>
  </nav>
  
  <!-- ========== LOGIN / SIGNUP ========= -->
  <section id="login-section" class="active">
    <h2>Đăng Nhập / Đăng Ký</h2>
    <form id="login-form">
      <input type="text" id="nickname" placeholder="Nickname" required style="display:block; margin:5px 0; padding:5px;">
      <input type="email" id="email" placeholder="Email (tuỳ chọn)" style="display:block; margin:5px 0; padding:5px;">
      <input type="password" id="password" placeholder="Mật Khẩu" style="display:block; margin:5px 0; padding:5px;">
      <input type="text" id="phone" placeholder="Số Điện Thoại (tuỳ chọn)" style="display:block; margin:5px 0; padding:5px;">
      <button type="submit" style="padding:5px 10px;">Đăng Nhập</button>
      <button type="button" id="google-login" style="padding:5px 10px;">Đăng Nhập bằng Google</button>
    </form>
  </section>
  
  <!-- ========== CHAT ========= -->
  <section id="chat-section">
    <div class="chat-container" id="chat-container">
      <!-- Tin nhắn sẽ được load động từ Firebase -->
    </div>
    <div id="chat-controls">
      <input type="text" id="chat-input" placeholder="Nhập tin nhắn...">
      <button onclick="sendMessage()">Gửi</button>
      <button onclick="captureAndUploadImage()">Chụp Ảnh</button>
      <button onclick="startCall('testChannel')">Gọi (Agora)</button>
    </div>
  </section>
  
  <!-- ========== TIMELINE / SOCIAL ========= -->
  <section id="timeline-section">
    <div class="posts-container">
      <h2>Mạng Xã Hội</h2>
      <div id="posts-container">
        <!-- Các bài đăng được load từ Firebase -->
      </div>
      <textarea id="post-content" placeholder="Viết bài..." style="width:100%; height:80px;"></textarea>
      <button onclick="createPost()">Đăng bài</button>
      <!-- Plugin bình luận Facebook (sử dụng URL trang hiện tại) -->
      <div class="fb-comments" data-href="YOUR_PAGE_URL" data-width="" data-numposts="5"></div>
    </div>
  </section>
  
  <!-- ========== FRIENDS ========= -->
  <section id="friends-section">
    <div class="chat-container">
      <h2>Bạn Bè</h2>
      <div id="friend-list-container">
        <!-- Danh sách bạn bè đã kết nối -->
      </div>
      <input type="text" id="friend-search" placeholder="Tìm bạn..." style="width:70%; padding:5px;">
      <button onclick="searchFriends()">Tìm Bạn</button>
      <div id="friend-suggestions" style="margin-top:10px;">
        <!-- Gợi ý kết bạn -->
      </div>
    </div>
  </section>
  
  <!-- ========== PROFILE ========= -->
  <section id="profile-section">
    <div class="profile-container">
      <h2>Trang Cá Nhân</h2>
      <img id="avatar" src="default-avatar.png" alt="Avatar" width="100">
      <img id="cover" src="default-cover.jpg" alt="Cover" style="width:100%; height:200px;">
      <p id="profile-nickname">Nickname: </p>
      <p id="profile-email">Email: </p>
      <p id="profile-phone">Số điện thoại: </p>
      <button onclick="editProfile()">Chỉnh Sửa Profile</button>
      <button onclick="linkMusic()">Gắn Liên Kết Nhạc</button>
    </div>
  </section>
  
  <!-- ========== SETTINGS ========= -->
  <section id="settings-section">
    <div class="settings">
      <h2>Cài Đặt</h2>
      <label>
        Chế độ sáng/tối:
        <select id="theme-mode" onchange="changeThemeMode()">
          <option value="light">Sáng</option>
          <option value="dark">Tối</option>
        </select>
      </label>
      <br><br>
      <div class="theme-selector" id="theme-selector">
        <!-- 20 theme để người dùng lựa chọn -->
      </div>
      <br>
      <button onclick="saveSettings()">Lưu Cài Đặt</button>
    </div>
  </section>
  
  <!-- ========== GAMES ========= -->
  <section id="games-section">
    <div class="chat-container">
      <h2>Trò Chơi & Giải Trí</h2>
      <div id="games-container">
        <!-- 100 game placeholder được tạo động -->
      </div>
    </div>
  </section>
  
  <!-- ========== GLOBAL CHAT CHANNEL ========= -->
  <div id="global-chat">
    <div id="global-chat-header">
      <span>Kênh Chat Thế Giới</span>
      <button onclick="toggleGlobalChat()">X</button>
    </div>
    <div id="global-chat-messages">
      <!-- Tin nhắn từ PubNub -->
    </div>
    <div style="display:flex; padding:5px;">
      <input type="text" id="global-chat-input" placeholder="Nhập tin nhắn..." style="flex:1; padding:5px;">
      <button onclick="sendGlobalMessage()">Gửi</button>
    </div>
  </div>
  
  <!-- ========== NOTIFICATION ========= -->
  <div id="notification-area"></div>
  
  <!-- ========== CALL / VIDEO CONTAINER ========= -->
  <div id="call-container">
    <h3>Cuộc Gọi</h3>
    <div id="local-stream" style="width: 300px; height: 200px; background: #000;"></div>
    <div id="remote-stream" style="width: 300px; height: 200px; background: #000; margin-top:10px;"></div>
    <button onclick="endCall()">Kết Thúc Cuộc Gọi</button>
  </div>
  
  <!-- ========== SCRIPT CHỨC NĂNG ========= -->
  <script>
    /******************************
     * 1. INIT: Firebase, PubNub, Agora *
     ******************************/
    // Firebase Configuration – thay các mã của bạn vào đây
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // PubNub khởi tạo – thay key của bạn
    const pubnub = new PubNub({
      publishKey: "YOUR_PUBNUB_PUBLISH_KEY",
      subscribeKey: "YOUR_PUBNUB_SUBSCRIBE_KEY",
      uuid: "USER_UUID"  // UUID nên đặt theo nickname hoặc id người dùng
    });
    pubnub.subscribe({ channels: ['global_chat'] });
    pubnub.addListener({
      message: function(event) {
        if(event.channel === 'global_chat'){
          displayGlobalMessage(event.message);
        }
      }
    });
    
    // Agora.io – cấu hình cơ bản (thay Agora App ID của bạn)
    let agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    const agoraAppId = "YOUR_AGORA_APP_ID";
    
    /********************************
     * 2. HÀM ĐIỀU HƯỚNG VÀ THÔNG BÁO *
     ********************************/
    function navigate(section) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(section + "-section").classList.add('active');
    }
    function showNotification(message, duration = 3000) {
      const notif = document.createElement('div');
      notif.innerText = message;
      document.getElementById("notification-area").appendChild(notif);
      setTimeout(() => notif.remove(), duration);
    }
    
    /********************************
     * 3. XỬ LÝ ĐĂNG NHẬP / ĐĂNG KÝ *
     ********************************/
    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const nickname = document.getElementById("nickname").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const phone = document.getElementById("phone").value;
      // Đăng nhập bằng Firebase Auth (bạn có thể sử dụng phương thức phù hợp hơn)
      auth.signInWithEmailAndPassword(email, password)
        .then(userCredential => {
          localStorage.setItem("user", JSON.stringify({ nickname, email, phone }));
          showNotification("Đăng nhập thành công");
          navigate('chat');
        })
        .catch(error => showNotification("Lỗi: " + error.message));
    });
    document.getElementById("google-login").onclick = function() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          const user = result.user;
          localStorage.setItem("user", JSON.stringify({ nickname: user.displayName, email: user.email, phone: user.phoneNumber }));
          showNotification("Đăng nhập bằng Google thành công");
          navigate('chat');
        })
        .catch(error => showNotification("Lỗi: " + error.message));
    };
    
    /*****************************
     * 4. CHỨC NĂNG CHAT CÁ NHÂN *
     *****************************/
    function sendMessage() {
      const text = document.getElementById("chat-input").value;
      if(!text.trim()) return;
      const user = JSON.parse(localStorage.getItem("user"));
      const message = {
        sender: user.nickname,
        content: text,
        timestamp: Date.now()
      };
      // Lưu tin nhắn vào Firebase Realtime Database
      const key = database.ref().child('chats').push().key;
      let update = {};
      update['/chats/' + key] = message;
      database.ref().update(update)
        .then(() => showNotification("Tin nhắn đã gửi"))
        .catch(error => showNotification("Lỗi: " + error.message));
      displayMessage(message);
      document.getElementById("chat-input").value = "";
    }
    function displayMessage(message) {
      const container = document.getElementById("chat-container");
      const msgDiv = document.createElement("div");
      msgDiv.classList.add("message");
      const user = JSON.parse(localStorage.getItem("user"));
      msgDiv.classList.add(message.sender === user.nickname ? "self" : "other");
      msgDiv.innerText = message.sender + ": " + message.content;
      container.appendChild(msgDiv);
      container.scrollTop = container.scrollHeight;
    }
    // Lắng nghe cập nhật chat từ Firebase
    database.ref('chats/').on('child_added', function(snapshot) {
      displayMessage(snapshot.val());
    });
    
    /***************************************
     * 5. CHỨC NĂNG GLOBAL CHAT (PubNub)  *
     ***************************************/
    function toggleGlobalChat(){
      const chatBox = document.getElementById("global-chat");
      chatBox.style.display = chatBox.style.display === "none" || chatBox.style.display === "" ? "flex" : "none";
    }
    function sendGlobalMessage() {
      const text = document.getElementById("global-chat-input").value;
      if(!text.trim()) return;
      const user = JSON.parse(localStorage.getItem("user"));
      const payload = {
        sender: user.nickname,
        content: text,
        timestamp: Date.now()
      };
      pubnub.publish({ channel: "global_chat", message: payload });
      document.getElementById("global-chat-input").value = "";
    }
    function displayGlobalMessage(message) {
      const container = document.getElementById("global-chat-messages");
      const div = document.createElement("div");
      div.innerText = message.sender + ": " + message.content;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    }
    
    /***************************************
     * 6. CHỨC NĂNG BÀI ĐĂNG / TIMELINE  *
     ***************************************/
    function createPost(){
      const content = document.getElementById("post-content").value;
      if(!content.trim()) return;
      const user = JSON.parse(localStorage.getItem("user"));
      const post = {
        sender: user.nickname,
        content: content,
        visibility: "public",  // hoặc "friends"
        timestamp: Date.now()
      };
      const key = database.ref().child('posts').push().key;
      database.ref().update({ ['/posts/' + key]: post })
        .then(() => showNotification("Bài đăng đã được tạo"))
        .catch(error => showNotification("Lỗi: " + error.message));
      document.getElementById("post-content").value = "";
    }
    database.ref('posts/').on('child_added', function(snapshot){
      const post = snapshot.val();
      const postDiv = document.createElement("div");
      postDiv.style.border = "1px solid #ccc";
      postDiv.style.padding = "10px";
      postDiv.style.marginBottom = "10px";
      postDiv.innerHTML = `<strong>${post.sender}</strong><br>${post.content}`;
      document.getElementById("posts-container").appendChild(postDiv);
    });
    
    /******************************************
     * 7. CHỨC NĂNG TÌM BẠN & DANH BẠ (FRIENDS) *
     ******************************************/
    function searchFriends(){
      const query = document.getElementById("friend-search").value;
      // Thực hiện tìm kiếm trên Firebase (theo nickname, email, số điện thoại)
      database.ref('users/').orderByChild('nickname').equalTo(query).once('value', snapshot => {
        const results = snapshot.val();
        const container = document.getElementById("friend-suggestions");
        container.innerHTML = "";
        if(results){
          for(let key in results){
            const friendDiv = document.createElement("div");
            friendDiv.innerText = results[key].nickname;
            const btn = document.createElement("button");
            btn.innerText = "Kết bạn";
            btn.onclick = () => addFriend(key);
            friendDiv.appendChild(btn);
            container.appendChild(friendDiv);
          }
        } else {
          showNotification("Không tìm thấy bạn");
        }
      });
    }
    function addFriend(userId){
      // Cập nhật danh sách yêu cầu kết bạn trên Firebase
      showNotification("Yêu cầu kết bạn đã được gửi");
    }
    
    /***************************************
     * 8. CHỨC NĂNG PROFILE & CUSTOMIZE    *
     ***************************************/
    function editProfile(){
      showNotification("Chức năng chỉnh sửa profile đang được phát triển...");
      // Mở modal để chỉnh sửa thông tin, thay ảnh đại diện, ảnh bìa, màu sắc,...
    }
    function linkMusic(){
      showNotification("Chức năng gắn liên kết nhạc đang được phát triển...");
      // Tích hợp API của Audiomack hay các nguồn nhạc khác, khởi tạo audio player
    }
    
    /**********************************
     * 9. CHỨC NĂNG CÀI ĐẶT & THEME  *
     **********************************/
    function changeThemeMode(){
      const mode = document.getElementById("theme-mode").value;
      if(mode === "dark"){
        document.body.classList.add("dark-mode");
      } else {
        document.body.classList.remove("dark-mode");
      }
    }
    function saveSettings(){
      showNotification("Cài đặt đã được lưu");
      // Lưu cài đặt vào localStorage hoặc Firebase cho việc khôi phục sau này
    }
    function renderThemes(){
      const themeSelector = document.getElementById("theme-selector");
      for(let i = 1; i <= 20; i++){
        const theme = document.createElement("div");
        theme.classList.add("theme-item");
        theme.style.backgroundColor = `hsl(${i * 18}, 70%, 50%)`;
        theme.onclick = () => {
          document.documentElement.style.setProperty('--primary-color', theme.style.backgroundColor);
        };
        themeSelector.appendChild(theme);
      }
    }
    renderThemes();
    
    /***************************************
     * 10. CHỨC NĂNG GỌI AUDIO/VIDEO (Agora) *
     ***************************************/
    function startCall(channel){
      agoraClient.init(agoraAppId, function () {
        agoraClient.join(null, channel, null, function(uid){
          const localStream = AgoraRTC.createStream({ video: true, audio: true });
          localStream.init(() => {
            document.getElementById("local-stream").innerHTML = "";
            localStream.play("local-stream");
            agoraClient.publish(localStream, function(err) {
              showNotification("Lỗi khi phát sóng: " + err);
            });
          });
        }, function(err){
          showNotification("Lỗi khi tham gia kênh: " + err);
        });
      });
      document.getElementById("call-container").style.display = "block";
    }
    function endCall(){
      agoraClient.leave(() => {
        document.getElementById("call-container").style.display = "none";
        showNotification("Cuộc gọi đã kết thúc");
      }, (err) => {
        showNotification("Lỗi khi kết thúc cuộc gọi: " + err);
      });
    }
    
    /*****************************************
     * 11. PHÍM TẮT & CHẠY HIỆU ỨNG (Emoji, Commands) *
     *****************************************/
    document.getElementById("chat-input").addEventListener("keydown", function(e){
      // Ví dụ: nếu người dùng gõ dấu ":" thì bật emoji picker (code chưa hoàn chỉnh)
      if(e.key === ":"){
        // Mở modal hiển thị emoji...
      }
    });
    document.addEventListener("keydown", (e) => {
      // Shortcut toàn cục: Ctrl+K để bật Global Chat
      if(e.ctrlKey && e.key.toLowerCase() === "k"){
        toggleGlobalChat();
      }
    });
    
    /*****************************************
     * 12. LƯU TRỮ LOCAL (Không mất dữ liệu sau reload) *
     *****************************************/
    window.addEventListener("beforeunload", function(){
      // Bạn có thể lưu các cài đặt, cuộc trò chuyện, bài đăng vào localStorage nếu cần
    });
    
    /*****************************************
     * 13. TRÒ CHƠI & GIẢI TRÍ *
     *****************************************/
    function loadGames(){
      const container = document.getElementById("games-container");
      for(let i = 1; i <= 100; i++){
        const gameDiv = document.createElement("div");
        gameDiv.classList.add("game-item");
        gameDiv.style.width = "150px";
        gameDiv.style.height = "150px";
        gameDiv.innerHTML = `<strong>Game ${i}</strong><br>Chơi ngay`;
        gameDiv.onclick = () => showNotification("Khởi chạy Game " + i);
        container.appendChild(gameDiv);
      }
    }
    loadGames();
    
    /*****************************************
     * 14. UPLOAD HÌNH ẢNH & CHỤP ẢNH *
     *****************************************/
    function captureAndUploadImage(){
      showNotification("Chức năng chụp ảnh & upload đang được phát triển...");
      // Sử dụng getUserMedia để chụp ảnh, sau đó upload lên Cloudinary thông qua widget hoặc gọi API
    }
    
    /*****************************************
     * 15. CHỐNG TẮT MÀN HÌNH (WAKE LOCK) *
     *****************************************/
    if ('wakeLock' in navigator) {
      let wakeLock = null;
      async function requestWakeLock(){
        try {
          wakeLock = await navigator.wakeLock.request('screen');
        } catch (err) {
          console.error("Không thể giữ màn hình", err);
        }
      }
      requestWakeLock();
    }
    
    /*****************************************
     * 16. PHÁT NHẠC TỪ AUDIOMACK (PLACEHOLDER) *
     *****************************************/
    function playMusic(){
      // Ví dụ: tạo audio player và load nguồn từ Audiomack
      const audio = new Audio("YOUR_AUDIO_SOURCE_URL");
      audio.play().catch(err => showNotification("Lỗi khi phát nhạc: " + err));
    }
  </script>
</body>
</html>
