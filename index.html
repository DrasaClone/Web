<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>N·ªÅn T·∫£ng Chat Realtime Cao C·∫•p</title>
  <style>
    /* ---------- Reset & c∆° b·∫£n ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 { text-align: center; margin-bottom: 1rem; }
    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 15px;
      background-color: #007BFF;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 10px;
    }
    button:hover { background-color: #0056b3; }
    button:disabled { background-color: #999; cursor: not-allowed; }
    /* ---------- C√°c n√∫t ph·ª• ---------- */
    .deleteBtn {
      background: #dc3545;
      margin-left: 5px;
      color: #fff;
    }
    .editBtn {
      background: #ffc107;
      margin-left: 5px;
      color: #000;
    }
    .replyBtn {
      background: #17a2b8;
      margin-left: 5px;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8em;
      margin-top: 5px;
    }
    .emojiBtn {
      background: #6c757d;
      margin-left: 5px;
      color: #fff;
    }
    .likeBtn, .deleteBtn, .editBtn, .emojiBtn, .replyBtn {
      font-size: 0.8em;
    }
    .likeCount { font-weight: bold; margin-left: 5px; }
    /* ---------- Dark mode ---------- */
    body.dark-mode {
      background-color: #121212;
      color: #e0e0e0;
    }
    body.dark-mode .container { background: #1e1e1e; }
    body.dark-mode input,
    body.dark-mode button { background-color: #333; color: #e0e0e0; border-color: #444; }
    /* ---------- C√°c ph·∫ßn giao di·ªán ---------- */
    #loginSection, #chatSection { margin-bottom: 1rem; }
    #chatSection { display: none; }
    #chatHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    #userInfo { display: flex; align-items: center; }
    #userAvatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-left: 10px;
      display: none;
    }
    #roomSelector, #searchContainer {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    #searchInput {
      width: 80%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #onlineUsersContainer {
      background: #eee;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    #onlineUsersContainer h4 { margin-bottom: 5px; text-align: center; }
    #onlineUsers div { margin: 2px 0; text-align: center; font-size: 0.9em; }
    #messages {
      border: 1px solid #ddd;
      background: #fafafa;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .message {
      background: #eef;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 5px;
      position: relative;
    }
    .timestamp {
      font-size: 0.8em;
      color: #555;
      position: absolute;
      top: 5px;
      right: 5px;
    }
    #typingIndicator {
      min-height: 20px;
      font-style: italic;
      color: #777;
      margin-bottom: 10px;
      text-align: center;
    }
    hr { border: 0; border-top: 1px solid #ccc; margin: 10px 0; }
    #darkModeContainer { text-align: right; margin-bottom: 10px; }
    #loginError { color: red; text-align: center; }
    /* ---------- File attachment ---------- */
    #attachBtn { background-color: #28a745; margin-right: 5px; }
    /* Responsive */
    @media (max-width: 600px) {
      .container { margin: 1rem; padding: 0.5rem; }
      button { width: 100%; margin-bottom: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>N·ªÅn T·∫£ng Chat Realtime</h1>
    
    <!-- Dark mode toggle -->
    <div id="darkModeContainer">
      <button id="darkModeToggle">Ch·∫ø ƒë·ªô t·ªëi</button>
    </div>
    
    <!-- Ph·∫ßn ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω -->
    <div id="loginSection">
      <h2>ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω</h2>
      <div id="emailLogin">
        <input id="emailInput" type="email" placeholder="Email">
        <input id="passwordInput" type="password" placeholder="M·∫≠t kh·∫©u">
        <button id="loginEmailBtn">ƒêƒÉng nh·∫≠p Email</button>
        <button id="registerEmailBtn">ƒêƒÉng k√Ω Email</button>
      </div>
      <hr>
      <div id="googleLogin">
        <button id="loginGoogleBtn">ƒêƒÉng nh·∫≠p v·ªõi Google</button>
      </div>
      <hr>
      <div id="phoneLogin">
        <input id="phoneInput" type="text" placeholder="S·ªë ƒëi·ªán tho·∫°i (e.g. +84123456789)">
        <button id="loginPhoneBtn">ƒêƒÉng nh·∫≠p v·ªõi SƒêT</button>
        <div id="recaptcha-container"></div>
      </div>
      <div id="loginError"></div>
    </div>
    
    <!-- Ph·∫ßn Chat -->
    <div id="chatSection">
      <div id="chatHeader">
        <div id="userInfo">
          <span id="welcomeMsg">Welcome, Guest</span>
          <img id="userAvatar" src="" alt="Avatar">
        </div>
        <button id="logoutBtn">ƒêƒÉng xu·∫•t</button>
      </div>
      <!-- Ch·ªçn ph√≤ng chat (room) -->
      <div id="roomSelector">
        Ch·ªçn ph√≤ng chat: 
        <select id="chatRoomSelect">
          <option value="general">General</option>
          <option value="tech">???</option>
          <option value="random">!!!</option>
          <option value="gaming">[‚àÜ|¬ß|‚Ä¢¬©¬Æ7‚úì]</option>
        </select>
      </div>
      <!-- T√¨m ki·∫øm tin nh·∫Øn -->
      <div id="searchContainer">
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm tin nh·∫Øn...">
      </div>
      <!-- Danh s√°ch ng∆∞·ªùi online c·ªßa ph√≤ng hi·ªán t·∫°i -->
      <div id="onlineUsersContainer">
        <h4>Ng∆∞·ªùi Online</h4>
        <div id="onlineUsers"></div>
      </div>
      <div id="typingIndicator"></div>
      <div id="messages"></div>
      <div id="messageInputContainer">
        <input id="messageInput" type="text" placeholder="Nh·∫≠p tin nh·∫Øn...">
        <button id="sendBtn">G·ª≠i</button>
        <button id="attachBtn">ƒê√≠nh k√®m ·∫£nh</button>
        <button id="emojiBtn" class="emojiBtn">üòÄ</button>
        <input type="file" id="fileInput" accept="image/*" style="display: none;">
      </div>
    </div>
    
    <!-- Facebook Comments -->
    <div id="fbCommentsSection">
      <h3>B√¨nh lu·∫≠n Facebook</h3>
      <!-- Thay YOUR_WEBSITE_URL b·∫±ng URL th·ª±c c·ªßa website b·∫°n -->
      <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="100%" data-numposts="100"></div>
    </div>
  </div>
  
  <!-- Audio th√¥ng b√°o (ch·∫Øc ch·∫Øn c√≥ file notification.mp3 trong c√πng th∆∞ m·ª•c) -->
  <audio id="notificationSound" src="notification.mp3" preload="auto"></audio>
  
  <!-- Facebook SDK -->
  <div id="fb-root"></div>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v15.0"></script>
  
  <!-- Firebase SDK (app, auth, database, storage) -->
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.14.0/firebase-storage-compat.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Emoji Button (picker) -->
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.2/dist/index.js"></script>
  
  <script>
    /********** C·∫§U H√åNH & KH·ªûI T·∫†O **********/
    // Thay c√°c gi√° tr·ªã b√™n d∆∞·ªõi b·∫±ng th√¥ng tin th·∫≠t c·ªßa d·ª± √°n b·∫°n!
    const firebaseConfig = {
  apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
  authDomain: "webai-7642b.firebaseapp.com",
  databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webai-7642b",
  storageBucket: "webai-7642b.firebasestorage.app",
  messagingSenderId: "967881370128",
  appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
  measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    // Global cho PubNub & ph√≤ng chat
    let pubnub;
    let currentChannel = "general"; // M·∫∑c ƒë·ªãnh l√† "general"
    let displayedMessages = {};  // ƒê·ªÉ tr√°nh hi·ªÉn th·ªã tr√πng l·∫∑p

    // C√°c bi·∫øn cho ch·ªâ b√°o ‚Äúƒëang nh·∫≠p‚Ä¶‚Äù
    let lastTypingSent = 0;
    let typingTimeout;

    /********** DARK MODE TOGGLE **********/
    const darkModeToggle = document.getElementById('darkModeToggle');
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
      anime({
        targets: 'body',
        backgroundColor: document.body.classList.contains('dark-mode') ? '#121212' : '#f5f5f5',
        duration: 500,
        easing: 'easeInOutQuad'
      });
    });
    if(localStorage.getItem('darkMode') === "true") {
      document.body.classList.add('dark-mode');
    }

    /********** X·ª¨ L√ù ƒêƒÇNG NH·∫¨P/ƒêƒÇNG K√ù **********/
    const loginError = document.getElementById('loginError');
    function showError(msg) { loginError.innerText = msg; }
    function clearError() { loginError.innerText = ""; }

    // ƒêƒÉng nh·∫≠p Email
    document.getElementById('loginEmailBtn').addEventListener('click', () => {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(() => clearError())
        .catch(error => showError("L·ªói ƒëƒÉng nh·∫≠p Email: " + error.message));
    });
    // ƒêƒÉng k√Ω Email
    document.getElementById('registerEmailBtn').addEventListener('click', () => {
      const email = document.getElementById('emailInput').value;
      const password = document.getElementById('passwordInput').value;
      auth.createUserWithEmailAndPassword(email, password)
        .then(() => clearError())
        .catch(error => showError("L·ªói ƒëƒÉng k√Ω Email: " + error.message));
    });
    // ƒêƒÉng nh·∫≠p Google
    document.getElementById('loginGoogleBtn').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(() => clearError())
        .catch(error => showError("L·ªói ƒëƒÉng nh·∫≠p Google: " + error.message));
    });
    // ƒêƒÉng nh·∫≠p SƒêT v·ªõi reCAPTCHA
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      size: 'invisible',
      callback: (response) => {}
    });
    document.getElementById('loginPhoneBtn').addEventListener('click', () => {
      const phoneNumber = document.getElementById('phoneInput').value;
      const appVerifier = window.recaptchaVerifier;
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then(confirmationResult => {
          const verificationCode = prompt('Nh·∫≠p m√£ x√°c th·ª±c SMS:');
          return confirmationResult.confirm(verificationCode);
        })
        .then(() => clearError())
        .catch(error => showError("L·ªói ƒëƒÉng nh·∫≠p SƒêT: " + error.message));
    });

    auth.onAuthStateChanged(user => {
      if(user) { showChat(); }
      else { showLogin(); }
    });

    /********** HI·ªÇN TH·ªä & CHUY·ªÇN ƒê·ªîI GIAO DI·ªÜN **********/
    function showChat() {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('chatSection').style.display = 'block';
      anime({
        targets: '#chatSection',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 600,
        easing: 'easeOutExpo'
      });
      updateUserInfo();
      // C·∫•p quy·ªÅn th√¥ng b√°o desktop n·∫øu c√≥
      if ("Notification" in window && Notification.permission !== "granted")
        Notification.requestPermission();
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i online cho user
      setUserPresence(currentChannel);
      // L·∫Øng nghe thay ƒë·ªïi ph√≤ng chat
      document.getElementById('chatRoomSelect').addEventListener('change', (e) => {
        switchChannel(e.target.value);
      });
      // Kh·ªüi t·∫°o PubNub & t·∫£i tin nh·∫Øn cho ph√≤ng hi·ªán t·∫°i
      initPubNub();
      loadMessages();
      updateOnlineUsers();
      document.getElementById('messageInput').focus();
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if(e.key === 'Enter') sendMessage();
      });
      document.getElementById('messageInput').addEventListener('input', handleTyping);
      // L·∫Øng nghe t√¨m ki·∫øm tin nh·∫Øn
      document.getElementById("searchInput").addEventListener("input", function(e){
        const query = e.target.value.toLowerCase();
        const msgs = document.querySelectorAll(".message");
        msgs.forEach(m => {
          if(m.textContent.toLowerCase().includes(query))
            m.style.display = "";
          else
            m.style.display = "none";
        });
      });
    }
    function showLogin() {
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('chatSection').style.display = 'none';
      document.getElementById('messages').innerHTML = '';
      displayedMessages = {};
      if(pubnub) { pubnub.unsubscribeAll(); }
    }
    function updateUserInfo() {
      const user = auth.currentUser;
      const name = user.displayName || user.email || user.phoneNumber || "User";
      document.getElementById('welcomeMsg').innerText = "Welcome, " + name;
      if(user.photoURL) {
        const avatar = document.getElementById('userAvatar');
        avatar.src = user.photoURL;
        avatar.style.display = 'inline-block';
      }
    }

    /********** ONLINE USERS & PRESENCE **********/
    // Khi user ƒëƒÉng nh·∫≠p, c·∫≠p nh·∫≠t tr·∫°ng th√°i online v√† ƒë·∫∑t room hi·ªán t·∫°i
    function setUserPresence(room) {
      const user = auth.currentUser;
      if(!user) return;
      const statusRef = db.ref('/status/' + user.uid);
      statusRef.set({
        name: user.displayName || user.email || user.phoneNumber || "User",
        room: room,
        online: true,
        lastChanged: firebase.database.ServerValue.TIMESTAMP
      });
      statusRef.onDisconnect().set({
        name: user.displayName || user.email || user.phoneNumber || "User",
        room: room,
        online: false,
        lastChanged: firebase.database.ServerValue.TIMESTAMP
      });
    }
    // C·∫≠p nh·∫≠t danh s√°ch online users
    function updateOnlineUsers() {
      db.ref('/status').on('value', snapshot => {
        const onlineDiv = document.getElementById("onlineUsers");
        onlineDiv.innerHTML = "";
        snapshot.forEach(childSnapshot => {
          const data = childSnapshot.val();
          if(data.online === true && data.room === currentChannel) {
            let userItem = document.createElement("div");
            userItem.textContent = data.name;
            onlineDiv.appendChild(userItem);
          }
        });
      });
    }

    /********** CHUY·ªÇN PH√íNG CHAT **********/
    function switchChannel(newChannel) {
      // H·ªßy ƒëƒÉng k√Ω PubNub t·ª´ k√™nh c≈©
      if(pubnub) { pubnub.unsubscribeAll(); }
      currentChannel = newChannel;
      // C·∫≠p nh·∫≠t tr·∫°ng th√°i online c·ªßa user v·ªõi ph√≤ng m·ªõi
      setUserPresence(newChannel);
      // X√≥a tin nh·∫Øn c≈© v√† reset cache
      document.getElementById('messages').innerHTML = "";
      displayedMessages = {};
      // Kh·ªüi t·∫°o l·∫°i PubNub, t·∫£i tin nh·∫Øn v√† c·∫≠p nh·∫≠t danh s√°ch online
      initPubNub();
      loadMessages();
      updateOnlineUsers();
    }

    /********** PUBNUB & TIN NH·∫ÆN REALTIME **********/
    function initPubNub() {
      const user = auth.currentUser;
      if(!user) return;
      pubnub = new PubNub({
        subscribeKey: 'YOUR_PUBNUB_SUBSCRIBE_KEY',
        publishKey: 'YOUR_PUBNUB_PUBLISH_KEY',
        uuid: user.uid
      });
      let pubnubChannel = "chat_" + currentChannel;
      pubnub.subscribe({ channels: [ pubnubChannel ] });
      pubnub.addListener({
        message: (msgEvent) => {
          const msg = msgEvent.message;
          updateMessageContent(msg);
          // N·∫øu tin nh·∫Øn kh√¥ng do ch√≠nh b·∫°n g·ª≠i, ph√°t √¢m v√† th√¥ng b√°o desktop
          if(auth.currentUser && msg.uid && msg.uid !== auth.currentUser.uid) {
            document.getElementById('notificationSound').play().catch(err => {});
            if(document.hidden && Notification.permission === "granted") {
              let title = "Tin nh·∫Øn m·ªõi t·ª´ " + msg.sender;
              let body = msg.text ? msg.text : (msg.imageUrl ? "G·ª≠i m·ªôt h√¨nh ·∫£nh" : "");
              new Notification(title, { body: body });
            }
          }
        },
        signal: (signalEvent) => {
          if(signalEvent.message && signalEvent.message.type === 'typing') {
            const sender = signalEvent.publisher;
            if(sender === auth.currentUser.uid) return;
            showTypingIndicator(sender);
          }
        }
      });
    }
    
    function sendMessage() {
      const textInput = document.getElementById('messageInput');
      let text = textInput.value;
      if(text.trim() === "") return;
      const user = auth.currentUser;
      const message = {
        uid: user.uid,
        sender: user.displayName || user.email || user.phoneNumber || "Anonymous",
        text: text,
        timestamp: Date.now(),
        likes: 0
      };
      // L∆∞u tin nh·∫Øn l√™n Firebase theo ph√≤ng hi·ªán t·∫°i
      const msgRef = db.ref('channels/' + currentChannel + '/messages').push();
      message.id = msgRef.key;
      msgRef.set(message).catch(error => console.error("L·ªói l∆∞u tin nh·∫Øn:", error));
      // G·ª≠i tin nh·∫Øn qua PubNub
      pubnub.publish({ channel: "chat_" + currentChannel, message: message });
      textInput.value = "";
      animateNewMessage();
    }

    /********** FILE ATTACHMENT & EMOJI PICKER **********/
    // G·ª≠i file ·∫£nh ƒë√≠nh k√®m
    document.getElementById('attachBtn').addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', uploadImage);
    function uploadImage() {
      const file = document.getElementById('fileInput').files[0];
      if(!file) return;
      const user = auth.currentUser;
      const filename = Date.now() + "_" + file.name;
      const storageRef = storage.ref('images/' + filename);
      const uploadTask = storageRef.put(file);
      uploadTask.on('state_changed',
        snapshot => {},
        error => { console.error("L·ªói upload:", error); },
        () => {
          uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
            const message = {
              uid: user.uid,
              sender: user.displayName || user.email || user.phoneNumber || "Anonymous",
              text: "",
              imageUrl: downloadURL,
              timestamp: Date.now(),
              likes: 0
            };
            const msgRef = db.ref('channels/' + currentChannel + '/messages').push();
            message.id = msgRef.key;
            msgRef.set(message).catch(error => console.error("L·ªói l∆∞u tin nh·∫Øn ·∫£nh:", error));
            pubnub.publish({ channel: "chat_" + currentChannel, message: message });
          });
        }
      );
    }
    // Emoji picker
    const emojiButton = document.getElementById('emojiBtn');
    const picker = new EmojiButton();
    emojiButton.addEventListener('click', () => {
      picker.togglePicker(emojiButton);
    });
    picker.on('emoji', selection => {
      document.getElementById('messageInput').value += selection.emoji;
    });

    /********** T√çN HI·ªÜU "ƒêANG NH·∫¨P" **********/
    function handleTyping() {
      const now = Date.now();
      if(now - lastTypingSent > 3000) {
        lastTypingSent = now;
        pubnub.signal({ channel: "chat_" + currentChannel, message: { type: 'typing' } });
      }
    }
    function showTypingIndicator(senderUid) {
      const indicator = document.getElementById('typingIndicator');
      indicator.innerText = "User " + senderUid.substring(0,6) + " ƒëang nh·∫≠p...";
      if(typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => { indicator.innerText = ""; }, 3000);
    }

    /********** T·∫¢I & C·∫¨P NH·∫¨T TIN NH·∫ÆN **********/
    // H√†m render HTML c·ªßa tin nh·∫Øn
    function renderMessageHTML(message) {
      let content = `<strong>${message.sender}:</strong>`;
      if(message.text) { content += ` ${message.text}`; }
      if(message.imageUrl) {
        content += `<br><img src="${message.imageUrl}" style="max-width:200px; margin-top:5px; border-radius:4px;">`;
      }
      content += `<div class="timestamp">${formatTimestamp(message.timestamp)}</div>`;
      content += `<button class="likeBtn" onclick="likeMessage('${message.id}')">Like (<span class="likeCount">${message.likes || 0}</span>)</button>`;
      if(auth.currentUser && message.uid === auth.currentUser.uid) {
        content += `<button class="deleteBtn" onclick="deleteMessage('${message.id}')">Delete</button>`;
        content += `<button class="editBtn" onclick="editMessage('${message.id}', '${(message.text||"").replace(/'/g, "\\'")}')">Edit</button>`;
      }
      // Th√™m n√∫t tr·∫£ l·ªùi (Reply) cho m·ªçi tin nh·∫Øn
      content += `<button class="replyBtn" onclick="replyMessage('${message.id}', '${(message.text||"").replace(/'/g, "\\'")}')">Reply</button>`;
      return content;
    }
    // Hi·ªÉn th·ªã tin nh·∫Øn m·ªõi (d√†nh cho event child_added)
    function displayMessage(message) {
      if(displayedMessages[message.id]) return;
      displayedMessages[message.id] = true;
      const messagesDiv = document.getElementById('messages');
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message';
      msgDiv.setAttribute('data-msg-id', message.id);
      msgDiv.innerHTML = renderMessageHTML(message);
      messagesDiv.appendChild(msgDiv);
      anime({
        targets: msgDiv,
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    // C·∫≠p nh·∫≠t n·ªôi dung tin nh·∫Øn khi c√≥ thay ƒë·ªïi
    function updateMessageContent(message) {
      const msgDiv = document.querySelector("[data-msg-id='" + message.id + "']");
      if(msgDiv) {
        msgDiv.innerHTML = renderMessageHTML(message);
      } else {
        displayMessage(message);
      }
    }
    // ƒê·ªãnh d·∫°ng timestamp d·∫°ng hh:mm:ss
    function formatTimestamp(ts) {
      const d = new Date(ts);
      let hh = d.getHours(), mm = d.getMinutes(), ss = d.getSeconds();
      hh = hh < 10 ? '0' + hh : hh;
      mm = mm < 10 ? '0' + mm : mm;
      ss = ss < 10 ? '0' + ss : ss;
      return hh + ':' + mm + ':' + ss;
    }
    // T·∫£i tin nh·∫Øn c·ªßa ph√≤ng hi·ªán t·∫°i t·ª´ Firebase
    function loadMessages() {
      const messagesRef = db.ref('channels/' + currentChannel + '/messages');
      messagesRef.off();
      messagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        msg.id = snapshot.key;
        displayMessage(msg);
      });
      messagesRef.on('child_changed', snapshot => {
        const msg = snapshot.val();
        msg.id = snapshot.key;
        updateMessageContent(msg);
      });
      // L·∫Øng nghe x√≥a tin nh·∫Øn
      messagesRef.on('child_removed', snapshot => {
        const msgId = snapshot.key;
        const elem = document.querySelector("[data-msg-id='" + msgId + "']");
        if(elem) {
          elem.remove();
          delete displayedMessages[msgId];
        }
      });
    }
    // TƒÉng l∆∞·ª£t Like cho tin nh·∫Øn
    function likeMessage(msgId) {
      const msgRef = db.ref('channels/' + currentChannel + '/messages/' + msgId + '/likes');
      msgRef.transaction(currentLikes => (currentLikes || 0) + 1);
    }
    // X√≥a tin nh·∫Øn (ch·ªâ cho tin c·ªßa ch√≠nh user g·ª≠i)
    function deleteMessage(msgId) {
      if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin nh·∫Øn n√†y?")) {
        db.ref('channels/' + currentChannel + '/messages/' + msgId).remove();
      }
    }
    // Ch·ªânh s·ª≠a tin nh·∫Øn (ch·ªâ cho tin c·ªßa ch√≠nh user g·ª≠i)
    function editMessage(msgId, currentText) {
      const newText = prompt("Ch·ªânh s·ª≠a tin nh·∫Øn:", currentText);
      if(newText != null && newText.trim() !== "") {
        db.ref('channels/' + currentChannel + '/messages/' + msgId).update({ text: newText, timestamp: Date.now() });
      }
    }
    // H√†m Reply: ƒëi·ªÅn k√Ω t·ª± tr√≠ch d·∫´n v√†o input
    function replyMessage(msgId, quote) {
      document.getElementById('messageInput').value = "> " + quote + "\n";
      document.getElementById('messageInput').focus();
    }
    // Hi·ªáu ·ª©ng cho input khi g·ª≠i tin nh·∫Øn
    function animateNewMessage() {
      anime({
        targets: '#messageInput',
        scale: [1, 1.05, 1],
        duration: 300,
        easing: 'easeInOutQuad'
      });
    }
    // Cho ph√©p g·ªçi c√°c h√†m like, delete, edit, reply t·ª´ inline
    window.likeMessage = likeMessage;
    window.deleteMessage = deleteMessage;
    window.editMessage = editMessage;
    window.replyMessage = replyMessage;

    /********** SERVICE WORKER (v√≠ d·ª• offline c∆° b·∫£n) **********/
    if ('serviceWorker' in navigator) {
      const swCode = `
        self.addEventListener('install', e => self.skipWaiting());
        self.addEventListener('activate', e => self.clients.claim());
        self.addEventListener('fetch', event => {
          event.respondWith(fetch(event.request));
        });
      `;
      const blob = new Blob([swCode], { type: 'text/javascript' });
      const swUrl = URL.createObjectURL(blob);
      navigator.serviceWorker.register(swUrl)
        .then(reg => console.log('Service Worker ƒëƒÉng k√Ω th√†nh c√¥ng, scope:', reg.scope))
        .catch(err => console.error('Service Worker ƒëƒÉng k√Ω th·∫•t b·∫°i:', err));
    }
  </script>
</body>
</html>
