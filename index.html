<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <!-- TITLE ĐÃ CẬP NHẬT -->
  <title>Thành Phố Giao Tiếp Online</title>
  <meta name="description" content="Một thành phố ảo online nơi bạn có thể di chuyển, gặp gỡ và sử dụng các tính năng chat, forum, mạng xã hội, và nhiều hơn nữa.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0"></script>

  <script src="https://openfpcdn.io/fingerprintjs/v3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/UAParser.js/0.7.28/ua-parser.min.js"></script>
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
  <!-- Axios để upload video lên Cloudinary -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>

  <style>
    /* ----- CSS MỚI CHO THẾ GIỚI GAME ----- */
    #city-game-world {
      width: 1200px;
      height: 700px;
      margin: 20px auto;
      background-color: #a7d3a7; /* Màu cỏ */
      background-image:
        linear-gradient(rgba(128, 128, 128, 0.5) 1px, transparent 1px),
        linear-gradient(90deg, rgba(128, 128, 128, 0.5) 1px, transparent 1px);
      background-size: 20px 20px;
      border: 5px solid #6b4a3a;
      position: relative;
      overflow: hidden; /* Ngăn người chơi đi ra ngoài */
    }

    .player-avatar {
      width: 30px;
      height: 30px;
      background-color: red;
      border: 2px solid black;
      border-radius: 50%;
      position: absolute;
      transition: top 0.1s linear, left 0.1s linear;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    
    .player-avatar .nickname-label {
        position: absolute;
        top: -20px;
        width: max-content;
        background: rgba(0, 0, 0, 0.6);
        color: white;
        padding: 2px 5px;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
    }

    .other-player {
        background-color: blue;
    }
    
    .building {
      position: absolute;
      background-color: #deb887; /* Màu gỗ */
      border: 3px solid #8b4513; /* Màu gỗ đậm */
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      font-weight: bold;
      font-size: 1.2rem;
      z-index: 5;
    }

    /* Vị trí và kích thước các tòa nhà */
    #building-forum { top: 20px; left: 20px; width: 150px; height: 100px; background-color: #6a89cc; }
    #building-social { top: 20px; left: 200px; width: 150px; height: 100px; background-color: #f7b731; }
    #building-game { top: 20px; left: 380px; width: 150px; height: 100px; background-color: #e84393; }
    #building-call { top: 150px; left: 20px; width: 150px; height: 100px; background-color: #00b894; }
    #building-img { top: 150px; left: 200px; width: 150px; height: 100px; background-color: #a29bfe; }
    #building-video { top: 150px; left: 380px; width: 150px; height: 100px; background-color: #2d3436; }
    #building-help { top: 280px; left: 20px; width: 150px; height: 100px; background-color: #ff7675; }

    /* Lớp modal cho các section */
    .section-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90vw;
        max-height: 90vh;
        overflow: auto;
        z-index: 100;
        display: none; /* Mặc định ẩn */
        opacity: 1; /* Reset opacity */
        background-color: rgba(30, 30, 30, 0.9);
        border: 2px solid #fff;
        padding: 20px;
        border-radius: 15px;
    }
    .close-modal-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.5rem;
        background: red;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 50%;
        width: 30px;
        height: 30px;
    }
    
    /* Vô hiệu hóa nút điều hướng cũ */
    .nav { pointer-events: none; opacity: 0.5; }

    /* Các chủ đề giao diện */
    body.theme-default { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
    body.theme-light { background: #f1f1f1; color: #333; }
    body.theme-dark { background: linear-gradient(135deg, #232526, #414345); color: #fff; }
    body.theme-colorful { background: linear-gradient(135deg, #ff7e5f, #feb47b); color: #fff; }
    
    /* Global Styles */
    body { font-family: "Dosis", cursive; font-weight: 200; margin: 0; padding: 0; transition: background 0.5s ease, color 0.5s ease; }
    header { padding: 20px; text-align: center;}
    h1, h2, h3 { margin-bottom: 10px; }
    .theme-switcher, .nav-btn { background: rgba(255,255,255,0.2); border: none; border-radius: 5px; color: inherit; cursor: pointer; font-size: 1rem; }
    .theme-switcher { padding: 8px 16px; margin-bottom: 10px; }
    .nav { margin: 20px 0; display: flex; justify-content: center;}
    .nav-btn { margin: 0 5px; padding: 10px 15px; }
    .nav-btn.active { background: rgba(255,255,255,0.5); }
    
    /* Section chung */
    .section {
      border: 1px solid rgba(255,255,255,0.5); padding: 20px; margin: 20px auto;
      max-width: 800px; background-color: rgba(0,0,0,0.5); border-radius: 10px;
      /* opacity: 0;  Bỏ opacity để modal xử lý */
      transition: opacity 0.5s ease;
    }
    .active-page { /* opacity: 1; */ display: block !important; } /* Sửa thành display để modal hoạt động */

    input, button, textarea, select { margin: 5px 0; padding: 5px; font-size: 1rem; border-radius: 5px; border: none; }
    input, textarea, select { width: 80%; }
    
    /* Loading Overlay */
    .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #fff; display: flex; align-items: center; justify-content: center; z-index: 1000; font-size: 2rem; color: #000; display: none; }
    .progress-circle { width: 150px; height: 150px; position: relative; }
    .progress-circle svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .progress-circle circle { fill: none; stroke-width: 12; stroke-linecap: round; }
    .progress-circle .bg { stroke: #eee; }
    .progress-circle .progress { stroke: #4caf50; stroke-dasharray: 440; stroke-dashoffset: 440; transition: stroke-dashoffset 1s ease-out; }
    .progress-circle .percentage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; font-weight: bold; }
    
    #chat-window { border: 1px solid rgba(255,255,255,0.5); height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; background-color: rgba(255,255,255,0.1); display: flex; flex-direction: column; }
    #chat-window .message, #chat-window .system-message { color: #000 !important; }
    .message { margin: 10px 0; padding: 10px; border-radius: 10px; max-width: 80%; word-break: break-word; }
    .message.mine { align-self: flex-end; background-color: #a8e6cf; text-align: right; }
    .message.other { align-self: flex-start; background-color: #81d4fa; text-align: left; }
    .system-message { align-self: center; background-color: #ffe082; color: #333; font-style: italic; padding: 5px; border-radius: 5px; max-width: 70%; margin: 10px auto; }
    
    .post-card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 10px; margin: 10px 0; text-align: left; }
    .post-card img { max-width: 100%; margin-top: 10px; border-radius: 5px; }
    .like-btn, .show-comment-btn, .submit-comment-btn, .social-like-btn, .social-show-comment-btn, .social-submit-comment-btn { margin: 5px 2px; padding: 5px 10px; font-size: 0.9rem; border-radius: 5px; cursor: pointer; }
    .comment-section, .social-comment-section { margin-top: 10px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 5px; }
    .comment, .social-comment { margin: 5px 0; font-size: 0.9rem; padding: 5px; border-bottom: 1px dotted #ccc; }
    
    .game-container iframe { width: 100%; height: 500px; border: none; }
    
    .fb-comments-container { border: 2px solid #ffffff; padding: 10px; background-color: #f9f9f9; border-radius: 5px; margin: 20px auto; max-width: 600px; color: #000; }
    
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast { background: rgba(0, 0, 0, 0.7); color: #fff; padding: 10px 20px; margin-top: 10px; border-radius: 5px; opacity: 1; transition: opacity 0.5s ease-out; }
    .toast.hide { opacity: 0; }
    .hidden { display: none; }
    .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
    h2 { margin-top: 0; }
    .room-list { list-style: none; padding: 0; }
    .room-list li { padding: 10px; border: 1px solid #ccc; margin-bottom: 5px; cursor: pointer; background: #fafafa; }
    .video-container { display: flex; flex-wrap: wrap; gap: 10px; }
    .video-box { width: 400px; height: 300px; background: black; position: relative; }
    .video-name { position: absolute; bottom: 10px; left: 10px; color: #fff; background: rgba(0, 0, 0, 0.5); padding: 5px; border-radius: 4px; }
    #upload_widget_opener { padding: 10px 15px; background-color: #4285f4; color: #fff; border: none; cursor: pointer; margin-bottom: 20px; }
    .image-container { border: 1px solid #ccc; padding: 10px; margin-bottom: 15px; width: 300px; position: relative; }
    .image-container img { max-width: 100%; display: block; }
    .buttons { margin-top: 10px; }
    .buttons button { margin-right: 5px; padding: 5px 8px; }
    .comments { margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 5px; }
    .user-comment { font-size: 0.9em; margin: 3px 0; }
    .upload-video { text-align: center; margin-bottom: 30px; }
    .video-item { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; max-width: 400px; margin: 15px auto; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    video { max-width: 100%; display: block; margin-bottom: 10px; border-radius: 4px; }
    button { margin: 5px 2px; padding: 7px 12px; border: none; border-radius: 4px; background-color: #007bff; color: #fff; cursor: pointer; font-size: 14px; }
    button:hover { background-color: #0056b3; }
    .comments-container { background: #f9f9f9; padding: 5px 10px; margin-top: 10px; max-height: 100px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
    form { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 5px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    label { display: block; margin-top: 10px; }
    .custom-input, .custom-textarea, .custom-select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
    .custom-button { margin-top: 15px; padding: 10px 15px; border: none; background-color: #007bff; color: #fff; cursor: pointer; border-radius: 4px; }
    .custom-button:hover { background-color: #0056b3; }
    .feedback { background: #fff; padding: 15px; margin: 10px auto; max-width: 600px; border-radius: 5px; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); }
    .feedback .meta { font-size: 0.9em; color: #555; }
  </style>
</head>
<body class="theme-default">
  <header>
    <!-- TIÊU ĐỀ ĐÃ THAY ĐỔI -->
    <h1>Chào mừng đến với Thành Phố Giao Tiếp Online</h1>
    <p>Sử dụng các phím mũi tên để di chuyển. Đi vào các tòa nhà để tương tác.</p>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề nhanh</button>
    <div class="nav">
      <!-- Các nút điều hướng NÀY SẼ BỊ VÔ HIỆU HÓA -->
      <button class="nav-btn" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="private-chat-section">Private Chat</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
      <button class="nav-btn" data-target="game-section">Giải trí</button>
      <button class="nav-btn" data-target="profile-section">Hồ sơ</button>
      <button class="nav-btn" data-target="settings-section">Cài đặt</button>
      <button class="nav-btn" data-target="call-section">Call</button>
      <button class="nav-btn" data-target="img-section">Ảnh</button>
      <button class="nav-btn" data-target="video-section">Video</button>
      <button class="nav-btn" data-target="help-section">Help</button>
    </div>
  </header>
  
  <!-- Loading overlay (giữ nguyên) -->
  <div id="loading-overlay" class="loading-overlay"> ... </div>
  
  <!-- Toast Container (giữ nguyên) -->
  <div id="toast-container"></div>
  
  <!-- Login Section (giữ nguyên, đây là cửa vào thành phố) -->
  <div class="section login-section" id="login-section">
    <h2>Đăng nhập để vào thành phố</h2>
    <!-- (nội dung đăng nhập giữ nguyên) -->
    <div id="login-google">
      <button id="google-login">Đăng nhập với Google</button>
    </div>
    <hr>
    <div id="login-email">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="email-login">Đăng nhập/Đăng ký với Email</button>
    </div>
    <hr>
    <div id="login-phone">
      <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
      <div id="recaptcha-container"></div>
      <button id="send-otp">Gửi OTP</button><br>
      <input type="text" id="otp-code" placeholder="Nhập OTP">
      <button id="verify-otp">Xác thực OTP</button>
    </div>
  </div>

  <!-- THẾ GIỚI GAME MỚI -->
  <div id="game-container" style="display: none;"> <!-- Ban đầu ẩn, chỉ hiện khi đã đăng nhập -->
      <div id="city-game-world">
          <!-- Các tòa nhà tương ứng với các section -->
          <div class="building" id="building-forum">Forum</div>
          <div class="building" id="building-social">Social Cafe</div>
          <div class="building" id="building-game">Arcade</div>
          <div class="building" id="building-call">Call Center</div>
          <div class="building" id="building-img">Art Gallery</div>
          <div class="building" id="building-video">Cinema</div>
          <div class="building" id="building-help">Help Desk</div>
          <!-- Avatar người chơi sẽ được thêm vào đây bằng JS -->
      </div>
  </div>

  <!-- TOÀN BỘ CÁC SECTION CŨ SẼ TRỞ THÀNH MODAL -->
  <!-- Thêm class section-modal và nút đóng cho mỗi section -->
  
  <!-- Chat Section (Modal) -->
  <div class="section chat-section section-modal" id="chat-section">
    <button class="close-modal-btn" data-target="chat-section">X</button>
    <h2>Phòng Chat Chung</h2>
    <!-- Nội dung chat giữ nguyên -->
    <div class="nickname-section"><input type="text" id="nickname" placeholder="Nhập nickname của bạn..."><button id="set-nickname-btn">Đổi Nickname</button></div>
    <div id="presence-list"><h3>Người trực tuyến:</h3><ul id="online-users-list"></ul><h4>Khung Chat Chung</h4></div>
    <div id="chat-window"></div>
    <div class="chat-input"><input type="text" id="message-input" placeholder="Nhập tin nhắn..."><button id="send-btn">Gửi</button><button id="upload-chat-btn">Upload Image</button></div>
  </div>
  
  <!-- Forum Section (Modal) -->
  <div class="section forum-section section-modal" id="forum-section">
    <button class="close-modal-btn" data-target="forum-section">X</button>
    <h2>Forum (Tòa Thị Chính)</h2>
    <!-- Nội dung forum giữ nguyên -->
    <div class="forum-input"><textarea id="forum-message" placeholder="Viết nội dung forum..."></textarea><button id="submit-forum-btn">Đăng bài</button><button id="upload-forum-btn">Upload Image</button></div>
    <div id="forum-posts"></div>
  </div>
  
  <!-- Private Chat Section (Modal) -->
  <div class="section private-chat-section section-modal" id="private-chat-section">
     <button class="close-modal-btn" data-target="private-chat-section">X</button>
    <h2>Private Chat</h2>
    <!-- Nội dung private chat giữ nguyên -->
     <div class="private-chat-input"><input type="text" id="pm-recipient" placeholder="Người nhận (nickname)"><input type="text" id="pm-message" placeholder="Nhập tin nhắn riêng..."><button id="send-pm-btn">Gửi tin riêng</button><button id="upload-pm-btn">Upload Image</button></div>
    <div id="pm-chat-window" style="min-height:300px; overflow-y:auto;"></div>
  </div>
  
  <!-- Social Network Section (Modal) -->
  <div class="section social-network-section section-modal" id="social-section">
     <button class="close-modal-btn" data-target="social-section">X</button>
    <h2>Mạng Xã Hội (Social Cafe)</h2>
     <!-- Nội dung social giữ nguyên -->
    <div class="social-input"><textarea id="social-message" placeholder="Chia sẻ điều gì đó..."></textarea><button id="submit-social-btn">Đăng</button><button id="upload-social-btn">Upload Image</button></div>
    <div id="social-posts"></div>
  </div>
  
  <!-- Game Section (Modal) -->
  <div class="section game-section section-modal" id="game-section">
    <button class="close-modal-btn" data-target="game-section">X</button>
    <h2>Giải Trí (Arcade)</h2>
    <!-- Nội dung game giữ nguyên -->
     <p>Bạn có thể chơi trò chơi bên dưới hoặc click vào đường link để mở cửa sổ trò chơi.</p><div class="game-container"><iframe src="https://drasaclone.github.io/Web/gamelite.html"></iframe></div><p>Nếu máy có hiệu năng cao, hãy <a href="https://drasaclone.github.io/Web/gametest.html" target="_blank">click vào đây</a>.</p><h5>Nhạc Youtube</h5><iframe width="280" height="160" src="https://www.youtube.com/embed/YobMVDtVjrI?si=GTYmlBiRpCduPWfO" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
  </div>

    <!-- Call Section (Modal) -->
  <div class="section call-section section-modal" id="call-section">
      <button class="close-modal-btn" data-target="call-section">X</button>
      <h2>Call Center</h2>
      <!-- Nội dung call giữ nguyên -->
      <div class="container">...</div>
  </div>

  <!-- Image Section (Modal) -->
  <div class="section img-section section-modal" id="img-section">
      <button class="close-modal-btn" data-target="img-section">X</button>
      <h2>Art Gallery</h2>
      <!-- Nội dung img giữ nguyên -->
      <h1>Trang Ảnh</h1><button id="upload_widget_opener">Upload Ảnh</button><div id="images_section"></div>
  </div>
    
  <!-- Video Section (Modal) -->
  <div class="section video-section section-modal" id="video-section">
      <button class="close-modal-btn" data-target="video-section">X</button>
      <h2>Cinema</h2>
      <!-- Nội dung video giữ nguyên -->
      <h1>Trang Video</h1><div class="upload-video"><input type="file" id="videoFile" accept="video/*"><br><br><button id="uploadButton">Upload Video</button></div><div id="videoContainer"></div>
  </div>

  <!-- Help Section (Modal) -->
  <div class="section help-section section-modal" id="help-section">
      <button class="close-modal-btn" data-target="help-section">X</button>
      <h2>Help Desk</h2>
       <!-- Nội dung help giữ nguyên -->
      <h1>Trang Đánh Giá, Feedback & Q&A</h1><form id="userFeedbackForm">...</form><h2>Tất cả đánh giá và câu hỏi</h2><div id="feedbackContainer"></div>
  </div>

  <!-- Profile & Settings luôn có thể truy cập -->
  <div class="section profile-section section-modal" id="profile-section"> ... </div>
  <div class="section settings-section section-modal" id="settings-section"> ... </div>
  
  <!-- Plugin Facebook (giữ nguyên) -->
  <div class="fb-comments-container">
    <div id="fb-root"></div>
    <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="600" data-numposts="100"></div>
  </div>
  
  <!-- Scripts -->
  <script>
    // =========================================================
    // PHẦN MÃ JAVASCRIPT CŨ - GIỮ NGUYÊN HOÀN TOÀN
    // =========================================================
    /* -------------------- HÀM HỖ TRỢ -------------------- */
    function sanitize(str) { /* ... giữ nguyên ... */ }
    function showToast(message) { /* ... giữ nguyên ... */ }
    function formatTime(timestamp) { /* ... giữ nguyên ... */ }
    function logEvent(eventType, details) { /* ... giữ nguyên ... */ }
    /* ... (Toàn bộ các hàm và event listener cũ) ... */
    // ...
    // ... (Rất nhiều code cũ ở đây, được giữ nguyên)
    // ...
    //======================= KẾT THÚC PHẦN CODE CŨ =========================
  </script>

  <script>
    // =================================================================
    // PHẦN MÃ JAVASCRIPT MỚI - LOGIC CHO GAME THÀNH PHỐ
    // =================================================================
    const gameContainer = document.getElementById('game-container');
    const world = document.getElementById('city-game-world');
    const loginSection = document.getElementById('login-section');
    const playersRef = firebase.database().ref('players');
    
    let localPlayer = {
        id: null,
        el: null,
        x: 50,
        y: 50,
        nickname: "Anonymous"
    };

    let allPlayers = {};
    const movementSpeed = 10;
    
    // Ánh xạ ID tòa nhà với ID section tương ứng
    const buildingMapping = {
        'building-forum': 'forum-section',
        'building-social': 'social-section',
        'building-game': 'game-section',
        'building-call': 'call-section',
        'building-img': 'img-section',
        'building-video': 'video-section',
        'building-help': 'help-section',
    };

    function initGame() {
        // Ẩn form login, hiện thế giới game
        loginSection.style.display = 'none';
        gameContainer.style.display = 'block';

        // Mở sẵn khung chat chung
        document.getElementById('chat-section').style.display = 'block';

        // Lấy thông tin người dùng hiện tại
        const user = firebase.auth().currentUser;
        if (!user) {
            console.error("Lỗi: Không tìm thấy người dùng đã đăng nhập để bắt đầu game.");
            return;
        }
        localPlayer.id = user.uid;
        localPlayer.nickname = window.userNickname || user.displayName || user.email || 'Player';
        
        // Tạo avatar cho người chơi cục bộ
        createPlayerAvatar(localPlayer.id, localPlayer.nickname, true);
        localPlayer.el = document.getElementById(`player-${localPlayer.id}`);
        
        // Lưu trạng thái online và vị trí ban đầu vào Firebase
        const playerRef = playersRef.child(localPlayer.id);
        playerRef.set({
            id: localPlayer.id,
            nickname: localPlayer.nickname,
            x: localPlayer.x,
            y: localPlayer.y
        });
        
        // Thiết lập tự động xóa khi mất kết nối
        playerRef.onDisconnect().remove();

        // Lắng nghe di chuyển từ bàn phím
        document.addEventListener('keydown', handleKeyPress);
        
        // Lắng nghe sự thay đổi của những người chơi khác
        playersRef.on('child_added', (snapshot) => {
            const newPlayer = snapshot.val();
            if (newPlayer.id !== localPlayer.id) {
                allPlayers[newPlayer.id] = newPlayer;
                createPlayerAvatar(newPlayer.id, newPlayer.nickname, false);
            }
        });
        
        playersRef.on('child_changed', (snapshot) => {
            const updatedPlayer = snapshot.val();
            if (updatedPlayer.id !== localPlayer.id && allPlayers[updatedPlayer.id]) {
                allPlayers[updatedPlayer.id] = updatedPlayer;
                const playerEl = document.getElementById(`player-${updatedPlayer.id}`);
                playerEl.style.left = `${updatedPlayer.x}px`;
                playerEl.style.top = `${updatedPlayer.y}px`;
            }
        });
        
        playersRef.on('child_removed', (snapshot) => {
            const removedPlayerId = snapshot.key;
            if (removedPlayerId !== localPlayer.id && allPlayers[removedPlayerId]) {
                const playerEl = document.getElementById(`player-${removedPlayerId}`);
                if (playerEl) {
                    playerEl.remove();
                }
                delete allPlayers[removedPlayerId];
            }
        });

        // Thêm sự kiện cho các nút đóng modal
        document.querySelectorAll('.close-modal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.getAttribute('data-target');
                document.getElementById(targetId).style.display = 'none';
            });
        });
    }

    function createPlayerAvatar(playerId, nickname, isLocal) {
        const avatar = document.createElement('div');
        avatar.id = `player-${playerId}`;
        avatar.className = isLocal ? 'player-avatar' : 'player-avatar other-player';

        const nameLabel = document.createElement('div');
        nameLabel.className = 'nickname-label';
        nameLabel.innerText = nickname;
        avatar.appendChild(nameLabel);
        
        world.appendChild(avatar);
    }
    
    function handleKeyPress(e) {
        const worldBounds = world.getBoundingClientRect();
        let newX = localPlayer.x;
        let newY = localPlayer.y;

        switch (e.key) {
            case "ArrowUp": newY -= movementSpeed; break;
            case "ArrowDown": newY += movementSpeed; break;
            case "ArrowLeft": newX -= movementSpeed; break;
            case "ArrowRight": newX += movementSpeed; break;
            default: return;
        }

        // Kiểm tra va chạm với biên
        if (newX < 0) newX = 0;
        if (newY < 0) newY = 0;
        if (newX > worldBounds.width - 30) newX = worldBounds.width - 30;
        if (newY > worldBounds.height - 30) newY = worldBounds.height - 30;

        // Cập nhật vị trí
        localPlayer.x = newX;
        localPlayer.y = newY;
        
        // Cập nhật DOM
        localPlayer.el.style.left = `${localPlayer.x}px`;
        localPlayer.el.style.top = `${localPlayer.y}px`;
        
        // Cập nhật vị trí lên Firebase
        playersRef.child(localPlayer.id).update({ x: localPlayer.x, y: localPlayer.y });
        
        // Kiểm tra va chạm với tòa nhà
        checkBuildingCollision();
    }

    let currentBuilding = null;
    function checkBuildingCollision() {
        const playerRect = localPlayer.el.getBoundingClientRect();
        let inBuilding = false;

        for (const buildingId in buildingMapping) {
            const buildingEl = document.getElementById(buildingId);
            const buildingRect = buildingEl.getBoundingClientRect();
            
            // Kiểm tra va chạm (overlap)
            if (!(playerRect.right < buildingRect.left || 
                  playerRect.left > buildingRect.right || 
                  playerRect.bottom < buildingRect.top || 
                  playerRect.top > buildingRect.bottom)) 
            {
                // Nếu người chơi đi vào một tòa nhà MỚI
                if (currentBuilding !== buildingId) {
                    currentBuilding = buildingId;
                    const sectionId = buildingMapping[buildingId];
                    // Hiển thị section tương ứng
                    document.getElementById(sectionId).style.display = 'block';
                    showToast(`Bạn đã vào ${buildingEl.innerText}!`);
                }
                inBuilding = true;
                break; // Thoát vòng lặp khi tìm thấy va chạm
            }
        }
        
        // Nếu không ở trong tòa nhà nào
        if (!inBuilding) {
            currentBuilding = null;
        }
    }

    // Ghi đè hàm cũ onAuthStateChanged
    firebase.auth().onAuthStateChanged(function(user) {
      if (user) {
        // Nếu người dùng đăng nhập, bắt đầu game
        initGame();
        // Cập nhật các section khác
        updateProfileSection();
      } else {
        // Nếu chưa đăng nhập, hiển thị form
        loginSection.style.display = 'block';
        gameContainer.style.display = 'none';
        console.log("Người dùng đã đăng xuất hoặc chưa đăng nhập.");
      }
    });

    // Vô hiệu hóa logic chuyển trang cũ
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
          e.preventDefault();
          showToast('Hãy đi bộ đến các tòa nhà để sử dụng chức năng này!');
          
          // Mở modal tương ứng khi click vào nav cũ để tiện lợi
          const targetId = this.getAttribute('data-target');
          if (document.getElementById(targetId)) {
            document.getElementById(targetId).style.display = 'block';
          }
      });
    });

    /* GHI ĐÈ một vài hàm cũ để tương thích với game */
    function showLoadingTransition(callback) {
      // Bỏ hiệu ứng loading khi chuyển trang vì giờ đây không chuyển trang nữa
      // chỉ hiển thị modal.
      if (callback) callback();
    }
  </script>
</body>
</html>
