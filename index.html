<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nền tảng Chat Realtime - Phiên bản Nâng Cấp Toàn Diện</title>
  <meta name="description" content="Nền tảng Chat Realtime tích hợp chat, forum, private chat, mạng xã hội và trò chơi với Firebase, PubNub, Cloudinary và Anime.js.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0"></script>
  
  <style>
    /* Các chủ đề giao diện */
    body.theme-default {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    body.theme-light {
      background: #f1f1f1;
      color: #333;
    }
    body.theme-dark {
      background: linear-gradient(135deg, #232526, #414345);
      color: #fff;
    }
    body.theme-colorful {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: #fff;
    }
    
    /* Global Styles */
    body {
      font-family: "Dosis", cursive;
      font-weight: 200;
      margin: 0;
      padding: 0;
      transition: background 0.5s ease, color 0.5s ease;
    }
    header {
      padding: 20px;
    }
    h1, h2, h3 {
      margin-bottom: 10px;
    }
    .theme-switcher, .nav-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: inherit;
      cursor: pointer;
      font-size: 1rem;
    }
    .theme-switcher {
      padding: 8px 16px;
      margin-bottom: 10px;
    }
    .nav {
      margin: 20px 0;
    }
    .nav-btn {
      margin: 0 10px;
      padding: 10px 20px;
    }
    .nav-btn.active {
      background: rgba(255,255,255,0.5);
    }
    
    /* Section chung */
    .section {
      border: 1px solid rgba(255,255,255,0.5);
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .active-page {
      opacity: 1;
    }
    input, button, textarea, select {
      margin: 5px 0;
      padding: 5px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
    }
    input, textarea, select {
      width: 80%;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 2rem;
      color: #000;
      display: none;
    }
    .progress-circle {
      width: 150px;
      height: 150px;
      position: relative;
    }
    .progress-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    .progress-circle circle {
      fill: none;
      stroke-width: 12px;
      stroke-linecap: round;
    }
    .progress-circle .bg {
      stroke: #eee;
    }
    .progress-circle .progress {
      stroke: #4caf50;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 1s ease-out;
    }
    .progress-circle .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* Chat Window (màu chữ thay đổi thành đen) */
    #chat-window {
      border: 1px solid rgba(255,255,255,0.5);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }
    #chat-window .message,
    #chat-window .system-message {
      color: #000 !important;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-break: break-word;
    }
    .message.mine {
      align-self: flex-end;
      background-color: #a8e6cf;
      text-align: right;
    }
    .message.other {
      align-self: flex-start;
      background-color: #81d4fa;
      text-align: left;
    }
    .system-message {
      align-self: center;
      background-color: #ffe082;
      color: #333;
      font-style: italic;
      padding: 5px;
      border-radius: 5px;
      max-width: 70%;
      margin: 10px auto;
    }
    
    /* Card cho Forum & Social Posts */
    .post-card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: left;
    }
    .post-card img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    .like-btn, .show-comment-btn, .submit-comment-btn,
    .social-like-btn, .social-show-comment-btn, .social-submit-comment-btn {
      margin: 5px 2px;
      padding: 5px 10px;
      font-size: 0.9rem;
      border-radius: 5px;
      cursor: pointer;
    }
    .comment-section, .social-comment-section {
      margin-top: 10px;
      background: rgba(0,0,0,0.2);
      padding: 5px;
      border-radius: 5px;
    }
    .comment, .social-comment {
      margin: 5px 0;
      font-size: 0.9rem;
      padding: 5px;
      border-bottom: 1px dotted #ccc;
    }
    
    /* PHẦN PRIVATE CHAT: Danh sách người dùng có presence và typing */
    #private-chat-user-list {
      margin-bottom: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 5px;
    }
    .private-chat-user-item {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    .private-chat-user-item:hover {
      background: rgba(0,0,0,0.1);
    }
    /* Đồng thời hiển thị tên user hiện chọn để chat riêng */
    #private-chat-selected-indicator {
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    /* PHẦN TRÒ CHƠI: Hiển thị nút chuyển hướng sang các web trò chơi */
    .game-buttons button {
      margin: 5px;
      padding: 8px 16px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
    }
    
    /* Facebook comments container */
    .fb-comments-container {
      border: 2px solid #ffffff;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      margin: 20px auto;
      max-width: 600px;
      color: #000;
    }
    
    /* Toast Notifications */
    #toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 2000;
    }
    .toast {
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 10px 20px;
      margin-top: 10px;
      border-radius: 5px;
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    .toast.hide {
      opacity: 0;
    }
  </style>
</head>
<body class="theme-default">
  <header>
    <h1>Nền tảng Chat Realtime</h1>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề nhanh</button>
    <div class="nav">
      <!-- Các nút định hướng -->
      <button class="nav-btn active" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="private-chat-section">Private Chat</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
      <button class="nav-btn" data-target="game-section">Trò chơi</button>
      <button class="nav-btn" data-target="profile-section">Hồ sơ</button>
      <button class="nav-btn" data-target="settings-section">Cài đặt</button>
    </div>
  </header>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <h1>Loading...</h1>
    <div class="progress-circle" data-percentage="75">
      <svg viewBox="0 0 150 150">
        <circle class="bg" cx="75" cy="75" r="70"></circle>
        <circle class="progress" cx="75" cy="75" r="70"></circle>
      </svg>
      <div class="percentage">100%</div>
    </div>
  </div>
  
  <!-- Toast Container -->
  <div id="toast-container"></div>
  
  <!-- Login Section -->
  <div class="section login-section" id="login-section">
    <h2>Đăng nhập</h2>
    <!-- Đăng nhập bằng Google -->
    <div id="login-google">
      <button id="google-login">Đăng nhập với Google</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Email -->
    <div id="login-email">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="email-login">Đăng nhập/Đăng ký với Email</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Số điện thoại -->
    <div id="login-phone">
      <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
      <div id="recaptcha-container"></div>
      <button id="send-otp">Gửi OTP</button><br>
      <input type="text" id="otp-code" placeholder="Nhập OTP">
      <button id="verify-otp">Xác thực OTP</button>
    </div>
  </div>
  
  <!-- Chat Section -->
  <div class="section chat-section active-page" id="chat-section">
    <h2>Phòng Chat</h2>
    <div class="nickname-section">
      <input type="text" id="nickname" placeholder="Nhập nickname của bạn...">
      <button id="set-nickname-btn">Đổi Nickname</button>
    </div>
    <div id="presence-list">
      <h3>Người trực tuyến:</h3>
      <ul id="online-users-list"></ul>
    </div>
    <div id="chat-window"></div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
      <button id="send-btn">Gửi</button>
      <button id="upload-chat-btn">Upload Image</button>
    </div>
  </div>
  
  <!-- Forum Section -->
  <div class="section forum-section" id="forum-section" style="display: none;">
    <h2>Forum</h2>
    <div class="forum-input">
      <textarea id="forum-message" placeholder="Viết nội dung forum..."></textarea>
      <button id="submit-forum-btn">Đăng bài</button>
      <button id="upload-forum-btn">Upload Image</button>
    </div>
    <div id="forum-posts"></div>
  </div>
  
  <!-- Private Chat Section -->
  <div class="section private-chat-section" id="private-chat-section" style="display: none;">
    <h2>Private Chat</h2>
    <!-- Danh sách người dùng có presence (green/red) và typing indicator -->
    <div id="private-chat-user-list"></div>
    <!-- Hiển thị thông tin về người dùng được chọn để chat riêng -->
    <div id="private-chat-selected-indicator"></div>
    <!-- Khu vực lịch sử chat riêng -->
    <div id="pm-chat-window" style="min-height:300px; overflow-y:auto;"></div>
    <div class="private-chat-input">
      <input type="text" id="pm-message" placeholder="Nhập tin nhắn riêng...">
      <button id="send-pm-btn">Gửi tin riêng</button>
      <button id="upload-pm-btn">Upload Image</button>
    </div>
  </div>
  
  <!-- Social Network Section -->
  <div class="section social-network-section" id="social-section" style="display: none;">
    <h2>Mạng Xã Hội</h2>
    <div class="social-input">
      <textarea id="social-message" placeholder="Chia sẻ điều gì đó..."></textarea>
      <button id="submit-social-btn">Đăng</button>
      <button id="upload-social-btn">Upload Image</button>
    </div>
    <div id="social-posts"></div>
  </div>
  
  <!-- Game Section: Các nút chuyển hướng sang web trò chơi -->
  <div class="section game-section" id="game-section" style="display: none;">
    <h2>Trò chơi</h2>
    <div class="game-buttons">
      <button onclick="window.open('https://game1.example.com','_blank')">Game 1</button>
      <button onclick="window.open('https://game2.example.com','_blank')">Game 2</button>
      <button onclick="window.open('https://game3.example.com','_blank')">Game 3</button>
    </div>
  </div>
  
  <!-- Profile Section -->
  <div class="section profile-section" id="profile-section" style="display: none;">
    <h2>Hồ sơ</h2>
    <div id="profile-info">
      <p>Chưa có thông tin, vui lòng đăng nhập.</p>
    </div>
    <div id="profile-update">
      <input type="text" id="profile-nickname" placeholder="Nhập nickname mới">
      <button id="update-profile-btn">Cập nhật nickname</button>
    </div>
  </div>
  
  <!-- Settings Section -->
  <div class="section settings-section" id="settings-section" style="display: none;">
    <h2>Cài đặt</h2>
    <label for="theme-select">Chọn chủ đề:</label>
    <select id="theme-select">
      <option value="theme-default">Mặc định</option>
      <option value="theme-light">Sáng</option>
      <option value="theme-dark">Tối</option>
      <option value="theme-colorful">Sắc màu</option>
    </select>
  </div>
  
  <!-- Plugin bình luận Facebook -->
  <div class="fb-comments-container">
    <div id="fb-root"></div>
    <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="600" data-numposts="100"></div>
  </div>
  
  <!-- Scripts -->
  <script>
    // Global variables cho private chat
    var currentPrivateChatUser = null; // uid của người dùng được chọn để chat riêng
    var currentUser = null; // thông tin người dùng hiện tại sau khi đăng nhập
    var currentConversationListener = null; // dùng để gỡ listener khi đổi private chat
    var typingTimeout; // dùng để debounce update typing
    
    /* -------------------- HÀM HỖ TRỢ -------------------- */
    // Saniize đầu vào
    function sanitize(str) {
      var temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }
    
    // Hệ thống Toast thông báo
    function showToast(message) {
      const container = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add("hide");
        toast.addEventListener("transitionend", () => {
          toast.remove();
        });
      }, 3000);
    }
    
    // Format thời gian
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleString();
    }
    
    // Ghi log hành động vào node "logs"
    function logEvent(eventType, details) {
      var logObj = {
        eventType: eventType,
        details: details,
        timestamp: Date.now(),
        user: currentUser 
              ? (currentUser.displayName || currentUser.email)
              : "Anonymous"
      };
      firebase.database().ref('logs').push(logObj);
    }
    
    /* -------------------- CẤU HÌNH FIREBASE -------------------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    
    /* -------------------- KHỞI TẠO PUBNUB -------------------- */
    var pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });
    
    pubnub.subscribe({
      channels: ['chat'],
      withPresence: true
    });
    
    pubnub.addListener({
      message: function(event) {
        var message = event.message;
        if(message.private) {
          appendPrivateMessage(message);
        } else {
          appendMessage(message);
        }
      },
      presence: function(event) {
        // Ví dụ: hiển thị thông báo online/offline
        if(event.action === "join") {
          appendSystemMessage(sanitize(event.uuid) + " đã online");
        } else if(event.action === "leave" || event.action === "timeout") {
          appendSystemMessage(sanitize(event.uuid) + " đã offline");
        }
      }
    });
    
    /* -------------------- HIỆU ỨNG TRÊN PAGE LOAD -------------------- */
    document.addEventListener("DOMContentLoaded", function() {
      anime({
        targets: '#login-section',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 5000,
        easing: 'easeOutExpo'
      });
      anime({
        targets: '.active-page',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        delay: 1000,
        easing: 'easeOutExpo'
      });
      showAlert();
    });
    
    /* -------------------- CHUYỂN ĐỔI GIỮA CÁC TRANG -------------------- */
    var navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var targetId = this.getAttribute('data-target');
        showLoadingTransition(function() {
          document.querySelectorAll('.chat-section, .forum-section, .private-chat-section, .social-network-section, .game-section, .profile-section, .settings-section')
            .forEach(function(section) {
              section.style.display = "none";
              section.classList.remove('active-page');
            });
          navButtons.forEach(function(b) { b.classList.remove('active'); });
          var targetSection = document.getElementById(targetId);
          targetSection.style.display = "block";
          targetSection.classList.add('active-page');
          anime({
            targets: '#' + targetId,
            opacity: [0, 1],
            translateY: [20, 0],
            duration: 500,
            easing: 'easeOutExpo'
          });
          btn.classList.add('active');
          if(targetId === "profile-section") updateProfileSection();
        });
      });
    });
    
    function showLoadingTransition(callback) {
      var overlay = document.getElementById("loading-overlay");
      overlay.style.display = "flex";
      var randomTransition = Math.floor(Math.random() * 3);
      switch(randomTransition) {
        case 0:
          anime({
            targets: overlay,
            opacity: [0, 1],
            scale: [0.5, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 1:
          anime({
            targets: overlay,
            translateY: [-100, 0],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  translateY: [0, 100],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 2:
          anime({
            targets: overlay,
            rotate: ['0deg', '360deg'],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  rotate: ['360deg', '720deg'],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
      }
    }
    
    /* -------------------- XỬ LÝ TIN NHẮN PUBLIC -------------------- */
    function appendMessage(message) {
      var senderName = sanitize(message.sender);
      var chatWindow = document.getElementById("chat-window");
      var msgDiv = document.createElement("div");
      var myIdentifier = window.userNickname || (currentUser ? (currentUser.displayName || currentUser.email) : "Anonymous");
      var messageClass = (senderName === myIdentifier) ? "mine" : "other";
      msgDiv.className = "message " + messageClass;
      var content = "<strong>" + senderName + ":</strong><br>" + sanitize(message.text || "");
      if (message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if (message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({
        targets: msgDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    function appendSystemMessage(text) {
      var chatWindow = document.getElementById("chat-window");
      var sysDiv = document.createElement("div");
      sysDiv.className = "system-message";
      sysDiv.innerHTML = sanitize(text);
      chatWindow.appendChild(sysDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({
        targets: sysDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    /* -------------------- XỬ LÝ PRIVATE CHAT -------------------- */
    // Hàm hiển thị tin nhắn private chat
    function appendPrivateMessage(message) {
      var pmWindow = document.getElementById("pm-chat-window");
      var msgDiv = document.createElement("div");
      msgDiv.className = "message";
      var content = "<strong>" + sanitize(message.sender) + " (riêng):</strong><br>" + sanitize(message.text || "");
      if(message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if(message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      pmWindow.appendChild(msgDiv);
      pmWindow.scrollTop = pmWindow.scrollHeight;
      anime({
        targets: msgDiv,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    // Hàm load lịch sử private chat của một cuộc trò chuyện (dựa trên convId)
    function loadPrivateChat(convId) {
      // Xóa nội dung cũ
      document.getElementById("pm-chat-window").innerHTML = "";
      // Nếu có listener trước đó, gỡ bỏ nó
      if(currentConversationListener) {
        currentConversationListener.off();
      }
      currentConversationListener = firebase.database().ref("privateChats/" + convId);
      currentConversationListener.on("child_added", function(snapshot) {
        var message = snapshot.val();
        appendPrivateMessage(message);
      });
    }
    
    // Hàm chọn người dùng để chat riêng
    function selectPrivateChat(uid) {
      currentPrivateChatUser = uid;
      // Hiển thị tên người dùng được chọn và cập nhật typing indicator nếu có
      firebase.database().ref("users/" + uid).once("value").then(function(snapshot) {
        var userData = snapshot.val();
        var indicator = "";
        if(userData.typing) {
          indicator = " (Đang nhập...)";
        }
        document.getElementById("private-chat-selected-indicator").innerHTML = userData.displayName + indicator;
      });
      
      // Xác định convId dựa trên uid hiện tại và người được chọn
      if(currentUser) {
        var convId = (currentUser.uid < uid)
                    ? currentUser.uid + "_" + uid
                    : uid + "_" + currentUser.uid;
        loadPrivateChat(convId);
      }
    }
    
    // Cập nhật danh sách người dùng trong Private Chat (hiển thị presence)
    firebase.database().ref("users").on("value", function(snapshot) {
      let userListHTML = "";
      snapshot.forEach(function(childSnapshot) {
        var userData = childSnapshot.val();
        var uid = childSnapshot.key;
        // Hiển thị: chấm xanh nếu online, đỏ nếu offline; nếu typing → chữ "Đang nhập..."
        var dotColor = userData.status === "online" ? "green" : "red";
        userListHTML += `<div class="private-chat-user-item" data-uid="${uid}" onclick="selectPrivateChat('${uid}')">`;
        userListHTML += `<span style="display:inline-block; width:10px; height:10px; background:${dotColor}; border-radius:50%; margin-right:5px;"></span>`;
        userListHTML += userData.displayName;
        if(userData.typing) {
          userListHTML += ` <span style="font-size:0.8rem; color:blue;">Đang nhập...</span>`;
        }
        userListHTML += `</div>`;
      });
      document.getElementById("private-chat-user-list").innerHTML = userListHTML;
    });
    
    // Khi người dùng đang gõ tin nhắn trong private chat, cập nhật trạng thái typing
    document.getElementById("pm-message").addEventListener("input", function() {
      if(currentUser) {
        firebase.database().ref("users/" + currentUser.uid).update({ typing: true });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(function(){
          firebase.database().ref("users/" + currentUser.uid).update({ typing: false });
        }, 1000);
      }
    });
    
    // Gửi tin nhắn private chat
    document.getElementById("send-pm-btn").addEventListener("click", function() {
      if(!currentPrivateChatUser) {
        showToast("Vui lòng chọn người dùng để chat riêng!");
        return;
      }
      var input = document.getElementById("pm-message");
      var text = input.value.trim();
      if(text === "") return;
      if(currentUser) {
        var senderName = currentUser.displayName || currentUser.email;
        // Xác định convId
        var convId = (currentUser.uid < currentPrivateChatUser)
                    ? currentUser.uid + "_" + currentPrivateChatUser
                    : currentPrivateChatUser + "_" + currentUser.uid;
        var message = { sender: senderName, text: text, timestamp: Date.now() };
        firebase.database().ref("privateChats/" + convId).push(message);
        input.value = "";
        firebase.database().ref("users/" + currentUser.uid).update({ typing: false });
        logEvent("private-chat-send", "Gửi tin private chat: " + text);
      }
    });
    
    // Upload image cho private chat
    document.getElementById("upload-pm-btn").addEventListener("click", function() {
      if(!currentPrivateChatUser) {
        showToast("Vui lòng chọn người dùng để chat riêng!");
        return;
      }
      cloudinary.createUploadWidget({
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        }, function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            if(currentUser) {
              var senderName = currentUser.displayName || currentUser.email;
              var convId = (currentUser.uid < currentPrivateChatUser)
                          ? currentUser.uid + "_" + currentPrivateChatUser
                          : currentPrivateChatUser + "_" + currentUser.uid;
              var message = { sender: senderName, image: url, timestamp: Date.now() };
              firebase.database().ref("privateChats/" + convId).push(message);
              logEvent("private-chat-upload", "Upload image cho private chat: " + url);
            }
          }
        }).open();
    });
    
    /* -------------------- XỬ LÝ SOCIAL NETWORK -------------------- */
    function updateSocialPostLike(postId) {
      firebase.database().ref("socialPosts/" + postId + "/likeCount").transaction(function(currentLikes) {
        return (currentLikes || 0) + 1;
      });
    }
    
    document.getElementById("submit-social-btn").addEventListener("click", function() {
      var socialMsg = document.getElementById("social-message").value.trim();
      if(socialMsg === "") return;
      var senderName = window.userNickname || "Anonymous";
      var socialPost = { sender: senderName, text: socialMsg, timestamp: Date.now(), likeCount: 0 };
      firebase.database().ref('socialPosts').push(socialPost);
      document.getElementById("social-message").value = "";
      logEvent("social-post", "Đăng bài xã hội: " + socialMsg);
    });
    
    document.getElementById("upload-social-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget({
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        }, function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var socialMsgField = document.getElementById("social-message");
            socialMsgField.value = socialMsgField.value + " <img src='" + url + "' alt='Image'/>";
            logEvent("social-upload", "Upload image cho social: " + url);
          }
        }).open();
    });
    
    firebase.database().ref('socialPosts').on('child_added', function(snapshot) {
      var postKey = snapshot.key;
      var post = snapshot.val();
      if(typeof post.likeCount === "undefined") post.likeCount = 0;
      var socialPostsDiv = document.getElementById('social-posts');
      var postDiv = document.createElement('div');
      postDiv.className = "post-card";
      postDiv.id = "social-post-" + postKey;
      var content = "<strong>" + sanitize(post.sender) + ":</strong><br>" + sanitize(post.text || "");
      if(post.image) {
        content += "<br><img src='" + post.image + "' alt='Social Post Image'/>";
      }
      if(post.timestamp) {
        content += "<br><small>" + formatTime(post.timestamp) + "</small>";
      }
      content += "<br><button class='social-like-btn' data-post-id='" + postKey + "'>Like (<span class='social-like-count'>" + post.likeCount + "</span>)</button>";
      content += " <button class='social-show-comment-btn' data-post-id='" + postKey + "'>Show Comments</button>";
      content += "<div class='social-comment-section' id='social-comment-section-" + postKey + "' style='display:none;'>";
      content += "<input type='text' class='social-comment-input' placeholder='Write a comment...'>";
      content += "<button class='social-submit-comment-btn' data-post-id='" + postKey + "'>Comment</button>";
      content += "<div class='social-comment-list' id='social-comment-list-" + postKey + "'></div>";
      content += "</div>";
      postDiv.innerHTML = content;
      socialPostsDiv.appendChild(postDiv);
      attachSocialCommentsListener(postKey);
    });
    
    document.getElementById("social-posts").addEventListener("click", function(e) {
      if(e.target && e.target.classList.contains("social-like-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        updateSocialPostLike(postId);
        logEvent("social-like", "Like bài xã hội " + postId);
      }
      if(e.target && e.target.classList.contains("social-show-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var commentSection = document.getElementById("social-comment-section-" + postId);
        commentSection.style.display = (commentSection.style.display === "none") ? "block" : "none";
      }
      if(e.target && e.target.classList.contains("social-submit-comment-btn")) {
        var postId = e.target.getAttribute("data-post-id");
        var parent = e.target.parentNode;
        var commentInput = parent.querySelector(".social-comment-input");
        var commentText = commentInput.value.trim();
        if(commentText === "") return;
        var commentObj = {
          sender: window.userNickname || (currentUser ? (currentUser.displayName || currentUser.email) : "Anonymous"),
          text: commentText,
          timestamp: Date.now()
        };
        firebase.database().ref("socialComments/" + postId).push(commentObj);
        commentInput.value = "";
        logEvent("social-comment", "Comment bài social " + postId + ": " + commentText);
      }
    });
    
    function attachSocialCommentsListener(postId) {
      firebase.database().ref("socialComments/" + postId).on("child_added", function(snapshot) {
        var comment = snapshot.val();
        var commentListDiv = document.getElementById("social-comment-list-" + postId);
        if(commentListDiv) {
          var commentDiv = document.createElement("div");
          commentDiv.className = "social-comment";
          commentDiv.innerHTML = "<strong>" + sanitize(comment.sender) + ":</strong> " + sanitize(comment.text) +
                                 "<br><small>" + formatTime(comment.timestamp) + "</small>";
          commentListDiv.appendChild(commentDiv);
        }
      });
    }
    
    /* -------------------- PHẦN PROFILE & SETTINGS -------------------- */
    function updateProfileSection() {
      var profileInfoDiv = document.getElementById("profile-info");
      if(currentUser) {
        var infoHTML = "<p><strong>Email:</strong> " + (currentUser.email || "Không có") + "</p>";
        infoHTML += "<p><strong>Tên hiển thị:</strong> " + (currentUser.displayName || "Không có") + "</p>";
        infoHTML += "<p><strong>Nickname:</strong> " + (window.userNickname || "Chưa đặt") + "</p>";
        profileInfoDiv.innerHTML = infoHTML;
      } else {
        profileInfoDiv.innerHTML = "<p>Chưa có thông tin, vui lòng đăng nhập.</p>";
      }
    }
    
    document.getElementById("update-profile-btn").addEventListener("click", function() {
      var newNickname = document.getElementById("profile-nickname").value.trim();
      if(newNickname === "") return;
      window.userNickname = newNickname;
      showToast("Nickname đã được cập nhật: " + newNickname);
      updateProfileSection();
      pubnub.subscribe({ channels: ["pm-" + newNickname] });
      logEvent("profile-update", "Cập nhật nickname: " + newNickname);
    });
    
    document.getElementById("theme-select").addEventListener("change", function() {
      var selectedTheme = this.value;
      document.body.className = selectedTheme;
    });
    
    document.getElementById("theme-switcher").addEventListener("click", function() {
      var themeSelect = document.getElementById("theme-select");
      var nextThemeIndex = (themeSelect.selectedIndex + 1) % themeSelect.options.length;
      themeSelect.selectedIndex = nextThemeIndex;
      document.body.className = themeSelect.value = themeSelect.options[nextThemeIndex].value;
    });
    
    /* -------------------- PHẦN ĐĂNG NHẬP -------------------- */
    firebase.auth().onAuthStateChanged(function(user) {
      if(user) {
        currentUser = user;
        // Cập nhật thông tin người dùng trong node "users"
        var userRef = firebase.database().ref("users/" + user.uid);
        userRef.set({
          displayName: user.displayName || user.email,
          status: "online",
          typing: false
        });
        userRef.onDisconnect().update({ status: "offline", typing: false });
      }
      updateProfileSection();
    });
    
    document.getElementById("google-login").addEventListener("click", function() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          showToast("Đăng nhập thành công: " + result.user.displayName);
          currentUser = result.user;
          updateProfileSection();
          logEvent("login", "Đăng nhập với Google: " + result.user.displayName);
        })
        .catch(function(error) {
          console.error("Lỗi đăng nhập Google:", error);
          showToast("Lỗi đăng nhập Google: " + error.message);
        });
    });
    
    document.getElementById("email-login").addEventListener("click", function() {
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          showToast("Đăng nhập thành công với Email: " + userCredential.user.email);
          currentUser = userCredential.user;
          updateProfileSection();
          logEvent("login", "Đăng nhập với Email: " + userCredential.user.email);
        })
        .catch(function(error) {
          if (error.code === 'auth/user-not-found') {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then(function(userCredential) {
                showToast("Tạo tài khoản Email thành công: " + userCredential.user.email);
                currentUser = userCredential.user;
                updateProfileSection();
                logEvent("signup", "Tạo tài khoản Email: " + userCredential.user.email);
              })
              .catch(function(error) {
                console.error("Lỗi tạo người dùng Email:", error.message);
                showToast("Lỗi tạo người dùng Email: " + error.message);
              });
          } else {
            console.error("Lỗi đăng nhập Email:", error.message);
            showToast("Lỗi đăng nhập Email: " + error.message);
          }
        });
    });
    
    document.getElementById("send-otp").addEventListener("click", function() {
      var phoneNumber = document.getElementById("phone-number").value;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
      firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
        .then(function(confirmationResult) {
          window.confirmationResult = confirmationResult;
          showToast("OTP đã được gửi đến số điện thoại: " + phoneNumber);
          logEvent("otp-send", "Gửi OTP đến số: " + phoneNumber);
        })
        .catch(function(error) {
          console.error("Lỗi gửi OTP:", error);
          showToast("Lỗi gửi OTP: " + error.message);
        });
    });
    
    document.getElementById("verify-otp").addEventListener("click", function() {
      var otpCode = document.getElementById("otp-code").value;
      window.confirmationResult.confirm(otpCode)
        .then(function(result) {
          showToast("Xác thực số điện thoại thành công: " + result.user.phoneNumber);
          currentUser = result.user;
          updateProfileSection();
          logEvent("otp-verify", "Xác thực OTP thành công cho số: " + result.user.phoneNumber);
        })
        .catch(function(error) {
          console.error("OTP không chính xác:", error);
          showToast("OTP không chính xác: " + error.message);
        });
    });
    
    /* -------------------- THÔNG BÁO -------------------- */
    function showAlert() {
      showToast("Chào bạn! Dự án đang được phát triển nên có thể xảy ra lỗi. Hãy sử dụng một cách văn minh và tích cực. Cảm ơn bạn đã tin dùng dịch vụ của chúng tôi.");
    }
    
    // Loading Animation cho progress-circle
    document.querySelectorAll('.progress-circle').forEach(el => {
      const circle = el.querySelector('.progress');
      const text = el.querySelector('.percentage');
      const radius = circle.getAttribute('r');
      const circumference = 2 * Math.PI * radius;
      const percent = parseInt(el.getAttribute('data-percentage'), 10);
      circle.style.strokeDasharray = `${circumference}`;
      const offset = circumference - (percent / 100) * circumference;
      setTimeout(() => {
        circle.style.strokeDashoffset = offset;
        text.textContent = `${percent}%`;
      }, 100);
    });
    
    // (Có thể bổ sung thêm push notifications, caching offline, ...)
  </script>
</body>
</html>
