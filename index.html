<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nền tảng Chat Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bad+Script&display=swap" rel="stylesheet">

    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>
    <!-- Agora.io SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

  <script async defer crossorigin="anonymous"
  src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0">
</script>
  <style>
    /* Global Styles */
    body {
      font-family: "Bad Script", cursive;
      font-weight: 400;
      font-style: normal;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    
    body.dark-theme {
      background: linear-gradient(135deg, #232526, #414345);
    }
    
    header {
      padding: 20px;
    }
    
    h1 {
      margin-bottom: 10px;
    }
    
    .theme-switcher {
      margin-bottom: 10px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .nav {
      margin: 20px 0;
    }
    
    .nav-btn {
      margin: 0 10px;
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .nav-btn.active {
      background: rgba(255,255,255,0.5);
    }
    
    /* Section common styles */
    .section {
      border: 1px solid rgba(255,255,255,0.5);
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 10px;
      opacity: 0;
    }
    
    .active-page {
      opacity: 1 !important;
    }
    
    input, button {
      margin: 5px 0;
      padding: 5px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
    }
    
    input {
      width: 80%;
    }
    
    #chat-window, #pm-chat-window {
      border: 1px solid rgba(255,255,255,0.5);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(255,255,255,0.1);
      text-align: left;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 2rem;
      color: #000;
      display: none; /* Ẩn ban đầu */
    }
    .progress-circle {
      width: 150px;
      height: 150px;
      position: relative;
    }
    .progress-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    .progress-circle circle {
      fill: none;
      stroke-width: 12;
      stroke-linecap: round;
    }
    .progress-circle .bg {
      stroke: #eee;
    }
    .progress-circle .progress {
      stroke: #4caf50;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 1s ease-out;
    }
    .progress-circle .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: bold;
    }

.message {
  display: inline-block;
  padding: 10px 15px;
  margin: 5px;
  border-radius: 15px;
  max-width: 60%;
}

.message.user {
  background-color: blue;
  color: white;
  text-align: right;
  float: right;
}

.message.other {
  background-color: green;
  color: white;
  text-align: left;
  float: left;
  clear: both;
}

.fb-comments-container {
  border: 2px solid #ffffff;  /* Khung viền trắng */
  padding: 10px;              /* Khoảng đệm để nội dung không sát cạnh */
  background-color: #f9f9f9;  /* Tùy chọn: Màu nền nếu cần */
  border-radius: 5px;         /* Tùy chọn: Bo góc đẹp mắt */
}

      /* Sidebar chứa danh sách người dùng */
      #sidebar {
        width: 25%;
        background-color: #f0f0f0;
        padding: 15px;
        border-right: 1px solid #ccc;
        box-sizing: border-box;
      }
      
      /* Phần chính chứa chat */
      #main {
        width: 75%;
        display: flex;
        flex-direction: column;
        padding: 15px;
        box-sizing: border-box;
      }
      
      /* Khu vực hiển thị tin nhắn */
      #messages {
        flex: 1;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: auto;
        margin-bottom: 15px;
      }
      
      /* Bộ điều khiển chat */
      #chat-controls {
        display: flex;
      }
      #chat-controls input {
        flex: 1;
        padding: 10px;
        font-size: 16px;
      }
      #chat-controls button {
        padding: 10px 15px;
        font-size: 16px;
        margin-left: 5px;
      }
      
      /* Cửa sổ Cài đặt/Tài khoản */
      #settings {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ccc;
        padding: 20px;
        z-index: 1000;
        opacity: 0;
      }
      /* Overlay khi hiển thị Settings */
      #overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 900;
      }


  .user-list {
    list-style: none;
    padding: 0;
  }
  .user-item {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 8px;
    display: inline-block;
  }
  .online {
    background-color: green;
  }
  .offline {
    background-color: red;
  }

  </style>
</head>
<body>
  <header>
    <h1>Nền tảng Chat Realtime</h1>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề</button>
    <div class="nav">
      <button class="nav-btn active" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="threads-section">User List</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
    </div>
  </header>
  
  <!-- Loading overlay cho chuyển tiếp trang -->
  <div id="loading-overlay" class="loading-overlay">
    <h1>Loading...</h1>
          <div class="progress-circle" data-percentage="75">
  <svg viewBox="0 0 150 150">
    <circle class="bg" cx="75" cy="75" r="70"></circle>
    <circle class="progress" cx="75" cy="75" r="70"></circle>
  </svg>
  <div class="percentage">100%</div>
</div>
  </div>
  
  <!-- Login Section -->
  <div class="section login-section" id="login-section">
    <h2>Đăng nhập</h2>
    <!-- Đăng nhập bằng Google -->
    <div id="login-google">
      <button id="google-login">Đăng nhập với Google</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Email -->
    <div id="login-email">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="email-login">Đăng nhập/Đăng ký với Email</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Số điện thoại -->
    <div id="login-phone">
      <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
      <div id="recaptcha-container"></div>
      <button id="send-otp">Gửi OTP</button><br>
      <input type="text" id="otp-code" placeholder="Nhập OTP">
      <button id="verify-otp">Xác thực OTP</button>
    </div>
  </div>
  
  <!-- Chat Section -->
  <div class="section chat-section active-page" id="chat-section">
    <h2>Phòng Chat</h2>
    <div class="nickname-section">
      <input type="text" id="nickname" placeholder="Nhập nickname của bạn...">
      <button id="set-nickname-btn">Đổi Nickname</button>
    </div>
    <div id="presence-list">
      <h3>Người trực tuyến:</h3>
      <ul id="online-users-list"></ul>
    </div>
    <div id="chat-window"></div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
      <button id="send-btn">Gửi</button>
    </div>
    <button id="toggle-pm-btn">Nhắn tin riêng</button>
    <div class="private-msg-section" id="private-msg-section" style="display: none;">
      <h2>Nhắn tin riêng</h2>
      <input type="text" id="pm-recipient" placeholder="Người nhận (nickname)">
      <input type="text" id="pm-message" placeholder="Nhập tin nhắn riêng...">
      <button id="send-pm-btn">Gửi tin riêng</button>
      <div id="pm-chat-window"></div>
    </div>
  </div>
  
  <!-- Forum Section -->
  <div class="section forum-section" id="forum-section" style="display: none;">
    <h2>Forum</h2>
    <div id="forum-content">
      <p>Nội dung forum sẽ được cập nhật ở đây.</p>
    </div>
  </div>
  
  <!-- Threads Section -->
  <div class="section threads-section" id="threads-section" style="display: none;">
    <h2>UserList</h2>
            <!-- Danh sách người dùng sẽ được hiển thị tại đây -->
  <ul id="user-list" class="user-list"></ul>

  <!-- Các phần JavaScript sẽ được chèn phía dưới -->
  </div>
  
  <!-- Social Network Section -->
  <div class="section social-network-section" id="social-section" style="display: none;">
    <h2>Mạng Xã Hội</h2>
    <div id="social-content">
      <p>Chức năng kết nối mạng xã hội sẽ hiển thị ở đây.</p>
    </div>
  </div>
  
  <!-- Plugin bình luận Facebook -->
<div class="fb-comments-container">
  <div id="fb-root"></div>
  <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="600" data-numposts="100"></div>
</div>

  <!-- Scripts -->
  <script>
    /* -------------------- CẤU HÌNH FIREBASE -------------------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();
    
    /* -------------------- KHỞI TẠO PUBNUB -------------------- */
    var pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb',
    });
    
    // Subscribe vào kênh "chat" và lắng nghe sự kiện presence
    pubnub.subscribe({
      channels: ['chat'],
      withPresence: true
    });
    
    pubnub.addListener({
      message: function(event) {
        var message = event.message;
        // Nếu message có thuộc tính private thì hiện tin nhắn riêng, ngược lại hiện tin công khai
        if(message.private){
          appendPrivateMessage(message);
        } else {
          appendMessage(message);
        }
      },
      presence: function(event) {
        // Cập nhật danh sách presence mỗi khi có sự kiện
        updatePresence();
      }
    });
    
    /* -------------------- HIỆU ỨNG TRÊN PAGE LOAD -------------------- */
    window.addEventListener('load', function() {
      // Hiệu ứng fade-in cho login và trang đang hoạt động
      anime({
        targets: '#login-section',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 5000,
        easing: 'easeOutExpo'
      });
      anime({
        targets: '.active-page',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 5000,
        delay: 1000,
        easing: 'easeOutExpo'
      });
    });
    
    /* -------------------- CHUYỂN ĐỔI CHỦ ĐỀ -------------------- */
    document.getElementById("theme-switcher").addEventListener("click", function() {
      document.body.classList.toggle("dark-theme");
    });
    
    /* -------------------- XỬ LÝ ĐĂNG NHẬP -------------------- */
    // Đăng nhập bằng Google
    document.getElementById("google-login").addEventListener("click", function() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          console.log("Đăng nhập thành công:", result.user.displayName);
        })
        .catch(function(error) {
          console.error("Lỗi đăng nhập Google:", error);
        });
    });
    
    // Đăng nhập bằng Email
    document.getElementById("email-login").addEventListener("click", function() {
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          console.log("Đăng nhập thành công với Email:", userCredential.user.email);
        })
        .catch(function(error) {
          if (error.code === 'auth/user-not-found') {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then(function(userCredential) {
                console.log("Tạo tài khoản Email thành công:", userCredential.user.email);
              })
              .catch(function(error) {
                console.error("Lỗi tạo người dùng Email:", error.message);
              });
          } else {
            console.error("Lỗi đăng nhập Email:", error.message);
          }
        });
    });
    
    // Đăng nhập bằng Số điện thoại: Gửi OTP
    document.getElementById("send-otp").addEventListener("click", function() {
      var phoneNumber = document.getElementById("phone-number").value;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
        'size': 'invisible'
      });
      
      firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
        .then(function(confirmationResult) {
          window.confirmationResult = confirmationResult;
          console.log("OTP đã được gửi đến số điện thoại:", phoneNumber);
        })
        .catch(function(error) {
          console.error("Lỗi gửi OTP:", error);
        });
    });
    
    // Xác thực OTP
    document.getElementById("verify-otp").addEventListener("click", function() {
      var otpCode = document.getElementById("otp-code").value;
      window.confirmationResult.confirm(otpCode)
        .then(function(result) {
          console.log("Xác thực số điện thoại thành công:", result.user.phoneNumber);
        })
        .catch(function(error) {
          console.error("OTP không chính xác:", error);
        });
    });
    
    /* -------------------- CHUYỂN ĐỔI GIỮA CÁC TRANG -------------------- */
    var navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var targetId = this.getAttribute('data-target');
        // Hiệu ứng chuyển loading với 3 kiểu ngẫu nhiên
        showLoadingTransition(function() {
          // Ẩn tất cả các trang (chat, forum, threads, social) và xóa active-page
          document.querySelectorAll('.chat-section, .forum-section, .threads-section, .social-network-section').forEach(function(section) {
            section.style.display = "none";
            section.classList.remove('active-page');
          });
          // Xóa active ở các nút
          navButtons.forEach(function(b) { b.classList.remove('active'); });
          // Hiển thị trang đích và thêm active-page
          document.getElementById(targetId).style.display = "block";
          document.getElementById(targetId).classList.add('active-page');
          // Hiệu ứng fade-in cho trang đích
          anime({
            targets: '#' + targetId,
            opacity: [0, 1],
            translateY: [20, 0],
            duration: 500,
            easing: 'easeOutExpo'
          });
          btn.classList.add('active');
        });
      });
    });
    
    function showLoadingTransition(callback) {
      var overlay = document.getElementById("loading-overlay");
      overlay.style.display = "flex";
      // Chọn ngẫu nhiên 1 trong 3 hiệu ứng loading
      var randomTransition = Math.floor(Math.random() * 3);
      switch(randomTransition) {
        case 0:
          anime({
            targets: overlay,
            opacity: [0, 1],
            scale: [0.5, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 1:
          anime({
            targets: overlay,
            translateY: [-100, 0],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  translateY: [0, 100],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 2:
          anime({
            targets: overlay,
            rotate: ['0deg', '360deg'],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  rotate: ['360deg', '720deg'],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
      }
    }
    
    /* -------------------- XỬ LÝ TIN NHẮN & HIỆU ỨNG ANIME -------------------- */
    // Hiển thị tin nhắn công khai
    function appendMessage(message) {
      var chatWindow = document.getElementById("chat-window");
      var p = document.createElement("p");
      p.className = "message";
      p.innerHTML = "<strong>" + message.sender + ":</strong> " + message.text;
      chatWindow.appendChild(p);
      
      chatWindow.scrollTop = chatWindow.scrollHeight;
      
      anime({
        targets: p,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    // Hiển thị tin nhắn riêng
    function appendPrivateMessage(message) {
      var pmWindow = document.getElementById("pm-chat-window");
      var p = document.createElement("p");
      p.className = "message";
      p.innerHTML = "<strong>" + message.sender + " (riêng):</strong> " + message.text;
      pmWindow.appendChild(p);
      
      pmWindow.scrollTop = pmWindow.scrollHeight;
      
      anime({
        targets: p,
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        easing: 'easeOutExpo'
      });
    }
    
    // Gửi tin công khai
    document.getElementById("send-btn").addEventListener("click", function() {
      var input = document.getElementById("message-input");
      var text = input.value.trim();
      if (text === "") return;
      
      var user = firebase.auth().currentUser;
      var senderName = (window.userNickname) ? window.userNickname : (user ? (user.displayName || user.email || user.phoneNumber) : "Anonymous");
      var message = { sender: senderName, text: text };
      
      pubnub.publish({
        channel: 'chat',
        message: message
      });
      
      firebase.database().ref('messages').push(message);
      input.value = "";
    });
    
    // Gửi tin nhắn riêng
    document.getElementById("send-pm-btn").addEventListener("click", function() {
      var recipient = document.getElementById("pm-recipient").value.trim();
      var msg = document.getElementById("pm-message").value.trim();
      if(recipient === "" || msg === "") return;
      
      var senderName = (window.userNickname) ? window.userNickname : "Anonymous";
      var message = { sender: senderName, text: msg, private: true };
      var pmChannel = "pm-" + recipient;
      
      pubnub.publish({
        channel: pmChannel,
        message: message
      });
      
      // Hiển thị tin nhắn riêng của người gửi
      appendPrivateMessage(message);
      document.getElementById("pm-message").value = "";
    });
    
    // Lấy tin nhắn từ Firebase và hiển thị
    firebase.database().ref('messages').on('child_added', function(snapshot) {
      var message = snapshot.val();
      appendMessage(message);
    });
          
    // Phân biệt giữa các người dùng
function appendMessage(message) {
  var chatWindow = document.getElementById("chat-window");
  var p = document.createElement("p");
  
  var user = firebase.auth().currentUser;
  var senderName = message.sender;
  
  p.className = "message " + (senderName === user.displayName ? "user" : "other");
  p.innerHTML = "<strong>" + senderName + ":</strong> " + message.text;
  
  chatWindow.appendChild(p);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  
  anime({
    targets: p,
    opacity: [0, 1],
    translateY: [20, 0],
    duration: 500,
    easing: 'easeOutExpo'
  });
}

    /* -------------------- NICKNAME & PRESENCE -------------------- */
    document.getElementById("set-nickname-btn").addEventListener("click", function() {
      var nickname = document.getElementById("nickname").value.trim();
      if(nickname === "") return;
      window.userNickname = nickname;
      alert("Nickname đã được đặt thành: " + nickname);
      
      // Subscribe vào kênh tin riêng của người dùng
      pubnub.subscribe({
        channels: ["pm-" + nickname]
      });
      updatePresence();
    });
    
    document.getElementById("toggle-pm-btn").addEventListener("click", function() {
      var pmSection = document.getElementById("private-msg-section");
      if(pmSection.style.display === "none") {
        anime({
          targets: pmSection,
          opacity: [0, 1],
          height: ['0px', 'auto'],
          duration: 500,
          easing: 'easeOutExpo',
          begin: function() {
            pmSection.style.display = "block";
          }
        });
      } else {
        anime({
          targets: pmSection,
          opacity: [1, 0],
          height: ['auto', '0px'],
          duration: 500,
          easing: 'easeInExpo',
          complete: function() {
            pmSection.style.display = "none";
          }
        });
      }
    });
    
    // Cập nhật danh sách người trực tuyến sử dụng hereNow của PubNub
    function updatePresence() {
      pubnub.hereNow(
        {
          channels: ['chat'],
          includeUUIDs: true
        },
        function (status, response) {
          var onlineList = document.getElementById("online-users-list");
          onlineList.innerHTML = "";
          if(response.channels.chat && response.channels.chat.occupants){
            response.channels.chat.occupants.forEach(function(occupant) {
              var li = document.createElement("li");
              li.textContent = occupant.uuid;
              onlineList.appendChild(li);
            });
          }
        }
      );
    }
    updatePresence();
// Loading Animation
  document.querySelectorAll('.progress-circle').forEach(el => {
    const circle = el.querySelector('.progress');
    const text = el.querySelector('.percentage');
    const radius = circle.getAttribute('r');
    const circumference = 2 * Math.PI * radius;
    const percent = parseInt(el.getAttribute('data-percentage'), 10);

    circle.style.strokeDasharray = `${circumference}`;
    const offset = circumference - (percent / 100) * circumference;
    setTimeout(() => {
      circle.style.strokeDashoffset = offset;
      text.textContent = `${percent}%`;
    }, 100);
  });
// Private Chat
      pubnub.subscribe({ channels: ['chat'], withPresence: true });
      pubnub.addListener({
        message: function(event) {
          var msg = event.message;
          renderMessage(msg.sender, msg.text);
        },
        presence: function(event) {
          console.log("Presence event:", event);
        }
      });

      /********* Hàm gửi tin nhắn (Firebase & PubNub) *********/
      function sendMessage() {
        var messageInput = document.getElementById("message-input");
        var messageText = messageInput.value;
        if (!messageText) return;
        var messageData = {
          sender: "current-user",  // Có thể thay bằng tên thật sau này
          text: messageText,
          timestamp: Date.now()
        };

        // Lưu tin nhắn vào Firebase
        database.ref("messages").push(messageData);

        // Phát tin nhắn qua PubNub
        pubnub.publish({
          channel: "chat",
          message: messageData
        }, function(status, response) {
          if (status.error) {
            console.error("Lỗi gửi tin nhắn qua PubNub:", status);
          }
        });

        messageInput.value = "";
      }
      document.getElementById("send-message").addEventListener("click", sendMessage);

      /********* Hàm hiển thị tin nhắn với hiệu ứng (Anime.js) *********/
      function renderMessage(sender, text) {
        var messageElem = document.createElement("div");
        messageElem.textContent = sender + ": " + text;
        messageElem.style.opacity = 0;
        messageElem.style.transform = "translateY(-20px)";
        document.getElementById("messages").appendChild(messageElem);

        anime({
          targets: messageElem,
          opacity: [0, 1],
          translateY: [-20, 0],
          easing: "easeOutExpo",
          duration: 600
        });
      }
      // Lắng nghe tin nhắn mới từ Firebase
      database.ref("messages").on("child_added", function(snapshot) {
        var msg = snapshot.val();
        renderMessage(msg.sender, msg.text);
      });

      /********* Hàm tải danh sách người dùng từ Firebase *********/
      // Giả sử bạn có bảng "users" trong Firebase chứa danh sách người dùng
      function loadUserList() {
        database.ref("users").on("value", function(snapshot) {
          var users = snapshot.val() || {};
          var userListElem = document.getElementById("user-list");
          userListElem.innerHTML = "";
          for (var uid in users) {
            var li = document.createElement("li");
            li.textContent = users[uid].email || uid;
            userListElem.appendChild(li);
          }
        });
      }
      loadUserList();

      /********* Hàm hiển thị Cài đặt & Tài khoản với anime.js *********/
      function showSettings() {
        var settingsElem = document.getElementById("settings");
        var overlayElem = document.getElementById("overlay");
        overlayElem.style.display = "block";
        settingsElem.style.display = "block";

        anime({
          targets: "#settings",
          opacity: [0, 1],
          translateY: [-50, 0],
          easing: "easeOutExpo",
          duration: 500
        });

        // Cập nhật thông tin người dùng (ví dụ, từ Auth)
        document.getElementById("current-user").textContent = "user@example.com";
      }
      function closeSettings() {
        var settingsElem = document.getElementById("settings");
        var overlayElem = document.getElementById("overlay");
        anime({
          targets: "#settings",
          opacity: [1, 0],
          translateY: [0, -50],
          easing: "easeInExpo",
          duration: 500,
          complete: function() {
            settingsElem.style.display = "none";
            overlayElem.style.display = "none";
          }
        });
      }

// Hiển thị danh sách người dùng
// Giả sử bạn có định danh cho user hiện tại
  var currentUserId = "user_1";
  var userStatusRef = database.ref('/status/' + currentUserId);
  var connectedRef = database.ref(".info/connected");

  connectedRef.on("value", function(snapshot) {
    if (snapshot.val() === false) return;

    // Khi mất kết nối sẽ tự động chuyển về trạng thái offline
    userStatusRef.onDisconnect().set({
      state: "offline",
      last_changed: firebase.database.ServerValue.TIMESTAMP
    }).then(function() {
      // Khi có kết nối, set trạng thái online
      userStatusRef.set({
        state: "online",
        last_changed: firebase.database.ServerValue.TIMESTAMP
      });
    });
  });

  // Hàm cập nhật UI cho người dùng
  function updateUserUI(userId, nickname, status) {
    var list = document.getElementById("user-list");
    var userItem = document.getElementById("user-" + userId);

    if (!userItem) {
      userItem = document.createElement("li");
      userItem.id = "user-" + userId;
      userItem.className = "user-item";

      var statusDot = document.createElement("span");
      statusDot.className = "status-dot " + (status === "online" ? "online" : "offline");
      statusDot.id = "dot-" + userId;

      var textNode = document.createTextNode(nickname);
      userItem.appendChild(statusDot);
      userItem.appendChild(textNode);
      list.appendChild(userItem);
    } else {
      var statusDot = document.getElementById("dot-" + userId);
      statusDot.className = "status-dot " + (status === "online" ? "online" : "offline");
    }
  }

  // Lắng nghe thay đổi trạng thái của tất cả người dùng
  var statusRef = database.ref('/status');
  statusRef.on("child_added", function(snapshot) {
    var userId = snapshot.key;
    var statusData = snapshot.val();
    var nickname = userId;  // Hoặc lấy từ node khác nếu có lưu thông tin chi tiết
    updateUserUI(userId, nickname, statusData.state);
  });
  statusRef.on("child_changed", function(snapshot) {
    var userId = snapshot.key;
    var statusData = snapshot.val();
    var nickname = userId;
    updateUserUI(userId, nickname, statusData.state);
  });

  </script>
</body>
</html>
