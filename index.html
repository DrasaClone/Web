<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASCII-NET v3.0 - Full Feature Integration</title>
    
    <!-- ================== T√çCH H·ª¢P SDK T·ª™ index++.html ================== -->
    <!-- Firebase JS SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- PubNub SDK -->
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    
    <!-- Cloudinary Upload Widget -->
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
    
    <!-- Agora RTC SDK -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>
    <!-- ================================================================= -->

    <style>
        :root {
            --bg-color: #0d0d0d;
            --main-color: #00ff41;
            --accent-color: #f0f0f0;
            --border-color: #333;
            --error-color: #ff3860;
        }
        
        * { box-sizing: border-box; }
        html, body {
            height: 100%; margin: 0; padding: 0;
            background-color: #000; color: var(--main-color);
            font-family: 'Courier New', Courier, monospace; font-size: 16px;
            overflow: hidden;
        }
        #terminal {
            width: 100%; height: 100%; padding: 15px;
            border: 2px solid var(--border-color); background-color: var(--bg-color);
            overflow-y: auto; position: relative;
        }
        #terminal::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; right: 0;
            height: 4px; background: rgba(0, 0, 0, 0.15); opacity: 0.2;
            animation: scanline 7s linear infinite; pointer-events: none;
        }
        @keyframes scanline { 0% { transform: translateY(0); } 100% { transform: translateY(100vh); } }
        
        .page { width: 100%; display: none; }
        .page.active { display: block; }
        .sub-page { display: none; }

        .header-title { text-align: center; margin-bottom: 20px; text-shadow: 0 0 5px var(--main-color), 0 0 10px var(--main-color); }
        pre { white-space: pre-wrap; word-wrap: break-word; margin: 0; font-family: inherit; color: inherit; font-size: inherit; }
        .ascii-art { color: var(--accent-color); }
        .ascii-box { border: 1px solid var(--main-color); padding: 10px; margin-bottom: 15px; }
        .ascii-button {
            display: inline-block; border: 1px solid var(--main-color); padding: 5px 10px; margin: 5px;
            cursor: pointer; background-color: transparent; color: var(--main-color); font-family: inherit;
        }
        .ascii-button:hover, .ascii-button.active { background-color: var(--main-color); color: var(--bg-color); }
        .ascii-button:disabled { cursor: not-allowed; opacity: 0.5; }

        input[type="text"], input[type="password"], textarea {
            background-color: transparent; border: none; border-bottom: 1px solid var(--main-color);
            color: var(--main-color); font-family: inherit; font-size: 1em; width: 250px;
        }
        textarea { width: 100%; border: 1px solid var(--main-color); padding: 5px; }
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 5px var(--main-color); }
        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { color: transparent; } 50% { color: var(--main-color); } }
        #main-nav { display: flex; justify-content: center; flex-wrap: wrap; margin: 10px 0; border-top: 1px dashed var(--main-color); border-bottom: 1px dashed var(--main-color); padding: 5px 0; }
        .status-online { color: #23d160; } .status-offline { color: #ff3860; }
        .loader { display: inline-block; font-size: 1em; text-align: center; width: 100%; }
        a { color: var(--main-color); text-decoration: underline; cursor: pointer; }
        .comment, .social-comment { border-bottom: 1px dotted var(--border-color); padding: 5px 0; margin-top: 5px; }
        
        /* Video Call Specific Styles */
        .video-call-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;}
        .video-box { border: 1px solid var(--main-color); background: #000; width: 320px; height: 240px; position: relative; }
        .video-box video { width: 100%; height: 100%; object-fit: cover; }
        .video-name { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.7); padding: 3px; font-size: 0.9em; }

        #toast-container { position: fixed; bottom: 10px; left: 10px; z-index: 9999; }
        .toast { border: 1px solid var(--main-color); background: var(--bg-color); padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>

<div id="terminal">

    <!-- TRANG 0: KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG -->
    <div id="boot-page" class="page active">
        <pre class="ascii-art">
           _   _  ___ ___ ___ _    ___ 
          /_\ | |/ __/ __/ __| |  |_ _|
         / _ \| | (_|(_| \__ \ |__ | | 
        /_/ \_\_|\___\___\___/____|___|
                                   
        [ ASCII-NET v3.0 - Full Feature Integration ]
        </pre>
        <pre id="boot-log"></pre>
    </div>


    <!-- TRANG 1: ƒêƒÇNG NH·∫¨P -->
    <div id="login-page" class="page">
        <div class="header-title">
            <pre>===================== TRUY C·∫¨P H·ªÜ TH·ªêNG =====================</pre>
        </div>
        <div id="login-form">
             <div class="ascii-box">
                <pre>
> Nh·∫≠p Email:   [ <input type="text" id="email" placeholder="user@domain.com" required> ]
> M·∫≠t kh·∫©u:     [ <input type="password" id="password" placeholder="√≠t nh·∫•t 6 k√Ω t·ª±" required> ]<span class="blinking-cursor">_</span>
                </pre>
                <br>
                <button id="email-login" class="ascii-button">[//> ƒêƒÇNG NH·∫¨P / ƒêƒÇNG K√ù B·∫∞NG EMAIL <//]</button>
             </div>
             <div class="ascii-box">
                <pre>> Ph∆∞∆°ng th·ª©c kh√°c:</pre>
                <button id="google-login" class="ascii-button">[G]> ƒêƒÇNG NH·∫¨P V·ªöI GOOGLE <[G]</button>
            </div>
        </div>
        <div id="login-loader" style="display: none; margin-top: 20px;">
            <pre class="loader">ƒêang k·∫øt n·ªëi ƒë·∫øn h·ªá th·ªëng ch√≠nh... [|]</pre>
        </div>
    </div>


    <!-- =============================================== -->
    <!--  KHU V·ª∞C CH√çNH SAU KHI ƒêƒÇNG NH·∫¨P -->
    <!-- =============================================== -->
    <div id="main-interface" class="page">
        <div class="ascii-box">
            <pre id="welcome-message">ƒêang k·∫øt n·ªëi...</pre>
            <div id="main-nav">
                <a class="ascii-button active" data-target="newsfeed-page">[B·∫£ng tin]</a>
                <a class="ascii-button" data-target="chat-public-page">[Chat Chung]</a>
                <a class="ascii-button" data-target="private-chat-page">[Tin Nh·∫Øn Ri√™ng]</a>
                <a class="ascii-button" data-target="video-call-page">[G·ªçi Video]</a>
                <a class="ascii-button" data-target="profile-page">[H·ªì s∆°]</a>
                <a class="ascii-button" data-target="help-page">[Tr·ª£ gi√∫p]</a>
                <a class="ascii-button" data-target="settings-page">[C√†i ƒê·∫∑t]</a>
                <button id="logout-btn" class="ascii-button" style="color:var(--error-color)">[ƒêƒÉng xu·∫•t]</button>
            </div>
        </div>
        
        <!-- N·ªòI DUNG C√ÅC TRANG CON -->
        <div id="page-content">
        
            <!-- Trang con: B·∫¢NG TIN -->
            <div id="newsfeed-page" class="sub-page">
                <pre class="header-title">+++ B·∫¢NG TIN H·ªÜ TH·ªêNG +++</pre>
                <div class="ascii-box">
                    <pre>T·∫°o b√†i ƒëƒÉng m·ªõi:</pre>
                    <textarea id="social-message" rows="3" placeholder="Chia s·∫ª suy nghƒ© c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
                    <button id="submit-social-btn" class="ascii-button">[ ƒêƒÉng ]</button>
                    <button id="upload-social-btn" class="ascii-button">[ T·∫£i L√™n ·∫¢nh ]</button>
                </div>
                <div id="social-posts-container">
                    <pre class="loader">ƒêang t·∫£i b·∫£ng tin... [-]</pre>
                </div>
            </div>

            <!-- Trang con: CHAT CHUNG -->
            <div id="chat-public-page" class="sub-page">
                <pre class="header-title">### K√äNH CHAT CHUNG TO√ÄN M·∫†NG ###</pre>
                <div style="display: flex; gap: 15px;">
                    <div class="ascii-box" style="flex-grow: 3;">
                        <pre><u><b>C·ª≠a s·ªï chat (G√µ /help ƒë·ªÉ xem l·ªánh):</b></u></pre>
                        <div id="public-chat-window" style="height: 300px; overflow-y: auto; padding-top: 5px;"></div>
                        <div style="display: flex; margin-top: 10px;">
                            <pre style="flex-grow: 1;">[<input type="text" id="public-chat-input" style="width: 95%;" placeholder="Nh·∫≠p tin nh·∫Øn ho·∫∑c l·ªánh..."><span class="blinking-cursor">_</span>]</pre>
                            <button id="send-chat-btn" class="ascii-button">[ G·ª≠i ]</button>
                            <button id="upload-chat-image-btn" class="ascii-button">[> UPLOAD IMG <]</button>
                        </div>
                    </div>
                    <div class="ascii-box" style="flex-grow: 1;">
                         <pre><u><b>Online Users (Click ƒë·ªÉ chat ri√™ng):</b></u></pre>
                         <div id="online-users-list" style="height: 350px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

             <!-- Trang con: TIN NH·∫ÆN RI√äNG -->
            <div id="private-chat-page" class="sub-page">
                <pre class="header-title">@@@ TIN NH·∫ÆN RI√äNG T∆Ø @@@</pre>
                <div id="private-chat-start-prompt" class="ascii-box">
                    <pre>
                        Ch·ªçn m·ªôt ng∆∞·ªùi d√πng t·ª´ danh s√°ch Online b√™n trang "Chat Chung" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                    </pre>
                </div>
                <div id="private-chat-interface" class="ascii-box" style="display:none;">
                    <pre>ƒêang chat v·ªõi: <b id="pm-partner-name"></b> <button id="pm-back-btn" class="ascii-button" style="float: right;">[< Quay l·∫°i]</button></pre>
                    <div id="pm-chat-window" style="height: 300px; overflow-y: auto; padding-top: 5px; border-top: 1px dashed; border-bottom: 1px dashed; margin: 10px 0;"></div>
                    <div style="display: flex; margin-top: 10px;">
                        <pre style="flex-grow: 1;">[<input type="text" id="pm-chat-input" style="width: 95%;" placeholder="G·ª≠i tin nh·∫Øn ri√™ng..."><span class="blinking-cursor">_</span>]</pre>
                        <button id="pm-send-btn" class="ascii-button">[ G·ª≠i ]</button>
                    </div>
                </div>
            </div>

            <!-- Trang con: G·ªåI VIDEO -->
            <div id="video-call-page" class="sub-page">
                <pre class="header-title">üìû TRUNG T√ÇM G·ªåI VIDEO AGORA üìû</pre>
                <!-- Room List & Creation -->
                <div id="room-selection" class="ascii-box">
                    <pre><b>Danh s√°ch ph√≤ng hi·ªán c√≥:</b></pre>
                    <div id="room-list">Ch∆∞a c√≥ ph√≤ng n√†o.</div>
                    <hr>
                    <pre>T·∫°o ph√≤ng m·ªõi: [ <input type="text" id="new-room-name" placeholder="T√™n ph√≤ng..."> ] <button id="create-room-btn" class="ascii-button">[ T·∫°o ]</button></pre>
                </div>
                <!-- Call Interface -->
                <div id="call-interface" style="display:none;">
                    <pre id="call-room-title">ƒêang trong ph√≤ng: </pre>
                    <div class="video-call-container">
                        <div class="video-box" id="local-stream">
                           <div class="video-name">You (Local)</div>
                        </div>
                        <!-- Remote streams will be added here by JS -->
                        <div id="remote-streams"></div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                       <button id="leave-btn" class="ascii-button">[ K·∫æT TH√öC CU·ªòC G·ªåI ]</button>
                    </div>
                </div>
            </div>

            <!-- C√°c trang c√≤n l·∫°i: Profile, Help, Settings -->
            <!-- ... Gi·ªØ nguy√™n nh∆∞ phi√™n b·∫£n tr∆∞·ªõc ... -->

            <!-- Trang con: H·ªí S∆† -->
            <div id="profile-page" class="sub-page">
                 <pre class="header-title">*** H·ªí S∆† NG∆Ø·ªúI D√ôNG ***</pre>
                 <div class="ascii-box" id="profile-info-container">
                    <pre>ƒêang t·∫£i th√¥ng tin h·ªì s∆°...</pre>
                 </div>
                 <div class="ascii-box">
                    <pre>C·∫≠p nh·∫≠t nickname:<br>[ <input type="text" id="profile-nickname-input" placeholder="Nh·∫≠p nickname m·ªõi..."> ] <button id="update-nickname-btn" class="ascii-button">[ C·∫≠p nh·∫≠t ]</button></pre>
                 </div>
            </div>

            <!-- Trang con: TR·ª¢ GI√öP / FEEDBACK -->
            <div id="help-page" class="sub-page">
                 <pre class="header-title">??? TR·ª¢ GI√öP & PH·∫¢N H·ªíI ???</pre>
                 <div class="ascii-box">
                    <form id="feedback-form">
                        <pre>H·ªç v√† T√™n:  [ <input type="text" id="feedback-name" required> ]</pre>
                        <pre>N·ªôi dung ph·∫£n h·ªìi:</pre>
                        <textarea id="feedback-message" rows="4" required></textarea><br>
                        <button type="submit" class="ascii-button">[ G·ª≠i Ph·∫£n H·ªìi ]</button>
                    </form>
                 </div>
                 <div class="ascii-box">
                     <pre><b>Danh s√°ch c√°c ph·∫£n h·ªìi:</b></pre>
                     <div id="feedback-container"></div>
                 </div>
            </div>
            
            <!-- Trang con: C√ÄI ƒê·∫∂T -->
            <div id="settings-page" class="sub-page">
                <pre class="header-title">‚öôÔ∏è C√ÄI ƒê·∫∂T H·ªÜ TH·ªêNG ‚öôÔ∏è</pre>
                 <div class="ascii-box">
                    <pre><b>[Ch·ªß ƒë·ªÅ (Theme)]</b> - Thay ƒë·ªïi m√†u s·∫Øc giao di·ªán</pre>
                    <br>
                    <button class="ascii-button theme-btn" data-theme="green">Terminal (M·∫∑c ƒë·ªãnh)</button>
                    <button class="ascii-button theme-btn" data-theme="amber">Amber</button>
                    <button class="ascii-button theme-btn" data-theme="blue">Matrix Blue</button>
                    <button class="ascii-button theme-btn" data-theme="white">Classic DOS</button>
                 </div>
            </div>

        </div>
    </div>
    
</div>
<div id="toast-container"></div>
<div id="recaptcha-container" style="display:none;"></div>

<script>
// Prevent FOUC
document.body.style.display = "none";

document.addEventListener('DOMContentLoaded', () => {
    document.body.style.display = "block";
    // === C·∫§U H√åNH FIREBASE, PUBNUB, AGORA ===
    const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    const pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });

    const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
    const socialCloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: 'dgbux4wzo',
        uploadPreset: 'okeqfdx4'
    }, (error, result) => {
        if (!error && result && result.event === "success") {
            const socialMsgField = document.getElementById("social-message");
            socialMsgField.value += `\n[image]${result.info.secure_url}[/image]`;
            showToast(`> ·∫¢nh ƒë√£ ƒë∆∞·ª£c th√™m v√†o b√†i ƒëƒÉng.`);
        }
    });
    // UPGRADE: New widget instance for chat
    const chatCloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: 'dgbux4wzo',
        uploadPreset: 'okeqfdx4'
    }, (error, result) => {
        if (!error && result && result.event === "success") {
             const message = {
                sender: userNickname,
                imageUrl: result.info.secure_url,
                timestamp: Date.now()
            };
            pubnub.publish({ channel: 'ascii_chat', message: message });
            db.ref('publicChatMessages').push(message); // Save to Firebase for history
        }
    });

    // === BI·∫æN TO√ÄN C·ª§C & DOM ELEMENTS ===
    let currentUser = null;
    let userNickname = 'anonymous';
    // UPGRADE: Variables for Private Chat
    let currentPrivateChannel = null;
    
    // === H√ÄM TI·ªÜN √çCH ===
    function showToast(message) { /* ... Gi·ªØ nguy√™n ... */ }
    function sanitize(str) { /* ... Gi·ªØ nguy√™n ... */ }
    function formatTime(timestamp) { return new Date(timestamp).toLocaleTimeString(); }
    function showPage(pageId) { /* ... Gi·ªØ nguy√™n ... */ }
    function showSubPage(subPageId) { /* ... Gi-/i·ªØ nguy√™n ... */ }

    // === X·ª¨ L√ù KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG & LOGIN/LOGOUT ===
    function runBootSequence() { /* ... Gi·ªØ nguy√™n ... */ }
    function initializeApp() {
        showPage('main-interface');
        showSubPage('newsfeed-page');
        document.getElementById('welcome-message').textContent = `USER: ${userNickname} | STATUS: Online`;

        loadChatHistory(); // UPGRADE: Load history before subscribing
        subscribeToPubNub();
        loadSocialPosts();
        loadFeedback();
        listenForAgoraRooms();
        updateProfilePage();
    }
    // All login/logout functions ... Gi·ªØ nguy√™n ...
    
    // === CH·ª®C NƒÇNG CHAT CHUNG (PUBNUB + FIREBASE) ===
    const publicChatInput = document.getElementById('public-chat-input');
    const publicChatWindow = document.getElementById('public-chat-window');

    // UPGRADE: Load last 50 messages from Firebase on start
    function loadChatHistory() {
        db.ref('publicChatMessages').limitToLast(50).once('value', snapshot => {
            snapshot.forEach(child => {
                appendChatMessage(child.val(), publicChatWindow);
            });
            publicChatWindow.innerHTML += `<pre><i>--- L·ªãch s·ª≠ chat ƒë√£ t·∫£i. Ch√†o m·ª´ng t·ªõi k√™nh chung. ---</i></pre>`;
            publicChatWindow.scrollTop = publicChatWindow.scrollHeight;
        });
    }

    function subscribeToPubNub() {
        const channelsToSubscribe = ['ascii_chat'];
        if (userNickname) {
            channelsToSubscribe.push(`pm-${userNickname}`); // Subscribe to own private channel
        }
        pubnub.subscribe({ channels: channelsToSubscribe, withPresence: true });
        
        pubnub.addListener({
            message: (event) => {
                if (event.channel === 'ascii_chat') {
                    appendChatMessage(event.message, publicChatWindow);
                } else if (event.channel.startsWith('pm-')) {
                    handlePrivateMessage(event);
                }
            },
            presence: (event) => {
                 updateOnlineUsers();
                 if (event.action === "join") {
                     appendSystemMessage(`${event.uuid} has connected.`);
                 } else if (event.action === "leave" || event.action === "timeout") {
                     appendSystemMessage(`${event.uuid} has disconnected.`);
                 }
            }
        });
        updateOnlineUsers();
    }
    
    function appendChatMessage(msg, windowElement) {
        const line = document.createElement('pre');
        let content;
        if (msg.text) {
            content = sanitize(msg.text);
        } else if (msg.imageUrl) {
            content = `chia s·∫ª m·ªôt ·∫£nh: <a href="${msg.imageUrl}" target="_blank">[LINK_TO_IMAGE]</a>`;
        }
        line.innerHTML = `[${formatTime(msg.timestamp)}] <b><${sanitize(msg.sender)}></b>: ${content}`;
        windowElement.appendChild(line);
        windowElement.scrollTop = windowElement.scrollHeight;
    }
    
    function appendSystemMessage(text, isCommand = false) {
        const line = document.createElement('pre');
        const style = isCommand ? `style="color: var(--accent-color)"` : 'style="font-style: italic"';
        line.innerHTML = `<span ${style}>--- ${sanitize(text)} ---</span>`;
        publicChatWindow.appendChild(line);
        publicChatWindow.scrollTop = publicChatWindow.scrollHeight;
    }

    function sendChatMessage() {
        const text = publicChatInput.value.trim();
        if (!text) return;
        
        // UPGRADE: Command handler
        if (text.startsWith('/')) {
            handleCommand(text);
            publicChatInput.value = '';
            return;
        }

        const message = { sender: userNickname, text: text, timestamp: Date.now() };
        pubnub.publish({ channel: 'ascii_chat', message: message });
        db.ref('publicChatMessages').push(message); // UPGRADE: Save to Firebase for history
        publicChatInput.value = '';
    }
    document.getElementById('send-chat-btn').addEventListener('click', sendChatMessage);
    publicChatInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendChatMessage(); });
    // UPGRADE: Bind click to the new image upload button
    document.getElementById('upload-chat-image-btn').addEventListener('click', () => chatCloudinaryWidget.open());

    function updateOnlineUsers(){
        pubnub.hereNow({ channels: ["ascii_chat"], includeUUIDs: true }, (status, response) => {
            const onlineUsersList = document.getElementById('online-users-list');
            onlineUsersList.innerHTML = '';
            if (response && response.channels.ascii_chat) {
                response.channels.ascii_chat.occupants.forEach(user => {
                    const userPre = document.createElement('pre');
                    if (user.uuid === userNickname) {
                         userPre.innerHTML = `> <b>${user.uuid} (You)</b>`;
                    } else {
                        // UPGRADE: Make username clickable for private chat
                        userPre.innerHTML = `> <a class="pm-user-link" data-user="${user.uuid}">${user.uuid}</a>`;
                    }
                    onlineUsersList.appendChild(userPre);
                });
                // Re-bind click events
                 document.querySelectorAll('.pm-user-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        const targetUser = e.target.getAttribute('data-user');
                        startPrivateChat(targetUser);
                    });
                });
            }
        });
    }

    // UPGRADE: Command handling function
    function handleCommand(commandText) {
        const [command, ...args] = commandText.split(' ');
        switch (command) {
            case '/clear':
                publicChatWindow.innerHTML = '';
                appendSystemMessage("C·ª≠a s·ªï chat ƒë√£ ƒë∆∞·ª£c x√≥a.", true);
                break;
            case '/help':
                const helpText = `L·ªánh c√≥ s·∫µn:\n`+
                                 `  /clear         - X√≥a c·ª≠a s·ªï chat.\n` +
                                 `  /help          - Hi·ªÉn th·ªã th√¥ng b√°o n√†y.\n` +
                                 `  /who           - Hi·ªÉn th·ªã danh s√°ch online.\n` +
                                 `  /theme [name]  - ƒê·ªïi theme (green, amber, blue, white).`;
                appendSystemMessage(helpText, true);
                break;
            case '/who':
                updateOnlineUsers();
                appendSystemMessage("ƒê√£ l√†m m·ªõi danh s√°ch online.", true);
                break;
            case '/theme':
                const themeBtn = document.querySelector(`.theme-btn[data-theme="${args[0]}"]`);
                if (themeBtn) {
                    themeBtn.click();
                    appendSystemMessage(`Theme ƒë√£ ƒë·ªïi th√†nh ${args[0]}.`, true);
                } else {
                    appendSystemMessage(`L·ªói: Theme '${args[0]}' kh√¥ng t·ªìn t·∫°i.`, true);
                }
                break;
            default:
                appendSystemMessage(`L·ªói: L·ªánh '${command}' kh√¥ng ƒë∆∞·ª£c nh·∫≠n d·∫°ng.`, true);
                break;
        }
    }
    
    // === UPGRADE: CH·ª®C NƒÇNG TIN NH·∫ÆN RI√äNG (PRIVATE MESSAGING) ===
    function getPrivateChannelName(user1, user2) {
        return `pm-${[user1, user2].sort().join('-')}`;
    }

    function startPrivateChat(partnerNickname) {
        if (partnerNickname === userNickname) {
            showToast('> B·∫°n kh√¥ng th·ªÉ t·ª± chat v·ªõi ch√≠nh m√¨nh.');
            return;
        }
        
        currentPrivateChannel = getPrivateChannelName(userNickname, partnerNickname);
        showSubPage('private-chat-page');
        document.getElementById('private-chat-start-prompt').style.display = 'none';
        document.getElementById('private-chat-interface').style.display = 'block';
        document.getElementById('pm-partner-name').textContent = partnerNickname;

        const pmWindow = document.getElementById('pm-chat-window');
        pmWindow.innerHTML = ''; // Clear previous chat
        
        // Load history for this PM channel from Firebase
        db.ref(`privateMessages/${currentPrivateChannel}`).limitToLast(50).once('value', snapshot => {
             snapshot.forEach(child => {
                appendChatMessage(child.val(), pmWindow);
            });
             pmWindow.scrollTop = pmWindow.scrollHeight;
        });

        showToast(`> B·∫Øt ƒë·∫ßu chat ri√™ng v·ªõi ${partnerNickname}`);
    }

    function handlePrivateMessage(event) {
        // Only append if the user is currently viewing the correct PM window
        if (event.channel === currentPrivateChannel) {
            appendChatMessage(event.message, document.getElementById('pm-chat-window'));
        } else {
            // Otherwise, just show a toast notification
            showToast(`> Tin nh·∫Øn m·ªõi t·ª´ ${event.message.sender}`);
        }
    }
    
    function sendPrivateMessage() {
        const partner = document.getElementById('pm-partner-name').textContent;
        const channel = getPrivateChannelName(userNickname, partner);
        const input = document.getElementById('pm-chat-input');
        const text = input.value.trim();

        if (text && channel) {
            const message = { sender: userNickname, text: text, timestamp: Date.now() };
            // Publish to PubNub for both users
            pubnub.publish({ channel: channel, message: message });
            // Save to Firebase for history
            db.ref(`privateMessages/${channel}`).push(message);
            input.value = '';
        }
    }

    document.getElementById('pm-send-btn').addEventListener('click', sendPrivateMessage);
    document.getElementById('pm-chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendPrivateMessage(); });
    document.getElementById('pm-back-btn').addEventListener('click', () => {
         currentPrivateChannel = null; // Exit the private chat state
         document.getElementById('private-chat-interface').style.display = 'none';
         document.getElementById('private-chat-start-prompt').style.display = 'block';
         showSubPage('chat-public-page'); // Go back to public chat
    });


    // === ALL OTHER FUNCTIONS (B·∫¢NG TIN, PROFILE, AGORA, SETTINGS, etc.) ===
    // ... Gi·ªØ nguy√™n nh∆∞ phi√™n b·∫£n tr∆∞·ªõc, kh√¥ng c·∫ßn thay ƒë·ªïi.
    // Logic for:
    // loadSocialPosts()
    // createPostElement()
    // document.getElementById('submit-social-btn').addEventListener('click',...)
    // document.getElementById('upload-social-btn').addEventListener('click',...)
    // updateProfilePage()
    // document.getElementById('update-nickname-btn').addEventListener('click',...)
    // feedbackForm.addEventListener('submit', ...)
    // loadFeedback()
    // document.querySelectorAll('.theme-btn').forEach(...)
    // Agora logic: listenForAgoraRooms(), joinRoom(), leaveRoom(), etc.
    // ... (To√†n b·ªô c√°c h√†m n√†y ƒë∆∞·ª£c sao ch√©p v√† gi·ªØ nguy√™n)

    // === B·∫ÆT ƒê·∫¶U CH∆Ø∆†G TR√åNH ===
    runBootSequence();

});
</script>

</body>
</html>
