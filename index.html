<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Nền tảng Chat Realtime</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Firebase JS SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
  
  <!-- Anime.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  
  <!-- Cloudinary Upload Widget -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Dosis:wght@200..800&display=swap" rel="stylesheet">
  
  <!-- Facebook SDK -->
  <script async defer crossorigin="anonymous"
    src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v17.0">
  </script>
  
  <style>
    /* Các chủ đề giao diện */
    body.theme-default {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: #fff;
    }
    body.theme-light {
      background: #f1f1f1;
      color: #333;
    }
    body.theme-dark {
      background: linear-gradient(135deg, #232526, #414345);
      color: #fff;
    }
    body.theme-colorful {
      background: linear-gradient(135deg, #ff7e5f, #feb47b);
      color: #fff;
    }
    
    /* Global Styles */
    body {
      font-family: "Dosis", cursive;
      font-weight: 200;
      margin: 0;
      padding: 0;
      transition: background 0.5s ease, color 0.5s ease;
    }
    header {
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .theme-switcher {
      margin-bottom: 10px;
      padding: 8px 16px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: inherit;
      cursor: pointer;
      font-size: 1rem;
    }
    .nav {
      margin: 20px 0;
    }
    .nav-btn {
      margin: 0 10px;
      padding: 10px 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 5px;
      color: inherit;
      cursor: pointer;
      font-size: 1rem;
    }
    .nav-btn.active {
      background: rgba(255,255,255,0.5);
    }
    
    /* Section chung */
    .section {
      border: 1px solid rgba(255,255,255,0.5);
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      background-color: rgba(0,0,0,0.5);
      border-radius: 10px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .active-page {
      opacity: 1;
    }
    input, button, textarea, select {
      margin: 5px 0;
      padding: 5px;
      font-size: 1rem;
      border-radius: 5px;
      border: none;
    }
    input, textarea, select {
      width: 80%;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      font-size: 2rem;
      color: #000;
      display: none;
    }
    .progress-circle {
      width: 150px;
      height: 150px;
      position: relative;
    }
    .progress-circle svg {
      transform: rotate(-90deg);
      width: 100%;
      height: 100%;
    }
    .progress-circle circle {
      fill: none;
      stroke-width: 12;
      stroke-linecap: round;
    }
    .progress-circle .bg {
      stroke: #eee;
    }
    .progress-circle .progress {
      stroke: #4caf50;
      stroke-dasharray: 440;
      stroke-dashoffset: 440;
      transition: stroke-dashoffset 1s ease-out;
    }
    .progress-circle .percentage {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    /* Chat Window: chỉ một khung hiển thị tin nhắn */
    #chat-window {
      border: 1px solid rgba(255,255,255,0.5);
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      margin: 10px 0;
      background-color: rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      max-width: 80%;
      word-break: break-word;
    }
    /* Tin nhắn của "tôi": căn về bên phải, nền xanh lá nhạt */
    .message.mine {
      align-self: flex-end;
      background-color: #a8e6cf;
      text-align: right;
    }
    /* Tin nhắn của người khác: căn về bên trái, nền xanh dương nhạt */
    .message.other {
      align-self: flex-start;
      background-color: #81d4fa;
      text-align: left;
    }
    /* Tin hệ thống thông báo online/offline */
    .system-message {
      align-self: center;
      background-color: #ffe082;
      color: #333;
      font-style: italic;
      padding: 5px;
      border-radius: 5px;
      max-width: 70%;
      margin: 10px auto;
    }
    
    /* Card cho forum & social posts */
    .post-card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      text-align: left;
    }
    .post-card img {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 5px;
    }
    
    /* Facebook comments container */
    .fb-comments-container {
      border: 2px solid #ffffff;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
      margin: 20px auto;
      max-width: 600px;
      color: #000;
    }
  </style>
</head>
<body class="theme-default">
  <header>
    <h1>Nền tảng Chat Realtime</h1>
    <button id="theme-switcher" class="theme-switcher">Chuyển đổi chủ đề nhanh</button>
    <div class="nav">
      <button class="nav-btn active" data-target="chat-section">Chat</button>
      <button class="nav-btn" data-target="forum-section">Forum</button>
      <button class="nav-btn" data-target="private-chat-section">Private Chat</button>
      <button class="nav-btn" data-target="social-section">Mạng Xã Hội</button>
      <button class="nav-btn" data-target="profile-section">Hồ sơ</button>
      <button class="nav-btn" data-target="settings-section">Cài đặt</button>
    </div>
  </header>
  
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <h1>Loading...</h1>
    <div class="progress-circle" data-percentage="75">
      <svg viewBox="0 0 150 150">
        <circle class="bg" cx="75" cy="75" r="70"></circle>
        <circle class="progress" cx="75" cy="75" r="70"></circle>
      </svg>
      <div class="percentage">100%</div>
    </div>
  </div>
  
  <!-- Login Section -->
  <div class="section login-section" id="login-section">
    <h2>Đăng nhập</h2>
    <!-- Đăng nhập bằng Google -->
    <div id="login-google">
      <button id="google-login">Đăng nhập với Google</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Email -->
    <div id="login-email">
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Mật khẩu">
      <button id="email-login">Đăng nhập/Đăng ký với Email</button>
    </div>
    <hr>
    <!-- Đăng nhập bằng Số điện thoại -->
    <div id="login-phone">
      <input type="text" id="phone-number" placeholder="Số điện thoại (VD: +849xxxxxxxx)">
      <div id="recaptcha-container"></div>
      <button id="send-otp">Gửi OTP</button><br>
      <input type="text" id="otp-code" placeholder="Nhập OTP">
      <button id="verify-otp">Xác thực OTP</button>
    </div>
  </div>
  
  <!-- Chat Section: hiển thị tin nhắn trong 1 khung với thông báo online/offline -->
  <div class="section chat-section active-page" id="chat-section">
    <h2>Phòng Chat</h2>
    <div class="nickname-section">
      <input type="text" id="nickname" placeholder="Nhập nickname của bạn...">
      <button id="set-nickname-btn">Đổi Nickname</button>
    </div>
    <div id="presence-list">
      <h3>Người trực tuyến:</h3>
      <ul id="online-users-list"></ul>
    </div>
    <div id="chat-window"></div>
    <div class="chat-input">
      <input type="text" id="message-input" placeholder="Nhập tin nhắn...">
      <button id="send-btn">Gửi</button>
      <button id="upload-chat-btn">Upload Image</button>
    </div>
  </div>
  
  <!-- Forum Section -->
  <div class="section forum-section" id="forum-section" style="display: none;">
    <h2>Forum</h2>
    <div class="forum-input">
      <textarea id="forum-message" placeholder="Viết nội dung forum..."></textarea>
      <button id="submit-forum-btn">Đăng bài</button>
      <button id="upload-forum-btn">Upload Image</button>
    </div>
    <div id="forum-posts"></div>
  </div>
  
  <!-- Private Chat Section -->
  <div class="section private-chat-section" id="private-chat-section" style="display: none;">
    <h2>Private Chat</h2>
    <div class="private-chat-input">
      <input type="text" id="pm-recipient" placeholder="Người nhận (nickname)">
      <input type="text" id="pm-message" placeholder="Nhập tin nhắn riêng...">
      <button id="send-pm-btn">Gửi tin riêng</button>
      <button id="upload-pm-btn">Upload Image</button>
    </div>
    <div id="pm-chat-window" style="min-height:300px; overflow-y:auto;"></div>
  </div>
  
  <!-- Social Network Section -->
  <div class="section social-network-section" id="social-section" style="display: none;">
    <h2>Mạng Xã Hội</h2>
    <div class="social-input">
      <textarea id="social-message" placeholder="Chia sẻ điều gì đó..."></textarea>
      <button id="submit-social-btn">Đăng</button>
      <button id="upload-social-btn">Upload Image</button>
    </div>
    <div id="social-posts"></div>
  </div>
  
  <!-- Profile Section -->
  <div class="section profile-section" id="profile-section" style="display: none;">
    <h2>Hồ sơ</h2>
    <div id="profile-info">
      <p>Chưa có thông tin, vui lòng đăng nhập.</p>
    </div>
    <div id="profile-update">
      <input type="text" id="profile-nickname" placeholder="Nhập nickname mới">
      <button id="update-profile-btn">Cập nhật nickname</button>
    </div>
  </div>
  
  <!-- Settings Section -->
  <div class="section settings-section" id="settings-section" style="display: none;">
    <h2>Cài đặt</h2>
    <label for="theme-select">Chọn chủ đề:</label>
    <select id="theme-select">
      <option value="theme-default">Mặc định</option>
      <option value="theme-light">Sáng</option>
      <option value="theme-dark">Tối</option>
      <option value="theme-colorful">Sắc màu</option>
    </select>
    <!-- Các thiết lập khác có thể được thêm vào đây -->
  </div>
  
  <!-- Plugin bình luận Facebook -->
  <div class="fb-comments-container">
    <div id="fb-root"></div>
    <div class="fb-comments" data-href="https://drasaclone.github.io/Web" data-width="600" data-numposts="100"></div>
  </div>
  
  <!-- Scripts -->
  <script>
    /* -------------------- CẤU HÌNH FIREBASE -------------------- */
    var firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    
    /* -------------------- KHỞI TẠO PUBNUB -------------------- */
    var pubnub = new PubNub({
      publishKey: 'pub-c-9ad32978-37b1-4f15-bc57-bac1884507a4',
      subscribeKey: 'sub-c-0269ec54-430f-41b1-8a33-4200f566fcbb'
    });
    
    // Subscribe kênh chat & lắng nghe sự kiện presence
    pubnub.subscribe({
      channels: ['chat'],
      withPresence: true
    });
    
    pubnub.addListener({
      message: function(event) {
        var message = event.message;
        if(message.private){
          appendPrivateMessage(message);
        } else {
          appendMessage(message);
        }
      },
      presence: function(event) {
        updatePresence();
        // Thông báo khi có người join/leave
        if(event.action === "join") {
          appendSystemMessage(event.uuid + " đã online");
        } else if(event.action === "leave" || event.action === "timeout") {
          appendSystemMessage(event.uuid + " đã offline");
        }
      }
    });
    
    /* -------------------- HIỆU ỨNG TRÊN PAGE LOAD -------------------- */
    window.addEventListener('load', function() {
      anime({
        targets: '#login-section',
        opacity: [0, 1],
        translateY: [-20, 0],
        duration: 5000,
        easing: 'easeOutExpo'
      });
      anime({
        targets: '.active-page',
        opacity: [0, 1],
        translateY: [20, 0],
        duration: 500,
        delay: 1000,
        easing: 'easeOutExpo'
      });
    });
    
    /* -------------------- CHUYỂN ĐỔI GIỮA CÁC TRANG -------------------- */
    var navButtons = document.querySelectorAll('.nav-btn');
    navButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var targetId = this.getAttribute('data-target');
        showLoadingTransition(function() {
          document.querySelectorAll('.chat-section, .forum-section, .private-chat-section, .social-network-section, .profile-section, .settings-section')
            .forEach(function(section) {
              section.style.display = "none";
              section.classList.remove('active-page');
            });
          navButtons.forEach(function(b) { b.classList.remove('active'); });
          document.getElementById(targetId).style.display = "block";
          document.getElementById(targetId).classList.add('active-page');
          anime({
            targets: '#' + targetId,
            opacity: [0, 1],
            translateY: [20, 0],
            duration: 500,
            easing: 'easeOutExpo'
          });
          btn.classList.add('active');
          if(targetId === "profile-section") updateProfileSection();
        });
      });
    });
    
    function showLoadingTransition(callback) {
      var overlay = document.getElementById("loading-overlay");
      overlay.style.display = "flex";
      var randomTransition = Math.floor(Math.random() * 3);
      switch(randomTransition) {
        case 0:
          anime({
            targets: overlay,
            opacity: [0, 1],
            scale: [0.5, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 1:
          anime({
            targets: overlay,
            translateY: [-100, 0],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  translateY: [0, 100],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
        case 2:
          anime({
            targets: overlay,
            rotate: ['0deg', '360deg'],
            opacity: [0, 1],
            duration: 500,
            easing: 'easeOutExpo',
            complete: function() {
              setTimeout(function() {
                anime({
                  targets: overlay,
                  rotate: ['360deg', '720deg'],
                  opacity: [1, 0],
                  duration: 500,
                  easing: 'easeInExpo',
                  complete: function() {
                    overlay.style.display = "none";
                    callback();
                  }
                });
              }, 300);
            }
          });
          break;
      }
    }
    
    /* -------------------- HÀM FORMAT THỜI GIAN -------------------- */
    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleString();
    }
    
    /* -------------------- XỬ LÝ TIN NHẮN & HIỆU ỨNG ANIME -------------------- */
    // Hiển thị tin nhắn của chat chung
    function appendMessage(message) {
      var senderName = message.sender;
      var chatWindow = document.getElementById("chat-window");
      var msgDiv = document.createElement("div");
      // Nếu tin của tôi dùng class "mine", còn của người khác dùng "other"
      msgDiv.className = "message " + ((window.userNickname && senderName === window.userNickname) ? "mine" : "other");
      var content = "<strong>" + senderName + ":</strong><br>" + (message.text || "");
      if(message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if(message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      chatWindow.appendChild(msgDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({ targets: msgDiv, opacity: [0, 1], translateY: [20, 0], duration: 500, easing: 'easeOutExpo' });
    }
    
    // Hiển thị tin hệ thống (ví dụ thông báo online/offline)
    function appendSystemMessage(text) {
      var chatWindow = document.getElementById("chat-window");
      var sysDiv = document.createElement("div");
      sysDiv.className = "system-message";
      sysDiv.innerHTML = text;
      chatWindow.appendChild(sysDiv);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      anime({ targets: sysDiv, opacity: [0, 1], translateY: [20, 0], duration: 500, easing: 'easeOutExpo' });
    }
    
    // Tin nhắn riêng
    function appendPrivateMessage(message) {
      var pmWindow = document.getElementById("pm-chat-window");
      var msgDiv = document.createElement("div");
      msgDiv.className = "message";
      var content = "<strong>" + message.sender + " (riêng):</strong><br>" + (message.text || "");
      if(message.image) {
        content += "<br><img src='" + message.image + "' alt='Uploaded Image' style='max-width:100%; border-radius:5px;'/>";
      }
      if(message.timestamp) {
        content += "<br><small>" + formatTime(message.timestamp) + "</small>";
      }
      msgDiv.innerHTML = content;
      pmWindow.appendChild(msgDiv);
      pmWindow.scrollTop = pmWindow.scrollHeight;
      anime({ targets: msgDiv, opacity: [0, 1], translateY: [20, 0], duration: 500, easing: 'easeOutExpo' });
    }
    
    /* Gửi tin nhắn chat (văn bản) */
    document.getElementById("send-btn").addEventListener("click", function() {
      var input = document.getElementById("message-input");
      var text = input.value.trim();
      if (text === "") return;
      var user = firebase.auth().currentUser;
      var senderName = window.userNickname ? window.userNickname : (user ? (user.displayName || user.email || user.phoneNumber) : "Anonymous");
      var message = { sender: senderName, text: text, timestamp: Date.now() };
      pubnub.publish({ channel: 'chat', message: message });
      firebase.database().ref('messages').push(message);
      input.value = "";
    });
    
    /* Upload image cho Chat */
    document.getElementById("upload-chat-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget(
        {
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        },
        function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var user = firebase.auth().currentUser;
            var senderName = window.userNickname ? window.userNickname : (user ? (user.displayName || user.email || user.phoneNumber) : "Anonymous");
            var message = { sender: senderName, image: url, timestamp: Date.now() };
            pubnub.publish({ channel: 'chat', message: message });
            firebase.database().ref('messages').push(message);
          }
        }
      ).open();
    });
    
    /* Upload image cho Forum */
    document.getElementById("upload-forum-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget(
        {
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        },
        function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var forumMsgField = document.getElementById("forum-message");
            forumMsgField.value = forumMsgField.value + " <img src='" + url + "' alt='Image'/>";
          }
        }
      ).open();
    });
    
    /* Upload image cho Private Chat */
    document.getElementById("upload-pm-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget(
        {
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        },
        function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var user = firebase.auth().currentUser;
            var senderName = window.userNickname ? window.userNickname : "Anonymous";
            var message = { sender: senderName, private: true, image: url, timestamp: Date.now() };
            var pmChannel = "pm-" + document.getElementById("pm-recipient").value.trim();
            pubnub.publish({ channel: pmChannel, message: message });
            appendPrivateMessage(message);
          }
        }
      ).open();
    });
    
    /* Upload image cho Mạng Xã Hội */
    document.getElementById("upload-social-btn").addEventListener("click", function() {
      cloudinary.createUploadWidget(
        {
          cloudName: 'demo',
          uploadPreset: 'ml_default'
        },
        function(error, result) {
          if(!error && result && result.event === "success") {
            var url = result.info.secure_url;
            var socialMsgField = document.getElementById("social-message");
            socialMsgField.value = socialMsgField.value + " <img src='" + url + "' alt='Image'/>";
          }
        }
      ).open();
    });
    
    /* Lắng nghe tin nhắn từ Firebase (chat công khai) */
    firebase.database().ref('messages').on('child_added', function(snapshot) {
      var message = snapshot.val();
      appendMessage(message);
    });
    
    /* -------------------- NICKNAME & PRESENCE -------------------- */
    document.getElementById("set-nickname-btn").addEventListener("click", function() {
      var nickname = document.getElementById("nickname").value.trim();
      if(nickname === "") return;
      window.userNickname = nickname;
      alert("Nickname đã được đặt thành: " + nickname);
      pubnub.subscribe({ channels: ["pm-" + nickname] });
      updatePresence();
      updateProfileSection();
    });
    
    function updatePresence() {
      pubnub.hereNow(
        { channels: ['chat'], includeUUIDs: true },
        function (status, response) {
          var onlineList = document.getElementById("online-users-list");
          onlineList.innerHTML = "";
          if(response.channels.chat && response.channels.chat.occupants) {
            response.channels.chat.occupants.forEach(function(occupant) {
              var li = document.createElement("li");
              li.textContent = occupant.uuid;
              onlineList.appendChild(li);
            });
          }
        }
      );
    }
    updatePresence();
    
    /* -------------------- FORUM FUNCTIONALITY -------------------- */
    document.getElementById("submit-forum-btn").addEventListener("click", function() {
      var forumMsg = document.getElementById("forum-message").value.trim();
      if(forumMsg === "") return;
      var senderName = window.userNickname ? window.userNickname : "Anonymous";
      var forumPost = { sender: senderName, text: forumMsg, timestamp: Date.now() };
      firebase.database().ref('forumPosts').push(forumPost);
      document.getElementById("forum-message").value = "";
    });
    
    firebase.database().ref('forumPosts').on('child_added', function(snapshot) {
      var post = snapshot.val();
      var forumPostsDiv = document.getElementById('forum-posts');
      var postDiv = document.createElement('div');
      postDiv.className = "post-card";
      var content = "<strong>" + post.sender + ":</strong><br>" + (post.text || "");
      if(post.image) {
        content += "<br><img src='" + post.image + "' alt='Forum Image'/>";
      }
      if(post.timestamp) {
        content += "<br><small>" + formatTime(post.timestamp) + "</small>";
      }
      postDiv.innerHTML = content;
      forumPostsDiv.appendChild(postDiv);
    });
    
    /* -------------------- SOCIAL NETWORK FUNCTIONALITY -------------------- */
    document.getElementById("submit-social-btn").addEventListener("click", function() {
      var socialMsg = document.getElementById("social-message").value.trim();
      if(socialMsg === "") return;
      var senderName = window.userNickname ? window.userNickname : "Anonymous";
      var socialPost = { sender: senderName, text: socialMsg, timestamp: Date.now() };
      firebase.database().ref('socialPosts').push(socialPost);
      document.getElementById("social-message").value = "";
    });
    
    firebase.database().ref('socialPosts').on('child_added', function(snapshot) {
      var post = snapshot.val();
      var socialPostsDiv = document.getElementById('social-posts');
      var postDiv = document.createElement('div');
      postDiv.className = "post-card";
      var content = "<strong>" + post.sender + ":</strong><br>" + (post.text || "");
      if(post.image) {
        content += "<br><img src='" + post.image + "' alt='Social Post Image'/>";
      }
      if(post.timestamp) {
        content += "<br><small>" + formatTime(post.timestamp) + "</small>";
      }
      postDiv.innerHTML = content;
      socialPostsDiv.appendChild(postDiv);
    });
    
    /* -------------------- PROFILE FUNCTIONALITY -------------------- */
    function updateProfileSection() {
      var profileInfoDiv = document.getElementById("profile-info");
      var user = firebase.auth().currentUser;
      if(user) {
        var infoHTML = "<p><strong>Email:</strong> " + (user.email || "Không có") + "</p>";
        infoHTML += "<p><strong>Tên hiển thị:</strong> " + (user.displayName || "Không có") + "</p>";
        infoHTML += "<p><strong>Nickname:</strong> " + (window.userNickname || "Chưa đặt") + "</p>";
        profileInfoDiv.innerHTML = infoHTML;
      } else {
        profileInfoDiv.innerHTML = "<p>Chưa có thông tin, vui lòng đăng nhập.</p>";
      }
    }
    document.getElementById("update-profile-btn").addEventListener("click", function() {
      var newNickname = document.getElementById("profile-nickname").value.trim();
      if(newNickname === "") return;
      window.userNickname = newNickname;
      alert("Nickname đã được cập nhật: " + newNickname);
      updateProfileSection();
      pubnub.subscribe({ channels: ["pm-" + newNickname] });
    });
    firebase.auth().onAuthStateChanged(function(user) {
      updateProfileSection();
    });
    
    /* -------------------- SETTINGS FUNCTIONALITY -------------------- */
    document.getElementById("theme-select").addEventListener("change", function() {
      var selectedTheme = this.value;
      document.body.className = selectedTheme;
    });
    
    /* -------------------- XỬ LÝ ĐĂNG NHẬP -------------------- */
    document.getElementById("google-login").addEventListener("click", function() {
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider)
        .then(function(result) {
          console.log("Đăng nhập thành công:", result.user.displayName);
          updateProfileSection();
        })
        .catch(function(error) { console.error("Lỗi đăng nhập Google:", error); });
    });
    document.getElementById("email-login").addEventListener("click", function() {
      var email = document.getElementById("email").value;
      var password = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .then(function(userCredential) {
          console.log("Đăng nhập thành công với Email:", userCredential.user.email);
          updateProfileSection();
        })
        .catch(function(error) {
          if (error.code === 'auth/user-not-found') {
            firebase.auth().createUserWithEmailAndPassword(email, password)
              .then(function(userCredential) {
                console.log("Tạo tài khoản Email thành công:", userCredential.user.email);
                updateProfileSection();
              })
              .catch(function(error) { console.error("Lỗi tạo người dùng Email:", error.message); });
          } else {
            console.error("Lỗi đăng nhập Email:", error.message);
          }
        });
    });
    document.getElementById("send-otp").addEventListener("click", function() {
      var phoneNumber = document.getElementById("phone-number").value;
      window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
      firebase.auth().signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier)
        .then(function(confirmationResult) {
          window.confirmationResult = confirmationResult;
          console.log("OTP đã được gửi đến số điện thoại:", phoneNumber);
        })
        .catch(function(error) { console.error("Lỗi gửi OTP:", error); });
    });
    document.getElementById("verify-otp").addEventListener("click", function() {
      var otpCode = document.getElementById("otp-code").value;
      window.confirmationResult.confirm(otpCode)
        .then(function(result) {
          console.log("Xác thực số điện thoại thành công:", result.user.phoneNumber);
          updateProfileSection();
        })
        .catch(function(error) { console.error("OTP không chính xác:", error); });
    });
    
    /* -------------------- THÔNG BÁO -------------------- */
    function showAlert() {
      alert("Chào bạn! Đây là thông báo về trang web. Dự án đang được phát triển nên có thể xảy ra lỗi. Hãy sử dụng một cách văn minh và tích cực. Cảm ơn bạn đã tin dùng dịch vụ của chúng tôi.");
    }
    window.onload = showAlert;
    
    // Loading Animation cho progress-circle
    document.querySelectorAll('.progress-circle').forEach(el => {
      const circle = el.querySelector('.progress');
      const text = el.querySelector('.percentage');
      const radius = circle.getAttribute('r');
      const circumference = 2 * Math.PI * radius;
      const percent = parseInt(el.getAttribute('data-percentage'), 10);
      circle.style.strokeDasharray = `${circumference}`;
      const offset = circumference - (percent / 100) * circumference;
      setTimeout(() => {
        circle.style.strokeDashoffset = offset;
        text.textContent = `${percent}%`;
      }, 100);
    });
  </script>
</body>
</html>
