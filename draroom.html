<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drasaroom</title>
    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --bg-light: #f8f9fa;
            --bg-white: #ffffff; --text-dark: #212529; --border-color: #dee2e6;
            --danger-color: #dc3545; --success-color: #198754; --warning-color: #ffc107;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 15px; background-color: var(--bg-light); color: var(--text-dark);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 800px; background: var(--bg-white);
            border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); overflow: hidden;
            position: relative;
        }
        .view { padding: 30px; }
        .hidden { display: none !important; }

        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .sphere { width: 60px; height: 60px; position: relative; transform-style: preserve-3d; animation: spin 5s linear infinite; }
        @keyframes spin { from { transform: rotateY(0deg) rotateX(0deg); } to { transform: rotateY(360deg) rotateX(360deg); } }
        .sphere .plane { position: absolute; width: 100%; height: 100%; border: 2px solid var(--primary-color); border-radius: 50%; }
        .sphere .plane:nth-child(1) { transform: rotateY(30deg); } .sphere .plane:nth-child(2) { transform: rotateY(60deg); }
        .sphere .plane:nth-child(3) { transform: rotateY(90deg); } .sphere .plane:nth-child(4) { transform: rotateY(120deg); }
        .sphere .plane:nth-child(5) { transform: rotateY(150deg); }
        #loading-text { margin-top: 20px; font-weight: 500; color: var(--primary-color); }


        h2, h3, h4 { text-align: center; color: var(--primary-color); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { flex-grow: 1; padding: 12px 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; background-color: var(--primary-color); color: white; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:hover:not(:disabled) { opacity: 0.85; }
        .btn:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-link { background: none; color: var(--primary-color); text-decoration: underline; padding: 0; font-size: 14px; }
        .feedback-message { text-align: center; margin-top: 10px; font-weight: 500; padding: 10px; border-radius: 6px; }
        .error { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c2c7; }
        .success { color: var(--success-color); background-color: #d1e7dd; border: 1px solid #badbcc; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        header img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); }
        #room-view { display: flex; flex-direction: column; height: 75vh; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); margin: 1rem 0; background: #fafafa; border-radius: 6px; }
        .message-item .msg-header { font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: baseline;}
        .message-item .msg-time { font-size: 0.75em; color: var(--secondary-color); font-weight: normal; }

        #avatar-upload-section { display: flex; align-items: center; gap: 15px; }
        #avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px dashed var(--border-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-overlay" class="hidden">
            <div class="sphere"><div class="plane"></div> <div class="plane"></div> <div class="plane"></div> <div class="plane"></div> <div class="plane"></div></div>
            <p id="loading-text">Đang tải...</p>
        </div>

        <div id="auth-view" class="view">
            <h2>Chào mừng đến Drasaroom</h2>
            <div class="form-group"><label for="username">Tên người dùng</label><input type="text" id="username"></div>
            <div class="form-group"><label for="password">Mật khẩu (chính hoặc khôi phục)</label><input type="password" id="password"></div>
            <div class="form-group hidden" id="password2-group"><label for="password2">Mật khẩu khôi phục</label><input type="password" id="password2"></div>
            <div class="button-group">
                <button id="login-btn" class="btn">🔑 Đăng nhập</button>
                <button id="show-register-btn" class="btn btn-secondary">📝 Đến trang Đăng ký</button>
                <button id="register-btn" class="btn btn-secondary hidden">✅ Xác nhận Đăng ký</button>
            </div>
            <div id="auth-feedback" class="feedback-message hidden"></div>
        </div>
        
        <div id="lobby-view" class="view hidden">
            <header>
                <div style="display: flex; align-items: center; gap: 10px;"><img id="user-avatar-display-lobby" alt="Avatar"> <h3 id="username-display"></h3></div>
                <div><button id="settings-btn" class="btn-link">⚙️ Cài đặt</button> <button id="logout-btn" class="btn btn-secondary">Đăng xuất</button></div>
            </header>
            <div class="form-group"><h4>➕ Tạo phòng mới</h4><div style="display: flex; gap: 10px; align-items:center;"><input type="text" id="room-name-input" placeholder="Tên phòng" style="flex-grow: 1;"><select id="room-privacy-input" style="width: 120px;"><option value="public">Công khai</option><option value="private">Riêng tư</option></select><button id="create-room-btn" class="btn" style="flex-grow: 0;">Tạo</button></div></div>
            <div class="join-by-code" style="border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem;"><h4>🚪 Tham gia bằng mã</h4><div style="display: flex; gap: 10px;"><input type="text" id="room-code-input" placeholder="Nhập mã phòng 6 ký tự"><button id="join-by-code-btn" class="btn">Vào</button></div></div>
            <h4 style="margin-top: 2rem;">🌍 Khám phá phòng công khai</h4>
            <div id="public-rooms-list"></div>
        </div>

        <div id="room-view" class="view hidden">
             <header><h3 id="room-title"></h3><div><span id="room-code-display" style="font-size: 0.9em; color: var(--secondary-color)"></span></div><div><button id="leave-room-btn" class="btn btn-danger">Rời phòng</button></div></header>
             <p>🔊 Trạng thái âm thanh: <b id="mic-status">Tắt</b></p>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-form" style="display: flex; gap: 10px;"><input type="text" id="chat-input" placeholder="Nhập tin nhắn..." style="flex-grow: 1;"><button id="send-chat-btn" class="btn">Gửi</button></div>
        </div>
        
        <div id="settings-view" class="view hidden">
            <header><button id="back-to-lobby-btn" class="btn-link">← Quay lại sảnh</button><h3>Cài đặt tài khoản</h3></header>
            <div class="form-group">
                <label for="avatar-file-input">Ảnh đại diện</label>
                <div id="avatar-upload-section"><img id="avatar-preview" alt="Avatar Preview"><div style="flex-grow: 1;"><input type="file" id="avatar-file-input" accept="image/png, image/jpeg, image/gif"><button id="upload-avatar-btn" class="btn" style="margin-top: 10px; width: 100%;">Tải lên & Lưu ảnh</button></div></div>
            </div>
            <hr>
            <h4>🔐 Thay đổi mật khẩu</h4>
            <p style="font-size:0.9em; text-align:center;">Để đổi mật khẩu chính, bạn cần xác thực bằng mật khẩu khôi phục.</p>
            <div class="form-group"><label for="new-password1-input">Mật khẩu chính MỚI</label><input type="password" id="new-password1-input"><button id="update-password1-btn" class="btn" style="margin-top: 10px;">Đổi mật khẩu chính</button></div>
            <div class="form-group"><label for="new-password2-input">Mật khẩu khôi phục MỚI</label><input type="password" id="new-password2-input"><button id="update-password2-btn" class="btn" style="margin-top: 10px;">Đổi mật khẩu khôi phục</button></div>
            <div id="settings-feedback" class="feedback-message hidden"></div>
            <hr>
            <button id="delete-account-btn" class="btn btn-danger" style="width: 100%;">❌ XÓA TÀI KHOẢN VĨNH VIỄN</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

    <script>
        // --- CẤU HÌNH ---
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
        const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
        const APP_DOMAIN = "drasaroom.io";
        const CLOUDINARY_CLOUD_NAME = "dgbux4wzo";
        const CLOUDINARY_UPLOAD_PRESET = "okeqfdx4";

        // --- KHỞI TẠO ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        
        // --- BIẾN TOÀN CỤC & DOM ---
        let currentUser = null, userData = {}, currentRoom = { id: null, data: null }, localAudioTrack = null, unsubscribeRooms = null, unsubscribeMessages = null;
        const views = { auth: document.getElementById('auth-view'), lobby: document.getElementById('lobby-view'), room: document.getElementById('room-view'), settings: document.getElementById('settings-view') };
        const loadingOverlay = document.getElementById('loading-overlay'), loadingText = document.getElementById('loading-text');

        // --- HÀM TIỆN ÍCH ---
        const showView = (v) => { Object.values(views).forEach(e => e.classList.add('hidden')); if(views[v]) views[v].classList.remove('hidden'); };
        const showLoading = (t = 'Đang tải...') => { loadingText.textContent = t; loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => loadingOverlay.classList.add('hidden');
        const hashString = async (s) => { const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); };
        const generateRoomCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        const showFeedback = (id, msg, isErr = true, dur = 5000) => { const el = document.getElementById(id); if (el) { el.textContent = msg; el.className = `feedback-message ${isErr ? 'error' : 'success'}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), dur); } };
        const formatTimestamp = (ts) => ts ? ts.toDate().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
        
        // --- LOGIC XÁC THỰC ---
        document.getElementById('show-register-btn').onclick = () => { ['password2-group','register-btn'].forEach(id => document.getElementById(id).classList.remove('hidden')); ['login-btn', 'show-register-btn'].forEach(id => document.getElementById(id).classList.add('hidden')); document.querySelector('#auth-view h2').textContent = 'Đăng ký tài khoản'; };
        document.getElementById('register-btn').onclick = async () => { const u = document.getElementById('username').value.trim(), p1 = document.getElementById('password').value, p2 = document.getElementById('password2').value; if (u.length < 3 || p1.length < 6 || p2.length < 6) return showFeedback('auth-feedback', "Username > 2, Mật khẩu > 5 ký tự."); showLoading('Đang tạo tài khoản...'); try { const p2h = await hashString(p2); const cred = await auth.createUserWithEmailAndPassword(`${u}@${APP_DOMAIN}`, p1); await db.collection('users').doc(cred.user.uid).set({ username: u, password2Hash: p2h, avatarUrl: `https://avatars.dicebear.com/api/bottts/${u}.svg` }); } catch (e) { showFeedback('auth-feedback', `Lỗi: ${e.message}`); } finally { hideLoading(); } };
        
        /***** LOGIN LOGIC ĐÃ SỬA LỖI VÀ NÂNG CẤP *****/
        document.getElementById('login-btn').onclick = async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return;
            showLoading('Đang đăng nhập...');

            // Cấu trúc try...finally đảm bảo hideLoading() LUÔN LUÔN được gọi.
            try {
                // Bước 1: Luôn thử đăng nhập bằng mật khẩu chính trước.
                await auth.signInWithEmailAndPassword(`${username}@${APP_DOMAIN}`, password);
                // Nếu thành công, onAuthStateChanged sẽ xử lý chuyển view.
            } catch (error) {
                // Bước 2: Nếu lỗi, kiểm tra xem có phải là "sai mật khẩu" không.
                if (error.code === 'auth/wrong-password') {
                    // Lỗi là "sai mật khẩu". Giờ ta kiểm tra xem đó có phải là mật khẩu khôi phục không.
                    const userQuery = await db.collection('users').where('username', '==', username).limit(1).get();
                    if (userQuery.empty) {
                        // Nếu không tìm thấy username, thông báo lỗi chung.
                        showFeedback('auth-feedback', 'Tên người dùng hoặc mật khẩu không chính xác.');
                        return; // Kết thúc hàm
                    }

                    const foundUserData = userQuery.docs[0].data();
                    const passwordHash = await hashString(password);

                    if (foundUserData.password2Hash === passwordHash) {
                        // Mật khẩu nhập vào TRÙNG với mật khẩu khôi phục.
                        // Ta sẽ đăng nhập người dùng bằng cách gửi link reset password và đăng nhập ngay.
                        // Đây là một "mẹo" để có thể đăng nhập bằng pass 2.
                        await auth.sendPasswordResetEmail(`${username}@${APP_DOMAIN}`);
                        alert("Mật khẩu khôi phục chính xác! Một email chứa link tạo mật khẩu mới đã được gửi (bạn có thể bỏ qua), hệ thống sẽ tự động đăng nhập cho bạn ngay bây giờ.");
                        // Đợi một chút để Firebase xử lý, sau đó onAuthStateChanged sẽ tự nhận diện.
                        // Nếu không, bạn cần phải tự refresh lại. Trong nhiều trường hợp, ta chỉ cần thông báo họ đăng nhập lại.
                    } else {
                        // Mật khẩu không phải là mật khẩu khôi phục. Thông báo lỗi.
                        showFeedback('auth-feedback', 'Tên người dùng hoặc mật khẩu không chính xác.');
                    }
                } else if (error.code === 'auth/user-not-found') {
                    showFeedback('auth-feedback', 'Người dùng không tồn tại.');
                } else {
                    // Một lỗi khác đã xảy ra
                    showFeedback('auth-feedback', 'Đã xảy ra lỗi không xác định.');
                }
            } finally {
                // Bước cuối: Dù thành công hay thất bại, luôn phải ẩn màn hình chờ.
                hideLoading();
            }
        };

        document.getElementById('logout-btn').onclick = () => { if(unsubscribeRooms) unsubscribeRooms(); auth.signOut(); };
        auth.onAuthStateChanged(async user => {
            if (user) {
                showLoading(); currentUser = user; const doc = await db.collection('users').doc(user.uid).get(); if (!doc.exists) return; userData = doc.data();
                document.getElementById('username-display').textContent = `${userData.username}`;
                document.getElementById('user-avatar-display-lobby').src = userData.avatarUrl;
                loadPublicRooms(); showView('lobby'); hideLoading();
            } else { currentUser = null; userData = {}; showView('auth'); }
        });

        // --- CÁC LOGIC KHÁC GIỮ NGUYÊN ---
        document.getElementById('create-room-btn').onclick = async () => { const n = document.getElementById('room-name-input').value.trim(); if (!n) return; const p = document.getElementById('room-privacy-input').value; const c = generateRoomCode(); showLoading('Đang tạo phòng...'); try { await db.collection('rooms').add({ name: n, creatorId: currentUser.uid, creatorName: userData.username, isPrivate: p === 'private', createdAt: firebase.firestore.FieldValue.serverTimestamp(), code: c }); document.getElementById('room-name-input').value = ''; alert(`Phòng đã được tạo! Mã tham gia: ${c}`); } finally { hideLoading(); } };
        document.getElementById('join-by-code-btn').onclick = async () => { const c = document.getElementById('room-code-input').value.trim().toUpperCase(); if(c.length !== 6) return alert("Mã phòng phải 6 ký tự."); showLoading(); try { const q = await db.collection('rooms').where('code', '==', c).limit(1).get(); if (q.empty) { alert("Không tìm thấy phòng."); return; } const doc = q.docs[0]; await attemptToJoinRoom(doc.id, doc.data()); } finally { hideLoading(); } };
        function loadPublicRooms() { if (unsubscribeRooms) unsubscribeRooms(); const el = document.getElementById('public-rooms-list'); unsubscribeRooms = db.collection('rooms').where('isPrivate', '==', false).orderBy('createdAt', 'desc').onSnapshot(snap => { el.innerHTML = ""; if (snap.empty) return el.innerHTML = "<p style='text-align:center;color:#6c757d;'>Chưa có phòng công khai.</p>"; snap.forEach(doc => { const d = doc.data(); const i = document.createElement('div'); i.className = 'room-item'; i.innerHTML = `<div class="room-item-info"><span>${d.name}</span><span style="font-size:0.8em; color:var(--secondary-color)">bởi ${d.creatorName}</span></div><span>🌍</span>`; i.onclick = () => attemptToJoinRoom(doc.id, d); el.appendChild(i); }); }); }
        async function attemptToJoinRoom(id, data) { currentRoom = { id, data }; if (data.isPrivate && data.creatorId !== currentUser.uid) { const p = prompt("Đây là phòng riêng tư, vui lòng nhập mã phòng:"); if (!p || p.toUpperCase() !== data.code) return alert("Mã phòng không chính xác!"); } await joinRoom(); }
        async function joinRoom() { showView('room'); document.getElementById('room-title').textContent = currentRoom.data.name; document.getElementById('room-code-display').textContent = `Mã: ${currentRoom.data.code}`; try { await agoraClient.join(AGORA_APP_ID, currentRoom.id, null, currentUser.uid); localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack(); await agoraClient.publish([localAudioTrack]); document.getElementById('mic-status').textContent = 'Đang bật'; } catch (e) { console.error("Agora join failed:", e); alert("Không thể kết nối âm thanh!"); } agoraClient.on("user-published", async (u, type) => { await agoraClient.subscribe(u, type); if (type === "audio") u.audioTrack.play(); }); listenForMessages(); }
        document.getElementById('leave-room-btn').onclick = async () => { showLoading(); if (unsubscribeMessages) unsubscribeMessages(); if (localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; } await agoraClient.leave(); currentRoom = { id: null, data: null }; document.getElementById('mic-status').textContent = 'Tắt'; document.getElementById('chat-messages').innerHTML = ''; showView('lobby'); hideLoading(); };
        const sendMessage = async () => { const input = document.getElementById('chat-input'); const text = input.value.trim(); if (text && currentRoom.id) { input.disabled = true; await db.collection('rooms').doc(currentRoom.id).collection('messages').add({ text, senderId: currentUser.uid, senderName: userData.username, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); input.value = ""; input.disabled = false; input.focus(); } };
        document.getElementById('send-chat-btn').onclick = sendMessage;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
        function listenForMessages() { if (unsubscribeMessages) unsubscribeMessages(); const el = document.getElementById('chat-messages'); el.innerHTML = ""; const ref = db.collection('rooms').doc(currentRoom.id).collection('messages').orderBy('createdAt', 'asc'); unsubscribeMessages = ref.onSnapshot(snap => { snap.docChanges().forEach(ch => { if (ch.type === "added") { const d = ch.doc.data(); const i = document.createElement('div'); i.className = 'message-item'; i.innerHTML = `<div class="msg-header"><span>${d.senderName}</span><span class="msg-time">${formatTimestamp(d.createdAt)}</span></div><div class="msg-text">${d.text}</div>`; el.appendChild(i); el.scrollTop = el.scrollHeight; } }); }); }
        document.getElementById('settings-btn').onclick = () => { document.getElementById('avatar-preview').src = userData.avatarUrl; showView('settings'); };
        document.getElementById('back-to-lobby-btn').onclick = () => showView('lobby');
        const avatarFileInput = document.getElementById('avatar-file-input');
        const avatarPreview = document.getElementById('avatar-preview');
        avatarFileInput.onchange = () => { const file = avatarFileInput.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { avatarPreview.src = e.target.result; }; reader.readAsDataURL(file); } };
        document.getElementById('upload-avatar-btn').onclick = async () => { const file = avatarFileInput.files[0]; if (!file) return showFeedback('settings-feedback', 'Bạn chưa chọn ảnh.'); if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) return showFeedback('settings-feedback', 'Chức năng tải ảnh chưa được cấu hình.'); showLoading('Đang tải ảnh lên...'); const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); try { const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Tải ảnh thất bại.'); const data = await res.json(); await db.collection('users').doc(currentUser.uid).update({ avatarUrl: data.secure_url }); document.getElementById('user-avatar-display-lobby').src = data.secure_url; userData.avatarUrl = data.secure_url; showFeedback('settings-feedback', 'Cập nhật ảnh thành công!', false); } catch (error) { showFeedback('settings-feedback', error.message); } finally { hideLoading(); } };
        document.getElementById('update-password1-btn').onclick = async () => { const p_rec = prompt("Nhập mật khẩu khôi phục:"); if (!p_rec) return; showLoading(); const hash_rec = await hashString(p_rec); if(hash_rec !== userData.password2Hash) { hideLoading(); return showFeedback('settings-feedback', 'Mật khẩu khôi phục không đúng!'); } const new_p1 = document.getElementById('new-password1-input').value; if (new_p1.length >= 6) { try { await currentUser.updatePassword(new_p1); showFeedback('settings-feedback', 'Đổi mật khẩu chính thành công!', false); } catch(e) { showFeedback('settings-feedback', 'Lỗi, cần đăng nhập lại.'); } } else { showFeedback('settings-feedback', 'Mật khẩu mới phải từ 6 ký tự.'); } hideLoading(); };
        document.getElementById('update-password2-btn').onclick = async () => { const new_p2 = document.getElementById('new-password2-input').value; if(new_p2.length >= 6) { showLoading(); const new_h = await hashString(new_p2); await db.collection('users').doc(currentUser.uid).update({ password2Hash: new_h }); userData.password2Hash = new_h; hideLoading(); showFeedback('settings-feedback', 'Đổi mật khẩu khôi phục thành công!', false); } else { showFeedback('settings-feedback', 'Mật khẩu mới phải từ 6 ký tự.'); } };
        document.getElementById('delete-account-btn').onclick = async () => { if(confirm("BẠN CÓ CHẮC MUỐN XÓA TÀI KHOẢN VĨNH VIỄN?")) { showLoading('Đang xóa tài khoản...'); try { await db.collection('users').doc(currentUser.uid).delete(); await currentUser.delete(); alert("Đã xóa tài khoản."); } catch(e) { alert("Lỗi: " + e.message + ". Cần đăng nhập lại để thực hiện."); } finally { hideLoading(); } } };
    </script>
</body>
</html>
