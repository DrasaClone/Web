<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drasaroom</title>
    <style>
        :root {
            --primary-color: #0d6efd; --secondary-color: #6c757d; --bg-light: #f8f9fa;
            --bg-white: #ffffff; --text-dark: #212529; --border-color: #dee2e6;
            --danger-color: #dc3545; --success-color: #198754; --warning-color: #ffc107;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; padding: 15px; background-color: var(--bg-light); color: var(--text-dark);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 800px; background: var(--bg-white);
            border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); overflow: hidden;
            position: relative;
        }
        .view { padding: 30px; }
        .hidden { display: none !important; }

        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(4px);
        }
        .sphere { width: 60px; height: 60px; position: relative; transform-style: preserve-3d; animation: spin 5s linear infinite; }
        @keyframes spin { from { transform: rotateY(0deg) rotateX(0deg); } to { transform: rotateY(360deg) rotateX(360deg); } }
        .sphere .plane { position: absolute; width: 100%; height: 100%; border: 2px solid var(--primary-color); border-radius: 50%; }
        .sphere .plane:nth-child(1) { transform: rotateY(30deg); } .sphere .plane:nth-child(2) { transform: rotateY(60deg); }
        .sphere .plane:nth-child(3) { transform: rotateY(90deg); } .sphere .plane:nth-child(4) { transform: rotateY(120deg); }
        .sphere .plane:nth-child(5) { transform: rotateY(150deg); }
        #loading-text { margin-top: 20px; font-weight: 500; color: var(--primary-color); }


        h2, h3, h4 { text-align: center; color: var(--primary-color); }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { flex-grow: 1; padding: 12px 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; background-color: var(--primary-color); color: white; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:hover:not(:disabled) { opacity: 0.85; }
        .btn:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-link { background: none; color: var(--primary-color); text-decoration: underline; padding: 0; font-size: 14px; }
        .feedback-message { text-align: center; margin-top: 10px; font-weight: 500; padding: 10px; border-radius: 6px; }
        .error { color: var(--danger-color); background-color: #f8d7da; border: 1px solid #f5c2c7; }
        .success { color: var(--success-color); background-color: #d1e7dd; border: 1px solid #badbcc; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1.5rem; }
        header img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary-color); }
        #room-view { display: flex; flex-direction: column; height: 75vh; }
        .chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; border: 1px solid var(--border-color); margin: 1rem 0; background: #fafafa; border-radius: 6px; }
        .message-item .msg-header { font-weight: bold; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: baseline;}
        .message-item .msg-time { font-size: 0.75em; color: var(--secondary-color); font-weight: normal; }

        #avatar-upload-section { display: flex; align-items: center; gap: 15px; }
        #avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px dashed var(--border-color); }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading-overlay" class="hidden">
            <div class="sphere"><div class="plane"></div> <div class="plane"></div> <div class="plane"></div> <div class="plane"></div> <div class="plane"></div></div>
            <p id="loading-text">Äang táº£i...</p>
        </div>

        <div id="auth-view" class="view">
            <h2>ChÃ o má»«ng Ä‘áº¿n Drasaroom</h2>
            <div class="form-group"><label for="username">TÃªn ngÆ°á»i dÃ¹ng</label><input type="text" id="username"></div>
            <div class="form-group"><label for="password">Máº­t kháº©u (chÃ­nh hoáº·c khÃ´i phá»¥c)</label><input type="password" id="password"></div>
            <div class="form-group hidden" id="password2-group"><label for="password2">Máº­t kháº©u khÃ´i phá»¥c</label><input type="password" id="password2"></div>
            <div class="button-group">
                <button id="login-btn" class="btn">ğŸ”‘ ÄÄƒng nháº­p</button>
                <button id="show-register-btn" class="btn btn-secondary">ğŸ“ Äáº¿n trang ÄÄƒng kÃ½</button>
                <button id="register-btn" class="btn btn-secondary hidden">âœ… XÃ¡c nháº­n ÄÄƒng kÃ½</button>
            </div>
            <div id="auth-feedback" class="feedback-message hidden"></div>
        </div>
        
        <div id="lobby-view" class="view hidden">
            <header>
                <div style="display: flex; align-items: center; gap: 10px;"><img id="user-avatar-display-lobby" alt="Avatar"> <h3 id="username-display"></h3></div>
                <div><button id="settings-btn" class="btn-link">âš™ï¸ CÃ i Ä‘áº·t</button> <button id="logout-btn" class="btn btn-secondary">ÄÄƒng xuáº¥t</button></div>
            </header>
            <div class="form-group"><h4>â• Táº¡o phÃ²ng má»›i</h4><div style="display: flex; gap: 10px; align-items:center;"><input type="text" id="room-name-input" placeholder="TÃªn phÃ²ng" style="flex-grow: 1;"><select id="room-privacy-input" style="width: 120px;"><option value="public">CÃ´ng khai</option><option value="private">RiÃªng tÆ°</option></select><button id="create-room-btn" class="btn" style="flex-grow: 0;">Táº¡o</button></div></div>
            <div class="join-by-code" style="border-top: 1px solid var(--border-color); margin-top: 1.5rem; padding-top: 1.5rem;"><h4>ğŸšª Tham gia báº±ng mÃ£</h4><div style="display: flex; gap: 10px;"><input type="text" id="room-code-input" placeholder="Nháº­p mÃ£ phÃ²ng 6 kÃ½ tá»±"><button id="join-by-code-btn" class="btn">VÃ o</button></div></div>
            <h4 style="margin-top: 2rem;">ğŸŒ KhÃ¡m phÃ¡ phÃ²ng cÃ´ng khai</h4>
            <div id="public-rooms-list"></div>
        </div>

        <div id="room-view" class="view hidden">
             <header><h3 id="room-title"></h3><div><span id="room-code-display" style="font-size: 0.9em; color: var(--secondary-color)"></span></div><div><button id="leave-room-btn" class="btn btn-danger">Rá»i phÃ²ng</button></div></header>
             <p>ğŸ”Š Tráº¡ng thÃ¡i Ã¢m thanh: <b id="mic-status">Táº¯t</b></p>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-form" style="display: flex; gap: 10px;"><input type="text" id="chat-input" placeholder="Nháº­p tin nháº¯n..." style="flex-grow: 1;"><button id="send-chat-btn" class="btn">Gá»­i</button></div>
        </div>
        
        <div id="settings-view" class="view hidden">
            <header><button id="back-to-lobby-btn" class="btn-link">â† Quay láº¡i sáº£nh</button><h3>CÃ i Ä‘áº·t tÃ i khoáº£n</h3></header>
            <div class="form-group">
                <label for="avatar-file-input">áº¢nh Ä‘áº¡i diá»‡n</label>
                <div id="avatar-upload-section"><img id="avatar-preview" alt="Avatar Preview"><div style="flex-grow: 1;"><input type="file" id="avatar-file-input" accept="image/png, image/jpeg, image/gif"><button id="upload-avatar-btn" class="btn" style="margin-top: 10px; width: 100%;">Táº£i lÃªn & LÆ°u áº£nh</button></div></div>
            </div>
            <hr>
            <h4>ğŸ” Thay Ä‘á»•i máº­t kháº©u</h4>
            <p style="font-size:0.9em; text-align:center;">Äá»ƒ Ä‘á»•i máº­t kháº©u chÃ­nh, báº¡n cáº§n xÃ¡c thá»±c báº±ng máº­t kháº©u khÃ´i phá»¥c.</p>
            <div class="form-group"><label for="new-password1-input">Máº­t kháº©u chÃ­nh Má»šI</label><input type="password" id="new-password1-input"><button id="update-password1-btn" class="btn" style="margin-top: 10px;">Äá»•i máº­t kháº©u chÃ­nh</button></div>
            <div class="form-group"><label for="new-password2-input">Máº­t kháº©u khÃ´i phá»¥c Má»šI</label><input type="password" id="new-password2-input"><button id="update-password2-btn" class="btn" style="margin-top: 10px;">Äá»•i máº­t kháº©u khÃ´i phá»¥c</button></div>
            <div id="settings-feedback" class="feedback-message hidden"></div>
            <hr>
            <button id="delete-account-btn" class="btn btn-danger" style="width: 100%;">âŒ XÃ“A TÃ€I KHOáº¢N VÄ¨NH VIá»„N</button>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N.js"></script>

    <script>
        // --- Cáº¤U HÃŒNH ---
        const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
        const AGORA_APP_ID = "a0b62867bee543fe828e23b4888eb3ae";
        const APP_DOMAIN = "drasaroom.io";
        const CLOUDINARY_CLOUD_NAME = "dgbux4wzo";
        const CLOUDINARY_UPLOAD_PRESET = "okeqfdx4";

        // --- KHá»I Táº O ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
        
        // --- BIáº¾N TOÃ€N Cá»¤C & DOM ---
        let currentUser = null, userData = {}, currentRoom = { id: null, data: null }, localAudioTrack = null, unsubscribeRooms = null, unsubscribeMessages = null;
        const views = { auth: document.getElementById('auth-view'), lobby: document.getElementById('lobby-view'), room: document.getElementById('room-view'), settings: document.getElementById('settings-view') };
        const loadingOverlay = document.getElementById('loading-overlay'), loadingText = document.getElementById('loading-text');

        // --- HÃ€M TIá»†N ÃCH ---
        const showView = (v) => { Object.values(views).forEach(e => e.classList.add('hidden')); if(views[v]) views[v].classList.remove('hidden'); };
        const showLoading = (t = 'Äang táº£i...') => { loadingText.textContent = t; loadingOverlay.classList.remove('hidden'); };
        const hideLoading = () => loadingOverlay.classList.add('hidden');
        const hashString = async (s) => { const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s)); return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join(''); };
        const generateRoomCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        const showFeedback = (id, msg, isErr = true, dur = 5000) => { const el = document.getElementById(id); if (el) { el.textContent = msg; el.className = `feedback-message ${isErr ? 'error' : 'success'}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), dur); } };
        const formatTimestamp = (ts) => ts ? ts.toDate().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) : '';
        
        // --- LOGIC XÃC THá»°C ---
        document.getElementById('show-register-btn').onclick = () => { ['password2-group','register-btn'].forEach(id => document.getElementById(id).classList.remove('hidden')); ['login-btn', 'show-register-btn'].forEach(id => document.getElementById(id).classList.add('hidden')); document.querySelector('#auth-view h2').textContent = 'ÄÄƒng kÃ½ tÃ i khoáº£n'; };
        document.getElementById('register-btn').onclick = async () => { const u = document.getElementById('username').value.trim(), p1 = document.getElementById('password').value, p2 = document.getElementById('password2').value; if (u.length < 3 || p1.length < 6 || p2.length < 6) return showFeedback('auth-feedback', "Username > 2, Máº­t kháº©u > 5 kÃ½ tá»±."); showLoading('Äang táº¡o tÃ i khoáº£n...'); try { const p2h = await hashString(p2); const cred = await auth.createUserWithEmailAndPassword(`${u}@${APP_DOMAIN}`, p1); await db.collection('users').doc(cred.user.uid).set({ username: u, password2Hash: p2h, avatarUrl: `https://avatars.dicebear.com/api/bottts/${u}.svg` }); } catch (e) { showFeedback('auth-feedback', `Lá»—i: ${e.message}`); } finally { hideLoading(); } };
        
        /***** LOGIN LOGIC ÄÃƒ Sá»¬A Lá»–I VÃ€ NÃ‚NG Cáº¤P *****/
        document.getElementById('login-btn').onclick = async () => {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            if (!username || !password) return;
            showLoading('Äang Ä‘Äƒng nháº­p...');

            // Cáº¥u trÃºc try...finally Ä‘áº£m báº£o hideLoading() LUÃ”N LUÃ”N Ä‘Æ°á»£c gá»i.
            try {
                // BÆ°á»›c 1: LuÃ´n thá»­ Ä‘Äƒng nháº­p báº±ng máº­t kháº©u chÃ­nh trÆ°á»›c.
                await auth.signInWithEmailAndPassword(`${username}@${APP_DOMAIN}`, password);
                // Náº¿u thÃ nh cÃ´ng, onAuthStateChanged sáº½ xá»­ lÃ½ chuyá»ƒn view.
            } catch (error) {
                // BÆ°á»›c 2: Náº¿u lá»—i, kiá»ƒm tra xem cÃ³ pháº£i lÃ  "sai máº­t kháº©u" khÃ´ng.
                if (error.code === 'auth/wrong-password') {
                    // Lá»—i lÃ  "sai máº­t kháº©u". Giá» ta kiá»ƒm tra xem Ä‘Ã³ cÃ³ pháº£i lÃ  máº­t kháº©u khÃ´i phá»¥c khÃ´ng.
                    const userQuery = await db.collection('users').where('username', '==', username).limit(1).get();
                    if (userQuery.empty) {
                        // Náº¿u khÃ´ng tÃ¬m tháº¥y username, thÃ´ng bÃ¡o lá»—i chung.
                        showFeedback('auth-feedback', 'TÃªn ngÆ°á»i dÃ¹ng hoáº·c máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c.');
                        return; // Káº¿t thÃºc hÃ m
                    }

                    const foundUserData = userQuery.docs[0].data();
                    const passwordHash = await hashString(password);

                    if (foundUserData.password2Hash === passwordHash) {
                        // Máº­t kháº©u nháº­p vÃ o TRÃ™NG vá»›i máº­t kháº©u khÃ´i phá»¥c.
                        // Ta sáº½ Ä‘Äƒng nháº­p ngÆ°á»i dÃ¹ng báº±ng cÃ¡ch gá»­i link reset password vÃ  Ä‘Äƒng nháº­p ngay.
                        // ÄÃ¢y lÃ  má»™t "máº¹o" Ä‘á»ƒ cÃ³ thá»ƒ Ä‘Äƒng nháº­p báº±ng pass 2.
                        await auth.sendPasswordResetEmail(`${username}@${APP_DOMAIN}`);
                        alert("Máº­t kháº©u khÃ´i phá»¥c chÃ­nh xÃ¡c! Má»™t email chá»©a link táº¡o máº­t kháº©u má»›i Ä‘Ã£ Ä‘Æ°á»£c gá»­i (báº¡n cÃ³ thá»ƒ bá» qua), há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng Ä‘Äƒng nháº­p cho báº¡n ngay bÃ¢y giá».");
                        // Äá»£i má»™t chÃºt Ä‘á»ƒ Firebase xá»­ lÃ½, sau Ä‘Ã³ onAuthStateChanged sáº½ tá»± nháº­n diá»‡n.
                        // Náº¿u khÃ´ng, báº¡n cáº§n pháº£i tá»± refresh láº¡i. Trong nhiá»u trÆ°á»ng há»£p, ta chá»‰ cáº§n thÃ´ng bÃ¡o há» Ä‘Äƒng nháº­p láº¡i.
                    } else {
                        // Máº­t kháº©u khÃ´ng pháº£i lÃ  máº­t kháº©u khÃ´i phá»¥c. ThÃ´ng bÃ¡o lá»—i.
                        showFeedback('auth-feedback', 'TÃªn ngÆ°á»i dÃ¹ng hoáº·c máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c.');
                    }
                } else if (error.code === 'auth/user-not-found') {
                    showFeedback('auth-feedback', 'NgÆ°á»i dÃ¹ng khÃ´ng tá»“n táº¡i.');
                } else {
                    // Má»™t lá»—i khÃ¡c Ä‘Ã£ xáº£y ra
                    showFeedback('auth-feedback', 'ÄÃ£ xáº£y ra lá»—i khÃ´ng xÃ¡c Ä‘á»‹nh.');
                }
            } finally {
                // BÆ°á»›c cuá»‘i: DÃ¹ thÃ nh cÃ´ng hay tháº¥t báº¡i, luÃ´n pháº£i áº©n mÃ n hÃ¬nh chá».
                hideLoading();
            }
        };

        document.getElementById('logout-btn').onclick = () => { if(unsubscribeRooms) unsubscribeRooms(); auth.signOut(); };
        auth.onAuthStateChanged(async user => {
            if (user) {
                showLoading(); currentUser = user; const doc = await db.collection('users').doc(user.uid).get(); if (!doc.exists) return; userData = doc.data();
                document.getElementById('username-display').textContent = `${userData.username}`;
                document.getElementById('user-avatar-display-lobby').src = userData.avatarUrl;
                loadPublicRooms(); showView('lobby'); hideLoading();
            } else { currentUser = null; userData = {}; showView('auth'); }
        });

        // --- CÃC LOGIC KHÃC GIá»® NGUYÃŠN ---
        document.getElementById('create-room-btn').onclick = async () => { const n = document.getElementById('room-name-input').value.trim(); if (!n) return; const p = document.getElementById('room-privacy-input').value; const c = generateRoomCode(); showLoading('Äang táº¡o phÃ²ng...'); try { await db.collection('rooms').add({ name: n, creatorId: currentUser.uid, creatorName: userData.username, isPrivate: p === 'private', createdAt: firebase.firestore.FieldValue.serverTimestamp(), code: c }); document.getElementById('room-name-input').value = ''; alert(`PhÃ²ng Ä‘Ã£ Ä‘Æ°á»£c táº¡o! MÃ£ tham gia: ${c}`); } finally { hideLoading(); } };
        document.getElementById('join-by-code-btn').onclick = async () => { const c = document.getElementById('room-code-input').value.trim().toUpperCase(); if(c.length !== 6) return alert("MÃ£ phÃ²ng pháº£i 6 kÃ½ tá»±."); showLoading(); try { const q = await db.collection('rooms').where('code', '==', c).limit(1).get(); if (q.empty) { alert("KhÃ´ng tÃ¬m tháº¥y phÃ²ng."); return; } const doc = q.docs[0]; await attemptToJoinRoom(doc.id, doc.data()); } finally { hideLoading(); } };
        function loadPublicRooms() { if (unsubscribeRooms) unsubscribeRooms(); const el = document.getElementById('public-rooms-list'); unsubscribeRooms = db.collection('rooms').where('isPrivate', '==', false).orderBy('createdAt', 'desc').onSnapshot(snap => { el.innerHTML = ""; if (snap.empty) return el.innerHTML = "<p style='text-align:center;color:#6c757d;'>ChÆ°a cÃ³ phÃ²ng cÃ´ng khai.</p>"; snap.forEach(doc => { const d = doc.data(); const i = document.createElement('div'); i.className = 'room-item'; i.innerHTML = `<div class="room-item-info"><span>${d.name}</span><span style="font-size:0.8em; color:var(--secondary-color)">bá»Ÿi ${d.creatorName}</span></div><span>ğŸŒ</span>`; i.onclick = () => attemptToJoinRoom(doc.id, d); el.appendChild(i); }); }); }
        async function attemptToJoinRoom(id, data) { currentRoom = { id, data }; if (data.isPrivate && data.creatorId !== currentUser.uid) { const p = prompt("ÄÃ¢y lÃ  phÃ²ng riÃªng tÆ°, vui lÃ²ng nháº­p mÃ£ phÃ²ng:"); if (!p || p.toUpperCase() !== data.code) return alert("MÃ£ phÃ²ng khÃ´ng chÃ­nh xÃ¡c!"); } await joinRoom(); }
        async function joinRoom() { showView('room'); document.getElementById('room-title').textContent = currentRoom.data.name; document.getElementById('room-code-display').textContent = `MÃ£: ${currentRoom.data.code}`; try { await agoraClient.join(AGORA_APP_ID, currentRoom.id, null, currentUser.uid); localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack(); await agoraClient.publish([localAudioTrack]); document.getElementById('mic-status').textContent = 'Äang báº­t'; } catch (e) { console.error("Agora join failed:", e); alert("KhÃ´ng thá»ƒ káº¿t ná»‘i Ã¢m thanh!"); } agoraClient.on("user-published", async (u, type) => { await agoraClient.subscribe(u, type); if (type === "audio") u.audioTrack.play(); }); listenForMessages(); }
        document.getElementById('leave-room-btn').onclick = async () => { showLoading(); if (unsubscribeMessages) unsubscribeMessages(); if (localAudioTrack) { localAudioTrack.stop(); localAudioTrack.close(); localAudioTrack = null; } await agoraClient.leave(); currentRoom = { id: null, data: null }; document.getElementById('mic-status').textContent = 'Táº¯t'; document.getElementById('chat-messages').innerHTML = ''; showView('lobby'); hideLoading(); };
        const sendMessage = async () => { const input = document.getElementById('chat-input'); const text = input.value.trim(); if (text && currentRoom.id) { input.disabled = true; await db.collection('rooms').doc(currentRoom.id).collection('messages').add({ text, senderId: currentUser.uid, senderName: userData.username, createdAt: firebase.firestore.FieldValue.serverTimestamp() }); input.value = ""; input.disabled = false; input.focus(); } };
        document.getElementById('send-chat-btn').onclick = sendMessage;
        document.getElementById('chat-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') { e.preventDefault(); sendMessage(); } });
        function listenForMessages() { if (unsubscribeMessages) unsubscribeMessages(); const el = document.getElementById('chat-messages'); el.innerHTML = ""; const ref = db.collection('rooms').doc(currentRoom.id).collection('messages').orderBy('createdAt', 'asc'); unsubscribeMessages = ref.onSnapshot(snap => { snap.docChanges().forEach(ch => { if (ch.type === "added") { const d = ch.doc.data(); const i = document.createElement('div'); i.className = 'message-item'; i.innerHTML = `<div class="msg-header"><span>${d.senderName}</span><span class="msg-time">${formatTimestamp(d.createdAt)}</span></div><div class="msg-text">${d.text}</div>`; el.appendChild(i); el.scrollTop = el.scrollHeight; } }); }); }
        document.getElementById('settings-btn').onclick = () => { document.getElementById('avatar-preview').src = userData.avatarUrl; showView('settings'); };
        document.getElementById('back-to-lobby-btn').onclick = () => showView('lobby');
        const avatarFileInput = document.getElementById('avatar-file-input');
        const avatarPreview = document.getElementById('avatar-preview');
        avatarFileInput.onchange = () => { const file = avatarFileInput.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { avatarPreview.src = e.target.result; }; reader.readAsDataURL(file); } };
        document.getElementById('upload-avatar-btn').onclick = async () => { const file = avatarFileInput.files[0]; if (!file) return showFeedback('settings-feedback', 'Báº¡n chÆ°a chá»n áº£nh.'); if (!CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) return showFeedback('settings-feedback', 'Chá»©c nÄƒng táº£i áº£nh chÆ°a Ä‘Æ°á»£c cáº¥u hÃ¬nh.'); showLoading('Äang táº£i áº£nh lÃªn...'); const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); try { const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, { method: 'POST', body: formData }); if (!res.ok) throw new Error('Táº£i áº£nh tháº¥t báº¡i.'); const data = await res.json(); await db.collection('users').doc(currentUser.uid).update({ avatarUrl: data.secure_url }); document.getElementById('user-avatar-display-lobby').src = data.secure_url; userData.avatarUrl = data.secure_url; showFeedback('settings-feedback', 'Cáº­p nháº­t áº£nh thÃ nh cÃ´ng!', false); } catch (error) { showFeedback('settings-feedback', error.message); } finally { hideLoading(); } };
        document.getElementById('update-password1-btn').onclick = async () => { const p_rec = prompt("Nháº­p máº­t kháº©u khÃ´i phá»¥c:"); if (!p_rec) return; showLoading(); const hash_rec = await hashString(p_rec); if(hash_rec !== userData.password2Hash) { hideLoading(); return showFeedback('settings-feedback', 'Máº­t kháº©u khÃ´i phá»¥c khÃ´ng Ä‘Ãºng!'); } const new_p1 = document.getElementById('new-password1-input').value; if (new_p1.length >= 6) { try { await currentUser.updatePassword(new_p1); showFeedback('settings-feedback', 'Äá»•i máº­t kháº©u chÃ­nh thÃ nh cÃ´ng!', false); } catch(e) { showFeedback('settings-feedback', 'Lá»—i, cáº§n Ä‘Äƒng nháº­p láº¡i.'); } } else { showFeedback('settings-feedback', 'Máº­t kháº©u má»›i pháº£i tá»« 6 kÃ½ tá»±.'); } hideLoading(); };
        document.getElementById('update-password2-btn').onclick = async () => { const new_p2 = document.getElementById('new-password2-input').value; if(new_p2.length >= 6) { showLoading(); const new_h = await hashString(new_p2); await db.collection('users').doc(currentUser.uid).update({ password2Hash: new_h }); userData.password2Hash = new_h; hideLoading(); showFeedback('settings-feedback', 'Äá»•i máº­t kháº©u khÃ´i phá»¥c thÃ nh cÃ´ng!', false); } else { showFeedback('settings-feedback', 'Máº­t kháº©u má»›i pháº£i tá»« 6 kÃ½ tá»±.'); } };
        document.getElementById('delete-account-btn').onclick = async () => { if(confirm("Báº N CÃ“ CHáº®C MUá»N XÃ“A TÃ€I KHOáº¢N VÄ¨NH VIá»„N?")) { showLoading('Äang xÃ³a tÃ i khoáº£n...'); try { await db.collection('users').doc(currentUser.uid).delete(); await currentUser.delete(); alert("ÄÃ£ xÃ³a tÃ i khoáº£n."); } catch(e) { alert("Lá»—i: " + e.message + ". Cáº§n Ä‘Äƒng nháº­p láº¡i Ä‘á»ƒ thá»±c hiá»‡n."); } finally { hideLoading(); } } };
    </script>
</body>
</html>
