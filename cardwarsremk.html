<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Card Wars Simulation - Chế độ đánh với Bot</title>
  <style>
    /* Phong cách chủ đạo cho trang game */
    body {
      margin: 0;
      font-family: sans-serif;
      background: #222;
      color: #fff;
    }
    #gameContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #threejsCanvas {
      width: 100%;
      max-width: 800px;
      height: 300px;
      background: #000;
      display: block;
    }
    #gameUI {
      width: 90%;
      max-width: 800px;
      margin: 10px;
      padding: 10px;
      border: 1px solid #444;
      background: #333;
      border-radius: 8px;
    }
    h1, h2 {
      text-align: center;
      margin: 10px 0;
    }
    #gameStatus {
      text-align: center;
      margin: 10px 0;
      white-space: pre-wrap;
    }
    button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #556;
      color: #fff;
      cursor: pointer;
    }
    button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    #playerCards, #botCards {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .card {
      width: 80px;
      height: 120px;
      border: 2px solid #fff;
      border-radius: 8px;
      margin: 5px;
      background: #444;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      text-align: center;
      font-size: 14px;
      padding: 5px;
    }
    .card.selected {
      border-color: yellow;
    }
    #scoreBoard p {
      text-align: center;
      font-size: 18px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <!-- Canvas 3D: sử dụng Three.js -->
    <canvas id="threejsCanvas"></canvas>
    
    <!-- Giao diện game: khu vực UI chứa thông tin trận đấu, bài của người chơi và bot -->
    <div id="gameUI">
      <h1>Card Wars Simulation</h1>
      <div id="gameStatus">Nhấn "New Game" để bắt đầu trận đấu.</div>
      <div style="text-align:center;">
        <button id="newGameBtn">New Game</button>
        <button id="playCardBtn" disabled>Play Card</button>
      </div>
      <div id="playerHand">
        <h2>Bài của bạn</h2>
        <div id="playerCards"></div>
      </div>
      <div id="botHand">
        <h2>Bài của Bot</h2>
        <div id="botCards"></div>
      </div>
      <div id="scoreBoard">
        <h2>Bảng điểm</h2>
        <p>Bạn: <span id="playerScore">0</span></p>
        <p>Bot: <span id="botScore">0</span></p>
      </div>
    </div>
  </div>
  
  <!-- Tích hợp các thư viện bên ngoài từ CDN -->
  <!-- Three.js để tạo đồ họa 3D -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <!-- Firebase (sử dụng phiên bản compat để đơn giản hóa) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <script>
    /* ---------------------- Firebase Setup ---------------------- */
    // Vui lòng thay thế các giá trị dưới đây bằng thông tin dự án Firebase của bạn
    const firebaseConfig = {
      apiKey: "AIzaSyCeYwTT7E8bi7bccIrc20MTe5S4r0e0wUI",
      authDomain: "webai-7642b.firebaseapp.com",
      databaseURL: "https://webai-7642b-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webai-7642b",
      storageBucket: "webai-7642b.firebasestorage.app",
      messagingSenderId: "967881370128",
      appId: "1:967881370128:web:e5c4b06e4f70f55a68b895",
      measurementId: "G-61XJ390Q30"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    /* ---------------------- Three.js 3D Graphics ---------------------- */
    const canvas = document.getElementById("threejsCanvas");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    // Cài đặt kích thước renderer theo canvas
    renderer.setSize(canvas.clientWidth, canvas.clientHeight);
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 100);
    camera.position.z = 5;
    
    // Tạo một đối tượng 3D đơn giản mô phỏng lá bài (dạng hộp mỏng)
    const geometry = new THREE.BoxGeometry(1, 1.5, 0.1);
    const material = new THREE.MeshPhongMaterial({ 
      color: 0x156289, 
      emissive: 0x072534, 
      side: THREE.DoubleSide, 
      flatShading: true 
    });
    const cardMesh = new THREE.Mesh(geometry, material);
    scene.add(cardMesh);
    
    // Thêm ánh sáng cho cảnh
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(5, 3, 5);
    scene.add(directionalLight);
    
    // Vòng lặp render cho đồ họa 3D
    function animate() {
      requestAnimationFrame(animate);
      // Quay nhẹ lá bài cho hiệu ứng 3D sống động
      cardMesh.rotation.y += 0.01;
      cardMesh.rotation.x += 0.005;
      renderer.render(scene, camera);
    }
    animate();
    
    /* ---------------------- Logic Game Card Wars ---------------------- */
    
    // Khởi tạo các biến của game
    let playerDeck = [];
    let botDeck = [];
    let playerHand = [];
    let botHand = [];
    let playerScore = 0;
    let botScore = 0;
    const maxHandSize = 5;
    
    // Bộ bài mẫu (mỗi lá bài có tên và giá trị tấn công)
    const cardPool = [
      { name: "Sát Thủ", value: 5 },
      { name: "Pháp Sư", value: 4 },
      { name: "Chiến Binh", value: 3 },
      { name: "Phù Thủy", value: 2 },
      { name: "Tập Trung", value: 1 }
    ];
    
    // Hàm xáo bài (shuffle)
    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
    
    // Tạo deck (mỗi loại bài xuất hiện 4 lần rồi xáo trộn)
    function generateDeck() {
      let deck = [];
      cardPool.forEach(card => {
        for (let i = 0; i < 4; i++) {
          deck.push({ ...card });
        }
      });
      return shuffle(deck);
    }
    
    // Chia bài cho người chơi và bot
    function dealHands() {
      playerHand = playerDeck.splice(0, maxHandSize);
      botHand = botDeck.splice(0, maxHandSize);
      renderHands();
    }
    
    // Hiển thị bài trên UI (người chơi thấy chi tiết, bot chỉ hiện ẩn)
    function renderHands() {
      const playerCardsDiv = document.getElementById("playerCards");
      const botCardsDiv = document.getElementById("botCards");
      playerCardsDiv.innerHTML = "";
      botCardsDiv.innerHTML = "";
      
      playerHand.forEach((card, index) => {
        const cardDiv = document.createElement("div");
        cardDiv.className = "card";
        cardDiv.innerHTML = `<b>${card.name}</b><br>Giá trị: ${card.value}`;
        cardDiv.onclick = () => selectCard(index);
        playerCardsDiv.appendChild(cardDiv);
      });
      
      // Với bài của bot, chỉ hiện mặt sau (ẩn nội dung)
      botHand.forEach(() => {
        const botCardDiv = document.createElement("div");
        botCardDiv.className = "card";
        botCardDiv.innerHTML = `<b>Bí Ẩn</b>`;
        botCardsDiv.appendChild(botCardDiv);
      });
    }
    
    let selectedCardIndex = null;
    
    // Người chơi chọn lá bài muốn chơi
    function selectCard(index) {
      selectedCardIndex = index;
      const cardDivs = document.querySelectorAll("#playerCards .card");
      cardDivs.forEach((div, idx) => {
        div.classList.toggle("selected", idx === index);
      });
      document.getElementById("playCardBtn").disabled = false;
    }
    
    // Hàm tính từng lượt: người chơi và bot chọn bài, so sánh "giá trị" để xác định người thắng vòng
    function playTurn() {
      if (selectedCardIndex === null) return;
      
      // Lấy bài của người chơi
      const playerCard = playerHand.splice(selectedCardIndex, 1)[0];
      
      // Bot chọn bài ngẫu nhiên
      const botChoiceIndex = Math.floor(Math.random() * botHand.length);
      const botCard = botHand.splice(botChoiceIndex, 1)[0];
      
      let roundResult = "";
      if (playerCard.value > botCard.value) {
        playerScore++;
        roundResult = "Bạn thắng vòng này!";
      } else if (playerCard.value < botCard.value) {
        botScore++;
        roundResult = "Bot thắng vòng này!";
      } else {
        roundResult = "Hòa vòng!";
      }
      
      document.getElementById("gameStatus").innerText = 
        `Bạn chơi: ${playerCard.name} (${playerCard.value})\nBot chơi: ${botCard.name} (${botCard.value})\n` + roundResult;
      
      updateScoreBoard();
      renderHands();
      document.getElementById("playCardBtn").disabled = true;
      selectedCardIndex = null;
      
      // Nếu hết bài trong tay và còn bài trong deck thì chia bài mới; ngược lại, kết thúc game
      if (playerHand.length === 0 || botHand.length === 0) {
        if (playerDeck.length > 0 && botDeck.length > 0) {
          setTimeout(dealHands, 1500);
        } else {
          endGame();
        }
      }
    }
    
    // Cập nhật bảng điểm
    function updateScoreBoard() {
      document.getElementById("playerScore").innerText = playerScore;
      document.getElementById("botScore").innerText = botScore;
    }
    
    // Bắt đầu trận mới
    function newGame() {
      playerDeck = generateDeck();
      botDeck = generateDeck();
      playerScore = 0;
      botScore = 0;
      updateScoreBoard();
      dealHands();
      document.getElementById("gameStatus").innerText = "Trận đấu bắt đầu!";
    }
    
    // Kết thúc game, hiển thị kết quả và lưu điểm số lên Firebase
    function endGame() {
      let finalMsg = "";
      if (playerScore > botScore) finalMsg = "Chúc mừng! Bạn đã thắng trận đấu!";
      else if (playerScore < botScore) finalMsg = "Bot thắng trận đấu!";
      else finalMsg = "Trận đấu kết thúc hòa.";
      document.getElementById("gameStatus").innerText = finalMsg;
      
      // Lưu kết quả điểm số vào Firebase Realtime Database
      database.ref('scores').push({
        playerScore: playerScore,
        botScore: botScore,
        timestamp: Date.now()
      }).then(() => {
        console.log("Score stored to Firebase.");
      }).catch(err => {
        console.error("Firebase error: ", err);
      });
    }
    
    // Gán sự kiện cho các nút bấm
    document.getElementById("newGameBtn").addEventListener("click", newGame);
    document.getElementById("playCardBtn").addEventListener("click", playTurn);
    
    // Điều chỉnh kích thước renderer khi window thay đổi
    window.addEventListener("resize", () => {
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      renderer.setSize(width, height);
      camera.aspect = width / height;
      camera.updateProjectionMatrix();
    });
  </script>
</body>
</html>
