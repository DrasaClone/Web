# Tên của workflow, sẽ hiển thị trong tab Actions
name: Build Android APK from Web Repo

# Dòng này quan trọng: cho phép bạn chạy workflow này một cách THỦ CÔNG
# bằng cách vào tab Actions và nhấn nút "Run workflow"
# Nó sẽ không tự chạy mỗi khi bạn cập nhật web để tránh phiền phức
on:
  workflow_dispatch:

jobs:
  build:
    # Chạy trên máy ảo Ubuntu mới nhất của GitHub
    runs-on: ubuntu-latest

    steps:
      # Bước 1: Tải về bộ mã nguồn Android WebView mẫu vào một thư mục tên là "android-project"
      - name: 1. Clone Android App Template
        run: git clone https://github.com/TomerGaber/Android-WebView-App-Template.git android-project

      # Bước 2: "Phẫu thuật" file MainActivity.java
      # Bước này sẽ XÓA nội dung file gốc và THAY THẾ bằng code mới của chúng ta
      # đã có đủ các tính năng bạn yêu cầu.
      - name: 2. Customize MainActivity with All Features
        run: |
          cat <<'EOF' > android-project/app/src/main/java/com/tomerg/webviewapp/MainActivity.java
          package com.tomerg.webviewapp;

          import android.content.Context;
          import android.content.SharedPreferences;
          import android.os.Bundle;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {

              // <<-- URL TRANG WEB CỦA BẠN ĐƯỢC ĐẶT CỨNG Ở ĐÂY -->>
              private static final String HOME_PAGE_URL = "https://drasaclone.github.io/Web";
              
              private static final String PREFS_NAME = "WebViewAppPrefs";
              private static final String LAST_URL_KEY = "last_visited_url";
              private WebView mWebView;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  
                  mWebView = findViewById(R.id.activity_main_webview);

                  WebSettings webSettings = mWebView.getSettings();
                  webSettings.setJavaScriptEnabled(true);
                  webSettings.setDomStorageEnabled(true);
                  
                  mWebView.setWebViewClient(new WebViewClient());

                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  String lastUrl = prefs.getString(LAST_URL_KEY, HOME_PAGE_URL);
                  
                  mWebView.loadUrl(lastUrl);
              }

              @Override
              public void onBackPressed() {
                  if (mWebView.canGoBack()) {
                      mWebView.goBack();
                  } else {
                      super.onBackPressed();
                  }
              }

              @Override
              protected void onPause() {
                  super.onPause();
                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  SharedPreferences.Editor editor = prefs.edit();
                  editor.putString(LAST_URL_KEY, mWebView.getUrl());
                  editor.apply();
              }
          }
          EOF

      # Bước 3: Cài đặt môi trường Java (bắt buộc cho build Android)
      - name: 3. Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Bước 4: Thực hiện build file APK
      - name: 4. Build the APK
        run: |
          cd android-project
          chmod +x gradlew
          ./gradlew assembleDebug

      # Bước 5: Tải file APK đã build xong lên mục Artifacts để bạn có thể download
      - name: 5. Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DrasaClone-WebApp
          path: android-project/app/build/outputs/apk/debug/app-debug.apk
