# Tên của workflow
name: Build Android APK (v4 - The ZIP Method)

# Chạy thủ công
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Bước 1: Dùng lệnh 'curl' để tải trực tiếp file .ZIP của mã nguồn mẫu.
      # Đây là phương pháp trực tiếp, bỏ qua mọi vấn đề về quyền của git.
      - name: 1. Download Source Code as ZIP
        run: curl -Lo template.zip https://github.com/DheerajDevaraj/Android-WebView-App-Template/archive/refs/heads/main.zip

      # Bước 2: Dùng lệnh 'unzip' để giải nén file vừa tải.
      # Thư mục sau khi giải nén sẽ có tên là "Android-WebView-App-Template-main"
      - name: 2. Unzip the Source Code
        run: unzip template.zip
        
      # Bước 3: Tùy chỉnh MainActivity.
      # --> Đường dẫn đã được cập nhật để trỏ vào thư mục vừa giải nén. <--
      - name: 3. Customize MainActivity with All Features
        run: |
          cat <<'EOF' > Android-WebView-App-Template-main/app/src/main/java/com/dheeraj/webviewapp/MainActivity.java
          package com.dheeraj.webviewapp;

          import android.content.Context;
          import android.content.SharedPreferences;
          import android.os.Bundle;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {

              private static final String HOME_PAGE_URL = "https://drasaclone.github.io/Web";
              
              private static final String PREFS_NAME = "WebViewAppPrefs";
              private static final String LAST_URL_KEY = "last_visited_url";
              private WebView mWebView;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  
                  mWebView = findViewById(R.id.activity_main_webview);

                  WebSettings webSettings = mWebView.getSettings();
                  webSettings.setJavaScriptEnabled(true);
                  webSettings.setDomStorageEnabled(true);
                  
                  mWebView.setWebViewClient(new WebViewClient());

                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  String lastUrl = prefs.getString(LAST_URL_KEY, HOME_PAGE_URL);
                  
                  mWebView.loadUrl(lastUrl);
              }

              @Override
              public void onBackPressed() {
                  if (mWebView.canGoBack()) {
                      mWebView.goBack();
                  } else {
                      super.onBackPressed();
                  }
              }

              @Override
              protected void onPause() {
                  super.onPause();
                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  SharedPreferences.Editor editor = prefs.edit();
                  editor.putString(LAST_URL_KEY, mWebView.getUrl());
                  editor.apply();
              }
          }
          EOF

      # Bước 4: Cài đặt Java.
      - name: 4. Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Bước 5: Build APK.
      # --> Di chuyển vào đúng thư mục đã giải nén trước khi build. <--
      - name: 5. Build the APK
        working-directory: ./Android-WebView-App-Template-main
        run: |
          chmod +x gradlew
          ./gradlew assembleDebug

      # Bước 6: Tải APK lên.
      # --> Cập nhật đường dẫn cuối cùng đến file APK. <--
      - name: 6. Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DrasaClone-WebApp-Final-Build
          path: ./Android-WebView-App-Template-main/app/build/outputs/apk/debug/app-debug.apk
