name: Build Android APK from Web Repo

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Bước 1: Dùng "Action" để clone repo mẫu một cách an toàn.
      # ---> DÒNG SỬA LỖI ĐƯỢC THÊM VÀO ĐÂY <---
      # Chúng ta chỉ định rõ phải lấy code từ nhánh "master".
      - name: 1. Checkout Android App Template
        uses: actions/checkout@v4
        with:
          repository: TomerGaber/Android-WebView-App-Template
          path: ./android-project
          ref: master # Chỉ định rõ nhánh cần checkout là 'master'

      # Bước 2: Tùy chỉnh MainActivity. (KHÔNG THAY ĐỔI)
      - name: 2. Customize MainActivity with All Features
        run: |
          cat <<'EOF' > android-project/app/src/main/java/com/tomerg/webviewapp/MainActivity.java
          package com.tomerg.webviewapp;

          import android.content.Context;
          import android.content.SharedPreferences;
          import android.os.Bundle;
          import android.webkit.WebSettings;
          import android.webkit.WebView;
          import android.webkit.WebViewClient;
          import androidx.appcompat.app.AppCompatActivity;

          public class MainActivity extends AppCompatActivity {

              private static final String HOME_PAGE_URL = "https://drasaclone.github.io/Web";
              
              private static final String PREFS_NAME = "WebViewAppPrefs";
              private static final String LAST_URL_KEY = "last_visited_url";
              private WebView mWebView;

              @Override
              protected void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  setContentView(R.layout.activity_main);
                  
                  mWebView = findViewById(R.id.activity_main_webview);

                  WebSettings webSettings = mWebView.getSettings();
                  webSettings.setJavaScriptEnabled(true);
                  webSettings.setDomStorageEnabled(true);
                  
                  mWebView.setWebViewClient(new WebViewClient());

                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  String lastUrl = prefs.getString(LAST_URL_KEY, HOME_PAGE_URL);
                  
                  mWebView.loadUrl(lastUrl);
              }

              @Override
              public void onBackPressed() {
                  if (mWebView.canGoBack()) {
                      mWebView.goBack();
                  } else {
                      super.onBackPressed();
                  }
              }

              @Override
              protected void onPause() {
                  super.onPause();
                  SharedPreferences prefs = getSharedPreferences(PREFS_NAME, Context.MODE_PRIVATE);
                  SharedPreferences.Editor editor = prefs.edit();
                  editor.putString(LAST_URL_KEY, mWebView.getUrl());
                  editor.apply();
              }
          }
          EOF

      # Bước 3: Cài đặt Java. (KHÔNG THAY ĐỔI)
      - name: 3. Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Bước 4: Build APK. (KHÔNG THAY ĐỔI)
      - name: 4. Build the APK
        run: |
          cd android-project
          chmod +x gradlew
          ./gradlew assembleDebug

      # Bước 5: Tải APK lên. (KHÔNG THAY ĐỔI)
      - name: 5. Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DrasaClone-WebApp
          path: android-project/app/build/outputs/apk/debug/app-debug.apk
